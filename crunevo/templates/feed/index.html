{% extends 'base.html' %}
{% import 'components/csrf.html' as csrf %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/feed.css') }}">
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-2 d-none d-lg-block">
    {% include 'feed/sidebar_left_feed.html' %}
    {% include 'components/feed_sidebar.html' with categoria=categoria %}
  </div>
  <div class="col-lg-7">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex mb-3">
          <img loading="lazy" loading="lazy" src="{{ current_user.avatar_url or url_for('static', filename='img/default.png') }}" class="rounded-circle me-2" width="40" height="40" alt="avatar">
          <textarea name="content" form="postForm" class="form-control" rows="2" placeholder="¿Qué deseas compartir?" required></textarea>
        </div>
        <form id="postForm" method="post" enctype="multipart/form-data">
          {{ csrf.csrf_field() }}
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="btn-group">
              <a href="{{ url_for('notes.upload') }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-file-earmark-plus"></i> Apunte</a>
              <label class="btn btn-outline-secondary btn-sm mb-0">
                <i class="bi bi-image"></i> Imagen
                <input type="file" name="file" id="feedImageInput" accept="image/*" class="d-none">
              </label>
              <button type="button" class="btn btn-outline-secondary btn-sm" disabled><i class="bi bi-trophy"></i> Logro</button>
            </div>
            <button id="postSubmitBtn" class="btn btn-primary btn-sm" type="submit">Publicar</button>
          </div>
          <div id="previewContainer" class="mt-2"></div>
        </form>
      </div>
    </div>
    <div class="d-lg-none mb-3">
      {% include 'components/feed_sidebar.html' with categoria=categoria %}
    </div>
    <div id="feed" class="tw-space-y-4" data-categoria="{{ categoria or '' }}">
      {% for item in feed_items %}
        {% if item.type == 'note' %}
          {% set note = item.data %}
          {% include 'components/feed_card.html' %}
        {% elif item.type == 'post' %}
          {% set post = item.data %}
          {% include 'feed/post_card.html' %}
        {% endif %}
      {% endfor %}
    </div>
    <div id="feedEnd" class="my-3 text-center">
      <div class="spinner-border" role="status"></div>
    </div>
    {% if not feed_items %}
      <div class="text-center my-5 text-muted">Aún no hay publicaciones. Sé el primero en compartir algo con la comunidad.</div>
    {% endif %}
  </div>
  <div class="col-lg-3 d-none d-lg-block">
    {% include 'components/sidebar_right.html' %}
  </div>
</div>
<button class="btn btn-primary rounded-circle position-fixed bottom-0 start-0 m-3 d-lg-none" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar"><i class="bi bi-list"></i></button>
<div class="offcanvas offcanvas-start" tabindex="-1" id="mobileSidebar" aria-labelledby="mobileSidebarLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="mobileSidebarLabel">Menú</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    {% include 'feed/sidebar_left_feed.html' %}
    {% include 'components/feed_sidebar.html' with categoria=categoria %}
  </div>
</div>
{% endblock %}
