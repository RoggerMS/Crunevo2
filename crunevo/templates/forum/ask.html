
{% extends "base.html" %}

{% block head_extra %}
<style>
/* Dark Mode for Ask Page */
@media (prefers-color-scheme: dark) {
  body {
    background-color: #111827;
    color: #d1d5db;
  }

  .ask-header {
    background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
    border-color: #4b5563;
  }

  .ask-title, .ask-subtitle, .stat-label {
    color: #f9fafb;
  }

  .ask-form-container, .sidebar-card {
    background-color: #1f2937;
    border-color: #374151;
  }

  .step-header .step-title, .step-description, .form-label, .options-title {
    color: #f3f4f6;
  }

  .modern-input, .modern-select, .tags-input {
    background-color: #374151;
    border-color: #4b5563;
    color: #f9fafb;
  }

  .modern-input::placeholder, .tags-input::placeholder {
    color: #9ca3af;
  }

  .input-help, .char-counter {
    color: #9ca3af;
  }

  .progress-bar-container {
    background-color: #374151;
  }

  .progress-bar-fill {
    background-color: #3b82f6;
  }

  .option-card {
    background-color: #374151;
    border-color: #4b5563;
  }

  .option-label:hover .option-card {
    border-color: #60a5fa;
  }

  .btn-primary {
    background-color: #3b82f6;
    border-color: #3b82f6;
  }

  .btn-secondary {
    background-color: #6b7280;
    border-color: #6b7280;
  }

  .sidebar-card .card-title, .sidebar-card .list-group-item {
    color: #f3f4f6;
  }

  .sidebar-card .list-group-item {
    background-color: transparent;
    border-color: #374151;
  }
}
</style>
{% endblock %}

{% block title %}Hacer una pregunta - Foro Estudiantil{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-lg-4 py-3">
  <!-- Modern Header -->
  <div class="ask-header mb-4">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="ask-title">üí≠ Haz tu pregunta</h1>
        <p class="ask-subtitle">Comparte tu duda con la comunidad y obt√©n respuestas de calidad</p>
      </div>
      <div class="col-md-4 text-end">
        <div class="ask-stats">
          <div class="stat-item">
            <span class="stat-number">95%</span>
            <span class="stat-label">Preguntas respondidas</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Main Form -->
    <div class="col-lg-8">
      <div class="ask-form-container">
        <form method="POST" id="questionForm" class="modern-form">
          {% import 'components/csrf.html' as csrf %}
          {{ csrf.csrf_field() }}
          
          <!-- Progress Bar -->
          <div class="progress-section mb-4">
            <div class="progress-header">
              <span class="progress-label">Progreso de tu pregunta</span>
              <span class="progress-percentage" id="progress-text">0%</span>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar-fill" id="progress-bar"></div>
            </div>
          </div>

          <!-- Step 1: Title -->
          <div class="form-step active" data-step="1">
            <div class="step-header">
              <div class="step-number">1</div>
              <div class="step-info">
                <h3 class="step-title">¬øCu√°l es tu pregunta?</h3>
                <p class="step-description">S√© espec√≠fico y claro para obtener mejores respuestas</p>
              </div>
            </div>
            
            <div class="form-group">
              <input type="text" 
                     class="modern-input" 
                     id="title" 
                     name="title" 
                     placeholder="Ej: ¬øC√≥mo resolver esta ecuaci√≥n cuadr√°tica paso a paso?"
                     maxlength="200"
                     required>
              <div class="input-help">
                <span class="help-icon">üí°</span>
                <span class="help-text">Un buen t√≠tulo es espec√≠fico y menciona el concepto principal</span>
              </div>
              <div class="char-counter">
                <span id="title-counter">0</span>/200 caracteres
              </div>
            </div>
          </div>

          <!-- Step 2: Categories and Context -->
          <div class="form-step" data-step="2">
            <div class="step-header">
              <div class="step-number">2</div>
              <div class="step-info">
                <h3 class="step-title">Contexto y categorizaci√≥n</h3>
                <p class="step-description">Ay√∫danos a dirigir tu pregunta a los expertos correctos</p>
              </div>
            </div>
            
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Materia principal</label>
                <select class="modern-select" id="category" name="category" required>
                  <option value="">Selecciona una materia</option>
                  {% for category in categories %}
                  <option value="{{ category }}">
                    {% if category == 'Matem√°ticas' %}üßÆ {{ category }}
                    {% elif category == 'Ciencias' %}üî¨ {{ category }}
                    {% elif category == 'Lenguas' %}üìö {{ category }}
                    {% elif category == 'Historia' %}üèõÔ∏è {{ category }}
                    {% elif category == 'Tecnolog√≠a' %}üíª {{ category }}
                    {% elif category == 'Arte' %}üé® {{ category }}
                    {% else %}üìù {{ category }}
                    {% endif %}
                  </option>
                  {% endfor %}
                </select>
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Nivel de dificultad</label>
                <select class="modern-select" id="difficulty_level" name="difficulty_level">
                  {% for value, label in difficulty_levels %}
                  <option value="{{ value }}" {{ 'selected' if value == 'intermedio' }}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Nivel educativo</label>
                <select class="modern-select" id="grade_level" name="grade_level">
                  <option value="">Selecciona tu nivel</option>
                  {% for value, label in grade_levels %}
                  <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Tipo de consulta</label>
                <select class="modern-select" id="context_type" name="context_type">
                  <option value="general">Consulta general</option>
                  <option value="homework">Tarea/Ejercicio</option>
                  <option value="exam">Preparaci√≥n de examen</option>
                  <option value="project">Proyecto</option>
                  <option value="curiosity">Curiosidad personal</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Step 3: Content -->
          <div class="form-step" data-step="3">
            <div class="step-header">
              <div class="step-number">3</div>
              <div class="step-info">
                <h3 class="step-title">Explica tu problema en detalle</h3>
                <p class="step-description">Mientras m√°s contexto proporciones, mejor ser√° la respuesta</p>
              </div>
            </div>
            
            <div class="form-group">
              <div class="editor-toolbar">
                <div class="writing-tips">
                  <span class="tip-icon">üìù</span>
                  <span>Incluye: el problema espec√≠fico, lo que has intentado, y d√≥nde te atascaste</span>
                </div>
              </div>
              <div id="questionEditor" class="modern-editor"></div>
              <input type="hidden" name="content" required>
              <div class="char-counter">
                <span id="content-counter">0</span> caracteres
              </div>
              <div class="invalid-feedback d-block" id="content-error" style="display:none;">
                La descripci√≥n debe tener al menos 20 caracteres.
              </div>
            </div>
          </div>

          <!-- Step 4: Tags and Advanced Options -->
          <div class="form-step" data-step="4">
            <div class="step-header">
              <div class="step-number">4</div>
              <div class="step-info">
                <h3 class="step-title">Tags y opciones adicionales</h3>
                <p class="step-description">Etiqueta tu pregunta para que sea m√°s f√°cil de encontrar</p>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Tags (etiquetas)</label>
              <div class="tags-input-container">
                <input type="text" 
                       class="tags-input" 
                       id="tags-input" 
                       placeholder="Escribe y presiona Enter para agregar tags">
                <div class="tags-suggestions" id="tags-suggestions"></div>
              </div>
              <div class="selected-tags" id="selected-tags"></div>
              <div class="input-help">
                <span class="help-icon">üè∑Ô∏è</span>
                <span class="help-text">Agrega palabras clave como "√°lgebra", "derivadas", "sintaxis", etc.</span>
              </div>
            </div>

            <!-- Advanced Options -->
            <div class="advanced-options">
              <h4 class="options-title">Opciones adicionales</h4>
              
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="option-card">
                    <label class="option-label">
                      <input type="checkbox" id="is_urgent" name="is_urgent" class="option-checkbox">
                      <div class="option-content">
                        <div class="option-icon">üö®</div>
                        <div class="option-text">
                          <div class="option-name">Pregunta urgente</div>
                          <div class="option-desc">Necesitas ayuda r√°pida</div>
                        </div>
                      </div>
                    </label>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="option-card">
                    <label class="form-label">Fecha l√≠mite (opcional)</label>
                    <input type="datetime-local" 
                           class="modern-input" 
                           id="homework_deadline" 
                           name="homework_deadline">
                  </div>
                </div>
              </div>

              <!-- Bounty System -->
              <div class="bounty-section">
                <h5 class="bounty-title">üí∞ Sistema de recompensas</h5>
                <p class="bounty-description">Ofrece puntos para motivar respuestas de alta calidad</p>
                
                <div class="bounty-options">
                  <div class="bounty-option">
                    <input type="radio" id="bounty-0" name="bounty_points" value="0" checked>
                    <label for="bounty-0" class="bounty-label">
                      <span class="bounty-amount">0 pts</span>
                      <span class="bounty-desc">Sin recompensa</span>
                    </label>
                  </div>
                  <div class="bounty-option">
                    <input type="radio" id="bounty-10" name="bounty_points" value="10">
                    <label for="bounty-10" class="bounty-label">
                      <span class="bounty-amount">10 pts</span>
                      <span class="bounty-desc">Pregunta importante</span>
                    </label>
                  </div>
                  <div class="bounty-option">
                    <input type="radio" id="bounty-25" name="bounty_points" value="25">
                    <label for="bounty-25" class="bounty-label">
                      <span class="bounty-amount">25 pts</span>
                      <span class="bounty-desc">Pregunta compleja</span>
                    </label>
                  </div>
                  <div class="bounty-option">
                    <input type="radio" id="bounty-50" name="bounty_points" value="50">
                    <label for="bounty-50" class="bounty-label">
                      <span class="bounty-amount">50 pts</span>
                      <span class="bounty-desc">Pregunta muy urgente</span>
                    </label>
                  </div>
                </div>
                
                <div class="user-points">
                  Tus puntos disponibles: <span class="points-count">{{ current_user.points or 0 }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Navigation Buttons -->
          <div class="form-navigation">
            <button type="button" class="btn-nav btn-prev" id="prevBtn" onclick="changeStep(-1)">
              <i class="bi bi-chevron-left"></i> Anterior
            </button>
            
            <div class="step-indicators">
              <div class="step-dot active" data-step="1"></div>
              <div class="step-dot" data-step="2"></div>
              <div class="step-dot" data-step="3"></div>
              <div class="step-dot" data-step="4"></div>
            </div>
            
            <button type="button" class="btn-nav btn-next" id="nextBtn" onclick="changeStep(1)">
              Siguiente <i class="bi bi-chevron-right"></i>
            </button>
            
            <button type="submit" class="btn-nav btn-submit" id="submitBtn" style="display: none;">
              <i class="bi bi-send"></i> Publicar pregunta
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Sidebar with Tips -->
    <div class="col-lg-4">
      <div class="sidebar-content">
        <!-- Writing Tips -->
        <div class="tip-card">
          <div class="tip-header">
            <h4 class="tip-title">üí° Consejos para una buena pregunta</h4>
          </div>
          <div class="tip-body">
            <div class="tip-item">
              <div class="tip-icon">üéØ</div>
              <div class="tip-content">
                <div class="tip-name">S√© espec√≠fico</div>
                <div class="tip-desc">En lugar de "no entiendo matem√°ticas", di "no s√© resolver ecuaciones cuadr√°ticas"</div>
              </div>
            </div>
            <div class="tip-item">
              <div class="tip-icon">üìù</div>
              <div class="tip-content">
                <div class="tip-name">Muestra tu trabajo</div>
                <div class="tip-desc">Comparte los pasos que ya intentaste</div>
              </div>
            </div>
            <div class="tip-item">
              <div class="tip-icon">üñºÔ∏è</div>
              <div class="tip-content">
                <div class="tip-name">Usa im√°genes</div>
                <div class="tip-desc">Una imagen vale m√°s que mil palabras</div>
              </div>
            </div>
            <div class="tip-item">
              <div class="tip-icon">üè∑Ô∏è</div>
              <div class="tip-content">
                <div class="tip-name">Etiqueta bien</div>
                <div class="tip-desc">Usa tags relevantes para tu tema</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Examples -->
        <div class="examples-card">
          <div class="examples-header">
            <h4 class="examples-title">üìö Ejemplos de buenas preguntas</h4>
          </div>
          <div class="examples-body">
            <div class="example-item">
              <div class="example-title">‚ùì "¬øC√≥mo derivar f(x) = x¬≤ + 3x?"</div>
              <div class="example-desc">Espec√≠fica, directa y con contexto claro</div>
            </div>
            <div class="example-item">
              <div class="example-title">‚ùì "Diferencia entre ser y estar en espa√±ol"</div>
              <div class="example-desc">Pregunta conceptual bien formulada</div>
            </div>
            <div class="example-item">
              <div class="example-title">‚ùì "¬øPor qu√© ocurri√≥ la Revoluci√≥n Francesa?"</div>
              <div class="example-desc">Pregunta abierta pero con foco espec√≠fico</div>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-card">
          <div class="stats-header">
            <h4 class="stats-title">üìä Estad√≠sticas de la comunidad</h4>
          </div>
          <div class="stats-body">
            <div class="stat-row">
              <span class="stat-label">Tiempo promedio de respuesta</span>
              <span class="stat-value">2.3 horas</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Expertos activos</span>
              <span class="stat-value">150+</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Preguntas resueltas hoy</span>
              <span class="stat-value">47</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modern Styles -->
<style>
/* Container Styles */
.ask-header {
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  border-radius: 24px;
  padding: 2rem;
  border: 1px solid #e5e7eb;
}

.ask-title {
  font-size: 2.25rem;
  font-weight: 700;
  color: #1f2937;
  margin: 0;
}

.ask-subtitle {
  color: #6b7280;
  font-size: 1.1rem;
  margin: 0;
}

.ask-stats {
  text-align: center;
  padding: 1rem;
  background: white;
  border-radius: 16px;
  border: 1px solid #e5e7eb;
}

.stat-number {
  display: block;
  font-size: 2rem;
  font-weight: 700;
  color: #10b981;
}

.stat-label {
  font-size: 0.875rem;
  color: #6b7280;
}

/* Form Container */
.ask-form-container {
  background: white;
  border-radius: 24px;
  padding: 2rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  border: 1px solid #f1f5f9;
}

/* Progress Bar */
.progress-section {
  background: #f8fafc;
  border-radius: 16px;
  padding: 1.5rem;
  border: 1px solid #e5e7eb;
}

.progress-header {
  display: flex;
  justify-content: between;
  align-items: center;
  margin-bottom: 1rem;
}

.progress-label {
  font-weight: 600;
  color: #374151;
}

.progress-percentage {
  font-weight: 700;
  color: #3b82f6;
}

.progress-bar-container {
  width: 100%;
  height: 8px;
  background: #e5e7eb;
  border-radius: 4px;
  overflow: hidden;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #3b82f6, #1e40af);
  border-radius: 4px;
  width: 0%;
  transition: width 0.5s ease;
}

/* Form Steps */
.form-step {
  display: none;
  margin-bottom: 2rem;
}

.form-step.active {
  display: block;
}

.step-header {
  display: flex;
  align-items: center;
  margin-bottom: 2rem;
  gap: 1rem;
}

.step-number {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: linear-gradient(135deg, #3b82f6, #1e40af);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 1.25rem;
}

.step-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1f2937;
  margin: 0;
}

.step-description {
  color: #6b7280;
  margin: 0;
}

/* Form Inputs */
.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.5rem;
}

.modern-input, .modern-select {
  width: 100%;
  padding: 16px 20px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 1rem;
  transition: all 0.3s ease;
  background: white;
}

.modern-input:focus, .modern-select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.input-help {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
  padding: 12px;
  background: #f0f9ff;
  border-radius: 8px;
  border: 1px solid #bae6fd;
}

.help-icon {
  font-size: 1.25rem;
}

.help-text {
  font-size: 0.875rem;
  color: #0369a1;
}

.char-counter {
  text-align: right;
  margin-top: 8px;
  font-size: 0.875rem;
  color: #6b7280;
}

/* Editor */
.modern-editor {
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  min-height: 200px;
  background: white;
  padding: 0;
}

.modern-editor .ql-editor {
  padding: 0.75rem;
  font-size: 1rem;
  line-height: 1.5;
}

#content-error {
  font-size: 0.875rem;
  color: #dc2626;
  margin-top: 4px;
}

.editor-toolbar {
  margin-bottom: 1rem;
}

.writing-tips {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  background: #fef3c7;
  border-radius: 8px;
  border: 1px solid #fbbf24;
}

.tip-icon {
  font-size: 1.25rem;
}

/* Tags Input */
.tags-input-container {
  position: relative;
}

.tags-input {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 1rem;
}

.tags-input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.tags-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 10;
  display: none;
}

.tag-suggestion {
  padding: 12px 16px;
  cursor: pointer;
  border-bottom: 1px solid #f3f4f6;
}

.tag-suggestion:hover {
  background: #f8fafc;
}

.selected-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 1rem;
}

.tag-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: #3b82f6;
  color: white;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 500;
}

.tag-remove {
  cursor: pointer;
  font-weight: bold;
}

/* Advanced Options */
.advanced-options {
  margin-top: 2rem;
  padding: 1.5rem;
  background: #f8fafc;
  border-radius: 16px;
  border: 1px solid #e5e7eb;
}

.options-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: #374151;
  margin-bottom: 1rem;
}

.option-card {
  background: white;
  border-radius: 12px;
  border: 2px solid #e5e7eb;
  transition: all 0.3s ease;
}

.option-card:hover {
  border-color: #3b82f6;
}

.option-label {
  display: flex;
  align-items: center;
  padding: 1rem;
  cursor: pointer;
  margin: 0;
}

.option-checkbox {
  display: none;
}

.option-content {
  display: flex;
  align-items: center;
  gap: 12px;
  width: 100%;
}

.option-icon {
  font-size: 1.5rem;
}

.option-name {
  font-weight: 600;
  color: #374151;
}

.option-desc {
  font-size: 0.875rem;
  color: #6b7280;
}

.option-checkbox:checked + .option-content {
  color: #3b82f6;
}

/* Bounty System */
.bounty-section {
  margin-top: 1.5rem;
  padding: 1.5rem;
  background: linear-gradient(135deg, #fef3c7, #fed7aa);
  border-radius: 16px;
  border: 1px solid #fbbf24;
}

.bounty-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: #92400e;
  margin-bottom: 0.5rem;
}

.bounty-description {
  color: #92400e;
  margin-bottom: 1rem;
}

.bounty-options {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 12px;
  margin-bottom: 1rem;
}

.bounty-option {
  position: relative;
}

.bounty-option input[type="radio"] {
  display: none;
}

.bounty-label {
  display: block;
  padding: 12px;
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

.bounty-option input[type="radio"]:checked + .bounty-label {
  border-color: #fbbf24;
  background: #fffbeb;
}

.bounty-amount {
  display: block;
  font-weight: 700;
  color: #92400e;
  font-size: 1.125rem;
}

.bounty-desc {
  display: block;
  font-size: 0.75rem;
  color: #6b7280;
  margin-top: 4px;
}

.user-points {
  text-align: center;
  color: #92400e;
  font-weight: 500;
}

.points-count {
  font-weight: 700;
  color: #dc2626;
}

/* Navigation */
.form-navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 3rem;
  padding-top: 2rem;
  border-top: 1px solid #e5e7eb;
}

.btn-nav {
  padding: 12px 24px;
  border-radius: 12px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-prev, .btn-next {
  background: #f3f4f6;
  color: #374151;
}

.btn-prev:hover, .btn-next:hover {
  background: #e5e7eb;
  transform: translateY(-2px);
}

.btn-submit {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
}

.btn-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
}

.step-indicators {
  display: flex;
  gap: 12px;
}

.step-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #e5e7eb;
  cursor: pointer;
  transition: all 0.3s ease;
}

.step-dot.active {
  background: #3b82f6;
  transform: scale(1.2);
}

.step-dot.completed {
  background: #10b981;
}

/* Sidebar */
.sidebar-content {
  position: sticky;
  top: 2rem;
}

.tip-card, .examples-card, .stats-card {
  background: white;
  border-radius: 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  border: 1px solid #f1f5f9;
  margin-bottom: 1.5rem;
  overflow: hidden;
}

.tip-header, .examples-header, .stats-header {
  padding: 1.5rem;
  background: linear-gradient(135deg, #f8fafc, #e2e8f0);
  border-bottom: 1px solid #e5e7eb;
}

.tip-title, .examples-title, .stats-title {
  margin: 0;
  font-weight: 600;
  color: #374151;
}

.tip-body, .examples-body, .stats-body {
  padding: 1.5rem;
}

.tip-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 1rem;
}

.tip-item:last-child {
  margin-bottom: 0;
}

.tip-icon {
  font-size: 1.25rem;
  width: 32px;
  text-align: center;
  flex-shrink: 0;
}

.tip-name {
  font-weight: 600;
  color: #374151;
  font-size: 0.875rem;
}

.tip-desc {
  font-size: 0.8rem;
  color: #6b7280;
  margin-top: 2px;
}

.example-item {
  margin-bottom: 1rem;
  padding: 12px;
  background: #f8fafc;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

.example-item:last-child {
  margin-bottom: 0;
}

.example-title {
  font-weight: 600;
  color: #374151;
  font-size: 0.875rem;
  margin-bottom: 4px;
}

.example-desc {
  font-size: 0.75rem;
  color: #6b7280;
}

.stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.stat-row:last-child {
  margin-bottom: 0;
}

.stat-label {
  font-size: 0.875rem;
  color: #6b7280;
}

.stat-value {
  font-weight: 700;
  color: #3b82f6;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .ask-header {
    padding: 1.5rem;
  }
  
  .ask-title {
    font-size: 1.75rem;
  }
  
  .ask-form-container {
    padding: 1.5rem;
  }
  
  .step-header {
    flex-direction: column;
    align-items: flex-start;
    text-align: left;
  }
  
  .bounty-options {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .form-navigation {
    flex-direction: column;
    gap: 1rem;
  }
  
  .sidebar-content {
    position: static;
    margin-top: 2rem;
  }
}
</style>

<script>
// Form State
let currentStep = 1;
let selectedTags = [];
let formData = {
  title: '',
  category: '',
  content: '',
  tags: []
};

// Initialize form
document.addEventListener('DOMContentLoaded', function() {
  updateProgress();
  setupEventListeners();

  setTimeout(function initEditorValidation() {
    if (window.quillEditor) {
      window.quillEditor.on('text-change', function() {
        updateContentValidation();
        updateProgress();
      });
      updateContentValidation();
    } else {
      setTimeout(initEditorValidation, 100);
    }
  }, 0);
});

function setupEventListeners() {
  // Title input
  const titleInput = document.getElementById('title');
  titleInput.addEventListener('input', function() {
    updateCharCounter('title', 200);
    updateProgress();
  });
  
  // Form inputs
  ['category', 'difficulty_level', 'grade_level', 'context_type'].forEach(id => {
    document.getElementById(id).addEventListener('change', updateProgress);
  });
  
  // Tags input
  const tagsInput = document.getElementById('tags-input');
  tagsInput.addEventListener('keydown', handleTagInput);
  tagsInput.addEventListener('input', handleTagSearch);
  
  // Bounty selection
  document.querySelectorAll('input[name="bounty_points"]').forEach(input => {
    input.addEventListener('change', updateBountyDisplay);
  });
  
  // Step dots
  document.querySelectorAll('.step-dot').forEach(dot => {
    dot.addEventListener('click', function() {
      const step = parseInt(this.dataset.step);
      if (step <= getMaxAccessibleStep()) {
        goToStep(step);
      }
    });
  });
}

function updateCharCounter(inputId, maxLength) {
  const input = document.getElementById(inputId);
  const counter = document.getElementById(inputId + '-counter');
  if (counter) {
    counter.textContent = input.value.length;
    if (input.value.length > maxLength * 0.9) {
      counter.style.color = '#dc2626';
    } else {
      counter.style.color = '#6b7280';
    }
  }
}

function countRealChars(text) {
  return text.replace(/[\s\p{P}\p{S}]/gu, '').length;
}

function updateContentValidation() {
  if (!window.quillEditor) return;
  const rawText = window.quillEditor.getText();
  const len = countRealChars(rawText);
  const counter = document.getElementById('content-counter');
  if (counter) counter.textContent = len;

  const nextBtn = document.getElementById('nextBtn');
  const errorEl = document.getElementById('content-error');

  const hasRealContent = len >= 20;
  const hasSomeText = rawText.replace(/\s/g, '').length > 0;

  if (hasRealContent) {
    if (errorEl) errorEl.style.display = 'none';
    if (currentStep === 3 && nextBtn) nextBtn.disabled = false;
  } else {
    if (errorEl) {
      errorEl.style.display = hasSomeText ? 'block' : 'none';
    }
    if (currentStep === 3 && nextBtn) nextBtn.disabled = true;
  }
}

function changeStep(direction) {
  const newStep = currentStep + direction;
  if (newStep >= 1 && newStep <= 4) {
    if (direction > 0 && !validateCurrentStep()) {
      return;
    }
    goToStep(newStep);
  }
}

function goToStep(step) {
  // Hide current step
  document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.remove('active');
  document.querySelector(`.step-dot[data-step="${currentStep}"]`).classList.remove('active');
  
  // Show new step
  currentStep = step;
  document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.add('active');
  document.querySelector(`.step-dot[data-step="${currentStep}"]`).classList.add('active');
  
  // Update navigation buttons
  updateNavigationButtons();
  updateProgress();
  if (currentStep === 3) {
    updateContentValidation();
  }
  
  // Mark previous steps as completed
  for (let i = 1; i < currentStep; i++) {
    document.querySelector(`.step-dot[data-step="${i}"]`).classList.add('completed');
  }
}

function updateNavigationButtons() {
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const submitBtn = document.getElementById('submitBtn');
  
  prevBtn.style.display = currentStep === 1 ? 'none' : 'flex';
  
  if (currentStep === 4) {
    nextBtn.style.display = 'none';
    submitBtn.style.display = 'flex';
  } else {
    nextBtn.style.display = 'flex';
    submitBtn.style.display = 'none';
  }
}

function validateCurrentStep() {
  switch (currentStep) {
    case 1:
      const title = document.getElementById('title').value.trim();
      if (title.length < 10) {
        alert('El t√≠tulo debe tener al menos 10 caracteres');
        return false;
      }
      return true;
    case 2:
      const category = document.getElementById('category').value;
      if (!category) {
        alert('Selecciona una materia');
        return false;
      }
      return true;
    case 3:
      const content = window.quillEditor ? window.quillEditor.getText() : '';
      if (countRealChars(content) < 20) {
        alert('La descripci√≥n debe tener al menos 20 caracteres');
        return false;
      }
      return true;
    case 4:
      return true;
    default:
      return true;
  }
}

function getMaxAccessibleStep() {
  // Users can only access steps they've completed prerequisites for
  const title = document.getElementById('title').value.trim();
  if (title.length < 10) return 1;
  
  const category = document.getElementById('category').value;
  if (!category) return 2;
  
  const content = window.quillEditor ? window.quillEditor.getText() : '';
  if (countRealChars(content) < 20) return 3;
  
  return 4;
}

function updateProgress() {
  let progress = 0;
  const totalSteps = 4;
  
  // Step 1: Title
  const title = document.getElementById('title').value.trim();
  if (title.length >= 10) progress += 25;
  
  // Step 2: Category
  const category = document.getElementById('category').value;
  if (category) progress += 25;
  
  // Step 3: Content
  const content = window.quillEditor ? window.quillEditor.getText() : '';
  if (countRealChars(content) >= 20) progress += 25;
  
  // Step 4: Completion
  if (selectedTags.length > 0 || currentStep === 4) progress += 25;
  
  document.getElementById('progress-bar').style.width = progress + '%';
  document.getElementById('progress-text').textContent = progress + '%';
}

function handleTagInput(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    const tagName = e.target.value.trim();
    if (tagName && !selectedTags.includes(tagName)) {
      addTag(tagName);
      e.target.value = '';
    }
  }
}

function handleTagSearch(e) {
  const query = e.target.value.trim();
  if (query.length >= 2) {
    // Here you would typically fetch suggestions from the server
    // For now, we'll show some dummy suggestions
    showTagSuggestions(['√°lgebra', 'geometr√≠a', 'c√°lculo', 'trigonometr√≠a', 'estad√≠stica']);
  } else {
    hideTagSuggestions();
  }
}

function showTagSuggestions(suggestions) {
  const container = document.getElementById('tags-suggestions');
  container.innerHTML = '';
  
  suggestions.forEach(tag => {
    if (!selectedTags.includes(tag)) {
      const div = document.createElement('div');
      div.className = 'tag-suggestion';
      div.textContent = tag;
      div.onclick = () => {
        addTag(tag);
        document.getElementById('tags-input').value = '';
        hideTagSuggestions();
      };
      container.appendChild(div);
    }
  });
  
  container.style.display = suggestions.length > 0 ? 'block' : 'none';
}

function hideTagSuggestions() {
  document.getElementById('tags-suggestions').style.display = 'none';
}

function addTag(tagName) {
  if (!selectedTags.includes(tagName)) {
    selectedTags.push(tagName);
    renderTags();
    updateProgress();
  }
}

function removeTag(tagName) {
  selectedTags = selectedTags.filter(tag => tag !== tagName);
  renderTags();
  updateProgress();
}

function renderTags() {
  const container = document.getElementById('selected-tags');
  container.innerHTML = '';
  
  selectedTags.forEach(tag => {
    const tagElement = document.createElement('div');
    tagElement.className = 'tag-item';
    tagElement.innerHTML = `
      <span>${tag}</span>
      <span class="tag-remove" onclick="removeTag('${tag}')">&times;</span>
    `;
    container.appendChild(tagElement);
  });
}

function updateBountyDisplay() {
  const selectedBounty = document.querySelector('input[name="bounty_points"]:checked');
  if (selectedBounty) {
    const points = parseInt(selectedBounty.value);
    const userPoints = {{ current_user.points or 0 }};
    
    if (points > userPoints) {
      alert('No tienes suficientes puntos para esta recompensa');
      document.getElementById('bounty-0').checked = true;
    }
  }
}


// Form submission
document.getElementById('questionForm').addEventListener('submit', function(e) {
  if (window.quillEditor) {
    const len = countRealChars(window.quillEditor.getText());
    if (len < 20) {
      e.preventDefault();
      const errorEl = document.getElementById('content-error');
      if (errorEl) errorEl.style.display = 'block';
      return;
    }
    document.querySelector('input[name="content"]').value = window.quillEditor.root.innerHTML;
  }
  
  // Add selected tags to form
  selectedTags.forEach(tag => {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'tags';
    input.value = tag;
    this.appendChild(input);
  });
  
  // Show loading state
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Publicando...';
});
</script>

{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/forum_editor.css') }}">
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
<script src="{{ url_for('static', filename='js/forum_editor.js') }}"></script>
{% endblock %}
