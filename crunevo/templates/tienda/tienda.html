{% extends "base.html" %}
{% include "components/csrf.html" %}
{% from 'components/price_credits.html' import render_price_credits %}

{% block title %}Tienda Crunevo{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/store.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/tom-select.bootstrap5.min.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Botón de filtros para móviles -->
    <div class="d-lg-none mb-3">
        <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas"
            data-bs-target="#filtersOffcanvas" aria-controls="filtersOffcanvas" id="filtersToggleBtn">
            Filtros
        </button>
    </div>
    <div class="row">
        <!-- Sidebar de filtros -->
        <div class="col-lg-3 mb-4 d-none d-lg-block filters-container">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">Filtros</h5>
                    <form id="filter-form" method="get" action="{{ url_for('commerce.commerce_index') }}">
                        <input type="hidden" name="sort" value="{{ sort }}">
                        <!-- Búsqueda -->
                        <div class="mb-3">
                            <label for="search" class="form-label">Buscar</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="search" name="search" value="{{ filters.search or '' }}" placeholder="Buscar productos...">
                                <button class="btn btn-primary" type="submit">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Tipo de productos -->
                        <div class="mb-3">
                            <label class="form-label">Tipo de productos</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show_official" name="official" value="1" {% if show_official %}checked{% endif %}>
                                <label class="form-check-label" for="show_official">
                                    Productos oficiales
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show_marketplace" name="marketplace" value="1" {% if show_marketplace %}checked{% endif %}>
                                <label class="form-check-label" for="show_marketplace">
                                    Marketplace
                                </label>
                            </div>
                        </div>

                        <!-- Categorías -->
                        <div class="mb-3">
                            <label for="categoria" class="form-label">Categoría</label>
                            <select class="form-select" id="categoria" name="categoria">
                                <option value="">Todas las categorías</option>
                                {% for cat in categories %}
                                <option value="{{ cat }}" {% if categoria == cat %}selected{% endif %}>{{ cat }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Subcategorías (se carga dinámicamente) -->
                        <div class="mb-3" id="subcategoria-container" {% if not categoria %}style="display: none;"{% endif %}>
                            <label for="subcategoria" class="form-label">Subcategoría</label>
                            <select class="form-select" id="subcategoria" name="subcategoria">
                                <option value="">Todas las subcategorías</option>
                                {% if categoria and categories_dict.get(categoria) %}
                                    {% for subcat in categories_dict.get(categoria) %}
                                    <option value="{{ subcat }}" {% if subcategoria == subcat %}selected{% endif %}>{{ subcat }}</option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                        </div>

                        <!-- Rango de precio -->
                        <div class="mb-3">
                            <label class="form-label">Rango de precio</label>
                            <div class="row g-2">
                                <div class="col">
                                    <input type="number" class="form-control" name="precio_min" placeholder="Min" value="{{ filters.precio_min or '' }}">
                                </div>
                                <div class="col">
                                    <input type="number" class="form-control" name="precio_max" placeholder="Max" value="{{ filters.precio_max or '' }}">
                                </div>
                            </div>
                        </div>

                        <!-- Condición (solo para marketplace) -->
                        <div class="mb-3" id="condicion-container" {% if not show_marketplace %}style="display: none;"{% endif %}>
                            <label for="condicion" class="form-label">Condición</label>
                            <select class="form-select" id="condicion" name="condicion">
                                <option value="">Todas</option>
                                <option value="new" {% if filters.condicion == 'new' %}selected{% endif %}>Nuevo</option>
                                <option value="used" {% if filters.condicion == 'used' %}selected{% endif %}>Usado</option>
                                <option value="refurbished" {% if filters.condicion == 'refurbished' %}selected{% endif %}>Reacondicionado</option>
                            </select>
                        </div>

                        <!-- Opciones adicionales -->
                        <div class="mb-3">
                            <label class="form-label">Opciones adicionales</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="stock" name="stock" value="1" {% if request.args.get('stock') %}checked{% endif %}>
                                <label class="form-check-label" for="stock">
                                    Solo productos en stock
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="free" name="free" value="1" {% if request.args.get('free') %}checked{% endif %}>
                                <label class="form-check-label" for="free">
                                    Solo productos gratuitos
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="envio_gratis" name="envio_gratis" value="1" {% if filters.envio_gratis %}checked{% endif %}>
                                <label class="form-check-label" for="envio_gratis">
                                    Envío gratis
                                </label>
                            </div>
                            <div class="form-check" id="vendedor-verificado-container" {% if not show_marketplace %}style="display: none;"{% endif %}>
                                <input class="form-check-input" type="checkbox" id="vendedor_verificado" name="vendedor_verificado" value="1" {% if filters.vendedor_verificado %}checked{% endif %}>
                                <label class="form-check-label" for="vendedor_verificado">
                                    Solo vendedores verificados
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Aplicar filtros</button>
                        <a href="{{ url_for('commerce.commerce_index') }}" class="btn btn-outline-secondary w-100 mt-2">Limpiar filtros</a>
                    </form>
                </div>
            </div>

            {% if current_user.is_authenticated and show_marketplace %}
            <div class="card shadow-sm mt-3">
                <div class="card-body text-center">
                    <h5 class="card-title">¿Quieres vender tus productos?</h5>
                    <p class="card-text">Conviértete en vendedor y comienza a publicar tus productos en el marketplace de Crunevo.</p>
                    <a href="{{ url_for('commerce.become_seller') }}" class="btn btn-primary">Convertirme en vendedor</a>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Contenido principal -->
        <div class="col-lg-9">
            <!-- Encabezado -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">Tienda Crunevo</h1>
                {% if current_user.is_authenticated and show_marketplace %}
                <a href="{{ url_for('marketplace.add_product') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i> Publicar producto
                </a>
                {% endif %}
            </div>

            <!-- Productos destacados (carousel) -->
            {% if featured_products %}
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title">Productos destacados</h5>
                    <div id="featuredCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            {% for product in featured_products %}
                            <div class="carousel-item {% if loop.first %}active{% endif %}">
                                <div class="row justify-content-center">
                                    <div class="col-md-6">
                                        <div class="card h-100 border-0">
                                            <div class="text-center p-3">
                                                {% if product.image_url %}
                                                <img src="{{ product.image_url }}" class="card-img-top featured-img" alt="{{ product.name }}">
                                                {% else %}
                                                <div class="placeholder-img featured-img d-flex align-items-center justify-content-center bg-light">
                                                    <i class="bi bi-image text-secondary" style="font-size: 3rem;"></i>
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="card-body text-center">
                                                <h5 class="card-title">{{ product.name }}</h5>
                                                <p class="card-text text-truncate">{{ product.description }}</p>
                                                <div class="d-flex justify-content-center align-items-center mb-3">
                                                    {% if product.price > 0 %}
                                                    <span class="fs-4 fw-bold text-primary me-2">S/ {{ "%.2f"|format(product.price) }}</span>
                                                    {% else %}
                                                    <span class="fs-4 fw-bold text-success me-2">Gratis</span>
                                                    {% endif %}
                                                    <span class="badge bg-warning">{{ render_price_credits(product) }}</span>
                                                </div>
                                                <a href="{{ url_for('commerce.view_product', product_id=product.id) }}" class="btn btn-primary">Ver detalles</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#featuredCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Anterior</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#featuredCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Siguiente</span>
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Lista de productos -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                        <div>
                            <h5 class="card-title mb-0">Productos</h5>
                            <span class="text-muted">{{ pagination.total }} productos encontrados</span>
                        </div>
                        <form method="get" class="d-flex align-items-center">
                            {% for key, values in request.args.lists() if key not in ['sort','page'] %}
                                {% for val in values %}
                                <input type="hidden" name="{{ key }}" value="{{ val }}">
                                {% endfor %}
                            {% endfor %}
                            <label for="sort" class="me-2 mb-0">Ordenar por:</label>
                            <select name="sort" id="sort" class="form-select" onchange="this.form.submit()">
                                <option value="date" {% if sort == 'date' %}selected{% endif %}>Fecha</option>
                                <option value="price" {% if sort == 'price' %}selected{% endif %}>Precio</option>
                                <option value="popular" {% if sort == 'popular' %}selected{% endif %}>Popularidad</option>
                            </select>
                        </form>
                    </div>

                    {% if pagination.items %}
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="products-container">
                        {% include "tienda/_product_cards.html" %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-search" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">No se encontraron productos</h5>
                        <p class="text-muted">Intenta con otros filtros o términos de búsqueda</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Offcanvas de filtros para móviles -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="filtersOffcanvas"
        aria-labelledby="filtersOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="filtersOffcanvasLabel">Filtros</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
        </div>
        <div class="offcanvas-body"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/tom-select.complete.min.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar Tom Select para categorías
        new TomSelect('#categoria', {
            create: false,
            sortField: {
                field: 'text',
                direction: 'asc'
            }
        });

        // Inicializar Tom Select para subcategorías
        new TomSelect('#subcategoria', {
            create: false,
            sortField: {
                field: 'text',
                direction: 'asc'
            }
        });

        // Actualizar subcategorías cuando cambia la categoría
        document.getElementById('categoria').addEventListener('change', function() {
            const categoria = this.value;
            const subcategoriaContainer = document.getElementById('subcategoria-container');
            const subcategoriaSelect = document.getElementById('subcategoria');
            
            // Mostrar/ocultar contenedor de subcategorías
            if (categoria) {
                subcategoriaContainer.style.display = 'block';
                
                // Obtener subcategorías para esta categoría
                fetch(`/tienda/api/subcategorias?categoria=${encodeURIComponent(categoria)}`)
                    .then(response => response.json())
                    .then(data => {
                        // Limpiar select actual
                        const tomSelect = subcategoriaSelect.tomselect;
                        tomSelect.clear();
                        tomSelect.clearOptions();
                        
                        // Añadir opción por defecto
                        tomSelect.addOption({value: '', text: 'Todas las subcategorías'});
                        
                        // Añadir nuevas opciones
                        data.subcategorias.forEach(subcat => {
                            tomSelect.addOption({value: subcat, text: subcat});
                        });
                        
                        tomSelect.refreshOptions(false);
                    });
            } else {
                subcategoriaContainer.style.display = 'none';
            }
        });

        // Mostrar/ocultar filtros específicos del marketplace
        document.getElementById('show_marketplace').addEventListener('change', function() {
            const showMarketplace = this.checked;
            document.getElementById('condicion-container').style.display = showMarketplace ? 'block' : 'none';
            document.getElementById('vendedor-verificado-container').style.display = showMarketplace ? 'block' : 'none';
        });
    });
</script>
{% endblock %}