{% set post = item.data %}
<article class="card mb-4 shadow-sm border-0 rounded-4 post-card" data-post-id="{{ post.id }}">
  <div class="card-body p-4">
    <!-- Post Header -->
    <div class="d-flex align-items-center gap-3 mb-3">
      <img src="{{ post.author.avatar_url or url_for('static', filename='img/default.png') }}" 
           alt="{{ post.author.username }}" 
           class="rounded-circle" 
           width="48" 
           height="48">
      <div class="flex-grow-1">
        <div class="d-flex align-items-center gap-2">
          <h6 class="mb-0 fw-semibold">
            <a href="{{ url_for('auth.profile_by_username', username=post.author.username) }}" 
               class="text-decoration-none text-dark">
              {{ post.author.username }}
            </a>
          </h6>
          {% if post.author.verified %}
          <span class="badge verified-badge">
            <i class="bi bi-check-circle-fill"></i> Verificado
          </span>
          {% endif %}
        </div>
        <small class="text-muted">
          <i class="bi bi-clock"></i>
          <span data-timestamp="{{ post.created_at.isoformat() }}">{{ post.created_at|timesince }}</span>
          {% if post.edited %}
          <span class="text-muted"> • editado</span>
          {% endif %}
        </small>
      </div>

      <!-- Post actions dropdown -->
      <div class="dropdown">
        <button class="btn btn-ghost btn-sm rounded-circle" data-bs-toggle="dropdown">
          <i class="bi bi-three-dots"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-3">
          {% if current_user.id == post.author_id %}
          <li><a class="dropdown-item" href="#" onclick="editPost({{ post.id }})">
            <i class="bi bi-pencil"></i> Editar
          </a></li>
          <li><a class="dropdown-item text-danger" href="#" onclick="deletePost({{ post.id }})">
            <i class="bi bi-trash"></i> Eliminar
          </a></li>
          {% else %}
          <li><a class="dropdown-item" href="#" onclick="reportPost({{ post.id }})">
            <i class="bi bi-flag"></i> Reportar
          </a></li>
          {% endif %}
          <li><a class="dropdown-item" href="#" onclick="copyPostLink({{ post.id }})">
            <i class="bi bi-link-45deg"></i> Copiar enlace
          </a></li>
        </ul>
      </div>
    </div>

    <!-- Post Content -->
    {% if post.content %}
    <div class="post-content mb-3">
      <p class="mb-0 lh-base">{{ post.content }}</p>
    </div>
    {% endif %}

    <!-- Post Media -->
    {% if post.file_url %}
    <div class="post-media mb-3">
      {% if post.file_url.endswith('.pdf') %}
      <div class="pdf-preview bg-light rounded-3 p-3 text-center">
        <i class="bi bi-file-pdf text-danger fs-1 mb-2"></i>
        <p class="mb-2 fw-semibold">Documento PDF</p>
        <a href="{{ post.file_url }}" target="_blank" class="btn btn-outline-primary btn-sm rounded-pill">
          <i class="bi bi-download"></i> Ver documento
        </a>
      </div>
      {% else %}
      <div class="image-container position-relative">
        <img src="{{ post.file_url }}" 
             alt="Imagen del post" 
             class="img-fluid rounded-3 w-100 post-image" 
             style="max-height: 400px; object-fit: cover;"
             onclick="openImageModal('{{ post.file_url }}')">
        <div class="image-overlay position-absolute bottom-0 start-0 w-100 p-2 bg-gradient rounded-bottom-3">
          <button class="btn btn-light btn-sm rounded-pill opacity-75" onclick="openImageModal('{{ post.file_url }}')">
            <i class="bi bi-arrows-fullscreen"></i> Ver completa
          </button>
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Post Stats -->
    <div class="post-stats d-flex align-items-center gap-4 mb-3 small text-muted">
      {% set counts = reaction_counts.get(post.id, {}) %}
      {% if counts %}
      <span class="d-flex align-items-center gap-1">
        {% for reaction, count in counts.items() %}
        <span>{{ reaction }}</span>
        {% endfor %}
        <span>{{ post.likes or 0 }}</span>
      </span>
      {% endif %}

      {% set comment_count = post.comments|length %}
      {% if comment_count > 0 %}
      <span>{{ comment_count }} comentario{{ 's' if comment_count > 1 else '' }}</span>
      {% endif %}
    </div>

    <!-- Post Actions -->
    <div class="post-actions d-flex align-items-center gap-1 border-top pt-3">
      <!-- Like Button -->
      {% set user_reaction = user_reactions.get(post.id) %}
      <button class="btn btn-ghost flex-fill d-flex align-items-center justify-content-center gap-2 like-btn {{ 'active' if user_reaction else '' }}"
              data-post-id="{{ post.id }}"
              data-reaction="👍">
        <i class="bi bi-fire{% if user_reaction %} text-danger{% endif %}"></i>
        <span class="d-none d-sm-inline">Me gusta</span>
        <span id="likeCount{{ post.id }}" class="badge bg-light text-dark rounded-pill">{{ post.likes or 0 }}</span>
      </button>

      <!-- Comment Button -->
      <button class="btn btn-ghost flex-fill d-flex align-items-center justify-content-center gap-2 comment-btn" 
              data-post-id="{{ post.id }}">
        <i class="bi bi-chat"></i>
        <span class="d-none d-sm-inline">Comentar</span>
      </button>

      <!-- Share Button -->
      <button class="btn btn-ghost flex-fill d-flex align-items-center justify-content-center gap-2 share-btn" 
              data-share-url="{{ url_for('feed.view_post', post_id=post.id, _external=True) }}">
        <i class="bi bi-share"></i>
        <span class="d-none d-sm-inline">Compartir</span>
      </button>

      <!-- Save Button -->
      <button class="btn btn-ghost d-flex align-items-center justify-content-center save-btn" 
              data-post-id="{{ post.id }}"
              style="width: 40px; height: 40px;">
        <i class="bi bi-bookmark"></i>
      </button>
    </div>

    <!-- Quick Comments Preview -->
    {% if post.comments %}
    <div class="quick-comments mt-3 pt-3 border-top">
      <h6 class="small text-muted mb-2">Comentarios recientes</h6>
      {% for comment in post.comments[:2] %}
      <div class="d-flex gap-2 mb-2">
        <img src="{{ comment.author.avatar_url or url_for('static', filename='img/default.png') }}" 
             class="rounded-circle" width="24" height="24">
        <div class="flex-grow-1">
          <div class="bg-light rounded-3 px-3 py-2">
            <div class="small fw-semibold mb-1">{{ comment.author.username }}</div>
            <div class="small">{{ comment.body }}</div>
          </div>
          <div class="small text-muted mt-1">{{ comment.timestamp|timesince }}</div>
        </div>
      </div>
      {% endfor %}

      {% if post.comments|length > 2 %}
      <button class="btn btn-link btn-sm p-0 text-decoration-none comment-btn" data-post-id="{{ post.id }}">
        Ver todos los comentarios ({{ post.comments|length }})
      </button>
      {% endif %}
    </div>
    {% endif %}
  </div>
</article>