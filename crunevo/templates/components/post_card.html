{% set post = item.data %}
{% set author = post.author %}
{% set reaction_counts = reaction_counts if reaction_counts is defined else {} %}
{% set user_reactions = user_reactions if user_reactions is defined else {} %}
{% import 'components/image_gallery.html' as gallery %}

<article class="facebook-post" data-post-id="{{ post.id }}" data-comment-permission="{{ post.comment_permission }}">
  <!-- Post Header -->
  <div class="post-header">
    <img src="{{ author.avatar_url if author else url_for('static', filename='img/default.png') }}"
         alt="{{ author.username if author else 'Usuario eliminado' }}"
         class="post-avatar">
    <div class="post-user-info">
      <div class="post-username">
        {% if author %}
        <a href="{{ url_for('auth.profile_by_username', username=author.username) }}">
          {{ author.username }}
        </a>
        {% else %}
        Usuario eliminado
        {% endif %}
        {% if author and author.verification_level >= 2 %}
        <span class="verified-badge">
          <i class="bi bi-check-circle-fill"></i>
        </span>
        {% endif %}
      </div>
      <div class="post-timestamp">
        <span data-timestamp="{{ post.created_at.isoformat() }}">{{ post.created_at|timesince }}</span>
        {% if post.edited %}
        Â· editado
        {% endif %}
      </div>
    </div>
    <button class="post-options" data-bs-toggle="dropdown" aria-label="Opciones">
      <i class="bi bi-three-dots"></i>
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
      {% if current_user.id == post.author_id %}
      <li><a class="dropdown-item" href="#" onclick="editPost({{ post.id }})">
        <i class="bi bi-pencil"></i> Editar
      </a></li>
      <li><a class="dropdown-item text-danger" href="#" onclick="deletePost({{ post.id }})">
        <i class="bi bi-trash"></i> Eliminar
      </a></li>
      {% else %}
      <li><a class="dropdown-item" href="#" onclick="reportPost({{ post.id }})">
        <i class="bi bi-flag"></i> Reportar
      </a></li>
      {% endif %}
      <li><a class="dropdown-item" href="#" onclick="copyPostLink({{ post.id }})">
        <i class="bi bi-link-45deg"></i> Copiar enlace
      </a></li>
    </ul>
  </div>

  <!-- Post Content -->
  {% if post.content %}
  <div class="post-text">
    {{ post.content }}
  </div>
  {% endif %}

  <!-- Post Images -->
  {% if post.images %}
  <div class="facebook-gallery-wrapper">
    {{ gallery.image_gallery(post.images, post.id) }}
  </div>
  {% elif post.file_url %}
  <div class="facebook-gallery-wrapper">
    {% if post.file_url.endswith('.pdf') %}
    <div class="pdf-attachment">
      <i class="bi bi-file-pdf"></i>
      <div>
        <div class="pdf-title">Documento PDF</div>
        <a href="{{ post.file_url }}" target="_blank">Ver documento</a>
      </div>
    </div>
    {% else %}
    {{ gallery.image_gallery([{'url': post.file_url}], post.id) }}
    {% endif %}
  </div>
  {% endif %}

  <!-- Post Actions -->
  <div class="facebook-actions">
    {% set user_reaction = user_reactions.get(post.id) %}
    <button class="fb-action-btn like-btn {{ 'active' if user_reaction else '' }}"
            data-post-id="{{ post.id }}"
            data-reaction="ðŸ”¥">
      <i class="bi bi-fire{% if user_reaction %}-fill{% endif %}"></i>
      <span>Me gusta</span>
    </button>

    <button class="fb-action-btn comment-btn" data-post-id="{{ post.id }}">
      <i class="bi bi-chat"></i>
      <span>Comentar</span>
    </button>

    <button class="fb-action-btn share-btn" data-post-id="{{ post.id }}">
      <i class="bi bi-share"></i>
      <span>Compartir</span>
    </button>
  </div>

  <!-- Quick Comments -->
  {% if post.comments %}
  <div class="quick-comments">
    {% for comment in post.comments[:2] %}
    <div class="comment-item">
      <img src="{{ comment.author.avatar_url or url_for('static', filename='img/default.png') }}"
           class="comment-avatar" alt="Avatar">
      <div class="comment-content">
        <div class="comment-box">
          <span class="comment-author">{{ comment.author.username }}</span>
          {{ comment.body }}
        </div>
        <div class="comment-meta">{{ comment.timestamp|timesince }}</div>
      </div>
    </div>
    {% endfor %}

    {% if post.comments|length > 2 %}
    <button class="view-more-comments comment-btn" data-post-id="{{ post.id }}">
      Ver todos los comentarios ({{ post.comments|length }})
    </button>
    {% endif %}
  </div>
  {% endif %}
</article>