
<div class="feed-card-clean" data-post-id="{{ post.id }}">
  <!-- Header -->
  <div class="feed-header-clean">
    <a href="{{ url_for('main.perfil_publico', username=post.user.username) }}" class="text-decoration-none">
      <img src="{{ post.user.avatar_url or url_for('static', filename='img/default.png') }}" 
           alt="{{ post.user.username }}" class="feed-avatar">
    </a>
    <div class="feed-user-info flex-grow-1">
      <h6 class="mb-0">
        <a href="{{ url_for('main.perfil_publico', username=post.user.username) }}" 
           class="text-decoration-none">{{ post.user.username }}</a>
        {% if post.user.is_verified %}
          <i class="bi bi-patch-check-fill text-primary ms-1" 
             data-bs-toggle="tooltip" title="Usuario verificado"></i>
        {% endif %}
      </h6>
      <p class="feed-timestamp">
        {{ post.created_at.strftime('%d/%m/%Y a las %H:%M') }}
        {% if post.edited %}
          <span class="text-muted">(editado)</span>
        {% endif %}
      </p>
    </div>
    {% if current_user.is_authenticated and (current_user.id == post.user_id or current_user.is_moderator or current_user.is_admin) %}
    <div class="dropdown">
      <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
              data-bs-toggle="dropdown">
        <i class="bi bi-three-dots"></i>
      </button>
      <ul class="dropdown-menu">
        {% if current_user.id == post.user_id %}
        <li><a class="dropdown-item" href="{{ url_for('feed.edit_post', id=post.id) }}">
          <i class="bi bi-pencil"></i> Editar
        </a></li>
        {% endif %}
        {% if current_user.id == post.user_id or current_user.is_moderator or current_user.is_admin %}
        <li><button class="dropdown-item text-danger" onclick="deletePost({{ post.id }})">
          <i class="bi bi-trash"></i> Eliminar
        </button></li>
        {% endif %}
        {% if current_user.id != post.user_id %}
        <li><a class="dropdown-item" href="{{ url_for('main.report_post', post_id=post.id) }}">
          <i class="bi bi-flag"></i> Reportar
        </a></li>
        {% endif %}
      </ul>
    </div>
    {% endif %}
  </div>

  <!-- Content -->
  <div class="feed-content-clean">
    <div class="feed-text">{{ post.content|safe }}</div>
    {% if post.image_urls %}
      {% for image_url in post.image_urls %}
        <img src="{{ image_url }}" alt="Imagen del post" class="feed-image" loading="lazy">
      {% endfor %}
    {% endif %}
  </div>

  <!-- Actions -->
  <div class="feed-actions-clean">
    <!-- Reactions -->
    <div class="position-relative">
      <button class="feed-action-btn btn-reaction {{ 'active' if current_user.is_authenticated and current_user.has_reacted_to_post(post.id) }}" 
              data-post-id="{{ post.id }}" 
              data-bs-toggle="tooltip" title="Reaccionar">
        <i class="bi bi-heart{% if current_user.is_authenticated and current_user.has_reacted_to_post(post.id) %}-fill{% endif %}"></i>
        <span class="reaction-count">{{ post.reaction_count or 0 }}</span>
      </button>
      
      <!-- Reaction options (hidden by default) -->
      <div class="reaction-options position-absolute d-none">
        <button class="reaction-btn" data-reaction="👍" title="Me gusta">👍</button>
        <button class="reaction-btn" data-reaction="❤️" title="Me encanta">❤️</button>
        <button class="reaction-btn" data-reaction="😂" title="Me divierte">😂</button>
        <button class="reaction-btn" data-reaction="😮" title="Me sorprende">😮</button>
      </div>
    </div>

    <!-- Comments -->
    <button class="feed-action-btn" onclick="toggleComments({{ post.id }})" 
            data-bs-toggle="tooltip" title="Comentarios">
      <i class="bi bi-chat"></i>
      <span>{{ post.comments|length if post.comments else 0 }}</span>
    </button>

    <!-- Share -->
    <button class="feed-action-btn" onclick="sharePost({{ post.id }})" 
            data-bs-toggle="tooltip" title="Compartir">
      <i class="bi bi-share"></i>
    </button>

    <!-- Save -->
    {% if current_user.is_authenticated %}
    <button class="feed-action-btn {{ 'active' if post.is_saved_by_user(current_user.id) }}" 
            onclick="toggleSavePost({{ post.id }})"
            data-bs-toggle="tooltip" title="Guardar">
      <i class="bi bi-bookmark{% if post.is_saved_by_user(current_user.id) %}-fill{% endif %}"></i>
    </button>
    {% endif %}
  </div>

  <!-- Comments Section -->
  <div class="comments-section d-none" id="comments-{{ post.id }}">
    {% if post.comments %}
      {% for comment in post.comments[:3] %}
        <div class="comment-item">
          <div class="d-flex gap-2">
            <img src="{{ comment.user.avatar_url or url_for('static', filename='img/default.png') }}" 
                 alt="{{ comment.user.username }}" 
                 class="rounded-circle" style="width: 32px; height: 32px;">
            <div class="flex-grow-1">
              <div class="comment-author">{{ comment.user.username }}</div>
              <div class="comment-text">{{ comment.content }}</div>
              <div class="comment-time text-muted" style="font-size: 0.75rem;">
                {{ comment.created_at.strftime('%d/%m/%Y %H:%M') }}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
      
      {% if post.comments|length > 3 %}
        <div class="text-center mt-2">
          <a href="{{ url_for('feed.post_detail', id=post.id) }}" class="text-primary">
            Ver todos los {{ post.comments|length }} comentarios
          </a>
        </div>
      {% endif %}
    {% endif %}

    <!-- Add comment form -->
    {% if current_user.is_authenticated %}
    <form class="add-comment-form mt-3" data-post-id="{{ post.id }}">
      {{ csrf_token() }}
      <div class="d-flex gap-2">
        <img src="{{ current_user.avatar_url or url_for('static', filename='img/default.png') }}" 
             alt="Tu avatar" 
             class="rounded-circle" style="width: 32px; height: 32px;">
        <div class="flex-grow-1">
          <input type="text" name="content" class="form-control form-control-sm" 
                 placeholder="Escribe un comentario..." required>
        </div>
        <button type="submit" class="btn btn-primary btn-sm">
          <i class="bi bi-send"></i>
        </button>
      </div>
    </form>
    {% endif %}
  </div>
</div>

<script>
// Toggle comments visibility
function toggleComments(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (commentsSection) {
        commentsSection.classList.toggle('d-none');
    }
}

// Share post functionality
function sharePost(postId) {
    if (navigator.share) {
        navigator.share({
            title: 'Publicación en Crunevo',
            url: `${window.location.origin}/feed/post/${postId}`
        });
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(`${window.location.origin}/feed/post/${postId}`).then(() => {
            // Show toast notification
            showToast('Enlace copiado al portapapeles', 'success');
        });
    }
}

// Delete post functionality
function deletePost(postId) {
    if (confirm('¿Estás seguro de que quieres eliminar esta publicación?')) {
        fetch(`/feed/delete/${postId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrf_token]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector(`[data-post-id="${postId}"]`).remove();
                showToast('Publicación eliminada', 'success');
            } else {
                showToast('Error al eliminar la publicación', 'error');
            }
        });
    }
}

// Save/unsave post functionality
function toggleSavePost(postId) {
    fetch(`/feed/save/${postId}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const saveBtn = document.querySelector(`[onclick="toggleSavePost(${postId})"]`);
            const icon = saveBtn.querySelector('i');
            if (data.saved) {
                saveBtn.classList.add('active');
                icon.classList.remove('bi-bookmark');
                icon.classList.add('bi-bookmark-fill');
                showToast('Publicación guardada', 'success');
            } else {
                saveBtn.classList.remove('active');
                icon.classList.remove('bi-bookmark-fill');
                icon.classList.add('bi-bookmark');
                showToast('Publicación removida de guardados', 'info');
            }
        }
    });
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
