{% import 'components/image_gallery.html' as gallery %}
{% import 'components/csrf.html' as csrf %}
{% set saved_posts = saved_posts if saved_posts is defined else {} %}

<!-- Modal de Comentarios -->
<div class="modal fade comment-modal" id="commentsModal-{{ post.id }}" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="commentsModalLabel-{{ post.id }}" aria-hidden="true" style="display: none;" data-post-id="{{ post.id }}">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-fullscreen-sm-down tw-mx-auto tw-w-full">
    <div class="modal-content facebook-modal-info-panel">
      <h5 id="commentsModalLabel-{{ post.id }}" class="visually-hidden">Comentarios</h5>

      <!-- Header (non-scrollable) -->
      <div class="modal-post-header">
        <img src="{{ post.author.avatar_url if post.author else url_for('static', filename='img/default.png') }}"
             alt="{{ post.author.username if post.author else 'Usuario eliminado' }}"
             class="modal-post-avatar">
        <div class="modal-user-info">
          <h6 class="modal-username">{{ post.author.username if post.author else 'Usuario eliminado' }}</h6>
          <small class="modal-timestamp">{{ post.created_at|timesince }}</small>
        </div>
        <button type="button" class="modal-close-btn" data-bs-dismiss="modal" aria-label="Cerrar">
          <i class="bi bi-x"></i>
        </button>
      </div>

      <!-- Scrollable Content -->
      <div class="modal-body modal-scrollable-content">
        {% if post.content %}
        <div class="modal-post-content">
          <p class="modal-post-text">{{ post.content }}</p>
        </div>
        {% endif %}

        {% if post.images %}
        {{ gallery.image_gallery(post.images, post.id) }}
        {% elif post.file_url and not post.file_url.endswith('.pdf') %}
        {{ gallery.image_gallery([post.file_url], post.id) }}
        {% endif %}

        <div class="modal-post-actions">
          <div class="relative reaction-container" data-post-id="{{ post.id }}" data-my-reaction="{{ user_reactions.get(post.id, '') }}">
            <button class="modal-action-btn like-btn {{ 'active' if user_reactions.get(post.id) }}" data-post-id="{{ post.id }}">
              <i class="bi bi-fire{{ '-fill' if user_reactions.get(post.id) else '' }}"></i>
              <span class="action-text">Me gusta</span>
              <span class="action-count">{{ reaction_counts.get(post.id, {}).get('🔥', '') }}</span>
            </button>
            <div class="reaction-panel d-none">
              <button class="reaction-btn" data-reaction="🔥" title="Crunazo">🔥</button>
              <button class="reaction-btn" data-reaction="🧠" title="Neuro">🧠</button>
              <button class="reaction-btn" data-reaction="💔" title="Roto">💔</button>
              <button class="reaction-btn" data-reaction="😠" title="Molesto">😠</button>
              <button class="reaction-btn" data-reaction="🥶" title="Congelao">🥶</button>
              <button class="reaction-btn" data-reaction="😂" title="Vacilón">😂</button>
              <button class="reaction-btn" data-reaction="🤡" title="Cringe">🤡</button>
              <button class="reaction-btn" data-reaction="😲" title="Asu">😲</button>
              <button class="reaction-btn" data-reaction="👍" title="Me gusta">👍</button>
              <button class="reaction-btn" data-reaction="💡" title="Interesante">💡</button>
              <button class="reaction-btn" data-reaction="🙌" title="Gracias">🙌</button>
              <button class="reaction-btn" data-reaction="📌" title="Lo guardé">📌</button>
            </div>
          </div>
          <button class="modal-action-btn share-btn" data-post-id="{{ post.id }}">
            <i class="bi bi-share"></i>
            <span>Compartir</span>
          </button>
          <button class="modal-action-btn save-btn {{ 'active' if saved_posts.get(post.id) }}" data-post-id="{{ post.id }}">
            <i class="bi bi-bookmark{{ '-fill' if saved_posts.get(post.id) else '' }}"></i>
            <span>Guardar</span>
          </button>
        </div>

        <div class="modal-comments-section">
          {% set more_comments = post.comments|length > 10 %}
          <div class="comments-list" id="commentsList-{{ post.id }}">
            {% for comment in post.comments[:10] %}
            <div class="comment-item">
              <img src="{{ comment.author.avatar_url if comment.author else url_for('static', filename='img/default.png') }}" alt="{{ comment.author.username if comment.author else 'Usuario' }}" class="comment-avatar">
              <div class="comment-content">
                <div class="comment-box">
                  <div class="comment-author">{{ comment.author.username if comment.author else 'Usuario eliminado' }}</div>
                  <div class="comment-text">{{ comment.body }}</div>
                </div>
                <div class="comment-meta">
                  <small class="text-muted">{{ comment.timestamp|timesince }}</small>
                  <button class="btn btn-link btn-sm p-0 ms-2 text-muted">Responder</button>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% if more_comments %}
          <div class="text-center my-2">
            <button class="btn btn-link load-more-comments" data-post-id="{{ post.id }}" data-page="2">Cargar más comentarios</button>
          </div>
          {% endif %}
        </div>
      </div>
      <div class="unified-comment-form-container compact-comment-form-container comment-input-container">
          {% if current_user.is_authenticated %}
          <form class="comment-form" data-post-id="{{ post.id }}" onsubmit="submitModalComment(event, '{{ post.id }}')">
            {{ csrf.csrf_field() }}
            <div class="compact-comment-form-group tw-w-full">
              <img src="{{ current_user.avatar_url or url_for('static', filename='img/default.png') }}" alt="{{ current_user.username }}" class="compact-comment-form-avatar">
              <div class="compact-comment-input-wrapper tw-w-full">
                <textarea class="compact-comment-input comment-input tw-w-full" name="body" rows="1" placeholder="Escribe un comentario..."></textarea>
                <button type="submit" class="compact-comment-submit-btn comment-submit-btn" disabled><i class="bi bi-send-fill"></i></button>
              </div>
            </div>
          </form>
          {% else %}
            <!-- Mensaje de inicio de sesión -->
          {% endif %}
      </div>
    </div>
  </div>
</div>
