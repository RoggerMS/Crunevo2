<nav class="facebook-mobile-navbar d-lg-none" id="mobileNavbar">
  <a href="{{ url_for('feed.feed_home') if 'feed.feed_home' in url_for.__globals__.get('current_app', {}).view_functions else '/' }}" class="nav-icon-btn {{ 'active' if request.endpoint == 'feed.feed_home' else '' }}" aria-label="Inicio">
    <i class="bi bi-house{{ '-fill' if request.endpoint == 'feed.feed_home' else '' }}"></i>
  </a>
  <a href="{{ url_for('forum.list_questions') if 'forum.list_questions' in url_for.__globals__.get('current_app', {}).view_functions else '/foro' }}" class="nav-icon-btn {{ 'active' if 'forum' in request.endpoint else '' }}" aria-label="Explorar">
    <i class="bi bi-compass{{ '-fill' if 'forum' in request.endpoint else '' }}"></i>
  </a>
  {# Botón TIENDA en lugar de notificaciones #}
  <a href="{{ url_for('commerce.commerce_index') if 'commerce.commerce_index' in url_for.__globals__.get('current_app', {}).view_functions else '/tienda' }}"
     class="nav-icon-btn" aria-label="Tienda">
    <i class="bi bi-shop"></i>
  </a>
  {# Botón APUNTES en lugar de chat #}
  <a href="{{ url_for('notes.my_notes') if 'notes.my_notes' in url_for.__globals__.get('current_app', {}).view_functions else '/apuntes' }}"
     class="nav-icon-btn" aria-label="Apuntes">
    <i class="bi bi-journal-text"></i>
  </a>
  <div class="dropdown">
    <a href="#" class="nav-icon-btn dropdown-toggle" data-bs-toggle="dropdown" aria-label="Menú">
      {% if current_user.is_authenticated and current_user.avatar %}
        <img src="{{ current_user.avatar }}" alt="Avatar" class="profile-avatar rounded-circle">
      {% else %}
        <i class="bi bi-person-circle"></i>
      {% endif %}
    </a>
    <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 rounded-3 mt-2">
      {% if current_user.is_authenticated %}
        <li><a class="dropdown-item" href="{{ url_for('auth.perfil') }}"><i class="bi bi-person me-2"></i>Mi Perfil</a></li>
        {# En el dropdown ahora va CHAT en lugar de notas #}
        <li><a class="dropdown-item" href="{{ url_for('chat.chat_index') }}"><i class="bi bi-chat-dots me-2"></i>Chat</a></li>
        {# En el dropdown ahora van NOTIFICACIONES en lugar de tienda #}
        <li><a class="dropdown-item" href="{{ url_for('noti.ver_notificaciones') }}"><i class="bi bi-bell me-2"></i>Notificaciones</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}"><i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión</a></li>
      {% else %}
        <li><a class="dropdown-item" href="{{ url_for('auth.login') }}"><i class="bi bi-box-arrow-in-right me-2"></i>Iniciar Sesión</a></li>
        <li><a class="dropdown-item" href="{{ url_for('onboarding.register') }}"><i class="bi bi-person-plus me-2"></i>Registrarse</a></li>
      {% endif %}
    </ul>
  </div>
</nav>

<style>
#mobileNavbar {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  align-items: center;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 56px;
  background: rgba(255, 255, 255, 0.95);
  z-index: 1030;
  transition: transform 0.3s ease;
}
[data-bs-theme="dark"] #mobileNavbar {
  background: rgba(36, 37, 38, 0.95);
}
/* Dejar SIEMPRE espacio para que no tape el contenido */
body.with-mobile-navbar { padding-top: var(--mobile-navbar-height, 56px); }
[id] { scroll-margin-top: calc(var(--mobile-navbar-height, 56px) + 8px); }

/* Safe area para iPhone con notch */
#mobileNavbar { padding-top: env(safe-area-inset-top); height: calc(56px + env(safe-area-inset-top)); }
body.with-mobile-navbar { padding-top: calc(var(--mobile-navbar-height, 56px) + env(safe-area-inset-top)); }
#mobileNavbar a.nav-icon-btn,
#mobileNavbar .dropdown > a {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
}
.profile-avatar {
  width: 24px;
  height: 24px;
  object-fit: cover;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const navbar = document.getElementById("mobileNavbar");
  if (!navbar) return;
  // Medir altura real (incluye safe-area gracias al padding-top)
  requestAnimationFrame(() => {
    const h = navbar.getBoundingClientRect().height || 56;
    document.body.classList.add("with-mobile-navbar");
    document.body.style.setProperty("--mobile-navbar-height", h + "px");
    // fallback directo por si alguna hoja CSS ignora la var
    document.body.style.paddingTop = `calc(${h}px + env(safe-area-inset-top))`;
  });
});

let lastScroll = 0;
window.addEventListener("scroll", () => {
  const navbar = document.getElementById("mobileNavbar");
  if (!navbar) return;
  const currentScroll = window.pageYOffset;
  if (currentScroll > lastScroll && currentScroll > 50) {
    navbar.style.transform = "translateY(-100%)";
  } else {
    navbar.style.transform = "translateY(0)";
  }
  lastScroll = currentScroll;
});
</script>
