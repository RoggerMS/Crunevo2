
<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{{ url_for('main.index') }}">
      <i class="bi bi-mortarboard-fill me-2"></i>CRUNEVO
    </a>

    <!-- Global Search Bar -->
    <div class="navbar-search d-none d-lg-block mx-auto" style="max-width: 400px; width: 100%;">
      <div class="position-relative">
        <input type="text" id="globalSearch" class="form-control bg-light border-0 rounded-pill ps-4" 
               placeholder="Buscar en CRUNEVO..." autocomplete="off">
        <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
        <div id="searchDropdown" class="dropdown-menu w-100 shadow-lg border-0 rounded-3" style="display: none; top: 100%; z-index: 1050;">
          <div id="searchResults"></div>
        </div>
      </div>
    </div>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto align-items-center">
        {% if current_user.is_authenticated %}
          <li class="nav-item d-lg-none">
            <form class="d-flex my-2">
              <input class="form-control me-2" type="search" placeholder="Buscar..." id="mobileSearch">
              <button class="btn btn-outline-light" type="button" onclick="performMobileSearch()">
                <i class="bi bi-search"></i>
              </button>
            </form>
          </li>
          
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('feed.index') }}">
              <i class="bi bi-house-fill me-1"></i>Feed
            </a>
          </li>
          
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('club.list_clubs') }}">
              <i class="bi bi-people-fill me-1"></i>Clubes
            </a>
          </li>
          
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('store.index') }}">
              <i class="bi bi-shop me-1"></i>Tienda
            </a>
          </li>
          
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('ranking.index') }}">
              <i class="bi bi-trophy-fill me-1"></i>Ranking
            </a>
          </li>
          
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('course.list_courses') }}">
              <i class="bi bi-play-circle-fill me-1"></i>Cursos
            </a>
          </li>
          
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('chat.chat_index') }}">
              <i class="bi bi-chat-dots-fill me-1"></i>Chat
            </a>
          </li>
          
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('crunebot.crunebot_chat') }}">
              <i class="bi bi-robot me-1"></i>Crunebot
            </a>
          </li>

          <!-- Notifications -->
          <li class="nav-item dropdown">
            <a class="nav-link position-relative" href="#" id="notificationsDropdown" role="button" data-bs-toggle="dropdown">
              <i class="bi bi-bell-fill"></i>
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notif-count" style="display: none;">
                0
              </span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" style="width: 300px;">
              <li><h6 class="dropdown-header">Notificaciones</h6></li>
              <div id="notifications-list">
                <li><span class="dropdown-item-text text-muted">No hay notificaciones</span></li>
              </div>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-center" href="{{ url_for('notifications.lista') }}">Ver todas</a></li>
            </ul>
          </li>

          <!-- User Menu -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
              <img src="{{ current_user.avatar_url or url_for('static', filename='img/default.png') }}" 
                   class="rounded-circle me-2" width="30" height="30" alt="Avatar">
              <span class="d-none d-lg-inline">{{ current_user.username }}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="{{ url_for('auth.perfil') }}">
                <i class="bi bi-person me-2"></i>Mi Perfil
              </a></li>
              <li><a class="dropdown-item" href="{{ url_for('missions.index') }}">
                <i class="bi bi-trophy me-2"></i>Misiones
              </a></li>
              <li><a class="dropdown-item" href="{{ url_for('saved.list') }}">
                <i class="bi bi-bookmark me-2"></i>Guardados
              </a></li>
              <li><hr class="dropdown-divider"></li>
              <li><span class="dropdown-item-text">
                <i class="bi bi-coin me-2"></i>{{ current_user.credits }} Crolars
              </span></li>
              <li><hr class="dropdown-divider"></li>
              {% if current_user.role == 'admin' %}
              <li><a class="dropdown-item" href="{{ url_for('admin.dashboard') }}">
                <i class="bi bi-gear me-2"></i>Panel Admin
              </a></li>
              <li><hr class="dropdown-divider"></li>
              {% endif %}
              <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">
                <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
              </a></li>
            </ul>
          </li>
        {% else %}
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('auth.login') }}">Iniciar Sesión</a>
          </li>
          <li class="nav-item">
            <a class="btn btn-light text-primary fw-bold ms-2" href="{{ url_for('onboarding.register') }}">Registrarse</a>
          </li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const globalSearch = document.getElementById('globalSearch');
  const searchDropdown = document.getElementById('searchDropdown');
  const searchResults = document.getElementById('searchResults');
  let searchTimeout;

  if (globalSearch) {
    globalSearch.addEventListener('input', function() {
      const query = this.value.trim();
      clearTimeout(searchTimeout);
      
      if (query.length >= 2) {
        searchTimeout = setTimeout(() => {
          performGlobalSearch(query);
        }, 300);
      } else {
        hideSearchResults();
      }
    });

    globalSearch.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const query = this.value.trim();
        if (query) {
          window.location.href = `/search?q=${encodeURIComponent(query)}`;
        }
      }
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!globalSearch.contains(e.target) && !searchDropdown.contains(e.target)) {
        hideSearchResults();
      }
    });
  }

  function performGlobalSearch(query) {
    fetch(`/search/suggestions?q=${encodeURIComponent(query)}`)
      .then(response => response.json())
      .then(suggestions => {
        displaySearchResults(suggestions, query);
      })
      .catch(error => {
        console.error('Error:', error);
      });
  }

  function displaySearchResults(suggestions, query) {
    if (suggestions.length === 0) {
      searchResults.innerHTML = `
        <div class="dropdown-item-text text-muted">
          <i class="bi bi-search me-2"></i>No se encontraron resultados
        </div>
        <div class="dropdown-divider"></div>
        <a href="/search?q=${encodeURIComponent(query)}" class="dropdown-item">
          <i class="bi bi-arrow-right me-2"></i>Buscar "${query}" en toda la plataforma
        </a>
      `;
    } else {
      searchResults.innerHTML = suggestions.map(item => `
        <a href="${item.url}" class="dropdown-item d-flex align-items-center py-2">
          <i class="${item.icon} me-3 text-muted"></i>
          <div>
            <div>${item.text}</div>
            <small class="text-muted">${item.type}</small>
          </div>
        </a>
      `).join('') + `
        <div class="dropdown-divider"></div>
        <a href="/search?q=${encodeURIComponent(query)}" class="dropdown-item text-center">
          <i class="bi bi-search me-2"></i>Ver todos los resultados
        </a>
      `;
    }
    
    searchDropdown.style.display = 'block';
  }

  function hideSearchResults() {
    searchDropdown.style.display = 'none';
  }
});

function performMobileSearch() {
  const mobileSearch = document.getElementById('mobileSearch');
  const query = mobileSearch.value.trim();
  if (query) {
    window.location.href = `/search?q=${encodeURIComponent(query)}`;
  }
}
</script>
</nav>
