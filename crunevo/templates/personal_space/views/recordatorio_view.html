{% extends 'base.html' %}
{% block title %}Recordatorio - {{ block.title }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personal-space.css') }}">
<style>
.recordatorio-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.recordatorio-header {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
}

.recordatorio-header.urgente {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    animation: pulse-urgent 2s infinite;
}

.recordatorio-header.vencido {
    background: linear-gradient(135deg, #c44569 0%, #f8b500 100%);
}

.recordatorio-header.completado {
    background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
}

@keyframes pulse-urgent {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

.recordatorio-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 150px;
    height: 150px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    animation: float 8s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    33% { transform: translateY(-15px) rotate(120deg); }
    66% { transform: translateY(15px) rotate(240deg); }
}

.recordatorio-info {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
}

.recordatorio-icon {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    cursor: pointer;
    transition: all 0.3s;
}

.recordatorio-icon:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.recordatorio-details h2 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 600;
}

.recordatorio-meta {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.meta-item {
    background: rgba(255, 255, 255, 0.2);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

.countdown-display {
    position: absolute;
    top: 20px;
    right: 20px;
    text-align: center;
    background: rgba(255, 255, 255, 0.2);
    padding: 15px;
    border-radius: 12px;
    min-width: 120px;
}

.countdown-number {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.countdown-label {
    font-size: 0.8rem;
    opacity: 0.9;
}

.content-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.section-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 15px;
    color: var(--bs-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.descripcion-editor {
    min-height: 120px;
    border: 1px solid var(--bs-border-color);
    border-radius: 8px;
    padding: 15px;
    font-family: inherit;
    line-height: 1.6;
    resize: vertical;
    width: 100%;
}

.descripcion-editor:focus {
    outline: none;
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.fecha-config {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.fecha-item {
    background: var(--bs-gray-50);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid var(--bs-border-color);
}

.fecha-label {
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--bs-dark);
    display: flex;
    align-items: center;
    gap: 8px;
}

.fecha-input {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--bs-border-color);
    border-radius: 6px;
    font-size: 0.95rem;
}

.fecha-input:focus {
    outline: none;
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.notificaciones-config {
    background: var(--bs-info-bg);
    border: 1px solid var(--bs-info);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.notificacion-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    background: white;
    border-radius: 6px;
    margin-bottom: 10px;
    border: 1px solid var(--bs-border-color);
}

.notificacion-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.notificacion-toggle {
    position: relative;
    width: 50px;
    height: 25px;
    background: var(--bs-gray-300);
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s;
}

.notificacion-toggle.active {
    background: var(--bs-success);
}

.notificacion-toggle::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 21px;
    height: 21px;
    background: white;
    border-radius: 50%;
    transition: all 0.3s;
}

.notificacion-toggle.active::after {
    transform: translateX(25px);
}

.prioridad-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.prioridad-option {
    flex: 1;
    padding: 15px;
    border: 2px solid var(--bs-border-color);
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: white;
}

.prioridad-option:hover {
    border-color: var(--bs-primary);
    background: var(--bs-primary-bg);
}

.prioridad-option.selected {
    border-color: var(--bs-primary);
    background: var(--bs-primary);
    color: white;
}

.prioridad-baja {
    border-color: var(--bs-success) !important;
}

.prioridad-baja.selected {
    background: var(--bs-success) !important;
}

.prioridad-media {
    border-color: var(--bs-warning) !important;
}

.prioridad-media.selected {
    background: var(--bs-warning) !important;
}

.prioridad-alta {
    border-color: var(--bs-danger) !important;
}

.prioridad-alta.selected {
    background: var(--bs-danger) !important;
}

.acciones-rapidas {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 20px;
}

.accion-btn {
    padding: 10px 20px;
    border: 1px solid var(--bs-border-color);
    border-radius: 20px;
    background: white;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.accion-btn:hover {
    background: var(--bs-primary);
    color: white;
    border-color: var(--bs-primary);
}

.historial-notificaciones {
    max-height: 300px;
    overflow-y: auto;
}

.notificacion-historial {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--bs-gray-50);
    border-radius: 8px;
    margin-bottom: 10px;
}

.notificacion-icon {
    width: 35px;
    height: 35px;
    background: var(--bs-primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.notificacion-content {
    flex-grow: 1;
}

.notificacion-texto {
    font-weight: 500;
    margin-bottom: 3px;
}

.notificacion-fecha {
    font-size: 0.8rem;
    color: var(--bs-secondary);
}

.estado-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.estado-pendiente {
    background: var(--bs-warning-bg);
    color: var(--bs-warning);
}

.estado-completado {
    background: var(--bs-success-bg);
    color: var(--bs-success);
}

.estado-vencido {
    background: var(--bs-danger-bg);
    color: var(--bs-danger);
}

.btn-floating {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--bs-primary);
    color: white;
    border: none;
    font-size: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    cursor: pointer;
    transition: all 0.3s;
    z-index: 1000;
}

.btn-floating:hover {
    transform: scale(1.1);
    background: var(--bs-primary-dark, #0056b3);
}

.modal-content {
    border-radius: 12px;
}

.form-floating {
    margin-bottom: 15px;
}

@media (max-width: 768px) {
    .recordatorio-container {
        padding: 15px;
    }
    
    .recordatorio-header {
        padding: 20px;
    }
    
    .recordatorio-info {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .countdown-display {
        position: static;
        margin: 0 auto;
        margin-top: 15px;
    }
    
    .fecha-config {
        grid-template-columns: 1fr;
    }
    
    .prioridad-selector {
        flex-direction: column;
    }
    
    .acciones-rapidas {
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="recordatorio-container">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-alarm me-2"></i>Recordatorio</h2>
            <p class="text-muted">Gestiona avisos importantes con fechas límite</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="exportRecordatorio()">
                <i class="bi bi-download"></i> Exportar
            </button>
            <button class="btn btn-primary" onclick="editRecordatorio()">
                <i class="bi bi-gear"></i> Configurar
            </button>
            <a href="{{ url_for('personal_space.index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>
    
    <!-- Recordatorio Header -->
    <div class="recordatorio-header" id="recordatorioHeader">
        <div class="recordatorio-info">
            <div class="recordatorio-icon" onclick="toggleCompletado()">
                <i class="bi bi-alarm" id="recordatorioIcon"></i>
            </div>
            <div class="recordatorio-details">
                <h2 id="recordatorioTitulo">{{ block.title }}</h2>
                <div class="recordatorio-meta">
                    <div class="meta-item" id="prioridadBadge">
                        <i class="bi bi-flag"></i>
                        <span id="prioridadText">{{ block.get_metadata().get('priority', 'media').title() }}</span>
                    </div>
                    <div class="meta-item" id="estadoBadge">
                        <i class="bi bi-circle"></i>
                        <span id="estadoText">Pendiente</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Countdown Display -->
        <div class="countdown-display" id="countdownDisplay">
            <div class="countdown-number" id="countdownNumber">--</div>
            <div class="countdown-label" id="countdownLabel">días restantes</div>
        </div>
    </div>
    
    <!-- Descripción -->
    <div class="content-section">
        <div class="section-title">
            <i class="bi bi-file-text"></i>
            Descripción del Recordatorio
        </div>
        <textarea class="descripcion-editor" id="descripcionEditor" 
                  placeholder="Describe los detalles de tu recordatorio...">{{ block.content }}</textarea>
    </div>
    
    <!-- Configuración de Fechas -->
    <div class="content-section">
        <div class="section-title">
            <i class="bi bi-calendar-event"></i>
            Configuración de Fechas
        </div>
        
        <div class="fecha-config">
            <div class="fecha-item">
                <div class="fecha-label">
                    <i class="bi bi-calendar-plus"></i>
                    Fecha de Inicio
                </div>
                <input type="datetime-local" class="fecha-input" id="fechaInicio">
            </div>
            <div class="fecha-item">
                <div class="fecha-label">
                    <i class="bi bi-calendar-x"></i>
                    Fecha Límite
                </div>
                <input type="datetime-local" class="fecha-input" id="fechaLimite">
            </div>
        </div>
    </div>
    
    <!-- Prioridad -->
    <div class="content-section">
        <div class="section-title">
            <i class="bi bi-flag"></i>
            Nivel de Prioridad
        </div>
        
        <div class="prioridad-selector">
            <div class="prioridad-option prioridad-baja" onclick="setPrioridad('baja')">
                <i class="bi bi-flag" style="font-size: 1.2rem; margin-bottom: 8px;"></i>
                <div><strong>Baja</strong></div>
                <div style="font-size: 0.8rem; opacity: 0.8;">Sin urgencia</div>
            </div>
            <div class="prioridad-option prioridad-media selected" onclick="setPrioridad('media')">
                <i class="bi bi-flag-fill" style="font-size: 1.2rem; margin-bottom: 8px;"></i>
                <div><strong>Media</strong></div>
                <div style="font-size: 0.8rem; opacity: 0.8;">Importante</div>
            </div>
            <div class="prioridad-option prioridad-alta" onclick="setPrioridad('alta')">
                <i class="bi bi-exclamation-triangle-fill" style="font-size: 1.2rem; margin-bottom: 8px;"></i>
                <div><strong>Alta</strong></div>
                <div style="font-size: 0.8rem; opacity: 0.8;">Urgente</div>
            </div>
        </div>
    </div>
    
    <!-- Notificaciones -->
    <div class="content-section">
        <div class="section-title">
            <i class="bi bi-bell"></i>
            Configuración de Notificaciones
        </div>
        
        <div class="notificaciones-config">
            <h6 class="mb-3"><i class="bi bi-info-circle me-2"></i>Recibir avisos automáticos</h6>
            
            <div class="notificacion-item">
                <div class="notificacion-info">
                    <i class="bi bi-calendar-week"></i>
                    <span>1 semana antes</span>
                </div>
                <div class="notificacion-toggle" onclick="toggleNotificacion('semana')" id="toggleSemana"></div>
            </div>
            
            <div class="notificacion-item">
                <div class="notificacion-info">
                    <i class="bi bi-calendar-day"></i>
                    <span>1 día antes</span>
                </div>
                <div class="notificacion-toggle active" onclick="toggleNotificacion('dia')" id="toggleDia"></div>
            </div>
            
            <div class="notificacion-item">
                <div class="notificacion-info">
                    <i class="bi bi-clock"></i>
                    <span>1 hora antes</span>
                </div>
                <div class="notificacion-toggle" onclick="toggleNotificacion('hora')" id="toggleHora"></div>
            </div>
            
            <div class="notificacion-item">
                <div class="notificacion-info">
                    <i class="bi bi-alarm"></i>
                    <span>En el momento exacto</span>
                </div>
                <div class="notificacion-toggle active" onclick="toggleNotificacion('momento')" id="toggleMomento"></div>
            </div>
        </div>
    </div>
    
    <!-- Acciones Rápidas -->
    <div class="content-section">
        <div class="section-title">
            <i class="bi bi-lightning"></i>
            Acciones Rápidas
        </div>
        
        <div class="acciones-rapidas">
            <div class="accion-btn" onclick="postponeRecordatorio(1)">
                <i class="bi bi-calendar-plus"></i>
                Posponer 1 día
            </div>
            <div class="accion-btn" onclick="postponeRecordatorio(7)">
                <i class="bi bi-calendar-week"></i>
                Posponer 1 semana
            </div>
            <div class="accion-btn" onclick="duplicateRecordatorio()">
                <i class="bi bi-files"></i>
                Duplicar
            </div>
            <div class="accion-btn" onclick="shareRecordatorio()">
                <i class="bi bi-share"></i>
                Compartir
            </div>
        </div>
    </div>
    
    <!-- Historial de Notificaciones -->
    <div class="content-section">
        <div class="section-title">
            <i class="bi bi-clock-history"></i>
            Historial de Notificaciones
        </div>
        
        <div class="historial-notificaciones" id="historialNotificaciones">
            <!-- Las notificaciones se cargarán dinámicamente -->
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<button class="btn-floating" onclick="toggleCompletado()" title="Marcar como completado">
    <i class="bi bi-check" id="floatingIcon"></i>
</button>

<!-- Modal para configurar recordatorio -->
<div class="modal fade" id="recordatorioModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configurar Recordatorio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="recordatorioForm">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="recordatorioTituloInput" required>
                        <label for="recordatorioTituloInput">Título del recordatorio</label>
                    </div>
                    
                    <div class="form-floating">
                        <select class="form-select" id="recordatorioCategoria">
                            <option value="personal">Personal</option>
                            <option value="trabajo">Trabajo</option>
                            <option value="estudio">Estudio</option>
                            <option value="salud">Salud</option>
                            <option value="finanzas">Finanzas</option>
                            <option value="otros">Otros</option>
                        </select>
                        <label for="recordatorioCategoria">Categoría</label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="recordatorioRecurrente">
                        <label class="form-check-label" for="recordatorioRecurrente">
                            Recordatorio recurrente
                        </label>
                    </div>
                    
                    <div class="form-floating" id="recurrenciaConfig" style="display: none;">
                        <select class="form-select" id="tipoRecurrencia">
                            <option value="diario">Diario</option>
                            <option value="semanal">Semanal</option>
                            <option value="mensual">Mensual</option>
                            <option value="anual">Anual</option>
                        </select>
                        <label for="tipoRecurrencia">Tipo de recurrencia</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveRecordatorio()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
let recordatorioData = {
    titulo: '{{ block.title }}',
    descripcion: '{{ block.content }}',
    fechaInicio: '{{ block.get_metadata().get("start_date", "") }}',
    fechaLimite: '{{ block.get_metadata().get("due_date", "") }}',
    prioridad: '{{ block.get_metadata().get("priority", "media") }}',
    completado: {{ block.get_metadata().get('completed', false)|tojson }},
    categoria: '{{ block.get_metadata().get("category", "personal") }}',
    recurrente: {{ block.get_metadata().get('recurrent', false)|tojson }},
    tipoRecurrencia: '{{ block.get_metadata().get("recurrence_type", "semanal") }}',
    notificaciones: {
        semana: {{ block.get_metadata().get('notifications', {}).get('week', false)|tojson }},
        dia: {{ block.get_metadata().get('notifications', {}).get('day', true)|tojson }},
        hora: {{ block.get_metadata().get('notifications', {}).get('hour', false)|tojson }},
        momento: {{ block.get_metadata().get('notifications', {}).get('moment', true)|tojson }}
    },
    historial: {{ block.get_metadata().get('notification_history', [])|tojson }}
};

document.addEventListener('DOMContentLoaded', function() {
    updateHeader();
    loadFechas();
    loadPrioridad();
    loadNotificaciones();
    loadHistorial();
    startCountdown();
    
    // Auto-save cada 30 segundos
    setInterval(saveData, 30000);
    
    // Configurar eventos
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('descripcionEditor').addEventListener('input', function() {
        recordatorioData.descripcion = this.value;
        debounceAutoSave();
    });
    
    document.getElementById('fechaInicio').addEventListener('change', function() {
        recordatorioData.fechaInicio = this.value;
        updateCountdown();
        saveData();
    });
    
    document.getElementById('fechaLimite').addEventListener('change', function() {
        recordatorioData.fechaLimite = this.value;
        updateCountdown();
        updateHeader();
        saveData();
    });
    
    document.getElementById('recordatorioRecurrente').addEventListener('change', function() {
        const recurrenciaConfig = document.getElementById('recurrenciaConfig');
        if (this.checked) {
            recurrenciaConfig.style.display = 'block';
        } else {
            recurrenciaConfig.style.display = 'none';
        }
    });
}

function updateHeader() {
    const header = document.getElementById('recordatorioHeader');
    const icon = document.getElementById('recordatorioIcon');
    const titulo = document.getElementById('recordatorioTitulo');
    const prioridadText = document.getElementById('prioridadText');
    const estadoText = document.getElementById('estadoText');
    const estadoBadge = document.getElementById('estadoBadge');
    
    titulo.textContent = recordatorioData.titulo;
    prioridadText.textContent = recordatorioData.prioridad.charAt(0).toUpperCase() + recordatorioData.prioridad.slice(1);
    
    // Determinar estado
    let estado = 'pendiente';
    let claseHeader = '';
    
    if (recordatorioData.completado) {
        estado = 'completado';
        claseHeader = 'completado';
        icon.className = 'bi bi-check-circle';
        estadoText.textContent = 'Completado';
    } else if (recordatorioData.fechaLimite) {
        const ahora = new Date();
        const fechaLimite = new Date(recordatorioData.fechaLimite);
        const tiempoRestante = fechaLimite - ahora;
        
        if (tiempoRestante < 0) {
            estado = 'vencido';
            claseHeader = 'vencido';
            icon.className = 'bi bi-exclamation-triangle';
            estadoText.textContent = 'Vencido';
        } else if (tiempoRestante < 24 * 60 * 60 * 1000) { // Menos de 24 horas
            estado = 'urgente';
            claseHeader = 'urgente';
            icon.className = 'bi bi-alarm';
            estadoText.textContent = 'Urgente';
        } else {
            icon.className = 'bi bi-alarm';
            estadoText.textContent = 'Pendiente';
        }
    }
    
    // Actualizar clases del header
    header.className = `recordatorio-header ${claseHeader}`;
    
    // Actualizar badge de estado
    estadoBadge.className = `meta-item estado-${estado}`;
}

function loadFechas() {
    document.getElementById('fechaInicio').value = recordatorioData.fechaInicio;
    document.getElementById('fechaLimite').value = recordatorioData.fechaLimite;
}

function loadPrioridad() {
    document.querySelectorAll('.prioridad-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    const selectedOption = document.querySelector(`.prioridad-${recordatorioData.prioridad}`);
    if (selectedOption) {
        selectedOption.classList.add('selected');
    }
}

function loadNotificaciones() {
    Object.keys(recordatorioData.notificaciones).forEach(tipo => {
        const toggle = document.getElementById(`toggle${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
        if (toggle) {
            if (recordatorioData.notificaciones[tipo]) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }
    });
}

function loadHistorial() {
    const container = document.getElementById('historialNotificaciones');
    container.innerHTML = '';
    
    if (recordatorioData.historial.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="bi bi-bell" style="font-size: 2rem; opacity: 0.5;"></i>
                <p class="mt-2">No hay notificaciones en el historial</p>
            </div>
        `;
        return;
    }
    
    recordatorioData.historial.forEach(notificacion => {
        const div = document.createElement('div');
        div.className = 'notificacion-historial';
        
        const fecha = new Date(notificacion.fecha).toLocaleString();
        
        div.innerHTML = `
            <div class="notificacion-icon">
                <i class="bi bi-bell"></i>
            </div>
            <div class="notificacion-content">
                <div class="notificacion-texto">${notificacion.mensaje}</div>
                <div class="notificacion-fecha">${fecha}</div>
            </div>
            <div class="estado-badge estado-${notificacion.estado}">${notificacion.estado}</div>
        `;
        
        container.appendChild(div);
    });
}

function startCountdown() {
    updateCountdown();
    setInterval(updateCountdown, 60000); // Actualizar cada minuto
}

function updateCountdown() {
    const countdownNumber = document.getElementById('countdownNumber');
    const countdownLabel = document.getElementById('countdownLabel');
    
    if (!recordatorioData.fechaLimite) {
        countdownNumber.textContent = '--';
        countdownLabel.textContent = 'sin fecha';
        return;
    }
    
    const ahora = new Date();
    const fechaLimite = new Date(recordatorioData.fechaLimite);
    const diferencia = fechaLimite - ahora;
    
    if (diferencia < 0) {
        countdownNumber.textContent = '¡Vencido!';
        countdownLabel.textContent = '';
        return;
    }
    
    const dias = Math.floor(diferencia / (1000 * 60 * 60 * 24));
    const horas = Math.floor((diferencia % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutos = Math.floor((diferencia % (1000 * 60 * 60)) / (1000 * 60));
    
    if (dias > 0) {
        countdownNumber.textContent = dias;
        countdownLabel.textContent = dias === 1 ? 'día restante' : 'días restantes';
    } else if (horas > 0) {
        countdownNumber.textContent = horas;
        countdownLabel.textContent = horas === 1 ? 'hora restante' : 'horas restantes';
    } else {
        countdownNumber.textContent = minutos;
        countdownLabel.textContent = minutos === 1 ? 'minuto restante' : 'minutos restantes';
    }
}

function setPrioridad(prioridad) {
    recordatorioData.prioridad = prioridad;
    loadPrioridad();
    updateHeader();
    saveData();
}

function toggleNotificacion(tipo) {
    recordatorioData.notificaciones[tipo] = !recordatorioData.notificaciones[tipo];
    loadNotificaciones();
    saveData();
}

function toggleCompletado() {
    recordatorioData.completado = !recordatorioData.completado;
    
    if (recordatorioData.completado) {
        // Agregar al historial
        recordatorioData.historial.unshift({
            id: Date.now().toString(),
            mensaje: 'Recordatorio marcado como completado',
            fecha: new Date().toISOString(),
            estado: 'completado'
        });
    }
    
    updateHeader();
    loadHistorial();
    saveData();
}

function postponeRecordatorio(dias) {
    if (!recordatorioData.fechaLimite) {
        alert('Primero debes establecer una fecha límite');
        return;
    }
    
    const fechaActual = new Date(recordatorioData.fechaLimite);
    fechaActual.setDate(fechaActual.getDate() + dias);
    
    recordatorioData.fechaLimite = fechaActual.toISOString().slice(0, 16);
    loadFechas();
    updateCountdown();
    updateHeader();
    
    // Agregar al historial
    recordatorioData.historial.unshift({
        id: Date.now().toString(),
        mensaje: `Recordatorio pospuesto ${dias} día${dias > 1 ? 's' : ''}`,
        fecha: new Date().toISOString(),
        estado: 'pendiente'
    });
    
    loadHistorial();
    saveData();
}

function duplicateRecordatorio() {
    // En una implementación real, esto crearía un nuevo recordatorio
    alert('Funcionalidad de duplicar recordatorio - implementar según necesidades');
}

function shareRecordatorio() {
    const shareData = {
        title: recordatorioData.titulo,
        text: recordatorioData.descripcion,
        url: window.location.href
    };
    
    if (navigator.share) {
        navigator.share(shareData);
    } else {
        // Fallback: copiar al portapapeles
        const shareText = `${recordatorioData.titulo}\n${recordatorioData.descripcion}\nFecha límite: ${recordatorioData.fechaLimite}`;
        navigator.clipboard.writeText(shareText).then(() => {
            alert('Información copiada al portapapeles');
        });
    }
}

function editRecordatorio() {
    document.getElementById('recordatorioTituloInput').value = recordatorioData.titulo;
    document.getElementById('recordatorioCategoria').value = recordatorioData.categoria;
    document.getElementById('recordatorioRecurrente').checked = recordatorioData.recurrente;
    document.getElementById('tipoRecurrencia').value = recordatorioData.tipoRecurrencia;
    
    const recurrenciaConfig = document.getElementById('recurrenciaConfig');
    if (recordatorioData.recurrente) {
        recurrenciaConfig.style.display = 'block';
    } else {
        recurrenciaConfig.style.display = 'none';
    }
    
    const modal = new bootstrap.Modal(document.getElementById('recordatorioModal'));
    modal.show();
}

function saveRecordatorio() {
    const form = document.getElementById('recordatorioForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    recordatorioData.titulo = document.getElementById('recordatorioTituloInput').value;
    recordatorioData.categoria = document.getElementById('recordatorioCategoria').value;
    recordatorioData.recurrente = document.getElementById('recordatorioRecurrente').checked;
    recordatorioData.tipoRecurrencia = document.getElementById('tipoRecurrencia').value;
    
    updateHeader();
    saveData();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('recordatorioModal'));
    modal.hide();
}

function exportRecordatorio() {
    const data = {
        recordatorio: {
            titulo: recordatorioData.titulo,
            descripcion: recordatorioData.descripcion,
            fechaInicio: recordatorioData.fechaInicio,
            fechaLimite: recordatorioData.fechaLimite,
            prioridad: recordatorioData.prioridad,
            completado: recordatorioData.completado,
            categoria: recordatorioData.categoria,
            recurrente: recordatorioData.recurrente,
            tipoRecurrencia: recordatorioData.tipoRecurrencia
        },
        notificaciones: recordatorioData.notificaciones,
        historial: recordatorioData.historial,
        exportadoEn: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${recordatorioData.titulo || 'recordatorio'}_datos.json`;
    a.click();
    URL.revokeObjectURL(url);
}

let autoSaveTimeout;
function debounceAutoSave() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(saveData, 2000);
}

function saveData() {
    fetch(`/espacio-personal/api/blocks/{{ block.id }}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            title: recordatorioData.titulo,
            content: recordatorioData.descripcion,
            metadata: {
                start_date: recordatorioData.fechaInicio,
                due_date: recordatorioData.fechaLimite,
                priority: recordatorioData.prioridad,
                completed: recordatorioData.completado,
                category: recordatorioData.categoria,
                recurrent: recordatorioData.recurrente,
                recurrence_type: recordatorioData.tipoRecurrencia,
                notifications: recordatorioData.notificaciones,
                notification_history: recordatorioData.historial
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Recordatorio guardado correctamente');
        }
    })
    .catch(error => console.error('Error saving recordatorio:', error));
}

function getCsrfToken() {
    return document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
}
</script>
{% endblock %}