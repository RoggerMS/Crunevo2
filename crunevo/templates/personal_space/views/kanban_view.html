{% extends 'base.html' %}
{% block title %}Tablero Kanban - {{ block.title }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personal-space.css') }}">
<style>
/* Trello-like Kanban Board Styles */
.kanban-container {
    display: flex;
    height: 100vh;
    background: linear-gradient(135deg, #0079bf 0%, #026aa7 100%);
    overflow: hidden;
}

.kanban-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.kanban-header {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    padding: 1rem 2rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.kanban-title {
    color: white;
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.kanban-title i {
    font-size: 1.8rem;
}

.kanban-actions {
    display: flex;
    gap: 12px;
    align-items: center;
}

.header-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    font-weight: 500;
}

.header-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
}

.kanban-board {
    flex: 1;
    display: flex;
    gap: 16px;
    padding: 20px;
    overflow-x: auto;
    overflow-y: hidden;
}

.kanban-column {
    background: #ebecf0;
    border-radius: 12px;
    min-width: 280px;
    max-width: 280px;
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - 140px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.column-header {
    padding: 12px 16px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f4f5f7;
    border-radius: 12px 12px 0 0;
}

.column-title {
    font-weight: 600;
    color: #172b4d;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.column-count {
    background: #ddd;
    color: #5e6c84;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    min-width: 20px;
    text-align: center;
}

.column-menu {
    background: none;
    border: none;
    color: #5e6c84;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.column-menu:hover {
    background: #ddd;
    color: #172b4d;
}

.tasks-container {
    flex: 1;
    padding: 8px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #c1c7d0 transparent;
}

.tasks-container::-webkit-scrollbar {
    width: 8px;
}

.tasks-container::-webkit-scrollbar-track {
    background: transparent;
}

.tasks-container::-webkit-scrollbar-thumb {
    background: #c1c7d0;
    border-radius: 4px;
}

.task-card {
    background: white;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 2px solid transparent;
    position: relative;
}

.task-card:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
}

.task-card.selected {
    border-color: #0079bf;
    box-shadow: 0 0 0 1px #0079bf;
}

.task-card.dragging {
    opacity: 0.8;
    transform: rotate(2deg);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.task-labels {
    display: flex;
    gap: 4px;
    margin-bottom: 8px;
    flex-wrap: wrap;
}

.task-label {
    background: #61bd4f;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.task-label.priority-alta { background: #eb5a46; }
.task-label.priority-media { background: #f2d600; color: #172b4d; }
.task-label.priority-baja { background: #61bd4f; }

.task-title {
    font-weight: 500;
    color: #172b4d;
    margin-bottom: 8px;
    line-height: 1.3;
    font-size: 0.9rem;
}

.task-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: #5e6c84;
}

.task-due-date {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 2px 6px;
    border-radius: 4px;
    background: #f4f5f7;
}

.task-due-date.overdue {
    background: #ffeceb;
    color: #eb5a46;
}

.task-due-date.today {
    background: #fff2cc;
    color: #bf8f00;
}

.task-attachments {
    display: flex;
    align-items: center;
    gap: 4px;
}

.add-task-btn {
    margin: 8px;
    padding: 8px 12px;
    background: none;
    border: none;
    color: #5e6c84;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.add-task-btn:hover {
    background: #e4e6ea;
    color: #172b4d;
}

/* Right Panel Styles */
.kanban-sidebar {
    width: 350px;
    background: white;
    border-left: 1px solid #ddd;
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    position: relative;
    z-index: 1000;
}

.kanban-sidebar.open {
    transform: translateX(0);
}

.sidebar-header {
    padding: 20px;
    border-bottom: 1px solid #ddd;
    background: #f8f9fa;
}

.sidebar-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #172b4d;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.close-sidebar {
    background: none;
    border: none;
    color: #5e6c84;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.close-sidebar:hover {
    background: #e4e6ea;
    color: #172b4d;
}

.sidebar-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

.sidebar-section {
    margin-bottom: 24px;
}

.sidebar-section h4 {
    font-size: 0.9rem;
    font-weight: 600;
    color: #5e6c84;
    text-transform: uppercase;
    margin-bottom: 12px;
    letter-spacing: 0.5px;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
}

.stat-card {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #e4e6ea;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #172b4d;
    margin-bottom: 4px;
}

.stat-label {
    font-size: 0.8rem;
    color: #5e6c84;
    font-weight: 500;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: #e4e6ea;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 8px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #61bd4f, #51a83f);
    transition: width 0.3s ease;
    border-radius: 4px;
}

.action-btn {
    width: 100%;
    padding: 12px;
    background: #0079bf;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-weight: 500;
    margin-bottom: 8px;
}

.action-btn:hover {
    background: #026aa7;
    transform: translateY(-1px);
}

.action-btn.secondary {
    background: #f4f5f7;
    color: #172b4d;
    border: 1px solid #ddd;
}

.action-btn.secondary:hover {
    background: #e4e6ea;
}

.filter-section {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
    border: 1px solid #e4e6ea;
}

.filter-group {
    margin-bottom: 16px;
}

.filter-group:last-child {
    margin-bottom: 0;
}

.filter-label {
    font-size: 0.85rem;
    font-weight: 500;
    color: #172b4d;
    margin-bottom: 8px;
    display: block;
}

.filter-select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: white;
    color: #172b4d;
    font-size: 0.9rem;
}

.filter-select:focus {
    outline: none;
    border-color: #0079bf;
    box-shadow: 0 0 0 2px rgba(0, 121, 191, 0.2);
}

/* Task Detail Panel */
.task-detail {
    display: none;
}

.task-detail.active {
    display: block;
}

.task-detail-header {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 20px;
}

.task-detail-title {
    flex: 1;
    font-size: 1.1rem;
    font-weight: 600;
    color: #172b4d;
    line-height: 1.3;
}

.task-detail-actions {
    display: flex;
    gap: 8px;
}

.task-action-btn {
    background: none;
    border: 1px solid #ddd;
    color: #5e6c84;
    padding: 6px 8px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.task-action-btn:hover {
    background: #f4f5f7;
    color: #172b4d;
}

.task-field {
    margin-bottom: 16px;
}

.task-field-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: #5e6c84;
    margin-bottom: 6px;
    display: block;
}

.task-field-value {
    color: #172b4d;
    font-size: 0.9rem;
    line-height: 1.4;
}

.task-description {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 6px;
    border: 1px solid #e4e6ea;
    min-height: 80px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .kanban-container {
        flex-direction: column;
    }
    
    .kanban-sidebar {
        width: 100%;
        position: fixed;
        top: 0;
        right: 0;
        height: 100vh;
        z-index: 1001;
    }
    
    .kanban-board {
        flex-direction: column;
        gap: 12px;
    }
    
    .kanban-column {
        min-width: 100%;
        max-width: 100%;
        max-height: 400px;
    }
}

/* Drag and Drop Styles */
.kanban-column.drag-over {
    background: #e4f3ff;
    border: 2px dashed #0079bf;
}

.task-card.drag-placeholder {
    background: #e4f3ff;
    border: 2px dashed #0079bf;
    opacity: 0.5;
}

/* Animation Classes */
.fade-in {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.slide-in {
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { transform: translateX(20px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
</style>
{% endblock %}

{% block content %}
<div class="kanban-container">
    <!-- Main Kanban Board -->
    <div class="kanban-main">
        <!-- Header -->
        <div class="kanban-header">
            <h1 class="kanban-title">
                <i class="bi bi-kanban"></i>
                <span id="boardTitle">{{ block.title or 'Tablero Kanban' }}</span>
            </h1>
            <div class="kanban-actions">
                <button class="header-btn" onclick="toggleSidebar()">
                    <i class="bi bi-layout-sidebar-inset-reverse"></i>
                    Panel
                </button>
                <button class="header-btn" onclick="addColumn()">
                    <i class="bi bi-plus"></i>
                    Columna
                </button>
                <button class="header-btn" onclick="configureBoard()">
                    <i class="bi bi-gear"></i>
                    Configurar
                </button>
            </div>
        </div>
        
        <!-- Kanban Board -->
        <div class="kanban-board" id="kanbanBoard">
            <!-- Columns will be dynamically generated -->
        </div>
    </div>
    
    <!-- Right Sidebar Panel -->
    <div class="kanban-sidebar" id="kanbanSidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">
                Panel de Control
                <button class="close-sidebar" onclick="toggleSidebar()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </h3>
        </div>
        
        <div class="sidebar-content">
            <!-- Statistics Section -->
            <div class="sidebar-section">
                <h4>Estadísticas</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalTasks">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedTasks">0</div>
                        <div class="stat-label">Completadas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="inProgressTasks">0</div>
                        <div class="stat-label">En Progreso</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="overdueTasks">0</div>
                        <div class="stat-label">Vencidas</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="sidebar-section">
                <h4>Acciones Rápidas</h4>
                <button class="action-btn" onclick="addTask()">
                    <i class="bi bi-plus"></i>
                    Nueva Tarea
                </button>
                <button class="action-btn secondary" onclick="autoOrganize()">
                    <i class="bi bi-arrow-down-up"></i>
                    Auto Organizar
                </button>
                <button class="action-btn secondary" onclick="archiveCompleted()">
                    <i class="bi bi-archive"></i>
                    Archivar Completadas
                </button>
                <button class="action-btn secondary" onclick="exportBoard()">
                    <i class="bi bi-download"></i>
                    Exportar Datos
                </button>
            </div>
            
            <!-- Filters -->
            <div class="sidebar-section">
                <h4>Filtros</h4>
                <div class="filter-section">
                    <div class="filter-group">
                        <label class="filter-label">Prioridad</label>
                        <select class="filter-select" id="priorityFilter" onchange="applyFilters()">
                            <option value="all">Todas las prioridades</option>
                            <option value="alta">Alta</option>
                            <option value="media">Media</option>
                            <option value="baja">Baja</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Fecha Límite</label>
                        <select class="filter-select" id="dueDateFilter" onchange="applyFilters()">
                            <option value="all">Todas las fechas</option>
                            <option value="overdue">Vencidas</option>
                            <option value="today">Hoy</option>
                            <option value="week">Esta semana</option>
                            <option value="month">Este mes</option>
                        </select>
                    </div>
                    <button class="action-btn secondary" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i>
                        Limpiar Filtros
                    </button>
                </div>
            </div>
            
            <!-- Task Detail Panel -->
            <div class="sidebar-section task-detail" id="taskDetail">
                <h4>Detalles de Tarea</h4>
                <div class="task-detail-content">
                    <!-- Task details will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Task Modal -->
<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalTitle">Nueva Tarea</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="taskTitle" required>
                                <label for="taskTitle">Título de la tarea</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="taskPriority">
                                    <option value="baja">Baja</option>
                                    <option value="media" selected>Media</option>
                                    <option value="alta">Alta</option>
                                </select>
                                <label for="taskPriority">Prioridad</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <textarea class="form-control" id="taskDescription" style="height: 100px"></textarea>
                        <label for="taskDescription">Descripción</label>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="date" class="form-control" id="taskDueDate">
                                <label for="taskDueDate">Fecha límite</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="taskColumn">
                                    <!-- Options will be populated dynamically -->
                                </select>
                                <label for="taskColumn">Columna</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="taskLabels" placeholder="Separar con comas">
                        <label for="taskLabels">Etiquetas (separar con comas)</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="taskAssignee">
                        <label for="taskAssignee">Asignado a</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveTask()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Column Modal -->
<div class="modal fade" id="columnModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="columnModalTitle">Nueva Columna</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="columnForm">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="columnTitle" required>
                        <label for="columnTitle">Título de la columna</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <select class="form-select" id="columnColor">
                            <option value="primary">Azul</option>
                            <option value="success">Verde</option>
                            <option value="warning">Amarillo</option>
                            <option value="danger">Rojo</option>
                            <option value="info">Cian</option>
                            <option value="secondary">Gris</option>
                        </select>
                        <label for="columnColor">Color</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="columnLimit" min="0" value="0">
                        <label for="columnLimit">Límite de tareas (0 = sin límite)</label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="columnAutoComplete">
                        <label class="form-check-label" for="columnAutoComplete">
                            Auto-completar tareas al mover a esta columna
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveColumn()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Board Config Modal -->
<div class="modal fade" id="boardConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configurar Tablero</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="boardConfigForm">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="boardTitleInput" required>
                        <label for="boardTitleInput">Título del tablero</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <textarea class="form-control" id="boardDescriptionInput" style="height: 100px"></textarea>
                        <label for="boardDescriptionInput">Descripción</label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="boardAutoArchive">
                        <label class="form-check-label" for="boardAutoArchive">
                            Auto-archivar tareas completadas después de 7 días
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="boardNotifications">
                        <label class="form-check-label" for="boardNotifications">
                            Notificaciones de fechas límite
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveBoardConfig()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let kanbanData = {
    title: '{{ block.title }}',
    description: '{{ block.content }}',
    autoArchive: {{ block.get_metadata().get('auto_archive', false)|tojson }},
    notifications: {{ block.get_metadata().get('notifications', true)|tojson }},
    columns: {{ block.get_metadata().get('columns', [])|tojson }},
    tasks: {{ block.get_metadata().get('tasks', [])|tojson }}
};

let currentTaskId = null;
let currentColumnId = null;
let selectedTaskId = null;
let filters = {
    priority: 'all',
    dueDate: 'all'
};

// Initialize default columns if none exist
if (kanbanData.columns.length === 0) {
    kanbanData.columns = [
        { id: 1, title: 'Por Hacer', color: 'secondary', limit: 0, autoComplete: false },
        { id: 2, title: 'En Progreso', color: 'primary', limit: 5, autoComplete: false },
        { id: 3, title: 'En Revisión', color: 'warning', limit: 3, autoComplete: false },
        { id: 4, title: 'Completado', color: 'success', limit: 0, autoComplete: true }
    ];
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadKanbanBoard();
    updateStatistics();
    setupDragAndDrop();
    
    // Auto-save every 30 seconds
    setInterval(saveData, 30000);
});

// Main Functions
function loadKanbanBoard() {
    const board = document.getElementById('kanbanBoard');
    board.innerHTML = '';
    
    kanbanData.columns.forEach(column => {
        const columnElement = createColumnElement(column);
        board.appendChild(columnElement);
    });
    
    updateStatistics();
}

function createColumnElement(column) {
    const div = document.createElement('div');
    div.className = 'kanban-column';
    div.dataset.columnId = column.id;
    
    const filteredTasks = getFilteredTasks(column.id);
    const taskCount = filteredTasks.length;
    
    div.innerHTML = `
        <div class="column-header">
            <div class="column-title">
                <i class="bi bi-circle-fill text-${column.color}"></i>
                ${column.title}
            </div>
            <div class="column-count">${taskCount}</div>
            <button class="column-menu" onclick="showColumnMenu(${column.id})">
                <i class="bi bi-three-dots"></i>
            </button>
        </div>
        
        <div class="tasks-container" id="tasks-${column.id}">
            <!-- Tasks will be added here -->
        </div>
        
        <button class="add-task-btn" onclick="addTask(${column.id})">
            <i class="bi bi-plus"></i>
            Agregar una tarjeta
        </button>
    `;
    
    // Add tasks to column
    const tasksContainer = div.querySelector(`#tasks-${column.id}`);
    filteredTasks.forEach(task => {
        const taskElement = createTaskElement(task);
        tasksContainer.appendChild(taskElement);
    });
    
    return div;
}

function createTaskElement(task) {
    const div = document.createElement('div');
    div.className = 'task-card';
    div.dataset.taskId = task.id;
    div.draggable = true;
    
    // Calculate due date status
    const dueDate = task.dueDate ? new Date(task.dueDate) : null;
    const today = new Date();
    let dueDateClass = '';
    let dueDateText = '';
    
    if (dueDate) {
        const diffTime = dueDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) {
            dueDateClass = 'overdue';
            dueDateText = `Vencida hace ${Math.abs(diffDays)} días`;
        } else if (diffDays === 0) {
            dueDateClass = 'today';
            dueDateText = 'Vence hoy';
        } else {
            dueDateText = `${diffDays} días restantes`;
        }
    }
    
    const labels = task.labels || [];
    const labelsHtml = labels.map(label => 
        `<span class="task-label">${label}</span>`
    ).join('');
    
    // Add priority label
    const priorityLabel = `<span class="task-label priority-${task.priority}">${task.priority.toUpperCase()}</span>`;
    
    div.innerHTML = `
        ${labels.length > 0 || task.priority ? `<div class="task-labels">${priorityLabel}${labelsHtml}</div>` : ''}
        <div class="task-title">${task.title}</div>
        <div class="task-meta">
            ${dueDate ? `
                <div class="task-due-date ${dueDateClass}">
                    <i class="bi bi-calendar"></i>
                    ${dueDateText}
                </div>
            ` : '<div></div>'}
            <div class="task-attachments">
                ${task.attachments ? `<i class="bi bi-paperclip"></i> ${task.attachments}` : ''}
            </div>
        </div>
    `;
    
    div.onclick = () => selectTask(task.id);
    
    return div;
}

function getFilteredTasks(columnId) {
    let tasks = kanbanData.tasks.filter(t => t.columnId === columnId);
    
    // Apply filters
    if (filters.priority !== 'all') {
        tasks = tasks.filter(t => t.priority === filters.priority);
    }
    
    if (filters.dueDate !== 'all') {
        const today = new Date();
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay());
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        tasks = tasks.filter(t => {
            if (!t.dueDate) return filters.dueDate === 'all';
            
            const dueDate = new Date(t.dueDate);
            
            switch (filters.dueDate) {
                case 'overdue':
                    return dueDate < today;
                case 'today':
                    return dueDate.toDateString() === today.toDateString();
                case 'week':
                    return dueDate >= startOfWeek && dueDate <= endOfWeek;
                case 'month':
                    return dueDate >= startOfMonth && dueDate <= endOfMonth;
                default:
                    return true;
            }
        });
    }
    
    return tasks;
}

function updateStatistics() {
    const totalTasks = kanbanData.tasks.length;
    const completedTasks = kanbanData.tasks.filter(t => {
        const column = kanbanData.columns.find(c => c.id === t.columnId);
        return column && column.autoComplete;
    }).length;
    const inProgressTasks = totalTasks - completedTasks;
    
    // Calculate overdue tasks
    const today = new Date();
    const overdueTasks = kanbanData.tasks.filter(t => {
        if (!t.dueDate) return false;
        return new Date(t.dueDate) < today;
    }).length;
    
    const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
    
    document.getElementById('totalTasks').textContent = totalTasks;
    document.getElementById('completedTasks').textContent = completedTasks;
    document.getElementById('inProgressTasks').textContent = inProgressTasks;
    document.getElementById('overdueTasks').textContent = overdueTasks;
    document.getElementById('progressFill').style.width = `${progress}%`;
}

// Sidebar Functions
function toggleSidebar() {
    const sidebar = document.getElementById('kanbanSidebar');
    sidebar.classList.toggle('open');
}

function selectTask(taskId) {
    // Remove previous selection
    document.querySelectorAll('.task-card.selected').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Select new task
    const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
    if (taskCard) {
        taskCard.classList.add('selected');
        selectedTaskId = taskId;
        showTaskDetail(taskId);
    }
}

function showTaskDetail(taskId) {
    const task = kanbanData.tasks.find(t => t.id === taskId);
    if (!task) return;
    
    const column = kanbanData.columns.find(c => c.id === task.columnId);
    const taskDetail = document.getElementById('taskDetail');
    const content = taskDetail.querySelector('.task-detail-content');
    
    content.innerHTML = `
        <div class="task-detail-header">
            <div class="task-detail-title">${task.title}</div>
            <div class="task-detail-actions">
                <button class="task-action-btn" onclick="editTask(${task.id})" title="Editar">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="task-action-btn" onclick="deleteTask(${task.id})" title="Eliminar">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        
        <div class="task-field">
            <span class="task-field-label">Columna</span>
            <div class="task-field-value">${column ? column.title : 'Sin columna'}</div>
        </div>
        
        <div class="task-field">
            <span class="task-field-label">Prioridad</span>
            <div class="task-field-value">
                <span class="task-label priority-${task.priority}">${task.priority.toUpperCase()}</span>
            </div>
        </div>
        
        ${task.description ? `
            <div class="task-field">
                <span class="task-field-label">Descripción</span>
                <div class="task-description">${task.description}</div>
            </div>
        ` : ''}
        
        ${task.dueDate ? `
            <div class="task-field">
                <span class="task-field-label">Fecha Límite</span>
                <div class="task-field-value">${new Date(task.dueDate).toLocaleDateString()}</div>
            </div>
        ` : ''}
        
        ${task.labels && task.labels.length > 0 ? `
            <div class="task-field">
                <span class="task-field-label">Etiquetas</span>
                <div class="task-field-value">
                    ${task.labels.map(label => `<span class="task-label">${label}</span>`).join(' ')}
                </div>
            </div>
        ` : ''}
        
        ${task.assignee ? `
            <div class="task-field">
                <span class="task-field-label">Asignado a</span>
                <div class="task-field-value">${task.assignee}</div>
            </div>
        ` : ''}
    `;
    
    taskDetail.classList.add('active');
    
    // Open sidebar if not already open
    const sidebar = document.getElementById('kanbanSidebar');
    if (!sidebar.classList.contains('open')) {
        sidebar.classList.add('open');
    }
}

// Filter Functions
function applyFilters() {
    filters.priority = document.getElementById('priorityFilter').value;
    filters.dueDate = document.getElementById('dueDateFilter').value;
    loadKanbanBoard();
}

function clearFilters() {
    filters.priority = 'all';
    filters.dueDate = 'all';
    document.getElementById('priorityFilter').value = 'all';
    document.getElementById('dueDateFilter').value = 'all';
    loadKanbanBoard();
}

// Task Functions
function addTask(columnId = null) {
    currentTaskId = null;
    
    document.getElementById('taskModalTitle').textContent = 'Nueva Tarea';
    document.getElementById('taskForm').reset();
    
    // Populate column options
    const columnSelect = document.getElementById('taskColumn');
    columnSelect.innerHTML = '';
    kanbanData.columns.forEach(column => {
        const option = document.createElement('option');
        option.value = column.id;
        option.textContent = column.title;
        if (columnId && column.id === columnId) {
            option.selected = true;
        }
        columnSelect.appendChild(option);
    });
    
    const modal = new bootstrap.Modal(document.getElementById('taskModal'));
    modal.show();
}

function editTask(taskId) {
    const task = kanbanData.tasks.find(t => t.id === taskId);
    if (!task) return;
    
    currentTaskId = taskId;
    
    document.getElementById('taskModalTitle').textContent = 'Editar Tarea';
    document.getElementById('taskTitle').value = task.title;
    document.getElementById('taskDescription').value = task.description || '';
    document.getElementById('taskPriority').value = task.priority;
    document.getElementById('taskDueDate').value = task.dueDate || '';
    document.getElementById('taskLabels').value = task.labels ? task.labels.join(', ') : '';
    document.getElementById('taskAssignee').value = task.assignee || '';
    
    // Populate column options
    const columnSelect = document.getElementById('taskColumn');
    columnSelect.innerHTML = '';
    kanbanData.columns.forEach(column => {
        const option = document.createElement('option');
        option.value = column.id;
        option.textContent = column.title;
        if (column.id === task.columnId) {
            option.selected = true;
        }
        columnSelect.appendChild(option);
    });
    
    const modal = new bootstrap.Modal(document.getElementById('taskModal'));
    modal.show();
}

function saveTask() {
    const form = document.getElementById('taskForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const title = document.getElementById('taskTitle').value;
    const description = document.getElementById('taskDescription').value;
    const priority = document.getElementById('taskPriority').value;
    const dueDate = document.getElementById('taskDueDate').value;
    const columnId = parseInt(document.getElementById('taskColumn').value);
    const labels = document.getElementById('taskLabels').value
        .split(',')
        .map(label => label.trim())
        .filter(label => label.length > 0);
    const assignee = document.getElementById('taskAssignee').value;
    
    const column = kanbanData.columns.find(c => c.id === columnId);
    if (!column) {
        alert('Columna no encontrada');
        return;
    }
    
    const taskData = {
        title: title,
        description: description,
        priority: priority,
        due_date: dueDate
    };
    
    if (currentTaskId) {
        // Update existing task via API
        updateTaskViaAPI(currentTaskId, taskData)
            .then(() => {
                console.log('Tarea actualizada correctamente');
                const modal = bootstrap.Modal.getInstance(document.getElementById('taskModal'));
                modal.hide();
            })
            .catch(error => {
                console.error('Error updating task:', error);
                alert('Error al actualizar la tarea: ' + error.message);
            });
    } else {
        // Create new task via API
        addTaskViaAPI(column.title, taskData)
            .then(() => {
                console.log('Tarea creada correctamente');
                const modal = bootstrap.Modal.getInstance(document.getElementById('taskModal'));
                modal.hide();
            })
            .catch(error => {
                console.error('Error creating task:', error);
                alert('Error al crear la tarea: ' + error.message);
            });
    }
}

function deleteTask(taskId) {
    if (confirm('¿Estás seguro de que quieres eliminar esta tarea?')) {
        deleteTaskViaAPI(taskId)
            .then(() => {
                console.log('Tarea eliminada correctamente');
                
                // Hide task detail if this task was selected
                if (selectedTaskId === taskId) {
                    document.getElementById('taskDetail').classList.remove('active');
                    selectedTaskId = null;
                }
            })
            .catch(error => {
                console.error('Error deleting task:', error);
                alert('Error al eliminar la tarea: ' + error.message);
            });
    }
}

// Column Functions
function addColumn() {
    currentColumnId = null;
    
    document.getElementById('columnModalTitle').textContent = 'Nueva Columna';
    document.getElementById('columnForm').reset();
    
    const modal = new bootstrap.Modal(document.getElementById('columnModal'));
    modal.show();
}

function editColumn(columnId) {
    const column = kanbanData.columns.find(c => c.id === columnId);
    if (!column) return;
    
    currentColumnId = columnId;
    
    document.getElementById('columnModalTitle').textContent = 'Editar Columna';
    document.getElementById('columnTitle').value = column.title;
    document.getElementById('columnColor').value = column.color;
    document.getElementById('columnLimit').value = column.limit;
    document.getElementById('columnAutoComplete').checked = column.autoComplete;
    
    const modal = new bootstrap.Modal(document.getElementById('columnModal'));
    modal.show();
}

function saveColumn() {
    const form = document.getElementById('columnForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const title = document.getElementById('columnTitle').value;
    const color = document.getElementById('columnColor').value;
    const limit = parseInt(document.getElementById('columnLimit').value);
    const autoComplete = document.getElementById('columnAutoComplete').checked;
    
    if (currentColumnId) {
        // Update existing column
        const column = kanbanData.columns.find(c => c.id === currentColumnId);
        if (column) {
            column.title = title;
            column.color = color;
            column.limit = limit;
            column.autoComplete = autoComplete;
        }
    } else {
        // Create new column
        const newId = Math.max(...kanbanData.columns.map(c => c.id), 0) + 1;
        const newColumn = {
            id: newId,
            title: title,
            color: color,
            limit: limit,
            autoComplete: autoComplete
        };
        
        kanbanData.columns.push(newColumn);
    }
    
    loadKanbanBoard();
    saveData();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('columnModal'));
    modal.hide();
}

function showColumnMenu(columnId) {
    // Simple implementation - could be enhanced with a proper dropdown menu
    const actions = [
        { text: 'Editar', action: () => editColumn(columnId) },
        { text: 'Eliminar', action: () => deleteColumn(columnId) }
    ];
    
    const action = prompt('Selecciona una acción:\n1. Editar\n2. Eliminar');
    
    if (action === '1') {
        editColumn(columnId);
    } else if (action === '2') {
        deleteColumn(columnId);
    }
}

function deleteColumn(columnId) {
    const column = kanbanData.columns.find(c => c.id === columnId);
    const tasksInColumn = kanbanData.tasks.filter(t => t.columnId === columnId).length;
    
    if (tasksInColumn > 0) {
        if (!confirm(`La columna "${column.title}" tiene ${tasksInColumn} tareas. ¿Estás seguro de eliminarla? Las tareas se moverán a la primera columna.`)) {
            return;
        }
        
        // Move tasks to first column
        const firstColumn = kanbanData.columns.find(c => c.id !== columnId);
        if (firstColumn) {
            kanbanData.tasks.forEach(t => {
                if (t.columnId === columnId) {
                    t.columnId = firstColumn.id;
                }
            });
        }
    }
    
    kanbanData.columns = kanbanData.columns.filter(c => c.id !== columnId);
    loadKanbanBoard();
    updateStatistics();
    saveData();
}

// Board Configuration
function configureBoard() {
    document.getElementById('boardTitleInput').value = kanbanData.title;
    document.getElementById('boardDescriptionInput').value = kanbanData.description;
    document.getElementById('boardAutoArchive').checked = kanbanData.autoArchive;
    document.getElementById('boardNotifications').checked = kanbanData.notifications;
    
    const modal = new bootstrap.Modal(document.getElementById('boardConfigModal'));
    modal.show();
}

function saveBoardConfig() {
    const form = document.getElementById('boardConfigForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    kanbanData.title = document.getElementById('boardTitleInput').value;
    kanbanData.description = document.getElementById('boardDescriptionInput').value;
    kanbanData.autoArchive = document.getElementById('boardAutoArchive').checked;
    kanbanData.notifications = document.getElementById('boardNotifications').checked;
    
    // Update UI
    document.getElementById('boardTitle').textContent = kanbanData.title;
    
    saveData();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('boardConfigModal'));
    modal.hide();
}

// Utility Functions
function autoOrganize() {
    // Sort tasks by priority and due date
    kanbanData.tasks.sort((a, b) => {
        const priorityOrder = { 'alta': 3, 'media': 2, 'baja': 1 };
        const priorityDiff = priorityOrder[b.priority] - priorityOrder[a.priority];
        
        if (priorityDiff !== 0) return priorityDiff;
        
        if (a.dueDate && b.dueDate) {
            return new Date(a.dueDate) - new Date(b.dueDate);
        }
        
        return 0;
    });
    
    loadKanbanBoard();
    saveData();
}

function archiveCompleted() {
    const completedTasks = kanbanData.tasks.filter(t => {
        const column = kanbanData.columns.find(c => c.id === t.columnId);
        return column && column.autoComplete;
    });
    
    if (completedTasks.length === 0) {
        alert('No hay tareas completadas para archivar.');
        return;
    }
    
    if (confirm(`¿Archivar ${completedTasks.length} tareas completadas?`)) {
        kanbanData.tasks = kanbanData.tasks.filter(t => {
            const column = kanbanData.columns.find(c => c.id === t.columnId);
            return !(column && column.autoComplete);
        });
        
        loadKanbanBoard();
        updateStatistics();
        saveData();
    }
}

function exportBoard() {
    const data = {
        board: {
            title: kanbanData.title,
            description: kanbanData.description,
            autoArchive: kanbanData.autoArchive,
            notifications: kanbanData.notifications
        },
        columns: kanbanData.columns,
        tasks: kanbanData.tasks,
        exportedAt: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${kanbanData.title || 'kanban'}_export.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// Drag and Drop
function setupDragAndDrop() {
    // This will be called after each board reload
    const taskCards = document.querySelectorAll('.task-card');
    const columns = document.querySelectorAll('.kanban-column');
    
    taskCards.forEach(card => {
        card.addEventListener('dragstart', function(e) {
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', this.dataset.taskId);
        });
        
        card.addEventListener('dragend', function() {
            this.classList.remove('dragging');
        });
    });
    
    columns.forEach(column => {
        column.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });
        
        column.addEventListener('dragleave', function() {
            this.classList.remove('drag-over');
        });
        
        column.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const taskId = parseInt(e.dataTransfer.getData('text/plain'));
            const newColumnId = parseInt(this.dataset.columnId);
            
            moveTask(taskId, newColumnId);
        });
    });
}

function moveTask(taskId, newColumnId) {
    const task = kanbanData.tasks.find(t => t.id === taskId);
    if (!task || task.columnId === newColumnId) return;
    
    // Check column limit
    const newColumn = kanbanData.columns.find(c => c.id === newColumnId);
    if (newColumn && newColumn.limit > 0) {
        const tasksInColumn = kanbanData.tasks.filter(t => t.columnId === newColumnId).length;
        if (tasksInColumn >= newColumn.limit) {
            alert(`La columna "${newColumn.title}" ha alcanzado su límite de ${newColumn.limit} tareas.`);
            return;
        }
    }
    
    // Move task via API
    moveTaskViaAPI(taskId, newColumn.title)
        .then(() => {
            console.log('Tarea movida correctamente');
        })
        .catch(error => {
            console.error('Error moving task:', error);
            alert('Error al mover la tarea: ' + error.message);
        });
}

// Data Persistence using new APIs
function saveData() {
    // Convert current data structure to new API format
    const columnsData = {};
    
    kanbanData.columns.forEach(column => {
        const columnTasks = kanbanData.tasks.filter(t => t.columnId === column.id);
        columnsData[column.title] = columnTasks.map(task => ({
            id: task.id,
            title: task.title,
            description: task.description || '',
            priority: task.priority || 'medium',
            due_date: task.dueDate || '',
            created_at: task.createdAt || new Date().toISOString(),
            updated_at: new Date().toISOString()
        }));
    });
    
    fetch(`/espacio-personal/api/blocks/{{ block.id }}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            title: kanbanData.title,
            content: kanbanData.description,
            metadata: {
                auto_archive: kanbanData.autoArchive,
                notifications: kanbanData.notifications,
                columns: columnsData
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Kanban guardado correctamente');
        }
    })
    .catch(error => console.error('Error saving kanban:', error));
}

// New API functions for task management
function addTaskViaAPI(columnName, taskData) {
    return fetch(`/espacio-personal/api/kanban/{{ block.id }}/tasks`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            column: columnName,
            title: taskData.title,
            description: taskData.description || '',
            priority: taskData.priority || 'medium',
            due_date: taskData.dueDate || ''
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadKanbanData(); // Reload data from server
            return data.task;
        }
        throw new Error(data.message || 'Error adding task');
    });
}

function updateTaskViaAPI(taskId, taskData) {
    return fetch(`/espacio-personal/api/kanban/{{ block.id }}/tasks/${taskId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadKanbanData(); // Reload data from server
            return data;
        }
        throw new Error(data.message || 'Error updating task');
    });
}

function deleteTaskViaAPI(taskId) {
    return fetch(`/espacio-personal/api/kanban/{{ block.id }}/tasks/${taskId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadKanbanData(); // Reload data from server
            return data;
        }
        throw new Error(data.message || 'Error deleting task');
    });
}

function moveTaskViaAPI(taskId, targetColumn) {
    return fetch(`/espacio-personal/api/kanban/{{ block.id }}/tasks/${taskId}/move`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            target_column: targetColumn
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadKanbanData(); // Reload data from server
            return data;
        }
        throw new Error(data.message || 'Error moving task');
    });
}

function addColumnViaAPI(columnName) {
    return fetch(`/espacio-personal/api/kanban/{{ block.id }}/columns`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            name: columnName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadKanbanData(); // Reload data from server
            return data;
        }
        throw new Error(data.message || 'Error adding column');
    });
}

function deleteColumnViaAPI(columnName) {
    return fetch(`/espacio-personal/api/kanban/{{ block.id }}/columns/${encodeURIComponent(columnName)}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadKanbanData(); // Reload data from server
            return data;
        }
        throw new Error(data.message || 'Error deleting column');
    });
}

// Load kanban data from server
function loadKanbanData() {
    fetch(`/espacio-personal/api/kanban/{{ block.id }}/tasks`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Convert server data to client format
            const columns = [];
            const tasks = [];
            let taskIdCounter = 1;
            let columnIdCounter = 1;
            
            Object.entries(data.columns).forEach(([columnName, columnTasks]) => {
                const columnId = columnIdCounter++;
                columns.push({
                    id: columnId,
                    title: columnName,
                    limit: 0,
                    autoComplete: columnName.toLowerCase().includes('hecho') || columnName.toLowerCase().includes('completado')
                });
                
                columnTasks.forEach(task => {
                    tasks.push({
                        id: task.id || taskIdCounter++,
                        title: task.title,
                        description: task.description || '',
                        priority: task.priority || 'medium',
                        dueDate: task.due_date || '',
                        columnId: columnId,
                        createdAt: task.created_at || new Date().toISOString(),
                        updatedAt: task.updated_at || new Date().toISOString()
                    });
                });
            });
            
            kanbanData.columns = columns;
            kanbanData.tasks = tasks;
            
            loadKanbanBoard();
            updateStatistics();
        }
    })
    .catch(error => {
        console.error('Error loading kanban data:', error);
        // Fallback to existing data structure
        loadKanbanBoard();
        updateStatistics();
    });
}

function getCsrfToken() {
    return document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
}
</script>
{% endblock %}
