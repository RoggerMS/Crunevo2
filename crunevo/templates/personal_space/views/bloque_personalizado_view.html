{% extends 'base.html' %}
{% block title %}Bloque Personalizado - {{ block.title }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personal-space.css') }}">
<style>
.bloque-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

.subject-header {
    background: linear-gradient(135deg, var(--bs-primary), var(--bs-primary-dark, #0056b3));
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
}

.subject-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    transform: translate(30px, -30px);
}

.subject-info {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 15px;
}

.subject-icon {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
}

.subject-details h2 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 600;
}

.subject-code {
    background: rgba(255, 255, 255, 0.2);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
    display: inline-block;
    margin-top: 5px;
}

.subject-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.stat-item {
    background: rgba(255, 255, 255, 0.15);
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: 600;
    display: block;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.elementos-section {
    margin-bottom: 30px;
}

.section-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--bs-border-color);
}

.section-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--bs-dark);
    margin: 0;
}

.add-elemento-btn {
    background: var(--bs-primary);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
}

.add-elemento-btn:hover {
    background: var(--bs-primary-dark, #0056b3);
    transform: translateY(-1px);
}

.elementos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
}

.elemento-card {
    background: white;
    border: 1px solid var(--bs-border-color);
    border-radius: 8px;
    padding: 15px;
    transition: all 0.2s;
    position: relative;
}

.elemento-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.elemento-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.elemento-icon {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    color: white;
}

.elemento-icon.tarea { background: #28a745; }
.elemento-icon.examen { background: #dc3545; }
.elemento-icon.proyecto { background: #ffc107; color: #000; }
.elemento-icon.nota { background: #17a2b8; }
.elemento-icon.enlace { background: #6f42c1; }

.elemento-title {
    font-weight: 600;
    margin: 0;
    flex-grow: 1;
}

.elemento-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    font-size: 0.85rem;
    color: var(--bs-secondary);
}

.elemento-fecha {
    display: flex;
    align-items: center;
    gap: 5px;
}

.elemento-prioridad {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.prioridad-alta { background: #ffebee; color: #c62828; }
.prioridad-media { background: #fff3e0; color: #ef6c00; }
.prioridad-baja { background: #e8f5e8; color: #2e7d32; }

.elemento-actions {
    position: absolute;
    top: 10px;
    right: 10px;
    opacity: 0;
    transition: opacity 0.2s;
}

.elemento-card:hover .elemento-actions {
    opacity: 1;
}

.action-btn {
    background: none;
    border: none;
    padding: 4px;
    margin-left: 5px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
}

.action-btn:hover {
    background: var(--bs-gray-200);
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--bs-secondary);
}

.empty-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.modal-content {
    border-radius: 12px;
}

.form-floating {
    margin-bottom: 15px;
}

.color-picker {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
}

.color-option {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.2s;
}

.color-option.selected {
    border-color: var(--bs-dark);
    transform: scale(1.1);
}

.progress-bar-custom {
    height: 8px;
    border-radius: 4px;
    background: var(--bs-gray-200);
    overflow: hidden;
    margin-top: 10px;
}

.progress-fill {
    height: 100%;
    background: var(--bs-success);
    transition: width 0.3s;
}
</style>
{% endblock %}

{% block content %}
<div class="bloque-container container py-4 tw-prose">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-collection me-2"></i>Gestión de Materia</h2>
            <p class="text-muted">Organiza todos los elementos de tu materia en un solo lugar</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="exportData()">
                <i class="bi bi-download"></i> Exportar
            </button>
            <button class="btn btn-primary" onclick="editSubject()">
                <i class="bi bi-gear"></i> Configurar
            </button>
            <a href="{{ url_for('personal_space.index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>
    
    <!-- Subject Header -->
    <div class="subject-header" id="subjectHeader">
        <div class="subject-info">
            <div class="subject-icon" id="subjectIcon">
                <i class="{{ block.get_metadata().get('subject', {}).get('icon', 'bi bi-book') }}"></i>
            </div>
            <div class="subject-details">
                <h2 id="subjectName">{{ block.get_metadata().get('subject', {}).get('name', 'Mi Materia') }}</h2>
                <span class="subject-code" id="subjectCode">{{ block.get_metadata().get('subject', {}).get('code', 'MAT-001') }}</span>
                <div class="mt-2">
                    <small><i class="bi bi-person me-1"></i><span id="subjectProfesor">{{ block.get_metadata().get('subject', {}).get('profesor', 'Profesor') }}</span></small>
                </div>
            </div>
        </div>
        
        <div class="subject-stats">
            <div class="stat-item">
                <span class="stat-number" id="totalTareas">0</span>
                <span class="stat-label">Tareas</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="tareasCompletadas">0</span>
                <span class="stat-label">Completadas</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="promedioNotas">0.0</span>
                <span class="stat-label">Promedio</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="proximoExamen">--</span>
                <span class="stat-label">Próximo Examen</span>
            </div>
        </div>
        
        <div class="progress-bar-custom">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
    </div>
    
    <!-- Elementos Sections -->
    <div id="elementosContainer">
        <!-- Las secciones se cargarán dinámicamente -->
    </div>
</div>

<!-- Modal para agregar/editar elemento -->
<div class="modal fade" id="elementoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Agregar Elemento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="elementoForm">
                    <div class="form-floating">
                        <select class="form-select" id="elementoTipo" required>
                            <option value="tarea">Tarea</option>
                            <option value="examen">Examen</option>
                            <option value="proyecto">Proyecto</option>
                            <option value="nota">Nota</option>
                            <option value="enlace">Enlace</option>
                        </select>
                        <label for="elementoTipo">Tipo de elemento</label>
                    </div>
                    
                    <div class="form-floating">
                        <input type="text" class="form-control" id="elementoTitulo" required>
                        <label for="elementoTitulo">Título</label>
                    </div>
                    
                    <div class="form-floating">
                        <textarea class="form-control" id="elementoDescripcion" style="height: 80px"></textarea>
                        <label for="elementoDescripcion">Descripción</label>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="date" class="form-control" id="elementoFecha">
                                <label for="elementoFecha">Fecha límite</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select" id="elementoPrioridad">
                                    <option value="baja">Baja</option>
                                    <option value="media" selected>Media</option>
                                    <option value="alta">Alta</option>
                                </select>
                                <label for="elementoPrioridad">Prioridad</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="camposEspecificos">
                        <!-- Campos específicos según el tipo -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveElemento()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para configurar materia -->
<div class="modal fade" id="subjectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configurar Materia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="subjectForm">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="subjectNameInput" required>
                        <label for="subjectNameInput">Nombre de la materia</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="subjectCodeInput">
                        <label for="subjectCodeInput">Código de la materia</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="subjectProfesorInput">
                        <label for="subjectProfesorInput">Profesor</label>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Color de la materia</label>
                        <div class="color-picker">
                            <div class="color-option" style="background: #007bff" data-color="#007bff"></div>
                            <div class="color-option" style="background: #28a745" data-color="#28a745"></div>
                            <div class="color-option" style="background: #dc3545" data-color="#dc3545"></div>
                            <div class="color-option" style="background: #ffc107" data-color="#ffc107"></div>
                            <div class="color-option" style="background: #17a2b8" data-color="#17a2b8"></div>
                            <div class="color-option" style="background: #6f42c1" data-color="#6f42c1"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveSubject()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
let bloqueData = {
    subject: {{ block.get_metadata().get('subject', {})|tojson }},
    elementos: {{ block.get_metadata().get('elementos', [])|tojson }}
};

let editingElementoId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadElementos();
    updateStats();
    setupEventListeners();
});

function setupEventListeners() {
    // Tipo de elemento change
    document.getElementById('elementoTipo').addEventListener('change', function() {
        updateCamposEspecificos(this.value);
    });
    
    // Color picker
    document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
        });
    });
}

function loadElementos() {
    const container = document.getElementById('elementosContainer');
    container.innerHTML = '';
    
    const tipos = ['tarea', 'examen', 'proyecto', 'nota', 'enlace'];
    const tiposLabels = {
        'tarea': 'Tareas',
        'examen': 'Exámenes',
        'proyecto': 'Proyectos',
        'nota': 'Notas',
        'enlace': 'Enlaces'
    };
    
    tipos.forEach(tipo => {
        const elementosTipo = bloqueData.elementos.filter(el => el.tipo === tipo);
        
        const section = document.createElement('div');
        section.className = 'elementos-section';
        
        section.innerHTML = `
            <div class="section-header">
                <h3 class="section-title">${tiposLabels[tipo]}</h3>
                <button class="add-elemento-btn" onclick="addElemento('${tipo}')">
                    <i class="bi bi-plus"></i> Agregar ${tipo}
                </button>
            </div>
            <div class="elementos-grid" id="${tipo}Grid">
                ${elementosTipo.length === 0 ? 
                    `<div class="empty-state">
                        <div class="empty-icon"><i class="bi bi-inbox"></i></div>
                        <p>No hay ${tiposLabels[tipo].toLowerCase()} agregados</p>
                    </div>` : 
                    elementosTipo.map(elemento => createElementoCard(elemento)).join('')
                }
            </div>
        `;
        
        container.appendChild(section);
    });
}

function createElementoCard(elemento) {
    const fechaFormatted = elemento.fecha ? new Date(elemento.fecha).toLocaleDateString() : '';
    const isOverdue = elemento.fecha && new Date(elemento.fecha) < new Date() && !elemento.completado;
    
    return `
        <div class="elemento-card ${isOverdue ? 'border-danger' : ''}">
            <div class="elemento-actions">
                <button class="action-btn" onclick="editElemento('${elemento.id}')">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="action-btn" onclick="deleteElemento('${elemento.id}')">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            
            <div class="elemento-header">
                <div class="elemento-icon ${elemento.tipo}">
                    <i class="${getElementoIcon(elemento.tipo)}"></i>
                </div>
                <h5 class="elemento-title">${elemento.titulo}</h5>
                ${elemento.tipo === 'tarea' ? 
                    `<input type="checkbox" ${elemento.completado ? 'checked' : ''} 
                            onchange="toggleCompletado('${elemento.id}')" class="form-check-input">` : 
                    ''
                }
            </div>
            
            ${elemento.descripcion ? `<p class="text-muted small mb-2">${elemento.descripcion}</p>` : ''}
            
            <div class="elemento-meta">
                <div class="elemento-fecha">
                    ${elemento.fecha ? `<i class="bi bi-calendar"></i> ${fechaFormatted}` : ''}
                </div>
                <span class="elemento-prioridad prioridad-${elemento.prioridad}">
                    ${elemento.prioridad.charAt(0).toUpperCase() + elemento.prioridad.slice(1)}
                </span>
            </div>
            
            ${elemento.nota ? `<div class="mt-2"><small><strong>Nota:</strong> ${elemento.nota}</small></div>` : ''}
        </div>
    `;
}

function getElementoIcon(tipo) {
    const icons = {
        'tarea': 'bi bi-check-square',
        'examen': 'bi bi-file-earmark-text',
        'proyecto': 'bi bi-folder',
        'nota': 'bi bi-sticky',
        'enlace': 'bi bi-link-45deg'
    };
    return icons[tipo] || 'bi bi-circle';
}

function addElemento(tipo) {
    editingElementoId = null;
    document.getElementById('modalTitle').textContent = `Agregar ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
    document.getElementById('elementoTipo').value = tipo;
    document.getElementById('elementoForm').reset();
    updateCamposEspecificos(tipo);
    
    const modal = new bootstrap.Modal(document.getElementById('elementoModal'));
    modal.show();
}

function editElemento(id) {
    const elemento = bloqueData.elementos.find(el => el.id === id);
    if (!elemento) return;
    
    editingElementoId = id;
    document.getElementById('modalTitle').textContent = 'Editar Elemento';
    
    // Llenar formulario
    document.getElementById('elementoTipo').value = elemento.tipo;
    document.getElementById('elementoTitulo').value = elemento.titulo;
    document.getElementById('elementoDescripcion').value = elemento.descripcion || '';
    document.getElementById('elementoFecha').value = elemento.fecha || '';
    document.getElementById('elementoPrioridad').value = elemento.prioridad;
    
    updateCamposEspecificos(elemento.tipo);
    
    // Llenar campos específicos
    if (elemento.nota) {
        const notaInput = document.getElementById('elementoNota');
        if (notaInput) notaInput.value = elemento.nota;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('elementoModal'));
    modal.show();
}

function updateCamposEspecificos(tipo) {
    const container = document.getElementById('camposEspecificos');
    
    switch (tipo) {
        case 'examen':
        case 'proyecto':
            container.innerHTML = `
                <div class="form-floating">
                    <input type="number" class="form-control" id="elementoNota" min="0" max="10" step="0.1">
                    <label for="elementoNota">Nota obtenida</label>
                </div>
            `;
            break;
        case 'enlace':
            container.innerHTML = `
                <div class="form-floating">
                    <input type="url" class="form-control" id="elementoUrl">
                    <label for="elementoUrl">URL del enlace</label>
                </div>
            `;
            break;
        default:
            container.innerHTML = '';
    }
}

function saveElemento() {
    const form = document.getElementById('elementoForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const elementoData = {
        id: editingElementoId || Date.now().toString(),
        tipo: document.getElementById('elementoTipo').value,
        titulo: document.getElementById('elementoTitulo').value,
        descripcion: document.getElementById('elementoDescripcion').value,
        fecha: document.getElementById('elementoFecha').value,
        prioridad: document.getElementById('elementoPrioridad').value,
        completado: false
    };
    
    // Campos específicos
    const notaInput = document.getElementById('elementoNota');
    if (notaInput && notaInput.value) {
        elementoData.nota = parseFloat(notaInput.value);
    }
    
    const urlInput = document.getElementById('elementoUrl');
    if (urlInput && urlInput.value) {
        elementoData.url = urlInput.value;
    }
    
    if (editingElementoId) {
        const index = bloqueData.elementos.findIndex(el => el.id === editingElementoId);
        if (index !== -1) {
            bloqueData.elementos[index] = { ...bloqueData.elementos[index], ...elementoData };
        }
    } else {
        bloqueData.elementos.push(elementoData);
    }
    
    saveData();
    loadElementos();
    updateStats();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('elementoModal'));
    modal.hide();
}

function deleteElemento(id) {
    if (confirm('¿Estás seguro de que quieres eliminar este elemento?')) {
        bloqueData.elementos = bloqueData.elementos.filter(el => el.id !== id);
        saveData();
        loadElementos();
        updateStats();
    }
}

function toggleCompletado(id) {
    const elemento = bloqueData.elementos.find(el => el.id === id);
    if (elemento) {
        elemento.completado = !elemento.completado;
        saveData();
        updateStats();
    }
}

function editSubject() {
    document.getElementById('subjectNameInput').value = bloqueData.subject.name || '';
    document.getElementById('subjectCodeInput').value = bloqueData.subject.code || '';
    document.getElementById('subjectProfesorInput').value = bloqueData.subject.profesor || '';
    
    // Seleccionar color actual
    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
    const currentColor = bloqueData.subject.color || '#007bff';
    const colorOption = document.querySelector(`[data-color="${currentColor}"]`);
    if (colorOption) colorOption.classList.add('selected');
    
    const modal = new bootstrap.Modal(document.getElementById('subjectModal'));
    modal.show();
}

function saveSubject() {
    const selectedColor = document.querySelector('.color-option.selected');
    
    bloqueData.subject = {
        name: document.getElementById('subjectNameInput').value,
        code: document.getElementById('subjectCodeInput').value,
        profesor: document.getElementById('subjectProfesorInput').value,
        color: selectedColor ? selectedColor.dataset.color : '#007bff',
        icon: bloqueData.subject.icon || 'bi bi-book'
    };
    
    updateSubjectHeader();
    saveData();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('subjectModal'));
    modal.hide();
}

function updateSubjectHeader() {
    document.getElementById('subjectName').textContent = bloqueData.subject.name || 'Mi Materia';
    document.getElementById('subjectCode').textContent = bloqueData.subject.code || 'MAT-001';
    document.getElementById('subjectProfesor').textContent = bloqueData.subject.profesor || 'Profesor';
    
    const header = document.getElementById('subjectHeader');
    if (bloqueData.subject.color) {
        header.style.background = `linear-gradient(135deg, ${bloqueData.subject.color}, ${bloqueData.subject.color}dd)`;
    }
}

function updateStats() {
    const tareas = bloqueData.elementos.filter(el => el.tipo === 'tarea');
    const tareasCompletadas = tareas.filter(t => t.completado);
    const examenes = bloqueData.elementos.filter(el => el.tipo === 'examen' && el.nota);
    
    document.getElementById('totalTareas').textContent = tareas.length;
    document.getElementById('tareasCompletadas').textContent = tareasCompletadas.length;
    
    // Promedio de notas
    if (examenes.length > 0) {
        const promedio = examenes.reduce((sum, ex) => sum + ex.nota, 0) / examenes.length;
        document.getElementById('promedioNotas').textContent = promedio.toFixed(1);
    } else {
        document.getElementById('promedioNotas').textContent = '0.0';
    }
    
    // Próximo examen
    const proximosExamenes = bloqueData.elementos
        .filter(el => el.tipo === 'examen' && el.fecha && new Date(el.fecha) > new Date())
        .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
    
    if (proximosExamenes.length > 0) {
        const fecha = new Date(proximosExamenes[0].fecha);
        const dias = Math.ceil((fecha - new Date()) / (1000 * 60 * 60 * 24));
        document.getElementById('proximoExamen').textContent = `${dias}d`;
    } else {
        document.getElementById('proximoExamen').textContent = '--';
    }
    
    // Progreso
    const progreso = tareas.length > 0 ? (tareasCompletadas.length / tareas.length) * 100 : 0;
    document.getElementById('progressFill').style.width = `${progreso}%`;
}

function saveData() {
    fetch(`/espacio-personal/api/blocks/{{ block.id }}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            title: document.getElementById('subjectName').textContent,
            metadata: {
                subject: bloqueData.subject,
                elementos: bloqueData.elementos
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Datos guardados correctamente');
        }
    })
    .catch(error => console.error('Error saving data:', error));
}

function exportData() {
    const data = {
        materia: bloqueData.subject,
        elementos: bloqueData.elementos,
        estadisticas: {
            totalTareas: bloqueData.elementos.filter(el => el.tipo === 'tarea').length,
            tareasCompletadas: bloqueData.elementos.filter(el => el.tipo === 'tarea' && el.completado).length,
            totalExamenes: bloqueData.elementos.filter(el => el.tipo === 'examen').length,
            promedioNotas: bloqueData.elementos.filter(el => el.tipo === 'examen' && el.nota).reduce((sum, ex, _, arr) => sum + ex.nota / arr.length, 0)
        }
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${bloqueData.subject.name || 'materia'}_datos.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function getCsrfToken() {
    return document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
}
</script>
{% endblock %}