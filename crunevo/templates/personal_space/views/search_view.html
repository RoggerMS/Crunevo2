{% extends 'base.html' %}
{% block title %}Búsqueda - Mi Espacio Personal{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personal-space.css') }}">
<style>
.search-container {
    background: white;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(139, 92, 246, 0.1);
    padding: 2.5rem;
    margin-bottom: 2.5rem;
    border: 1px solid rgba(139, 92, 246, 0.1);
    transition: all 0.3s ease;
}

.search-container:hover {
    box-shadow: 0 12px 40px rgba(139, 92, 246, 0.15);
}

.dark-mode .search-container {
    background: #1e293b;
    color: white;
    border-color: rgba(139, 92, 246, 0.2);
}

.search-header {
    text-align: center;
    margin-bottom: 3rem;
}

.search-box {
    position: relative;
    max-width: 700px;
    margin: 0 auto 3rem;
}

.search-input {
    width: 100%;
    padding: 1.25rem 1.25rem 1.25rem 3.5rem;
    border: 2px solid rgba(139, 92, 246, 0.2);
    border-radius: 16px;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    background: white;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.05);
}

.search-input:focus {
    border-color: #8b5cf6;
    box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1), 0 8px 20px rgba(139, 92, 246, 0.1);
    outline: none;
    transform: translateY(-2px);
}

.search-icon {
    position: absolute;
    left: 1.25rem;
    top: 50%;
    transform: translateY(-50%);
    color: #8b5cf6;
    font-size: 1.3rem;
}

.search-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    justify-content: center;
    margin-bottom: 3rem;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.filter-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: #8b5cf6;
    letter-spacing: 0.025em;
}

.filter-select {
    padding: 0.75rem 1.25rem;
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 12px;
    background: white;
    min-width: 180px;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.05);
}

.filter-select:focus {
    border-color: #8b5cf6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1), 0 4px 12px rgba(139, 92, 246, 0.1);
    outline: none;
}

.dark-mode .filter-select {
    background: #374151;
    border-color: rgba(139, 92, 246, 0.3);
    color: white;
}

.quick-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: center;
    margin-bottom: 3rem;
}

.quick-filter {
    padding: 0.75rem 1.5rem;
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 25px;
    background: white;
    color: #6b7280;
    text-decoration: none;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.05);
}

.quick-filter:hover {
    border-color: #8b5cf6;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05));
    color: #8b5cf6;
    text-decoration: none;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
}

.quick-filter.active {
    border-color: #8b5cf6;
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    color: white;
    text-decoration: none;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}

.search-results {
    margin-top: 3rem;
}

.results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid rgba(139, 92, 246, 0.1);
}

.dark-mode .results-header {
    border-bottom-color: rgba(139, 92, 246, 0.2);
}

.results-count {
    color: #6b7280;
    font-size: 0.95rem;
    font-weight: 500;
}

.sort-options {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.sort-select {
    padding: 0.5rem 0.75rem;
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 8px;
    background: white;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(139, 92, 246, 0.05);
}

.sort-select:focus {
    border-color: #8b5cf6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    outline: none;
}

.dark-mode .sort-select {
    background: #374151;
    border-color: rgba(139, 92, 246, 0.3);
    color: white;
}

.result-item {
    border: 1px solid rgba(139, 92, 246, 0.1);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 1.5rem;
    transition: all 0.4s ease;
    cursor: pointer;
    background: white;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.05);
}

.result-item:hover {
    border-color: #8b5cf6;
    transform: translateY(-4px) scale(1.01);
    box-shadow: 0 12px 25px rgba(139, 92, 246, 0.2);
}

.dark-mode .result-item {
    border-color: rgba(139, 92, 246, 0.2);
    background: #374151;
}

.result-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
}

.result-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1.5rem;
    font-size: 1.4rem;
    color: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
}

.result-icon:hover {
    transform: scale(1.1) rotate(5deg);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

.result-icon.nota {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}

.result-icon.kanban {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.result-icon.objetivo {
    background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
}

.result-icon.tarea {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.result-icon.recordatorio {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.result-content {
    flex: 1;
}

.result-title {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: #1f2937;
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.dark-mode .result-title {
    background: linear-gradient(135deg, #a78bfa, #8b5cf6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.result-description {
    color: #6b7280;
    margin-bottom: 1rem;
    line-height: 1.6;
    font-size: 0.95rem;
}

.result-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1.25rem;
    align-items: center;
    font-size: 0.9rem;
    color: #6b7280;
}

.result-type {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05));
    color: #8b5cf6;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 500;
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 12px;
    font-weight: 500;
}

.dark-mode .result-type {
    background: rgba(139, 92, 246, 0.2);
    color: #a78bfa;
    border-color: rgba(139, 92, 246, 0.3);
}

.result-date {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
}

.result-actions {
    display: flex;
    gap: 0.75rem;
    margin-left: auto;
}

.no-results {
    text-align: center;
    padding: 4rem 2rem;
    color: #6b7280;
}

.no-results i {
    font-size: 4rem;
    margin-bottom: 1.5rem;
    color: rgba(139, 92, 246, 0.3);
}

.search-suggestions {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(139, 92, 246, 0.02));
    border: 1px solid rgba(139, 92, 246, 0.1);
    border-radius: 16px;
    padding: 1.5rem;
    margin-top: 1.5rem;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.05);
}

.dark-mode .search-suggestions {
    background: rgba(139, 92, 246, 0.1);
    border-color: rgba(139, 92, 246, 0.2);
}

.suggestion-item {
    display: inline-block;
    background: white;
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 20px;
    padding: 0.5rem 1rem;
    margin: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    font-weight: 500;
    box-shadow: 0 2px 6px rgba(139, 92, 246, 0.1);
}

.suggestion-item:hover {
    border-color: #8b5cf6;
    background: #8b5cf6;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(139, 92, 246, 0.3);
}

.dark-mode .suggestion-item {
    background: #4b5563;
    border-color: rgba(139, 92, 246, 0.3);
    color: white;
}

.advanced-search {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(139, 92, 246, 0.02));
    border: 1px solid rgba(139, 92, 246, 0.1);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2.5rem;
    display: none;
    box-shadow: 0 8px 20px rgba(139, 92, 246, 0.08);
    transition: all 0.3s ease;
}

.dark-mode .advanced-search {
    background: rgba(139, 92, 246, 0.1);
    border-color: rgba(139, 92, 246, 0.2);
}

.advanced-search.show {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.advanced-row {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    align-items: end;
}

.advanced-field {
    flex: 1;
}

.advanced-field label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #374151;
}

.dark-mode .advanced-field label {
    color: white;
}

.advanced-field input,
.advanced-field select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: white;
}

.dark-mode .advanced-field input,
.dark-mode .advanced-field select {
    background: #4b5563;
    border-color: #6b7280;
    color: white;
}

.toggle-advanced {
    background: none;
    border: none;
    color: #8b5cf6;
    text-decoration: underline;
    cursor: pointer;
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

.highlight {
    background: #fef3c7;
    padding: 0.1rem 0.2rem;
    border-radius: 3px;
}

.dark-mode .highlight {
    background: #92400e;
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="personal-space-container">
    <!-- Modern Header -->
    <div class="modern-block-container">
        <div class="modern-hero">
            <div class="hero-content">
                <h1 class="hero-title">
                    <i class="bi bi-search"></i>
                    Búsqueda Avanzada
                </h1>
                <p class="hero-subtitle">Encuentra cualquier bloque en tu espacio personal con búsqueda inteligente</p>
                
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-files"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">1,247</div>
                            <div class="stat-label">Bloques Totales</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-search"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">89</div>
                            <div class="stat-label">Búsquedas Recientes</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">0.3s</div>
                            <div class="stat-label">Tiempo Promedio</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-bookmark"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">12</div>
                            <div class="stat-label">Búsquedas Guardadas</div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="hero-actions">
                    <button class="modern-btn modern-btn-primary" onclick="saveSearch()">
                        <i class="bi bi-bookmark"></i>
                        Guardar Búsqueda
                    </button>
                    <a href="{{ url_for('personal_space.dashboard') }}" class="modern-btn modern-btn-secondary">
                        <i class="bi bi-arrow-left"></i>
                        Volver al Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Búsqueda Principal -->
        <div class="search-container">
            <div class="search-header">
                <h3>¿Qué estás buscando?</h3>
                <p class="text-muted">Busca por título, contenido, tipo de bloque o fecha</p>
            </div>

            <!-- Caja de Búsqueda -->
            <div class="search-box">
                <i class="bi bi-search search-icon"></i>
                <input type="text" class="search-input" id="searchInput" 
                       placeholder="Buscar en mis bloques..." 
                       onkeyup="performSearch()" 
                       autocomplete="off">
            </div>

            <!-- Botón para Búsqueda Avanzada -->
            <div class="text-center">
                <button class="toggle-advanced" onclick="toggleAdvancedSearch()">
                    <i class="bi bi-sliders"></i> Búsqueda Avanzada
                </button>
            </div>

            <!-- Búsqueda Avanzada -->
            <div class="advanced-search" id="advancedSearch">
                <h5 class="mb-3">Filtros Avanzados</h5>
                <div class="advanced-row">
                    <div class="advanced-field">
                        <label>Tipo de Bloque</label>
                        <select id="blockType" onchange="performSearch()">
                            <option value="">Todos los tipos</option>
                            <option value="nota">Notas</option>
                            <option value="kanban">Tableros Kanban</option>
                            <option value="objetivo">Objetivos</option>
                            <option value="tarea">Tareas</option>
                            <option value="recordatorio">Recordatorios</option>
                            <option value="enlace">Enlaces</option>
                            <option value="frase">Frases Motivacionales</option>
                            <option value="lista">Listas</option>
                            <option value="bloque">Bloques Personalizados</option>
                        </select>
                    </div>
                    <div class="advanced-field">
                        <label>Estado</label>
                        <select id="blockStatus" onchange="performSearch()">
                            <option value="">Cualquier estado</option>
                            <option value="active">Activo</option>
                            <option value="completed">Completado</option>
                            <option value="pending">Pendiente</option>
                            <option value="overdue">Vencido</option>
                        </select>
                    </div>
                    <div class="advanced-field">
                        <label>Fecha de Creación</label>
                        <select id="dateRange" onchange="performSearch()">
                            <option value="">Cualquier fecha</option>
                            <option value="today">Hoy</option>
                            <option value="week">Esta semana</option>
                            <option value="month">Este mes</option>
                            <option value="year">Este año</option>
                        </select>
                    </div>
                </div>
                <div class="advanced-row">
                    <div class="advanced-field">
                        <label>Fecha Desde</label>
                        <input type="date" id="dateFrom" onchange="performSearch()">
                    </div>
                    <div class="advanced-field">
                        <label>Fecha Hasta</label>
                        <input type="date" id="dateTo" onchange="performSearch()">
                    </div>
                    <div class="advanced-field">
                        <label>Destacado</label>
                        <select id="featured" onchange="performSearch()">
                            <option value="">Todos</option>
                            <option value="true">Solo destacados</option>
                            <option value="false">No destacados</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Filtros Rápidos -->
            <div class="quick-filters">
                <a href="#" class="quick-filter" onclick="quickFilter('recent')">
                    <i class="bi bi-clock me-1"></i> Recientes
                </a>
                <a href="#" class="quick-filter" onclick="quickFilter('featured')">
                    <i class="bi bi-star me-1"></i> Destacados
                </a>
                <a href="#" class="quick-filter" onclick="quickFilter('completed')">
                    <i class="bi bi-check-circle me-1"></i> Completados
                </a>
                <a href="#" class="quick-filter" onclick="quickFilter('pending')">
                    <i class="bi bi-clock-history me-1"></i> Pendientes
                </a>
                <a href="#" class="quick-filter" onclick="quickFilter('notes')">
                    <i class="bi bi-journal-text me-1"></i> Notas
                </a>
                <a href="#" class="quick-filter" onclick="quickFilter('goals')">
                    <i class="bi bi-target me-1"></i> Objetivos
                </a>
                <a href="#" class="quick-filter" onclick="quickFilter('kanban')">
                    <i class="bi bi-kanban me-1"></i> Tableros
                </a>
            </div>
        </div>

        <!-- Resultados de Búsqueda -->
        <div class="search-results" id="searchResults" style="display: none;">
            <div class="results-header">
                <div class="results-count" id="resultsCount">
                    <!-- Se actualiza dinámicamente -->
                </div>
                <div class="sort-options">
                    <label for="sortBy" class="me-2">Ordenar por:</label>
                    <select id="sortBy" class="sort-select" onchange="sortResults()">
                        <option value="relevance">Relevancia</option>
                        <option value="date_desc">Más reciente</option>
                        <option value="date_asc">Más antiguo</option>
                        <option value="title">Título A-Z</option>
                        <option value="type">Tipo</option>
                    </select>
                </div>
            </div>

            <div id="resultsList">
                <!-- Los resultados se cargan dinámicamente -->
            </div>

            <!-- Estado sin resultados -->
            <div class="no-results" id="noResults" style="display: none;">
                <i class="bi bi-search"></i>
                <h4>No se encontraron resultados</h4>
                <p>Intenta con diferentes términos de búsqueda o ajusta los filtros.</p>
                
                <div class="search-suggestions">
                    <h6>Sugerencias:</h6>
                    <div class="suggestion-item" onclick="applySuggestion('nota')">Buscar notas</div>
                    <div class="suggestion-item" onclick="applySuggestion('objetivo')">Buscar objetivos</div>
                    <div class="suggestion-item" onclick="applySuggestion('kanban')">Buscar tableros</div>
                    <div class="suggestion-item" onclick="applySuggestion('completado')">Buscar completados</div>
                    <div class="suggestion-item" onclick="applySuggestion('pendiente')">Buscar pendientes</div>
                </div>
            </div>
        </div>

        <!-- Estado inicial -->
        <div class="search-container" id="initialState">
            <div class="text-center py-5">
                <i class="bi bi-search" style="font-size: 4rem; color: #d1d5db; margin-bottom: 1rem;"></i>
                <h4>Comienza a buscar</h4>
                <p class="text-muted">Escribe algo en la caja de búsqueda para encontrar tus bloques</p>
                
                <div class="mt-4">
                    <h6>Búsquedas populares:</h6>
                    <div class="quick-filters justify-content-center">
                        <a href="#" class="quick-filter" onclick="applySuggestion('matemáticas')">
                            matemáticas
                        </a>
                        <a href="#" class="quick-filter" onclick="applySuggestion('proyecto')">
                            proyecto
                        </a>
                        <a href="#" class="quick-filter" onclick="applySuggestion('examen')">
                            examen
                        </a>
                        <a href="#" class="quick-filter" onclick="applySuggestion('tarea')">
                            tarea
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let searchTimeout;
let currentResults = [];
let searchHistory = [];

document.addEventListener('DOMContentLoaded', function() {
    loadSearchHistory();
    
    // Enfocar automáticamente en la caja de búsqueda
    document.getElementById('searchInput').focus();
    
    // Atajos de teclado
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'k') {
            e.preventDefault();
            document.getElementById('searchInput').focus();
        }
        if (e.key === 'Escape') {
            clearSearch();
        }
    });
});

function performSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const query = document.getElementById('searchInput').value.trim();
        
        if (query.length === 0) {
            showInitialState();
            return;
        }
        
        if (query.length < 2) {
            return;
        }
        
        const filters = getSearchFilters();
        executeSearch(query, filters);
    }, 300);
}

function getSearchFilters() {
    return {
        type: document.getElementById('blockType')?.value || '',
        status: document.getElementById('blockStatus')?.value || '',
        dateRange: document.getElementById('dateRange')?.value || '',
        dateFrom: document.getElementById('dateFrom')?.value || '',
        dateTo: document.getElementById('dateTo')?.value || '',
        featured: document.getElementById('featured')?.value || ''
    };
}

function executeSearch(query, filters) {
    // Mostrar loading
    showSearchResults();
    document.getElementById('resultsList').innerHTML = '<div class="text-center py-4"><i class="bi bi-hourglass-split"></i> Buscando...</div>';
    
    // Realizar búsqueda
    fetch('/espacio-personal/api/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            query: query,
            filters: filters
        })
    })
    .then(response => response.json())
    .then(data => {
        currentResults = data.results;
        displayResults(data.results, query);
        updateResultsCount(data.results.length, query);
        
        // Guardar en historial
        addToSearchHistory(query);
    })
    .catch(error => {
        console.error('Error en búsqueda:', error);
        showError('Error al realizar la búsqueda');
    });
}

function displayResults(results, query) {
    const resultsList = document.getElementById('resultsList');
    const noResults = document.getElementById('noResults');
    
    if (results.length === 0) {
        resultsList.style.display = 'none';
        noResults.style.display = 'block';
        return;
    }
    
    resultsList.style.display = 'block';
    noResults.style.display = 'none';
    
    resultsList.innerHTML = results.map(result => createResultHTML(result, query)).join('');
}

function createResultHTML(result, query) {
    const highlightedTitle = highlightText(result.title, query);
    const highlightedContent = highlightText(result.content || '', query);
    
    return `
        <div class="result-item" onclick="openBlock(${result.id})">
            <div class="result-header">
                <div class="result-icon ${result.type}">
                    <i class="bi bi-${getBlockIcon(result.type)}"></i>
                </div>
                <div class="result-content">
                    <h5 class="result-title">${highlightedTitle}</h5>
                    <p class="result-description">${highlightedContent}</p>
                    <div class="result-meta">
                        <span class="result-type">${getBlockTypeName(result.type)}</span>
                        <span class="result-date">
                            <i class="bi bi-calendar me-1"></i>
                            ${formatDate(result.created_at)}
                        </span>
                        ${result.is_featured ? '<span class="text-warning"><i class="bi bi-star-fill"></i></span>' : ''}
                        ${result.progress ? `<span class="text-success">${result.progress}% completado</span>` : ''}
                    </div>
                </div>
                <div class="result-actions">
                    <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); editBlock(${result.id})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); shareBlock(${result.id})">
                        <i class="bi bi-share"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

function highlightText(text, query) {
    if (!query || !text) return text;
    
    const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
}

function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function getBlockIcon(type) {
    const icons = {
        'nota': 'journal-text',
        'kanban': 'kanban',
        'objetivo': 'target',
        'tarea': 'check-square',
        'recordatorio': 'alarm',
        'enlace': 'link-45deg',
        'frase': 'chat-quote',
        'lista': 'list-ul',
        'bloque': 'square'
    };
    return icons[type] || 'square';
}

function getBlockTypeName(type) {
    const names = {
        'nota': 'Nota',
        'kanban': 'Tablero Kanban',
        'objetivo': 'Objetivo',
        'tarea': 'Tarea',
        'recordatorio': 'Recordatorio',
        'enlace': 'Enlace',
        'frase': 'Frase Motivacional',
        'lista': 'Lista',
        'bloque': 'Bloque Personalizado'
    };
    return names[type] || 'Bloque';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 1) return 'Ayer';
    if (diffDays < 7) return `Hace ${diffDays} días`;
    if (diffDays < 30) return `Hace ${Math.ceil(diffDays / 7)} semanas`;
    
    return date.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function updateResultsCount(count, query) {
    const resultsCount = document.getElementById('resultsCount');
    resultsCount.textContent = `${count} resultado${count !== 1 ? 's' : ''} para "${query}"`;
}

function sortResults() {
    const sortBy = document.getElementById('sortBy').value;
    
    currentResults.sort((a, b) => {
        switch (sortBy) {
            case 'date_desc':
                return new Date(b.created_at) - new Date(a.created_at);
            case 'date_asc':
                return new Date(a.created_at) - new Date(b.created_at);
            case 'title':
                return a.title.localeCompare(b.title);
            case 'type':
                return a.type.localeCompare(b.type);
            default: // relevance
                return b.relevance - a.relevance;
        }
    });
    
    const query = document.getElementById('searchInput').value;
    displayResults(currentResults, query);
}

function toggleAdvancedSearch() {
    const advancedSearch = document.getElementById('advancedSearch');
    advancedSearch.classList.toggle('show');
    
    const button = event.target;
    if (advancedSearch.classList.contains('show')) {
        button.innerHTML = '<i class="bi bi-sliders"></i> Ocultar Búsqueda Avanzada';
    } else {
        button.innerHTML = '<i class="bi bi-sliders"></i> Búsqueda Avanzada';
    }
}

function quickFilter(filter) {
    // Remover clase active de todos los filtros
    document.querySelectorAll('.quick-filter').forEach(f => f.classList.remove('active'));
    event.target.classList.add('active');
    
    // Aplicar filtro
    switch (filter) {
        case 'recent':
            document.getElementById('dateRange').value = 'week';
            break;
        case 'featured':
            document.getElementById('featured').value = 'true';
            break;
        case 'completed':
            document.getElementById('blockStatus').value = 'completed';
            break;
        case 'pending':
            document.getElementById('blockStatus').value = 'pending';
            break;
        case 'notes':
            document.getElementById('blockType').value = 'nota';
            break;
        case 'goals':
            document.getElementById('blockType').value = 'objetivo';
            break;
        case 'kanban':
            document.getElementById('blockType').value = 'kanban';
            break;
    }
    
    performSearch();
}

function applySuggestion(suggestion) {
    document.getElementById('searchInput').value = suggestion;
    performSearch();
}

function showSearchResults() {
    document.getElementById('searchResults').style.display = 'block';
    document.getElementById('initialState').style.display = 'none';
}

function showInitialState() {
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('initialState').style.display = 'block';
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('blockType').value = '';
    document.getElementById('blockStatus').value = '';
    document.getElementById('dateRange').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    document.getElementById('featured').value = '';
    
    document.querySelectorAll('.quick-filter').forEach(f => f.classList.remove('active'));
    
    showInitialState();
}

function openBlock(blockId) {
    window.location.href = `/espacio-personal/bloque/${blockId}`;
}

function editBlock(blockId) {
    window.location.href = `/espacio-personal/bloque/${blockId}/editar`;
}

function shareBlock(blockId) {
    // Implementar funcionalidad de compartir
    navigator.clipboard.writeText(`${window.location.origin}/espacio-personal/bloque/${blockId}`);
    alert('Enlace copiado al portapapeles');
}

function saveSearch() {
    const query = document.getElementById('searchInput').value;
    const filters = getSearchFilters();
    
    if (!query) {
        alert('Ingresa una búsqueda para guardar');
        return;
    }
    
    const name = prompt('Nombre para esta búsqueda guardada:');
    if (name) {
        fetch('/espacio-personal/api/saved-searches', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                name: name,
                query: query,
                filters: filters
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Búsqueda guardada exitosamente');
            } else {
                alert('Error al guardar la búsqueda');
            }
        })
        .catch(error => {
            console.error('Error al guardar búsqueda:', error);
            alert('Error al guardar la búsqueda');
        });
    }
}

function addToSearchHistory(query) {
    if (!searchHistory.includes(query)) {
        searchHistory.unshift(query);
        if (searchHistory.length > 10) {
            searchHistory.pop();
        }
        localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
    }
}

function loadSearchHistory() {
    const saved = localStorage.getItem('searchHistory');
    if (saved) {
        searchHistory = JSON.parse(saved);
    }
}

function showError(message) {
    document.getElementById('resultsList').innerHTML = `
        <div class="text-center py-4 text-danger">
            <i class="bi bi-exclamation-triangle"></i>
            <p>${message}</p>
        </div>
    `;
}

function getCsrfToken() {
    return document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
}
</script>
{% endblock %}