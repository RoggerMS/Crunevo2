{% extends 'base.html' %}
{% from 'components/csrf.html' import csrf_field %}
{% set app = url_for.__globals__.get('current_app') %}

{% block title %}Tarea - {{ block.title }}{% endblock %}

{% block content %}
<header id="task-header" data-section="header">
  <nav>
    <a href="{{ request.referrer or (url_for('personal_space.index') if app and 'personal_space.index' in app.view_functions else '#') }}" data-action="back">Volver</a>
    <a href="{{ url_for('personal_space.settings_view') if app and 'personal_space.settings_view' in app.view_functions else '#' }}" data-action="settings">Configurar</a>
    <a href="{{ url_for('personal_space.link_note', block_id=block.id) if app and 'personal_space.link_note' in app.view_functions else '#' }}" data-action="link-note">Añadir desde Apuntes</a>
    <a href="{{ url_for('personal_space.link_forum', block_id=block.id) if app and 'personal_space.link_forum' in app.view_functions else '#' }}" data-action="link-forum">Añadir desde Foro</a>
  </nav>
  <h1 id="task-title">{{ block.title }}</h1>
  <form method="post" action="{{ url_for('personal_space.update_block', block_id=block.id) if app and 'personal_space.update_block' in app.view_functions else '' }}">
    {{ csrf_field() }}
    <label for="title">Título</label>
    <input id="title" name="title" type="text" value="{{ block.title }}">
    <label for="type">Tipo</label>
    <select id="type" name="type">
      <option value="tarea"{% if block.type == 'tarea' %} selected{% endif %}>tarea</option>
      <option value="objetivo"{% if block.type == 'objetivo' %} selected{% endif %}>objetivo</option>
      <option value="estudio"{% if block.type == 'estudio' %} selected{% endif %}>estudio</option>
    </select>
    <label for="priority">Prioridad</label>
    <select id="priority" name="priority">
      <option value="alta"{% if block.priority == 'alta' %} selected{% endif %}>alta</option>
      <option value="media"{% if block.priority == 'media' %} selected{% endif %}>media</option>
      <option value="baja"{% if block.priority == 'baja' %} selected{% endif %}>baja</option>
    </select>
    <label for="due_date">Fecha límite</label>
    <input id="due_date" name="due_date" type="date" value="{{ block.due_date }}">
    <button type="submit" data-action="save-block">Guardar</button>
  </form>
</header>

<section id="task-progress" data-section="progress" aria-live="polite">
  Progreso: {{ stats.progress_pct }}% — {{ stats.done }} / {{ stats.total }} completadas
</section>

<main id="task-main" data-section="main">
  <section id="left" data-section="work">
    <section id="description" data-block="description">
      <form method="post" action="{{ url_for('personal_space.update_block', block_id=block.id) if app and 'personal_space.update_block' in app.view_functions else '' }}">
        {{ csrf_field() }}
        <label for="description-text">Descripción</label>
        <textarea id="description-text" name="description">{{ block.description }}</textarea>
        <button type="submit" data-action="save-description">Guardar</button>
      </form>
    </section>

    <section id="subtasks" data-block="subtasks">
      <form method="get" action="">
        <fieldset>
          <legend>Filtrar</legend>
          <label for="filter-all"><input id="filter-all" type="radio" name="filter" value="all"{% if request.args.get('filter','all') == 'all' %} checked{% endif %}> Todas</label>
          <label for="filter-pending"><input id="filter-pending" type="radio" name="filter" value="pending"{% if request.args.get('filter') == 'pending' %} checked{% endif %}> Pendientes</label>
          <label for="filter-done"><input id="filter-done" type="radio" name="filter" value="done"{% if request.args.get('filter') == 'done' %} checked{% endif %}> Completadas</label>
        </fieldset>
        <button type="submit" data-action="apply-filter">Aplicar</button>
      </form>

      <ul>
        {% for subtask in subtasks %}
        <li data-subtask-id="{{ subtask.id }}">
          <form method="post" action="{{ url_for('personal_space.toggle_subtask', subtask_id=subtask.id) if app and 'personal_space.toggle_subtask' in app.view_functions else '' }}">
            {{ csrf_field() }}
            <input type="checkbox" id="subtask-{{ subtask.id }}" name="done"{% if subtask.done %} checked{% endif %} onchange="this.form.submit()">
            <input type="hidden" name="next" value="{{ request.full_path }}">
            <label for="subtask-{{ subtask.id }}">{{ subtask.title }}</label>
          </form>
          <small>Prioridad: {{ subtask.priority }}{% if subtask.due_date %} | Vence: {{ subtask.due_date }}{% endif %}</small>
          <a href="{{ url_for('personal_space.delete_subtask', subtask_id=subtask.id) if app and 'personal_space.delete_subtask' in app.view_functions else '#' }}" data-action="delete-subtask">Eliminar</a>
        </li>
        {% else %}
        <li>No hay subtareas</li>
        {% endfor %}
      </ul>

      <form method="post" action="{{ url_for('personal_space.add_subtask', block_id=block.id) if app and 'personal_space.add_subtask' in app.view_functions else '' }}">
        {{ csrf_field() }}
        <label for="new-title">Título</label>
        <input id="new-title" name="title" type="text" required>
        <label for="new-priority">Prioridad</label>
        <select id="new-priority" name="priority">
          <option value="alta">alta</option>
          <option value="media">media</option>
          <option value="baja">baja</option>
        </select>
        <label for="new-due-date">Fecha límite</label>
        <input id="new-due-date" name="due_date" type="date">
        <button type="submit" data-action="add-subtask">Añadir</button>
      </form>

      <form method="post" action="{{ url_for('personal_space.reorder_subtasks', block_id=block.id) if app and 'personal_space.reorder_subtasks' in app.view_functions else '' }}">
        {{ csrf_field() }}
        <label for="order-json">Nuevo orden</label>
        <input id="order-json" name="order_json" type="text">
        <button type="submit" data-action="reorder-subtasks">Reordenar</button>
      </form>
    </section>
  </section>

  <aside id="right" data-section="side">
    <section id="linked-resources" data-block="resources">
      <section>
        <h2>Apuntes</h2>
        <ul>
          {% for note in linked_notes %}
          <li>
            <a href="{{ note.url }}" target="_blank">{{ note.title }}</a>
            <a href="{{ url_for('personal_space.unlink_resource', kind='note', resource_id=note.id) if app and 'personal_space.unlink_resource' in app.view_functions else '#' }}" data-action="unlink-note">Quitar</a>
          </li>
          {% else %}
          <li>No hay apuntes vinculados</li>
          {% endfor %}
        </ul>
      </section>
      <section>
        <h2>Foro</h2>
        <ul>
          {% for post in linked_forum_posts %}
          <li>
            <a href="{{ post.url }}" target="_blank">{{ post.title }}</a>
            <a href="{{ url_for('personal_space.unlink_resource', kind='forum', resource_id=post.id) if app and 'personal_space.unlink_resource' in app.view_functions else '#' }}" data-action="unlink-forum">Quitar</a>
          </li>
          {% else %}
          <li>No hay publicaciones vinculadas</li>
          {% endfor %}
        </ul>
      </section>
    </section>

    <section id="dates" data-block="dates">
      <p>Fecha límite del bloque: {{ block.due_date }}</p>
      <p>Estado: {{ block.status }}</p>
    </section>

    <section id="stats" data-block="stats">
      <ul>
        <li>Total: {{ stats.total }}</li>
        <li>Completadas: {{ stats.done }}</li>
        <li>Pendientes: {{ stats.pending }}</li>
        <li>Progreso %: {{ stats.progress_pct }}</li>
      </ul>
    </section>
  </aside>
</main>

<footer id="task-footer" data-section="footer">
  <p>Última actualización: {{ block.updated_at }}</p>
  <nav>
    <a href="{{ url_for('personal_space.duplicate_block', block_id=block.id) if app and 'personal_space.duplicate_block' in app.view_functions else '#' }}" data-action="duplicate-block">Duplicar bloque</a>
    <a href="{{ url_for('personal_space.complete_block', block_id=block.id) if app and 'personal_space.complete_block' in app.view_functions else '#' }}" data-action="complete-block">Marcar como completado</a>
  </nav>
</footer>
{% endblock %}
