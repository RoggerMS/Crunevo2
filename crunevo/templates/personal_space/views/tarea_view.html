{% extends 'base.html' %}
{% from 'components/csrf.html' import csrf_field %}
{% set app = url_for.__globals__.get('current_app') %}

{% block title %}Tarea - {{ block.title }}{% endblock %}

{% block content %}
<header id="task-header">
  <nav aria-label="Navegación">
    <a href="{{ request.referrer or (url_for('personal_space.dashboard') if app and 'personal_space.dashboard' in app.view_functions else '#') }}">Volver</a>
    <a href="{{ url_for('personal_space.settings_view') if app and 'personal_space.settings_view' in app.view_functions else '#' }}">Configurar</a>
    <a href="{{ url_for('personal_space.link_note', block_id=block.id) if app and 'personal_space.link_note' in app.view_functions else '#' }}">Vincular Apunte</a>
    <a href="{{ url_for('personal_space.link_forum', block_id=block.id) if app and 'personal_space.link_forum' in app.view_functions else '#' }}">Vincular Foro</a>
  </nav>
  <h1 id="task-title" contenteditable="true">{{ block.title }}</h1>
</header>

<section id="task-progress" aria-live="polite">
  Progreso: {{ stats.progress_pct|default(0) }}%
</section>

<form id="meta-form" method="post" action="{{ url_for('personal_space.update_block', block_id=block.id) }}">
  {{ csrf_field() }}
  <label for="priority">Prioridad</label>
  <select id="priority" name="priority">
    <option value="alta"{% if block.priority == 'alta' %} selected{% endif %}>alta</option>
    <option value="media"{% if block.priority == 'media' %} selected{% endif %}>media</option>
    <option value="baja"{% if block.priority == 'baja' %} selected{% endif %}>baja</option>
  </select>
  <label for="due-date">Fecha límite</label>
  <input id="due-date" name="due_date" type="date" value="{{ block.due_date.strftime('%Y-%m-%d') if block.due_date else '' }}">
</form>

<form id="description-form" method="post" action="{{ url_for('personal_space.update_block', block_id=block.id) }}">
  {{ csrf_field() }}
  <label for="description-text">Descripción</label>
  <textarea id="description-text" name="content">{{ block.content or '' }}</textarea>
</form>

<section id="subtasks">
  <h2>Subtareas</h2>
  <ul>
    {% for subtask in subtasks %}
    <li data-subtask-id="{{ subtask.id }}">
      <form method="post" action="{{ url_for('personal_space.toggle_subtask', block_id=block.id, subtask_id=subtask.id) }}">
        {{ csrf_field() }}
        <input type="checkbox" id="subtask-{{ subtask.id }}" name="done" {% if subtask.done %}checked{% endif %} onchange="this.form.submit()">
        <input type="hidden" name="next" value="{{ request.full_path }}">
        <label for="subtask-{{ subtask.id }}">{{ subtask.title }}</label>
      </form>
      {% if subtask.due_date %}
      <span>{{ subtask.due_date }}</span>
      {% endif %}
      <form method="post" action="{{ url_for('personal_space.delete_subtask', block_id=block.id, subtask_id=subtask.id) }}">
        {{ csrf_field() }}
        <button type="submit">Eliminar</button>
      </form>
    </li>
    {% else %}
    <li>No hay subtareas</li>
    {% endfor %}
  </ul>

  <form method="post" action="{{ url_for('personal_space.add_subtask', block_id=block.id) }}">
    {{ csrf_field() }}
    <label for="new-title">Título</label>
    <input id="new-title" name="title" required>
    <label for="new-priority">Prioridad</label>
    <select id="new-priority" name="priority">
      <option value="alta">alta</option>
      <option value="media">media</option>
      <option value="baja">baja</option>
    </select>
    <label for="new-due-date">Fecha límite</label>
    <input id="new-due-date" name="due_date" type="date">
    <button type="submit">Añadir</button>
  </form>

  <form method="post" action="{{ url_for('personal_space.reorder_subtasks', block_id=block.id) }}">
    {{ csrf_field() }}
    <label for="order-json">Nuevo orden</label>
    <input id="order-json" name="order_json">
    <button type="submit">Reordenar</button>
  </form>
</section>

<section id="links">
  <h2>Apuntes</h2>
  <ul>
    {% for note in linked_notes %}
    <li>
      <a href="{{ note.url }}" target="_blank">{{ note.title }}</a>
      <form method="post" action="{{ url_for('personal_space.unlink_resource', kind='note', resource_id=note.id, block_id=block.id) }}">
        {{ csrf_field() }}
        <button type="submit">Quitar</button>
      </form>
    </li>
    {% else %}
    <li>No hay apuntes vinculados</li>
    {% endfor %}
  </ul>

  <h2>Foro</h2>
  <ul>
    {% for post in linked_forum_posts %}
    <li>
      <a href="{{ post.url }}" target="_blank">{{ post.title }}</a>
      <form method="post" action="{{ url_for('personal_space.unlink_resource', kind='forum', resource_id=post.id, block_id=block.id) }}">
        {{ csrf_field() }}
        <button type="submit">Quitar</button>
      </form>
    </li>
    {% else %}
    <li>No hay publicaciones vinculadas</li>
    {% endfor %}
  </ul>
</section>

<aside id="stats">
  <p>Total: {{ stats.total|default(0) }}</p>
  <p>Completadas: {{ stats.done|default(0) }}</p>
  <p>Pendientes: {{ stats.pending|default(0) }}</p>
  <p>Progreso: {{ stats.progress_pct|default(0) }}%</p>
</aside>

<footer id="task-footer">
  <nav aria-label="Navegación">
    <a href="{{ url_for('personal_space.duplicate_block', block_id=block.id) if app and 'personal_space.duplicate_block' in app.view_functions else '#' }}">Duplicar</a>
    <a href="{{ url_for('personal_space.complete_block', block_id=block.id) if app and 'personal_space.complete_block' in app.view_functions else '#' }}">Completar</a>
  </nav>
</footer>

<div id="toast" hidden></div>

<script>
const csrfToken = document.querySelector('input[name="csrf_token"]').value;
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.hidden=false;
  setTimeout(()=>{t.hidden=true;},2000);
}
async function saveField(field,value){
  try{
    const res=await fetch("{{ url_for('personal_space.update_block', block_id=block.id) }}",{
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
      body:JSON.stringify({[field]:value})
    });
    if(!res.ok) throw new Error();
    showToast('Guardado ✓');
    return true;
  }catch(e){
    showToast('No se pudo guardar');
    return false;
  }
}
let prevTitle='{{ block.title }}';
const titleEl=document.getElementById('task-title');
let tTimer;
titleEl.addEventListener('focus',()=>{prevTitle=titleEl.textContent;});
titleEl.addEventListener('input',()=>{
  clearTimeout(tTimer);
  tTimer=setTimeout(()=>saveField('title',titleEl.textContent),700);
});
titleEl.addEventListener('blur',async()=>{
  const ok=await saveField('title',titleEl.textContent);
  if(!ok){titleEl.textContent=prevTitle;}
});
let prevDesc='{{ block.content or '' }}';
const descEl=document.getElementById('description-text');
let dTimer;
descEl.addEventListener('focus',()=>{prevDesc=descEl.value;});
descEl.addEventListener('input',()=>{
  clearTimeout(dTimer);
  dTimer=setTimeout(()=>saveField('content',descEl.value),700);
});
descEl.addEventListener('blur',async()=>{
  const ok=await saveField('content',descEl.value);
  if(!ok){descEl.value=prevDesc;}
});
const priorityEl=document.getElementById('priority');
priorityEl.addEventListener('change',()=>saveField('priority',priorityEl.value));
const dueEl=document.getElementById('due-date');
dueEl.addEventListener('change',()=>saveField('due_date',dueEl.value));
</script>
{% endblock %}
