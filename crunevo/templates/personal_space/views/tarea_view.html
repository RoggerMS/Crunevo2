{% extends 'base.html' %}
{% block title %}Tarea - {{ block.title }}{% endblock %}

{% block content %}
<section id="task-header" data-section="header">
  <nav>
    <a href="{{ request.referrer or url_for('personal_space.index') }}" id="nav-back">Volver</a>
    <a href="{{ url_for('personal_space.settings_view') }}" id="nav-config">Configurar</a>
    <a href="{{ url_for('personal_space.link_note', block_id=block.id) }}" id="nav-add-note">Añadir desde Apuntes</a>
    <a href="{{ url_for('personal_space.link_forum', block_id=block.id) }}" id="nav-add-forum">Añadir desde Foro</a>
  </nav>
  <h1 id="task-title">{{ block.title }}</h1>
  <form method="post" action="{{ url_for('personal_space.update_block', block_id=block.id) }}" data-action="update-block">
    {{ csrf_token() }}
    <label for="block-title">Título</label>
    <input id="block-title" name="title" type="text" value="{{ block.title }}">
    <label for="block-type">Tipo</label>
    <select id="block-type" name="type">
      <option value="tarea" {% if block.type == 'tarea' %}selected{% endif %}>tarea</option>
      <option value="objetivo" {% if block.type == 'objetivo' %}selected{% endif %}>objetivo</option>
      <option value="estudio" {% if block.type == 'estudio' %}selected{% endif %}>estudio</option>
    </select>
    <label for="block-priority">Prioridad</label>
    <select id="block-priority" name="priority">
      <option value="alta" {% if block.priority == 'alta' %}selected{% endif %}>alta</option>
      <option value="media" {% if block.priority == 'media' %}selected{% endif %}>media</option>
      <option value="baja" {% if block.priority == 'baja' %}selected{% endif %}>baja</option>
    </select>
    <label for="block-due-date">Fecha límite</label>
    <input id="block-due-date" name="due_date" type="date" value="{{ block.due_date or '' }}">
    <button type="submit">Guardar</button>
  </form>
</section>

<section id="task-progress" data-section="progress" aria-live="polite">
  <p>Progreso: {{ stats.progress_pct }}% — {{ stats.done }} / {{ stats.total }} completadas</p>
</section>

<section id="task-main" data-section="main">
  <article id="left" data-section="work">
    <section id="description" data-block="description">
      <form method="post" action="{{ url_for('personal_space.update_block', block_id=block.id) }}" data-action="update-description">
        {{ csrf_token() }}
        <label for="block-description">Descripción</label>
        <textarea id="block-description" name="description">{{ block.description }}</textarea>
        <button type="submit">Guardar</button>
      </form>
    </section>
    <section id="subtasks" data-block="subtasks">
      <form method="get" action="" data-action="filter-subtasks">
        <label for="filter-all"><input id="filter-all" type="radio" name="filter" value="all" {% if request.args.get('filter', 'all') == 'all' %}checked{% endif %}> Todas</label>
        <label for="filter-pending"><input id="filter-pending" type="radio" name="filter" value="pending" {% if request.args.get('filter') == 'pending' %}checked{% endif %}> Pendientes</label>
        <label for="filter-done"><input id="filter-done" type="radio" name="filter" value="done" {% if request.args.get('filter') == 'done' %}checked{% endif %}> Completadas</label>
        <button type="submit">Aplicar</button>
      </form>
      <ul>
        {% for sub in subtasks %}
        <li data-subtask-id="{{ sub.id }}">
          <form method="post" action="{{ url_for('personal_space.toggle_subtask', block_id=block.id, subtask_id=sub.id) }}" data-action="toggle-subtask">
            {{ csrf_token() }}
            <label for="subtask-{{ sub.id }}-done">Hecho</label>
            <input id="subtask-{{ sub.id }}-done" type="checkbox" name="done" value="true" {% if sub.done %}checked{% endif %} onchange="this.form.submit()">
            <input type="hidden" name="next" value="{{ request.full_path }}">
          </form>
          <span>{{ sub.title }}</span>
          <small>Prioridad: {{ sub.priority }}{% if sub.due_date %} | Vence: {{ sub.due_date }}{% endif %}</small>
          <a href="{{ url_for('personal_space.delete_subtask', block_id=block.id, subtask_id=sub.id) }}">Eliminar</a>
        </li>
        {% endfor %}
      </ul>
      <form method="post" action="{{ url_for('personal_space.add_subtask', block_id=block.id) }}" data-action="add-subtask">
        {{ csrf_token() }}
        <label for="new-subtask-title">Título</label>
        <input id="new-subtask-title" name="title" type="text" required>
        <label for="new-subtask-priority">Prioridad</label>
        <select id="new-subtask-priority" name="priority">
          <option value="alta">alta</option>
          <option value="media" selected>media</option>
          <option value="baja">baja</option>
        </select>
        <label for="new-subtask-due-date">Fecha límite</label>
        <input id="new-subtask-due-date" name="due_date" type="date">
        <button type="submit">Añadir</button>
      </form>
      <form method="post" action="{{ url_for('personal_space.reorder_subtasks', block_id=block.id) }}" data-action="reorder-subtasks">
        {{ csrf_token() }}
        <label for="order-json">Nuevo orden (JSON)</label>
        <input id="order-json" name="order_json" type="text">
        <button type="submit">Reordenar</button>
      </form>
    </section>
  </article>
  <aside id="right" data-section="side">
    <section id="linked-resources" data-block="resources">
      <article data-kind="notes">
        <h2>Apuntes</h2>
        <ul>
          {% for note in linked_notes %}
          <li data-resource-id="{{ note.id }}">
            <a href="{{ note.url }}" target="_blank">{{ note.title }}</a>
            <a href="{{ url_for('personal_space.unlink_resource', block_id=block.id, kind='note', resource_id=note.id) }}">Quitar</a>
          </li>
          {% endfor %}
        </ul>
        <a href="{{ url_for('personal_space.link_note', block_id=block.id) }}">Añadir desde Apuntes</a>
      </article>
      <article data-kind="forum">
        <h2>Foro</h2>
        <ul>
          {% for post in linked_forum_posts %}
          <li data-resource-id="{{ post.id }}">
            <a href="{{ post.url }}" target="_blank">{{ post.title }}</a>
            <a href="{{ url_for('personal_space.unlink_resource', block_id=block.id, kind='forum', resource_id=post.id) }}">Quitar</a>
          </li>
          {% endfor %}
        </ul>
        <a href="{{ url_for('personal_space.link_forum', block_id=block.id) }}">Añadir desde Foro</a>
      </article>
    </section>
    <section id="dates" data-block="dates">
      <p>Fecha límite del bloque: {{ block.due_date }}</p>
      <p>Estado: {{ block.status }}</p>
    </section>
    <section id="stats" data-block="stats">
      <ul>
        <li>Total: {{ stats.total }}</li>
        <li>Completadas: {{ stats.done }}</li>
        <li>Pendientes: {{ stats.pending }}</li>
        <li>Progreso %: {{ stats.progress_pct }}</li>
      </ul>
    </section>
  </aside>
</section>

<section id="task-footer" data-section="footer">
  <div id="footer-left">
    <span>Última actualización: {{ block.updated_at }}</span>
  </div>
  <div id="footer-right">
    <a href="{{ url_for('personal_space.duplicate_block', block_id=block.id) }}">Duplicar bloque</a>
    <a href="{{ url_for('personal_space.complete_block', block_id=block.id) }}">Marcar como completado</a>
  </div>
</section>
{% endblock %}
