{% extends 'base.html' %}
{% block title %}Bit√°cora Inteligente - {{ block.title }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personal-space.css') }}">
<style>
/* Modern Bit√°cora Inteligente */
.bitacora-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.02), rgba(139, 92, 246, 0.01));
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.1);
}

.entry-form {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 8px 25px rgba(139, 92, 246, 0.1);
    margin-bottom: 2rem;
    border: 1px solid rgba(139, 92, 246, 0.1);
    transition: all 0.3s ease;
}

.entry-form:hover {
    box-shadow: 0 12px 35px rgba(139, 92, 246, 0.15);
    transform: translateY(-2px);
}

.mood-selector {
    display: flex;
    gap: 12px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.mood-option {
    padding: 12px 18px;
    border: 2px solid rgba(139, 92, 246, 0.2);
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1.3rem;
    background: white;
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.1);
}

.mood-option:hover {
    border-color: #8b5cf6;
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 6px 15px rgba(139, 92, 246, 0.2);
}

.mood-option.active {
    border-color: #8b5cf6;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05));
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 8px 20px rgba(139, 92, 246, 0.25);
}

.entries-timeline {
    position: relative;
    padding-left: 2rem;
}

.entries-timeline::before {
    content: '';
    position: absolute;
    left: 25px;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(180deg, #8b5cf6, #7c3aed);
    border-radius: 2px;
}

.entry-item {
    position: relative;
    margin-left: 60px;
    margin-bottom: 2rem;
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 6px 20px rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.1);
    transition: all 0.3s ease;
}

.entry-item:hover {
    transform: translateY(-4px) scale(1.01);
    box-shadow: 0 12px 30px rgba(139, 92, 246, 0.2);
}

.entry-item::before {
    content: '';
    position: absolute;
    left: -48px;
    top: 20px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    border: 4px solid white;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
}

.entry-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(139, 92, 246, 0.1);
}

.entry-date {
    font-weight: 700;
    color: #8b5cf6;
    font-size: 0.95rem;
}

.entry-mood {
    font-size: 1.8rem;
    filter: drop-shadow(0 2px 4px rgba(139, 92, 246, 0.3));
}

.entry-content {
    line-height: 1.7;
    margin-bottom: 15px;
    font-size: 1.05rem;
    color: #374151;
}

.entry-tags {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
}

.tag-pill {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05));
    color: #8b5cf6;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    border: 1px solid rgba(139, 92, 246, 0.2);
    transition: all 0.2s ease;
}

.tag-pill:hover {
    transform: translateY(-1px) scale(1.05);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 6px 20px rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.1);
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 12px 30px rgba(139, 92, 246, 0.2);
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: #8b5cf6;
    display: block;
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-label {
    font-size: 0.95rem;
    color: #6b7280;
    font-weight: 500;
    margin-top: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="bitacora-container">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-journal-text me-2"></i>{{ block.title }}</h2>
            <p class="text-muted">Registra tu progreso acad√©mico diario</p>
        </div>
        <a href="{{ url_for('personal_space.index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>
    
    <!-- Estad√≠sticas -->
    {% set metadata = block.get_metadata() %}
    {% set entries = metadata.get('entries', []) %}
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-number">{{ entries|length }}</span>
            <span class="stat-label">Entradas totales</span>
        </div>
        <div class="stat-card">
            <span class="stat-number">{{ metadata.get('streak', 0) }}</span>
            <span class="stat-label">D√≠as consecutivos</span>
        </div>
        <div class="stat-card">
            <span class="stat-number">{{ entries|length // 7 if entries else 0 }}</span>
            <span class="stat-label">Semanas activas</span>
        </div>
        <div class="stat-card">
            <span class="stat-number">üòä</span>
            <span class="stat-label">Estado promedio</span>
        </div>
    </div>
    
    <!-- Formulario nueva entrada -->
    <div class="entry-form">
        <h5><i class="bi bi-plus-circle me-2"></i>Nueva entrada</h5>
        <form id="entryForm">
            <div class="mb-3">
                <label class="form-label">¬øC√≥mo te sientes hoy?</label>
                <div class="mood-selector">
                    <div class="mood-option" data-mood="happy" title="Feliz">üòä</div>
                    <div class="mood-option" data-mood="neutral" title="Neutral">üòê</div>
                    <div class="mood-option" data-mood="sad" title="Triste">üò¢</div>
                    <div class="mood-option" data-mood="excited" title="Emocionado">ü§©</div>
                    <div class="mood-option" data-mood="stressed" title="Estresado">üò∞</div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="entryContent" class="form-label">¬øQu√© aprendiste hoy?</label>
                <textarea class="form-control" id="entryContent" rows="4" 
                         placeholder="Describe tu progreso, logros, dificultades o reflexiones del d√≠a..."></textarea>
            </div>
            
            <div class="mb-3">
                <label for="entryTags" class="form-label">Etiquetas (separadas por comas)</label>
                <input type="text" class="form-control" id="entryTags" 
                       placeholder="matem√°ticas, proyecto, examen, estudio...">
            </div>
            
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Guardar entrada
            </button>
        </form>
    </div>
    
    <!-- Timeline de entradas -->
    <div class="entries-timeline">
        <h5 class="mb-3"><i class="bi bi-clock-history me-2"></i>Historial de entradas</h5>
        
        {% if entries %}
            {% for entry in entries|reverse %}
            <div class="entry-item">
                <div class="entry-header">
                    <span class="entry-date">{{ entry.date }}</span>
                    <span class="entry-mood">
                        {% if entry.mood == 'happy' %}üòä
                        {% elif entry.mood == 'neutral' %}üòê
                        {% elif entry.mood == 'sad' %}üò¢
                        {% elif entry.mood == 'excited' %}ü§©
                        {% elif entry.mood == 'stressed' %}üò∞
                        {% else %}üòê{% endif %}
                    </span>
                </div>
                <div class="entry-content">
                    {{ entry.content }}
                </div>
                {% if entry.tags %}
                <div class="entry-tags">
                    {% for tag in entry.tags %}
                    <span class="tag-pill">{{ tag }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-journal-plus text-muted" style="font-size: 3rem;"></i>
                <h5 class="text-muted mt-3">A√∫n no hay entradas</h5>
                <p class="text-muted">Comienza tu bit√°cora acad√©mica registrando tu primer d√≠a</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mood selector
    const moodOptions = document.querySelectorAll('.mood-option');
    let selectedMood = null;
    
    moodOptions.forEach(option => {
        option.addEventListener('click', function() {
            moodOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            selectedMood = this.dataset.mood;
        });
    });
    
    // Form submission
    document.getElementById('entryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const content = document.getElementById('entryContent').value.trim();
        const tags = document.getElementById('entryTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
        
        if (!content) {
            alert('Por favor, escribe algo sobre tu d√≠a');
            return;
        }
        
        if (!selectedMood) {
            alert('Por favor, selecciona tu estado de √°nimo');
            return;
        }
        
        const newEntry = {
            date: new Date().toLocaleDateString('es-ES'),
            mood: selectedMood,
            content: content,
            tags: tags
        };
        
        // Save entry via API
        fetch(`/espacio-personal/api/blocks/{{ block.id }}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                metadata: {
                    ...{{ block.get_metadata()|tojson }},
                    entries: [...{{ metadata.get('entries', [])|tojson }}, newEntry],
                    streak: calculateStreak([...{{ metadata.get('entries', [])|tojson }}, newEntry])
                }
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error al guardar la entrada');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al guardar la entrada');
        });
    });
    
    function calculateStreak(entries) {
        if (entries.length === 0) return 0;
        
        const today = new Date();
        let streak = 0;
        
        for (let i = 0; i < 30; i++) {
            const checkDate = new Date(today);
            checkDate.setDate(today.getDate() - i);
            const dateStr = checkDate.toLocaleDateString('es-ES');
            
            const hasEntry = entries.some(entry => entry.date === dateStr);
            if (hasEntry) {
                streak++;
            } else {
                break;
            }
        }
        
        return streak;
    }
    
    function getCsrfToken() {
        return document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
    }
});
</script>
{% endblock %}