{% extends 'base.html' %}
{% block title %}Estadísticas - Mi Espacio Personal{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personal-space.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.stats-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 2rem;
    margin-bottom: 2rem;
}

.dark-mode .stats-container {
    background: #1e293b;
    color: white;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 1.5rem;
    color: white;
    text-align: center;
    margin-bottom: 1rem;
}

.stat-card.success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.stat-card.warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.stat-card.info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
}

.stat-label {
    font-size: 1rem;
    opacity: 0.9;
    margin: 0;
}

.chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 2rem;
}

.progress-ring {
    width: 120px;
    height: 120px;
    margin: 0 auto;
}

.progress-ring circle {
    fill: transparent;
    stroke-width: 8;
    stroke-linecap: round;
}

.progress-ring .background {
    stroke: #e5e7eb;
}

.progress-ring .progress {
    stroke: #8b5cf6;
    stroke-dasharray: 0 100;
    transition: stroke-dasharray 0.5s ease;
}

.achievement-badge {
    display: inline-flex;
    align-items: center;
    background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    margin: 0.25rem;
    font-size: 0.85rem;
}

.trend-indicator {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

.trend-up {
    background: #dcfce7;
    color: #166534;
}

.trend-down {
    background: #fef2f2;
    color: #991b1b;
}

.trend-stable {
    background: #f3f4f6;
    color: #374151;
}

.activity-heatmap {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin: 1rem 0;
}

.heatmap-day {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    background: #e5e7eb;
}

.heatmap-day.level-1 { background: #c6f6d5; }
.heatmap-day.level-2 { background: #9ae6b4; }
.heatmap-day.level-3 { background: #68d391; }
.heatmap-day.level-4 { background: #38a169; }
</style>
{% endblock %}

{% block content %}
<div class="personal-space-container">
    <!-- Header -->
    <div class="ps-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="ps-title tw-text-indigo-600">
                        <i class="bi bi-graph-up me-2"></i>
                        Estadísticas Personales
                    </h1>
                    <p class="ps-subtitle">Analiza tu productividad y progreso académico</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="ps-controls tw-space-x-2">
                        <button class="btn btn-outline-primary me-2" onclick="exportStats()">
                            <i class="bi bi-download"></i>
                            Exportar Reporte
                        </button>
                        <a href="{{ url_for('personal_space.index') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i>
                            Volver al Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Métricas Principales -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <h3 class="stat-number">{{ stats.total_blocks }}</h3>
                    <p class="stat-label">Bloques Totales</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card success">
                    <h3 class="stat-number">{{ stats.completion_rate }}%</h3>
                    <p class="stat-label">Tasa de Completado</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card warning">
                    <h3 class="stat-number">{{ stats.goals_achieved }}</h3>
                    <p class="stat-label">Objetivos Logrados</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card info">
                    <h3 class="stat-number">{{ stats.weekly_activity }}</h3>
                    <p class="stat-label">Actividad Semanal</p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Gráfico de Productividad -->
            <div class="col-lg-8">
                <div class="stats-container">
                    <h5 class="mb-3">
                        <i class="bi bi-activity text-primary"></i>
                        Tendencia de Productividad
                        <span class="trend-indicator trend-{{ stats.productivity_trend.direction }}">
                            <i class="bi bi-arrow-{{ 'up' if stats.productivity_trend.direction == 'up' else 'down' if stats.productivity_trend.direction == 'down' else 'right' }}"></i>
                            {{ stats.productivity_trend.percentage }}%
                        </span>
                    </h5>
                    <div class="chart-container">
                        <canvas id="productivityChart"></canvas>
                    </div>
                </div>

                <!-- Distribución de Tipos de Bloques -->
                <div class="stats-container">
                    <h5 class="mb-3">
                        <i class="bi bi-pie-chart text-success"></i>
                        Distribución de Actividades
                    </h5>
                    <div class="chart-container">
                        <canvas id="blockTypesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Sidebar con Métricas Adicionales -->
            <div class="col-lg-4">
                <!-- Progreso General -->
                <div class="stats-container text-center">
                    <h6 class="mb-3">
                        <i class="bi bi-target"></i>
                        Progreso General
                    </h6>
                    <div class="progress-ring">
                        <svg width="120" height="120">
                            <circle class="background" cx="60" cy="60" r="54"></circle>
                            <circle class="progress" cx="60" cy="60" r="54" 
                                    style="stroke-dasharray: {{ stats.completion_rate }} 100"></circle>
                        </svg>
                    </div>
                    <h4 class="mt-2 text-primary">{{ stats.completion_rate }}%</h4>
                    <p class="text-muted">Completado</p>
                </div>

                <!-- Logros Recientes -->
                <div class="stats-container">
                    <h6 class="mb-3">
                        <i class="bi bi-trophy text-warning"></i>
                        Logros Recientes
                    </h6>
                    <div class="achievements-list">
                        {% for achievement in stats.recent_achievements %}
                        <div class="achievement-badge">
                            <i class="bi bi-{{ achievement.icon }} me-2"></i>
                            {{ achievement.name }}
                        </div>
                        {% endfor %}
                        
                        {% if not stats.recent_achievements %}
                        <p class="text-muted text-center py-3">
                            <i class="bi bi-emoji-smile"></i><br>
                            ¡Sigue trabajando para desbloquear logros!
                        </p>
                        {% endif %}
                    </div>
                </div>

                <!-- Actividad Semanal (Heatmap) -->
                <div class="stats-container">
                    <h6 class="mb-3">
                        <i class="bi bi-calendar-week text-info"></i>
                        Actividad de la Semana
                    </h6>
                    <div class="activity-heatmap" id="activityHeatmap">
                        <!-- Se genera dinámicamente con JavaScript -->
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-muted">Menos</small>
                        <div class="d-flex gap-1">
                            <div class="heatmap-day"></div>
                            <div class="heatmap-day level-1"></div>
                            <div class="heatmap-day level-2"></div>
                            <div class="heatmap-day level-3"></div>
                            <div class="heatmap-day level-4"></div>
                        </div>
                        <small class="text-muted">Más</small>
                    </div>
                </div>

                <!-- Estadísticas Rápidas -->
                <div class="stats-container">
                    <h6 class="mb-3">
                        <i class="bi bi-speedometer2 text-danger"></i>
                        Estadísticas Rápidas
                    </h6>
                    <div class="quick-stats">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tareas pendientes:</span>
                            <strong class="text-warning">{{ stats.pending_tasks }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Objetivos activos:</span>
                            <strong class="text-info">{{ stats.active_goals }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Notas creadas:</span>
                            <strong class="text-success">{{ stats.notes_count }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Racha actual:</span>
                            <strong class="text-primary">{{ stats.current_streak }} días</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    generateActivityHeatmap();
});

function initializeCharts() {
    // Gráfico de Productividad
    const productivityCtx = document.getElementById('productivityChart').getContext('2d');
    new Chart(productivityCtx, {
        type: 'line',
        data: {
            labels: {{ stats.productivity_trend.labels | tojson }},
            datasets: [{
                label: 'Bloques Completados',
                data: {{ stats.productivity_trend.data | tojson }},
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Gráfico de Tipos de Bloques
    const blockTypesCtx = document.getElementById('blockTypesChart').getContext('2d');
    new Chart(blockTypesCtx, {
        type: 'doughnut',
        data: {
            labels: {{ stats.most_used_types.labels | tojson }},
            datasets: [{
                data: {{ stats.most_used_types.data | tojson }},
                backgroundColor: [
                    '#8b5cf6',
                    '#06b6d4',
                    '#f59e0b',
                    '#ef4444',
                    '#10b981',
                    '#f97316'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function generateActivityHeatmap() {
    const heatmap = document.getElementById('activityHeatmap');
    const activityData = {{ stats.weekly_activity_data | tojson }};
    
    heatmap.innerHTML = '';
    
    activityData.forEach(day => {
        const dayElement = document.createElement('div');
        dayElement.className = `heatmap-day level-${day.level}`;
        dayElement.title = `${day.date}: ${day.count} actividades`;
        heatmap.appendChild(dayElement);
    });
}

function exportStats() {
    // Generar y descargar reporte de estadísticas
    fetch('/espacio-personal/api/export-stats', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `estadisticas-${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    })
    .catch(error => {
        console.error('Error al exportar estadísticas:', error);
        alert('Error al generar el reporte');
    });
}

function getCsrfToken() {
    return document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
}
</script>
{% endblock %}