{% extends 'base.html' %}
{% block title %}Objetivo Académico - {{ block.title }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personal-space.css') }}">
<style>
.objetivo-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

.objetivo-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
}

.objetivo-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200px;
    height: 200px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    animation: float 6s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-20px); }
}

.objetivo-info {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
}

.objetivo-icon {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
}

.objetivo-details h2 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 600;
}

.objetivo-categoria {
    background: rgba(255, 255, 255, 0.2);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
    display: inline-block;
    margin-top: 5px;
}

.progress-section {
    margin-top: 25px;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.progress-percentage {
    font-size: 1.5rem;
    font-weight: 600;
}

.progress-bar-custom {
    height: 12px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    overflow: hidden;
    position: relative;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
    border-radius: 6px;
    transition: width 0.5s ease;
    position: relative;
}

.progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
     100% { transform: translateX(100%); }
}

.deadline-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    font-size: 0.9rem;
}

.deadline-status {
    padding: 4px 12px;
    border-radius: 12px;
    font-weight: 500;
}

.deadline-status.urgente {
    background: rgba(255, 107, 107, 0.2);
    color: #ff6b6b;
}

.deadline-status.proximo {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
}

.deadline-status.tiempo {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
}

.content-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.section-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 15px;
    color: var(--bs-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.hitos-timeline {
    position: relative;
    padding-left: 30px;
}

.hitos-timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--bs-border-color);
}

.hito-item {
    position: relative;
    margin-bottom: 20px;
    padding: 15px;
    background: var(--bs-gray-50);
    border-radius: 8px;
    border-left: 4px solid var(--bs-primary);
}

.hito-item.completado {
    background: var(--bs-success-bg);
    border-left-color: var(--bs-success);
}

.hito-item::before {
    content: '';
    position: absolute;
    left: -23px;
    top: 20px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--bs-primary);
    border: 3px solid white;
    box-shadow: 0 0 0 2px var(--bs-border-color);
}

.hito-item.completado::before {
    background: var(--bs-success);
    box-shadow: 0 0 0 2px var(--bs-success);
}

.hito-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.hito-titulo {
    font-weight: 600;
    margin: 0;
}

.hito-fecha {
    font-size: 0.85rem;
    color: var(--bs-secondary);
}

.hito-descripcion {
    color: var(--bs-secondary);
    margin: 0;
    font-size: 0.9rem;
}

.hito-actions {
    margin-top: 10px;
    display: flex;
    gap: 10px;
}

.recursos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
}

.recurso-card {
    background: var(--bs-gray-50);
    border: 1px solid var(--bs-border-color);
    border-radius: 8px;
    padding: 15px;
    transition: all 0.2s;
}

.recurso-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.recurso-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.recurso-icon {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    color: white;
}

.recurso-icon.libro { background: #17a2b8; }
.recurso-icon.video { background: #dc3545; }
.recurso-icon.articulo { background: #28a745; }
.recurso-icon.curso { background: #ffc107; color: #000; }
.recurso-icon.herramienta { background: #6f42c1; }

.recurso-titulo {
    font-weight: 600;
    margin: 0;
    flex-grow: 1;
}

.recurso-descripcion {
    color: var(--bs-secondary);
    font-size: 0.9rem;
    margin: 0;
}

.add-item-btn {
    background: var(--bs-primary);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 15px;
}

.add-item-btn:hover {
    background: var(--bs-primary-dark, #0056b3);
    transform: translateY(-1px);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.stat-number {
    font-size: 1.8rem;
    font-weight: 600;
    color: var(--bs-primary);
    display: block;
}

.stat-label {
    color: var(--bs-secondary);
    font-size: 0.9rem;
    margin-top: 5px;
}

.motivacion-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    margin-bottom: 20px;
}

.motivacion-quote {
    font-size: 1.1rem;
    font-style: italic;
    margin-bottom: 10px;
}

.motivacion-author {
    font-size: 0.9rem;
    opacity: 0.8;
}

.modal-content {
    border-radius: 12px;
}

.form-floating {
    margin-bottom: 15px;
}
</style>
{% endblock %}

{% block content %}
<div class="modern-block-container">
    <!-- Modern Hero Header -->
    <div class="modern-hero">
        <div class="hero-content">
            <div class="hero-header">
                <div class="hero-icon">
                    <i class="{{ block.get_metadata().get('icon', 'bi bi-target') }}"></i>
                </div>
                <div>
                    <h1 class="hero-title">{{ block.title }}</h1>
                    <div class="hero-subtitle">Objetivo académico</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Resumen del Objetivo -->
    <div class="modern-card mb-4">
        <div class="card-body">
            <div class="d-flex align-items-start gap-3 mb-4">
                <div class="flex-shrink-0">
                    <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                        <i class="{{ block.get_metadata().get('icon', 'bi bi-target') }} text-primary fs-4"></i>
                    </div>
                </div>
                <div class="flex-grow-1">
                    <h3 class="h5 mb-2" id="objetivoTitulo">{{ block.title }}</h3>
                    <p class="content-text line-clamp-2 mb-3">{{ block.content or 'Descripción del objetivo académico' }}</p>
                    
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <span class="chip chip-primary" id="objetivoCategoria">
                            {{ block.get_metadata().get('categoria', 'General') }}
                        </span>
                        {% set prioridad = block.get_metadata().get('prioridad', 'media') %}
                        <span class="chip chip-{% if prioridad == 'alta' %}danger{% elif prioridad == 'media' %}warning{% else %}secondary{% endif %}">
                            Prioridad {{ prioridad|title }}
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Progreso -->
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-medium">Progreso del objetivo</span>
                    <span class="fw-bold text-primary" id="progressPercentage">0%</span>
                </div>
                <div class="modern-progress">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Fechas -->
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-calendar-event text-muted"></i>
                        <div>
                            <div class="small text-muted">Fecha límite</div>
                            <div class="fw-medium" id="deadlineText">--</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-clock text-muted"></i>
                        <div>
                            <div class="small text-muted">Estado</div>
                            <span class="chip chip-secondary" id="deadlineStatus">Sin definir</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Estadísticas -->
    <div class="modern-card mb-4">
        <div class="card-body">
            <div class="section-header mb-3">
                <i class="bi bi-graph-up"></i>
                <h3>Estadísticas</h3>
            </div>
            
            <div class="modern-grid modern-grid-2">
                <div class="text-center p-3 bg-light rounded">
                    <div class="fs-2 fw-bold text-primary" id="totalHitos">0</div>
                    <div class="small text-muted">Hitos Totales</div>
                </div>
                <div class="text-center p-3 bg-light rounded">
                    <div class="fs-2 fw-bold text-success" id="hitosCompletados">0</div>
                    <div class="small text-muted">Completados</div>
                </div>
                <div class="text-center p-3 bg-light rounded">
                    <div class="fs-2 fw-bold text-warning" id="diasRestantes">--</div>
                    <div class="small text-muted">Días Restantes</div>
                </div>
                <div class="text-center p-3 bg-light rounded">
                    <div class="fs-2 fw-bold text-info" id="velocidadProgreso">0%</div>
                    <div class="small text-muted">Velocidad Semanal</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hitos y Timeline -->
    <div class="modern-card mb-4">
        <div class="card-body">
            <div class="section-header mb-3">
                <i class="bi bi-flag"></i>
                <h3>Hitos del Objetivo</h3>
            </div>
            
            <div class="hitos-timeline" id="hitosTimeline">
                <!-- Los hitos se cargarán dinámicamente -->
                <div class="d-flex align-items-center gap-3 p-3 border rounded mb-3">
                    <div class="flex-shrink-0">
                        <div class="bg-success bg-opacity-10 rounded-circle p-2">
                            <i class="bi bi-check-circle text-success"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">Hito de ejemplo completado</h6>
                        <p class="content-text line-clamp-2 mb-1">Descripción del hito que ya fue completado exitosamente.</p>
                        <div class="d-flex gap-2">
                            <span class="chip chip-success">Completado</span>
                            <span class="chip chip-secondary">15 Mar 2024</span>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex align-items-center gap-3 p-3 border rounded mb-3">
                    <div class="flex-shrink-0">
                        <div class="bg-warning bg-opacity-10 rounded-circle p-2">
                            <i class="bi bi-clock text-warning"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">Hito en progreso</h6>
                        <p class="content-text line-clamp-2 mb-1">Descripción del hito que está actualmente en desarrollo.</p>
                        <div class="d-flex gap-2">
                            <span class="chip chip-warning">En progreso</span>
                            <span class="chip chip-secondary">30 Mar 2024</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="action-footer">
                <button class="modern-btn" onclick="addHito()">
                    <i class="bi bi-plus-circle"></i>
                    Agregar Hito
                </button>
            </div>
        </div>
    </div>
    
    <!-- Recursos -->
    <div class="modern-card mb-4">
        <div class="card-body">
            <div class="section-header mb-3">
                <i class="bi bi-collection"></i>
                <h3>Recursos de Apoyo</h3>
            </div>
            
            <div class="recursos-grid" id="recursosGrid">
                <!-- Los recursos se cargarán dinámicamente -->
                <div class="modern-grid modern-grid-2">
                    <div class="d-flex align-items-center gap-3 p-3 border rounded">
                        <div class="flex-shrink-0">
                            <i class="bi bi-book text-primary fs-4"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">Libro de referencia</h6>
                            <p class="content-text line-clamp-1 mb-1">Material de estudio principal</p>
                            <span class="chip chip-primary">Libro</span>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center gap-3 p-3 border rounded">
                        <div class="flex-shrink-0">
                            <i class="bi bi-play-circle text-primary fs-4"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">Video tutorial</h6>
                            <p class="content-text line-clamp-1 mb-1">Explicación práctica del tema</p>
                            <span class="chip chip-info">Video</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="action-footer">
                <button class="modern-btn" onclick="addRecurso()">
                    <i class="bi bi-plus-circle"></i>
                    Agregar Recurso
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para configurar objetivo -->
<div class="modal fade" id="objetivoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configurar Objetivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="objetivoForm">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="objetivoTituloInput" required>
                        <label for="objetivoTituloInput">Título del objetivo</label>
                    </div>
                    
                    <div class="form-floating">
                        <textarea class="form-control" id="objetivoDescripcion" style="height: 80px"></textarea>
                        <label for="objetivoDescripcion">Descripción</label>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select" id="objetivoCategoria">
                                    <option value="Académico">Académico</option>
                                    <option value="Personal">Personal</option>
                                    <option value="Profesional">Profesional</option>
                                    <option value="Habilidades">Habilidades</option>
                                </select>
                                <label for="objetivoCategoria">Categoría</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="date" class="form-control" id="objetivoFechaLimite">
                                <label for="objetivoFechaLimite">Fecha límite</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-floating">
                        <select class="form-select" id="objetivoPrioridad">
                            <option value="baja">Baja</option>
                            <option value="media" selected>Media</option>
                            <option value="alta">Alta</option>
                        </select>
                        <label for="objetivoPrioridad">Prioridad</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveObjetivo()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar/editar hito -->
<div class="modal fade" id="hitoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="hitoModalTitle">Agregar Hito</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="hitoForm">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="hitoTitulo" required>
                        <label for="hitoTitulo">Título del hito</label>
                    </div>
                    
                    <div class="form-floating">
                        <textarea class="form-control" id="hitoDescripcion" style="height: 60px"></textarea>
                        <label for="hitoDescripcion">Descripción</label>
                    </div>
                    
                    <div class="form-floating">
                        <input type="date" class="form-control" id="hitoFecha">
                        <label for="hitoFecha">Fecha objetivo</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveHito()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar/editar recurso -->
<div class="modal fade" id="recursoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="recursoModalTitle">Agregar Recurso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="recursoForm">
                    <div class="form-floating">
                        <select class="form-select" id="recursoTipo" required>
                            <option value="libro">Libro</option>
                            <option value="video">Video</option>
                            <option value="articulo">Artículo</option>
                            <option value="curso">Curso</option>
                            <option value="herramienta">Herramienta</option>
                        </select>
                        <label for="recursoTipo">Tipo de recurso</label>
                    </div>
                    
                    <div class="form-floating">
                        <input type="text" class="form-control" id="recursoTitulo" required>
                        <label for="recursoTitulo">Título del recurso</label>
                    </div>
                    
                    <div class="form-floating">
                        <textarea class="form-control" id="recursoDescripcion" style="height: 60px"></textarea>
                        <label for="recursoDescripcion">Descripción</label>
                    </div>
                    
                    <div class="form-floating">
                        <input type="url" class="form-control" id="recursoUrl">
                        <label for="recursoUrl">URL (opcional)</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveRecurso()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
let objetivoData = {
    titulo: '{{ block.title }}',
    descripcion: '{{ block.get_metadata().get("descripcion", "") }}',
    categoria: '{{ block.get_metadata().get("categoria", "General") }}',
    fechaLimite: '{{ block.get_metadata().get("fechaLimite", "") }}',
    prioridad: '{{ block.get_metadata().get("prioridad", "media") }}',
    hitos: {{ block.get_metadata().get('hitos', [])|tojson }},
    recursos: {{ block.get_metadata().get('recursos', [])|tojson }}
};

let editingHitoId = null;
let editingRecursoId = null;

const frases = [
    { quote: "El éxito es la suma de pequeños esfuerzos repetidos día tras día.", author: "Robert Collier" },
    { quote: "No esperes por el momento perfecto, toma el momento y hazlo perfecto.", author: "Zoey Sayward" },
    { quote: "El futuro pertenece a quienes creen en la belleza de sus sueños.", author: "Eleanor Roosevelt" },
    { quote: "La disciplina es el puente entre metas y logros.", author: "Jim Rohn" },
    { quote: "El conocimiento es poder, pero el conocimiento aplicado es súper poder.", author: "Robin Sharma" }
];

document.addEventListener('DOMContentLoaded', function() {
    loadHitos();
    loadRecursos();
    updateStats();
    updateMotivacion();
    
    // Cambiar frase motivacional cada 30 segundos
    setInterval(updateMotivacion, 30000);
});

function loadHitos() {
    const container = document.getElementById('hitosTimeline');
    container.innerHTML = '';
    
    if (objetivoData.hitos.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="bi bi-flag" style="font-size: 2rem; opacity: 0.5;"></i>
                <p class="mt-2">No hay hitos definidos para este objetivo</p>
            </div>
        `;
        return;
    }
    
    objetivoData.hitos.forEach((hito, index) => {
        const hitoElement = createHitoElement(hito, index);
        container.appendChild(hitoElement);
    });
}

function createHitoElement(hito, index) {
    const div = document.createElement('div');
    div.className = `hito-item ${hito.completado ? 'completado' : ''}`;
    
    const fechaFormatted = hito.fecha ? new Date(hito.fecha).toLocaleDateString() : '';
    
    div.innerHTML = `
        <div class="hito-header">
            <h5 class="hito-titulo">${hito.titulo}</h5>
            <span class="hito-fecha">${fechaFormatted}</span>
        </div>
        ${hito.descripcion ? `<p class="hito-descripcion">${hito.descripcion}</p>` : ''}
        <div class="hito-actions">
            <button class="btn btn-sm ${hito.completado ? 'btn-success' : 'btn-outline-success'}" 
                    onclick="toggleHitoCompletado('${hito.id}')">
                <i class="bi ${hito.completado ? 'bi-check-circle-fill' : 'bi-circle'}"></i>
                ${hito.completado ? 'Completado' : 'Marcar como completado'}
            </button>
            <button class="btn btn-sm btn-outline-primary" onclick="editHito('${hito.id}')">
                <i class="bi bi-pencil"></i> Editar
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteHito('${hito.id}')">
                <i class="bi bi-trash"></i> Eliminar
            </button>
        </div>
    `;
    
    return div;
}

function loadRecursos() {
    const container = document.getElementById('recursosGrid');
    container.innerHTML = '';
    
    if (objetivoData.recursos.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4" style="grid-column: 1 / -1;">
                <i class="bi bi-collection" style="font-size: 2rem; opacity: 0.5;"></i>
                <p class="mt-2">No hay recursos agregados</p>
            </div>
        `;
        return;
    }
    
    objetivoData.recursos.forEach(recurso => {
        const recursoElement = createRecursoElement(recurso);
        container.appendChild(recursoElement);
    });
}

function createRecursoElement(recurso) {
    const div = document.createElement('div');
    div.className = 'recurso-card';
    
    div.innerHTML = `
        <div class="recurso-header">
            <div class="recurso-icon ${recurso.tipo}">
                <i class="${getRecursoIcon(recurso.tipo)}"></i>
            </div>
            <h6 class="recurso-titulo">${recurso.titulo}</h6>
        </div>
        ${recurso.descripcion ? `<p class="recurso-descripcion">${recurso.descripcion}</p>` : ''}
        <div class="d-flex justify-content-between align-items-center mt-2">
            ${recurso.url ? `<a href="${recurso.url}" target="_blank" class="btn btn-sm btn-outline-primary">Abrir</a>` : '<span></span>'}
            <div>
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="editRecurso('${recurso.id}')">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteRecurso('${recurso.id}')">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    return div;
}

function getRecursoIcon(tipo) {
    const icons = {
        'libro': 'bi bi-book',
        'video': 'bi bi-play-circle',
        'articulo': 'bi bi-file-text',
        'curso': 'bi bi-mortarboard',
        'herramienta': 'bi bi-tools'
    };
    return icons[tipo] || 'bi bi-file';
}

function updateStats() {
    const totalHitos = objetivoData.hitos.length;
    const hitosCompletados = objetivoData.hitos.filter(h => h.completado).length;
    const progreso = totalHitos > 0 ? (hitosCompletados / totalHitos) * 100 : 0;
    
    document.getElementById('totalHitos').textContent = totalHitos;
    document.getElementById('hitosCompletados').textContent = hitosCompletados;
    document.getElementById('progressPercentage').textContent = `${Math.round(progreso)}%`;
    document.getElementById('progressFill').style.width = `${progreso}%`;
    
    // Días restantes
    if (objetivoData.fechaLimite) {
        const fechaLimite = new Date(objetivoData.fechaLimite);
        const hoy = new Date();
        const diasRestantes = Math.ceil((fechaLimite - hoy) / (1000 * 60 * 60 * 24));
        
        document.getElementById('diasRestantes').textContent = diasRestantes > 0 ? diasRestantes : '0';
        document.getElementById('deadlineText').textContent = `Fecha límite: ${fechaLimite.toLocaleDateString()}`;
        
        // Estado del deadline
        const deadlineStatus = document.getElementById('deadlineStatus');
        if (diasRestantes < 0) {
            deadlineStatus.textContent = 'Vencido';
            deadlineStatus.className = 'deadline-status urgente';
        } else if (diasRestantes <= 7) {
            deadlineStatus.textContent = 'Urgente';
            deadlineStatus.className = 'deadline-status urgente';
        } else if (diasRestantes <= 30) {
            deadlineStatus.textContent = 'Próximo';
            deadlineStatus.className = 'deadline-status proximo';
        } else {
            deadlineStatus.textContent = 'A tiempo';
            deadlineStatus.className = 'deadline-status tiempo';
        }
    } else {
        document.getElementById('diasRestantes').textContent = '--';
        document.getElementById('deadlineText').textContent = 'Fecha límite: No definida';
        document.getElementById('deadlineStatus').textContent = 'Sin definir';
        document.getElementById('deadlineStatus').className = 'deadline-status';
    }
    
    // Velocidad de progreso (simulada)
    const velocidad = Math.min(progreso / 4, 25); // Máximo 25% por semana
    document.getElementById('velocidadProgreso').textContent = `${Math.round(velocidad)}%`;
}

function updateMotivacion() {
    const fraseAleatoria = frases[Math.floor(Math.random() * frases.length)];
    document.getElementById('motivacionQuote').textContent = `"${fraseAleatoria.quote}"`;
    document.querySelector('.motivacion-author').textContent = `- ${fraseAleatoria.author}`;
}

function addHito() {
    editingHitoId = null;
    document.getElementById('hitoModalTitle').textContent = 'Agregar Hito';
    document.getElementById('hitoForm').reset();
    
    const modal = new bootstrap.Modal(document.getElementById('hitoModal'));
    modal.show();
}

function editHito(id) {
    const hito = objetivoData.hitos.find(h => h.id === id);
    if (!hito) return;
    
    editingHitoId = id;
    document.getElementById('hitoModalTitle').textContent = 'Editar Hito';
    document.getElementById('hitoTitulo').value = hito.titulo;
    document.getElementById('hitoDescripcion').value = hito.descripcion || '';
    document.getElementById('hitoFecha').value = hito.fecha || '';
    
    const modal = new bootstrap.Modal(document.getElementById('hitoModal'));
    modal.show();
}

function saveHito() {
    const form = document.getElementById('hitoForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const hitoData = {
        id: editingHitoId || Date.now().toString(),
        titulo: document.getElementById('hitoTitulo').value,
        descripcion: document.getElementById('hitoDescripcion').value,
        fecha: document.getElementById('hitoFecha').value,
        completado: false
    };
    
    if (editingHitoId) {
        const index = objetivoData.hitos.findIndex(h => h.id === editingHitoId);
        if (index !== -1) {
            objetivoData.hitos[index] = { ...objetivoData.hitos[index], ...hitoData };
        }
    } else {
        objetivoData.hitos.push(hitoData);
    }
    
    saveData();
    loadHitos();
    updateStats();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('hitoModal'));
    modal.hide();
}

function deleteHito(id) {
    if (confirm('¿Estás seguro de que quieres eliminar este hito?')) {
        objetivoData.hitos = objetivoData.hitos.filter(h => h.id !== id);
        saveData();
        loadHitos();
        updateStats();
    }
}

function toggleHitoCompletado(id) {
    const hito = objetivoData.hitos.find(h => h.id === id);
    if (hito) {
        hito.completado = !hito.completado;
        saveData();
        loadHitos();
        updateStats();
    }
}

function addRecurso() {
    editingRecursoId = null;
    document.getElementById('recursoModalTitle').textContent = 'Agregar Recurso';
    document.getElementById('recursoForm').reset();
    
    const modal = new bootstrap.Modal(document.getElementById('recursoModal'));
    modal.show();
}

function editRecurso(id) {
    const recurso = objetivoData.recursos.find(r => r.id === id);
    if (!recurso) return;
    
    editingRecursoId = id;
    document.getElementById('recursoModalTitle').textContent = 'Editar Recurso';
    document.getElementById('recursoTipo').value = recurso.tipo;
    document.getElementById('recursoTitulo').value = recurso.titulo;
    document.getElementById('recursoDescripcion').value = recurso.descripcion || '';
    document.getElementById('recursoUrl').value = recurso.url || '';
    
    const modal = new bootstrap.Modal(document.getElementById('recursoModal'));
    modal.show();
}

function saveRecurso() {
    const form = document.getElementById('recursoForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const recursoData = {
        id: editingRecursoId || Date.now().toString(),
        tipo: document.getElementById('recursoTipo').value,
        titulo: document.getElementById('recursoTitulo').value,
        descripcion: document.getElementById('recursoDescripcion').value,
        url: document.getElementById('recursoUrl').value
    };
    
    if (editingRecursoId) {
        const index = objetivoData.recursos.findIndex(r => r.id === editingRecursoId);
        if (index !== -1) {
            objetivoData.recursos[index] = recursoData;
        }
    } else {
        objetivoData.recursos.push(recursoData);
    }
    
    saveData();
    loadRecursos();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('recursoModal'));
    modal.hide();
}

function deleteRecurso(id) {
    if (confirm('¿Estás seguro de que quieres eliminar este recurso?')) {
        objetivoData.recursos = objetivoData.recursos.filter(r => r.id !== id);
        saveData();
        loadRecursos();
    }
}

function editObjetivo() {
    document.getElementById('objetivoTituloInput').value = objetivoData.titulo;
    document.getElementById('objetivoDescripcion').value = objetivoData.descripcion;
    document.getElementById('objetivoCategoria').value = objetivoData.categoria;
    document.getElementById('objetivoFechaLimite').value = objetivoData.fechaLimite;
    document.getElementById('objetivoPrioridad').value = objetivoData.prioridad;
    
    const modal = new bootstrap.Modal(document.getElementById('objetivoModal'));
    modal.show();
}

function saveObjetivo() {
    const form = document.getElementById('objetivoForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    objetivoData.titulo = document.getElementById('objetivoTituloInput').value;
    objetivoData.descripcion = document.getElementById('objetivoDescripcion').value;
    objetivoData.categoria = document.getElementById('objetivoCategoria').value;
    objetivoData.fechaLimite = document.getElementById('objetivoFechaLimite').value;
    objetivoData.prioridad = document.getElementById('objetivoPrioridad').value;
    
    document.getElementById('objetivoTitulo').textContent = objetivoData.titulo;
    document.getElementById('objetivoCategoria').textContent = objetivoData.categoria;
    
    saveData();
    updateStats();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('objetivoModal'));
    modal.hide();
}

function saveData() {
    fetch(`/espacio-personal/api/blocks/{{ block.id }}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            title: objetivoData.titulo,
            metadata: {
                descripcion: objetivoData.descripcion,
                categoria: objetivoData.categoria,
                fechaLimite: objetivoData.fechaLimite,
                prioridad: objetivoData.prioridad,
                hitos: objetivoData.hitos,
                recursos: objetivoData.recursos
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Objetivo guardado correctamente');
        }
    })
    .catch(error => console.error('Error saving objetivo:', error));
}

function exportObjetivo() {
    const data = {
        objetivo: {
            titulo: objetivoData.titulo,
            descripcion: objetivoData.descripcion,
            categoria: objetivoData.categoria,
            fechaLimite: objetivoData.fechaLimite,
            prioridad: objetivoData.prioridad
        },
        hitos: objetivoData.hitos,
        recursos: objetivoData.recursos,
        estadisticas: {
            totalHitos: objetivoData.hitos.length,
            hitosCompletados: objetivoData.hitos.filter(h => h.completado).length,
            progreso: objetivoData.hitos.length > 0 ? (objetivoData.hitos.filter(h => h.completado).length / objetivoData.hitos.length) * 100 : 0
        }
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${objetivoData.titulo || 'objetivo'}_datos.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function getCsrfToken() {
    return document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
}
</script>
{% endblock %}