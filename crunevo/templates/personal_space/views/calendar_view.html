{% extends 'base.html' %}
{% block title %}Calendario - Mi Espacio Personal{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personal-space.css') }}">
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<style>
/* Modern Calendar Styles */
.calendar-container {
    background: white;
    border-radius: 16px;
    box-shadow: 0 8px 25px rgba(111, 66, 193, 0.1);
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid rgba(111, 66, 193, 0.1);
}

.dark-mode .calendar-container {
    background: #1e293b;
    color: white;
    border-color: rgba(139, 92, 246, 0.2);
}

.fc-event {
    border: none !important;
    border-radius: 8px !important;
    padding: 4px 8px !important;
    font-size: 0.85rem !important;
    font-weight: 500 !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    transition: all 0.3s ease !important;
}

    transform: translateY(-1px) !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
}

.fc-event.type-objetivo {
    background: linear-gradient(135deg, #6f42c1, #8b5cf6) !important;
}

.fc-event.type-tarea {
    background: linear-gradient(135deg, #0ea5e9, #06b6d4) !important;
}

.fc-event.type-recordatorio {
    background: linear-gradient(135deg, #f59e0b, #fbbf24) !important;
}

.upcoming-events {
    background: white;
    border-radius: 16px;
    box-shadow: 0 8px 25px rgba(111, 66, 193, 0.1);
    padding: 1.5rem;
    border: 1px solid rgba(111, 66, 193, 0.1);
}

.dark-mode .upcoming-events {
    background: #1e293b;
    color: white;
    border-color: rgba(139, 92, 246, 0.2);
}

.event-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-radius: 12px;
    margin-bottom: 0.75rem;
    border-left: 4px solid;
    background: #f8fafc;
    transition: all 0.3s ease;
    cursor: pointer;
}

.event-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(111, 66, 193, 0.15);
}

.dark-mode .event-item {
    background: #334155;
}

.event-item.type-objetivo {
    border-left-color: #6f42c1;
    background: linear-gradient(135deg, rgba(111, 66, 193, 0.05), rgba(139, 92, 246, 0.05));
}

.event-item.type-tarea {
    border-left-color: #0ea5e9;
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.05), rgba(6, 182, 212, 0.05));
}

.event-item.type-recordatorio {
    border-left-color: #f59e0b;
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(251, 191, 36, 0.05));
}

.event-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    color: white;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.event-details h6 {
    margin: 0;
    font-weight: 600;
    color: var(--bs-dark);
}

.event-details p {
    margin: 0;
    font-size: 0.85rem;
    opacity: 0.7;
    color: var(--bs-secondary);
}
</style>
{% endblock %}

{% block content %}
<div class="personal-space-container">
    <!-- Modern Header -->
    <div class="modern-block-container">
        <div class="modern-hero">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="hero-title">
                            <i class="bi bi-calendar3 me-3"></i>
                            Calendario Personal
                        </h1>
                        <p class="hero-subtitle">Visualiza y gestiona tus tareas, objetivos y recordatorios en un calendario interactivo</p>
                        
                        <!-- Calendar Stats -->
                        <div class="stats-grid mt-4">
                            <div class="stat-card">
                                <div class="stat-number">12</div>
                                <div class="stat-label">Eventos este mes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">5</div>
                                <div class="stat-label">Próximos</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">8</div>
                                <div class="stat-label">Completados</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="hero-actions">
                            <button class="btn btn-primary btn-lg me-2" onclick="addQuickEvent()">
                                <i class="bi bi-plus-lg me-2"></i>
                                Evento Rápido
                            </button>
                            <a href="/espacio-personal" class="btn btn-outline-light btn-lg">
                                <i class="bi bi-arrow-left me-2"></i>
                                Volver
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Calendar -->
            <div class="col-lg-8">
                <div class="calendar-container">
                    <div id="calendar"></div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Próximos Eventos -->
                <div class="upcoming-events mb-4">
                    <h5 class="mb-3">
                        <i class="bi bi-clock text-warning me-2"></i>
                        Próximos Eventos
                    </h5>
                    <div id="upcomingEventsList">
                        <!-- Ejemplo: Objetivo -->
                        <div class="event-item type-objetivo">
                            <div class="event-icon" style="background: linear-gradient(135deg, #6f42c1, #8b5cf6)">
                                <i class="bi bi-trophy"></i>
                            </div>
                            <div class="event-details flex-grow-1">
                                <h6>Completar Proyecto Final</h6>
                                <p>15 Mayo 2024 - Objetivo</p>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="editEvent(1)">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                        
                        <!-- Ejemplo: Tarea -->
                        <div class="event-item type-tarea">
                            <div class="event-icon" style="background: linear-gradient(135deg, #0ea5e9, #06b6d4)">
                                <i class="bi bi-clipboard-check"></i>
                            </div>
                            <div class="event-details flex-grow-1">
                                <h6>Reunión de Equipo</h6>
                                <p>12 Mayo 2024 - Tarea</p>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="editEvent(2)">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                        
                        <!-- Ejemplo: Recordatorio -->
                        <div class="event-item type-recordatorio">
                            <div class="event-icon" style="background: linear-gradient(135deg, #f59e0b, #fbbf24)">
                                <i class="bi bi-alarm"></i>
                            </div>
                            <div class="event-details flex-grow-1">
                                <h6>Entrega de Documentos</h6>
                                <p>10 Mayo 2024 - Recordatorio</p>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="editEvent(3)">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                        
                        <!-- Ejemplo: Tarea -->
                        <div class="event-item type-tarea">
                            <div class="event-icon" style="background: linear-gradient(135deg, #0ea5e9, #06b6d4)">
                                <i class="bi bi-clipboard-check"></i>
                            </div>
                            <div class="event-details flex-grow-1">
                                <h6>Revisión de Código</h6>
                                <p>8 Mayo 2024 - Tarea</p>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="editEvent(4)">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                        
                        <!-- Ejemplo: Objetivo -->
                        <div class="event-item type-objetivo">
                            <div class="event-icon" style="background: linear-gradient(135deg, #6f42c1, #8b5cf6)">
                                <i class="bi bi-trophy"></i>
                            </div>
                            <div class="event-details flex-grow-1">
                                <h6>Lanzamiento Beta</h6>
                                <p>20 Mayo 2024 - Objetivo</p>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="editEvent(5)">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="upcoming-events">
                    <h6 class="mb-3">
                        <i class="bi bi-funnel me-2"></i>
                        Filtros de Eventos
                    </h6>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showObjetivos" checked>
                        <label class="form-check-label d-flex align-items-center" for="showObjetivos">
                            <span class="badge me-2" style="background: linear-gradient(135deg, #6f42c1, #8b5cf6); width: 12px; height: 12px; border-radius: 50%;"></span>
                            <span class="fw-medium">Objetivos</span>
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showTareas" checked>
                        <label class="form-check-label d-flex align-items-center" for="showTareas">
                            <span class="badge me-2" style="background: linear-gradient(135deg, #0ea5e9, #06b6d4); width: 12px; height: 12px; border-radius: 50%;"></span>
                            <span class="fw-medium">Tareas</span>
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showRecordatorios" checked>
                        <label class="form-check-label d-flex align-items-center" for="showRecordatorios">
                            <span class="badge me-2" style="background: linear-gradient(135deg, #f59e0b, #fbbf24); width: 12px; height: 12px; border-radius: 50%;"></span>
                            <span class="fw-medium">Recordatorios</span>
                        </label>
                    </div>
                    
                    <!-- Acciones rápidas -->
                    <div class="mt-4 pt-3 border-top">
                        <h6 class="mb-3 text-muted small">ACCIONES RÁPIDAS</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="calendar.today()">
                                <i class="bi bi-calendar-today me-1"></i>
                                Ir a Hoy
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="calendar.changeView('timeGridWeek')">
                                <i class="bi bi-calendar-week me-1"></i>
                                Vista Semanal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Evento Rápido -->
<div class="modal fade" id="quickEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crear Evento Rápido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickEventForm">
                    <div class="mb-3">
                        <label class="form-label">Título</label>
                        <input type="text" class="form-control" id="eventTitle" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo</label>
                        <select class="form-select" id="eventType">
                            <option value="tarea">Tarea</option>
                            <option value="objetivo">Objetivo</option>
                            <option value="recordatorio">Recordatorio</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-control" id="eventDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveQuickEvent()">Crear Evento</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
let calendar;

document.addEventListener('DOMContentLoaded', function() {
    initializeCalendar();
    setupEventFilters();
});

function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');
    
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        events: [
            // Eventos de ejemplo
            {
                id: '1',
                title: 'Completar Proyecto Final',
                start: '2024-05-15',
                className: 'type-objetivo',
                extendedProps: {
                    type: 'objetivo',
                    blockId: 1
                }
            },
            {
                id: '2',
                title: 'Reunión de Equipo',
                start: '2024-05-12',
                className: 'type-tarea',
                extendedProps: {
                    type: 'tarea',
                    blockId: 2
                }
            },
            {
                id: '3',
                title: 'Entrega de Documentos',
                start: '2024-05-10',
                className: 'type-recordatorio',
                extendedProps: {
                    type: 'recordatorio',
                    blockId: 3
                }
            },
            {
                id: '4',
                title: 'Revisión de Código',
                start: '2024-05-08',
                className: 'type-tarea',
                extendedProps: {
                    type: 'tarea',
                    blockId: 4
                }
            },
            {
                id: '5',
                title: 'Lanzamiento Beta',
                start: '2024-05-20',
                className: 'type-objetivo',
                extendedProps: {
                    type: 'objetivo',
                    blockId: 5
                }
            },
            {
                id: '6',
                title: 'Presentación Cliente',
                start: '2024-05-18',
                className: 'type-tarea',
                extendedProps: {
                    type: 'tarea',
                    blockId: 6
                }
            },
            {
                id: '7',
                title: 'Backup Semanal',
                start: '2024-05-14',
                className: 'type-recordatorio',
                extendedProps: {
                    type: 'recordatorio',
                    blockId: 7
                }
            }
        ],
        eventClick: function(info) {
            editEvent(info.event.extendedProps.blockId);
        },
        dateClick: function(info) {
            addQuickEvent(info.dateStr);
        }
    });
    
    calendar.render();
}

function setupEventFilters() {
    ['showObjetivos', 'showTareas', 'showRecordatorios'].forEach(filterId => {
        document.getElementById(filterId).addEventListener('change', filterEvents);
    });
}

function filterEvents() {
    const showObjetivos = document.getElementById('showObjetivos').checked;
    const showTareas = document.getElementById('showTareas').checked;
    const showRecordatorios = document.getElementById('showRecordatorios').checked;
    
    calendar.getEvents().forEach(event => {
        const type = event.extendedProps.type;
        let shouldShow = false;
        
        if (type === 'objetivo' && showObjetivos) shouldShow = true;
        if (type === 'tarea' && showTareas) shouldShow = true;
        if (type === 'recordatorio' && showRecordatorios) shouldShow = true;
        
        event.setProp('display', shouldShow ? 'auto' : 'none');
    });
}

function addQuickEvent(date = null) {
    if (date) {
        document.getElementById('eventDate').value = date;
    }
    const modal = new bootstrap.Modal(document.getElementById('quickEventModal'));
    modal.show();
}

function saveQuickEvent() {
    const form = document.getElementById('quickEventForm');
    const formData = new FormData();
    
    formData.append('type', document.getElementById('eventType').value);
    formData.append('title', document.getElementById('eventTitle').value);
    formData.append('content', document.getElementById('eventDescription').value);
    formData.append('deadline', document.getElementById('eventDate').value);
    
    fetch('/espacio-personal/api/blocks', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error al crear el evento');
        }
    });
}

function editEvent(blockId) {
    window.location.href = `/espacio-personal/bloque/${blockId}`;
}

function getCsrfToken() {
    return document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
}
</script>
{% endblock %}