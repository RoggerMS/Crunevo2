{% extends 'base.html' %}
{% set metadata = block.get_metadata() %}
{% block title %}Editor: {{ block.title }}{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personal-space.css') }}">
{% endblock %}

{% block content %}
<div class="editor-workspace">
    <aside class="editor-sidebar">
        <div class="sidebar-header">
            <a href="{{ url_for('personal_space.view_bitacora') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver a la Bitácora
            </a>
        </div>

        <div class="sidebar-section">
            <label class="form-label">Icono</label>
            <button class="icon-display-btn" id="iconDisplayBtn" data-bs-toggle="popover" data-bs-placement="bottom" title="Elige un icono">
                <i id="currentIcon" class="{{ metadata.get('icon', 'bi bi-file-text') }}"></i>
            </button>
        </div>

        <div class="sidebar-section">
            <label for="templateSelectorInput" class="form-label">Plantilla</label>
            <select id="templateSelectorInput" class="form-select">
                <option value="">Ninguna</option>
                <option value="apuntes" {% if metadata.get('template_type') == 'apuntes' %}selected{% endif %}>Apuntes de Clase</option>
                <option value="proyecto" {% if metadata.get('template_type') == 'proyecto' %}selected{% endif %}>Proyecto</option>
                <option value="investigacion" {% if metadata.get('template_type') == 'investigacion' %}selected{% endif %}>Investigación</option>
                <option value="resumen" {% if metadata.get('template_type') == 'resumen' %}selected{% endif %}>Resumen</option>
            </select>
        </div>

        <div class="sidebar-section">
            <label for="tagsInput" class="form-label">Etiquetas</label>
            <input type="text" id="tagsInput" class="form-control" placeholder="Presiona Enter para agregar...">
            <div id="tagsContainer" class="mt-2"></div>
        </div>

        <div class="sidebar-footer">
            <span id="saveIndicator" class="text-muted small">Guardado</span>
            <button class="btn btn-sm btn-outline-danger" id="deleteNoteBtn">Eliminar</button>
        </div>
    </aside>

    <main class="editor-main-content">
        <div class="editor-title-container">
            <input type="text" id="noteTitleInput" class="nota-title-input" value="{{ block.title }}" placeholder="Nueva nota...">
        </div>

        <div id="noteContent" class="note-content-area"></div>

        <div class="add-block-container">
            <button id="addBlockBtn" class="btn btn-light w-100">
                <i class="bi bi-plus"></i> Agregar bloque
            </button>
        </div>
    </main>
</div>

<script>
    const noteData = {
        title: {{ block.title|tojson }},
        icon: {{ metadata.get('icon', 'bi bi-file-text')|tojson }},
        template_type: {{ metadata.get('template_type', '')|tojson }},
        blocks: {{ metadata.get('blocks', [])|tojson }},
        tags: {{ metadata.get('tags', [])|tojson }}
    };

    let blockIdCounter = noteData.blocks.length;
    let autoSaveTimeout;

    document.addEventListener('DOMContentLoaded', function () {
        loadBlocks();
        loadTags();
        setupEventListeners();
        setInterval(saveNote, 30000);
    });

    function setupEventListeners() {
        document.getElementById('noteTitleInput').addEventListener('input', function () {
            noteData.title = this.value;
            debounceAutoSave();
        });

        document.getElementById('templateSelectorInput').addEventListener('change', function () {
            noteData.template_type = this.value;
            applyTemplate(this.value);
            debounceAutoSave();
        });

        document.getElementById('tagsInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const tag = this.value.trim();
                if (tag && !noteData.tags.includes(tag)) {
                    noteData.tags.push(tag);
                    this.value = '';
                    loadTags();
                    debounceAutoSave();
                }
            }
        });

        document.getElementById('addBlockBtn').addEventListener('click', function () {
            addNewBlock();
            debounceAutoSave();
        });

        document.getElementById('deleteNoteBtn').addEventListener('click', function () {
            if (confirm('¿Eliminar esta nota?')) {
                fetch(`/espacio-personal/api/blocks/{{ block.id }}`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': getCsrfToken() }
                }).then(r => r.json()).then(data => {
                    if (data.success) {
                        window.location.href = "{{ url_for('personal_space.view_bitacora') }}";
                    }
                });
            }
        });

        initIconPopover();
    }

    function initIconPopover() {
        const ICONS = ['bi-file-text','bi-journal-text','bi-lightbulb','bi-book','bi-code-slash','bi-bookmark-star','bi-check2-circle','bi-star','bi-calendar-event','bi-clipboard-data','bi-collection','bi-diagram-3','bi-emoji-smile','bi-gear','bi-graph-up','bi-heart','bi-link-45deg','bi-list-check','bi-pen','bi-quote','bi-search','bi-shield-check','bi-stickies','bi-translate'];
        const btn = document.getElementById('iconDisplayBtn');
        const popover = new bootstrap.Popover(btn, {
            html: true,
            sanitize: false,
            content: () => {
                return `<div class="icon-grid">${ICONS.map(icon => `<i class='bi ${icon} icon-option' data-icon='bi ${icon}'></i>`).join('')}</div>`;
            }
        });

        document.addEventListener('click', (e) => {
            const iconEl = e.target.closest('.icon-option');
            if (iconEl) {
                const iconClass = iconEl.getAttribute('data-icon');
                noteData.icon = iconClass;
                document.getElementById('currentIcon').className = iconClass;
                debounceAutoSave();
                popover.hide();
            }
        });
    }

    function loadBlocks() {
        const container = document.getElementById('noteContent');
        container.innerHTML = '';
        noteData.blocks.forEach((block, index) => {
            const blockElement = createBlockElement(block, index);
            container.appendChild(blockElement);
        });
    }

    function createBlockElement(block, index) {
        const div = document.createElement('div');
        div.className = 'content-block';
        div.dataset.index = index;

        let content = '';
        switch (block.type) {
            case 'heading':
                content = `<h3 class="block-heading" contenteditable="true" data-field="content">${block.content || ''}</h3>`;
                break;
            case 'text':
                content = `<p class="block-text" contenteditable="true" data-field="content">${block.content || ''}</p>`;
                break;
            case 'list':
                const listItems = (block.items || []).map(item =>
                    `<div class="block-list-item">
                        <span>•</span>
                        <span contenteditable="true" data-field="item">${item}</span>
                    </div>`
                ).join('');
                content = `<div class="block-list" data-field="items">${listItems}</div>`;
                break;
            case 'code':
                content = `<pre class="block-code" contenteditable="true" data-field="content">${block.content || ''}</pre>`;
                break;
            case 'quote':
                content = `<blockquote class="block-quote" contenteditable="true" data-field="content">${block.content || ''}</blockquote>`;
                break;
        }

        div.innerHTML = `
            <div class="block-controls">
                <button class="btn btn-sm btn-outline-danger" onclick="removeBlock(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            <div class="block-type-selector">
                <button class="block-type-btn ${block.type === 'heading' ? 'active' : ''}" onclick="changeBlockType(${index}, 'heading')">H</button>
                <button class="block-type-btn ${block.type === 'text' ? 'active' : ''}" onclick="changeBlockType(${index}, 'text')">T</button>
                <button class="block-type-btn ${block.type === 'list' ? 'active' : ''}" onclick="changeBlockType(${index}, 'list')">L</button>
                <button class="block-type-btn ${block.type === 'code' ? 'active' : ''}" onclick="changeBlockType(${index}, 'code')">C</button>
                <button class="block-type-btn ${block.type === 'quote' ? 'active' : ''}" onclick="changeBlockType(${index}, 'quote')">Q</button>
            </div>
            ${content}
        `;

        div.querySelectorAll('[contenteditable]').forEach(element => {
            element.addEventListener('input', function () {
                updateBlockContent(index, this);
                debounceAutoSave();
            });
        });

        return div;
    }

    function addNewBlock() {
        const newBlock = {
            id: blockIdCounter++,
            type: 'text',
            content: ''
        };
        noteData.blocks.push(newBlock);
        loadBlocks();
    }

    function changeBlockType(index, newType) {
        const block = noteData.blocks[index];
        block.type = newType;
        if (newType === 'list') {
            block.items = block.items || [''];
        } else {
            delete block.items;
            block.content = '';
        }
        loadBlocks();
    }

    function updateBlockContent(index, element) {
        const block = noteData.blocks[index];
        const field = element.getAttribute('data-field');

        if (block.type === 'list') {
            const items = Array.from(element.querySelectorAll('[data-field="item"]')).map(el => el.textContent.trim());
            block.items = items;
        } else if (field === 'content') {
            block.content = element.textContent.trim();
        }
    }

    function removeBlock(index) {
        noteData.blocks.splice(index, 1);
        loadBlocks();
    }

    function loadTags() {
        const container = document.getElementById('tagsContainer');
        container.innerHTML = '';
        noteData.tags.forEach((tag, index) => {
            const tagElement = document.createElement('div');
            tagElement.className = 'tag-item';
            tagElement.innerHTML = `
                <span>${tag}</span>
                <span class="tag-remove" onclick="removeTag(${index})">&times;</span>
            `;
            container.appendChild(tagElement);
        });
    }

    function removeTag(index) {
        noteData.tags.splice(index, 1);
        loadTags();
        debounceAutoSave();
    }

    function applyTemplate(templateType) {
        const templates = {
            'apuntes': [
                { type: 'heading', content: 'Tema de la clase' },
                { type: 'text', content: 'Fecha y contexto...' },
                { type: 'heading', content: 'Conceptos principales' },
                { type: 'list', items: ['Concepto 1', 'Concepto 2'] },
                { type: 'heading', content: 'Notas adicionales' },
                { type: 'text', content: 'Observaciones y reflexiones...' }
            ],
            'proyecto': [
                { type: 'heading', content: 'Nombre del proyecto' },
                { type: 'text', content: 'Descripción general...' },
                { type: 'heading', content: 'Objetivos' },
                { type: 'list', items: ['Objetivo 1', 'Objetivo 2'] },
                { type: 'heading', content: 'Tareas' },
                { type: 'list', items: ['Tarea 1', 'Tarea 2'] }
            ],
            'investigacion': [
                { type: 'heading', content: 'Título de la investigación' },
                { type: 'text', content: 'Pregunta de investigación...' },
                { type: 'heading', content: 'Hipótesis' },
                { type: 'text', content: 'Hipótesis principal...' },
                { type: 'heading', content: 'Fuentes' },
                { type: 'list', items: ['Fuente 1', 'Fuente 2'] }
            ],
            'resumen': [
                { type: 'heading', content: 'Título del material' },
                { type: 'text', content: 'Autor y contexto...' },
                { type: 'heading', content: 'Ideas principales' },
                { type: 'list', items: ['Idea 1', 'Idea 2'] },
                { type: 'heading', content: 'Conclusiones' },
                { type: 'text', content: 'Síntesis personal...' }
            ]
        };

        if (templates[templateType]) {
            noteData.blocks = templates[templateType];
            loadBlocks();
        }
    }

    function debounceAutoSave() {
        document.getElementById('saveIndicator').textContent = 'Guardando...';
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(saveNote, 2000);
    }

    function saveNote() {
        fetch(`/espacio-personal/api/blocks/{{ block.id }}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                title: noteData.title,
                metadata: {
                    icon: noteData.icon,
                    template_type: noteData.template_type,
                    blocks: noteData.blocks,
                    tags: noteData.tags
                }
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSaveIndicator();
            }
        })
        .catch(error => console.error('Error saving note:', error));
    }

    function showSaveIndicator() {
        document.getElementById('saveIndicator').textContent = 'Guardado';
    }

    function getCsrfToken() {
        return document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
    }
</script>
{% endblock %}

