{% extends 'base.html' %}
{% block title %}Lista - {{ block.title }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personal-space.css') }}">
<style>
.lista-container {
    max-width: 700px;
    margin: 0 auto;
    padding: 20px;
}

.lista-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
}

.lista-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 120px;
    height: 120px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    animation: float 6s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(180deg); }
}

.lista-info {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
}

.lista-icon {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
}

.lista-details h2 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 600;
}

.lista-stats {
    display: flex;
    gap: 20px;
    margin-top: 15px;
}

.stat-item {
    background: rgba(255, 255, 255, 0.2);
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

.progress-ring {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 80px;
    height: 80px;
}

.progress-ring circle {
    fill: none;
    stroke: rgba(255, 255, 255, 0.3);
    stroke-width: 4;
}

.progress-ring .progress {
    stroke: rgba(255, 255, 255, 0.9);
    stroke-linecap: round;
    transition: stroke-dasharray 0.5s;
}

.progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.9rem;
    font-weight: 600;
    text-align: center;
}

.content-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.section-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 20px;
    color: var(--bs-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.add-item-form {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    padding: 15px;
    background: var(--bs-gray-50);
    border-radius: 8px;
    border: 2px dashed var(--bs-border-color);
    transition: all 0.3s;
}

.add-item-form:focus-within {
    border-color: var(--bs-primary);
    background: var(--bs-primary-bg);
}

.add-item-input {
    flex-grow: 1;
    border: none;
    background: transparent;
    font-size: 1rem;
    padding: 8px 0;
    outline: none;
}

.add-item-input::placeholder {
    color: var(--bs-secondary);
    font-style: italic;
}

.items-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.item-element {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border: 1px solid var(--bs-border-color);
    border-radius: 8px;
    margin-bottom: 10px;
    background: white;
    transition: all 0.3s;
    cursor: pointer;
    position: relative;
}

.item-element:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.item-element.completed {
    background: var(--bs-success-bg);
    border-color: var(--bs-success);
    opacity: 0.8;
}

.item-element.completed::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent 40%, var(--bs-success) 50%, transparent 60%);
    opacity: 0.1;
    pointer-events: none;
}

.item-checkbox {
    width: 24px;
    height: 24px;
    border: 2px solid var(--bs-border-color);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    flex-shrink: 0;
}

.item-checkbox:hover {
    border-color: var(--bs-primary);
    background: var(--bs-primary-bg);
}

.item-checkbox.completed {
    background: var(--bs-success);
    border-color: var(--bs-success);
    color: white;
}

.item-checkbox i {
    font-size: 0.9rem;
    opacity: 0;
    transition: opacity 0.3s;
}

.item-checkbox.completed i {
    opacity: 1;
}

.item-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.item-text {
    font-weight: 500;
    font-size: 1rem;
    line-height: 1.4;
    transition: all 0.3s;
}

.item-text.completed {
    text-decoration: line-through;
    color: var(--bs-secondary);
}

.item-meta {
    display: flex;
    gap: 10px;
    font-size: 0.85rem;
    color: var(--bs-secondary);
}

.item-priority {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.priority-alta {
    background: var(--bs-danger-bg);
    color: var(--bs-danger);
}

.priority-media {
    background: var(--bs-warning-bg);
    color: var(--bs-warning);
}

.priority-baja {
    background: var(--bs-success-bg);
    color: var(--bs-success);
}

.item-actions {
    display: flex;
    gap: 5px;
    opacity: 0;
    transition: opacity 0.3s;
}

.item-element:hover .item-actions {
    opacity: 1;
}

.item-date {
    font-size: 0.8rem;
    color: var(--bs-secondary);
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--bs-secondary);
}

.empty-icon {
    font-size: 4rem;
    opacity: 0.3;
    margin-bottom: 20px;
}

.filter-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    padding: 5px;
    background: var(--bs-gray-100);
    border-radius: 8px;
}

.filter-tab {
    flex: 1;
    padding: 8px 15px;
    border: none;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
    font-size: 0.9rem;
}

.filter-tab.active {
    background: white;
    color: var(--bs-primary);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.quick-actions {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.quick-action {
    padding: 8px 15px;
    border: 1px solid var(--bs-border-color);
    border-radius: 20px;
    background: white;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

.quick-action:hover {
    background: var(--bs-primary);
    color: white;
    border-color: var(--bs-primary);
}

.completion-celebration {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    text-align: center;
    z-index: 1000;
    opacity: 0;
    scale: 0.8;
    transition: all 0.3s;
}

.completion-celebration.show {
    opacity: 1;
    scale: 1;
}

.celebration-icon {
    font-size: 3rem;
    color: var(--bs-success);
    margin-bottom: 15px;
}

.btn-floating {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--bs-primary);
    color: white;
    border: none;
    font-size: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    cursor: pointer;
    transition: all 0.3s;
    z-index: 1000;
}

.btn-floating:hover {
    transform: scale(1.1);
    background: var(--bs-primary-dark, #0056b3);
}

@media (max-width: 768px) {
    .lista-container {
        padding: 15px;
    }
    
    .lista-header {
        padding: 20px;
    }
    
    .lista-info {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .lista-stats {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .progress-ring {
        position: static;
        margin: 0 auto;
    }
    
    .item-element {
        padding: 12px;
    }
    
    .quick-actions {
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="lista-container">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-list-check me-2"></i>Lista de Tareas</h2>
            <p class="text-muted">Checklist simple y r√°pido para organizar tus pendientes</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="exportLista()">
                <i class="bi bi-download"></i> Exportar
            </button>
            <button class="btn btn-primary" onclick="editLista()">
                <i class="bi bi-gear"></i> Configurar
            </button>
            <a href="{{ url_for('personal_space.index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>
    
    <!-- Lista Header -->
    <div class="lista-header">
        <div class="lista-info">
            <div class="lista-icon">
                <i class="bi bi-list-check"></i>
            </div>
            <div class="lista-details">
                <h2 id="listaTitulo">{{ block.title }}</h2>
                <div class="lista-stats">
                    <div class="stat-item">
                        <i class="bi bi-check-circle"></i>
                        <span id="completedCount">0</span> completadas
                    </div>
                    <div class="stat-item">
                        <i class="bi bi-circle"></i>
                        <span id="pendingCount">0</span> pendientes
                    </div>
                    <div class="stat-item">
                        <i class="bi bi-list-ul"></i>
                        <span id="totalCount">0</span> total
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Progress Ring -->
        <div class="progress-ring">
            <svg width="80" height="80">
                <circle cx="40" cy="40" r="36" stroke-width="4"></circle>
                <circle cx="40" cy="40" r="36" stroke-width="4" class="progress" 
                        stroke-dasharray="0 226" id="progressCircle"></circle>
            </svg>
            <div class="progress-text">
                <div id="progressPercentage">0%</div>
                <div style="font-size: 0.7rem;">completo</div>
            </div>
        </div>
    </div>
    
    <!-- Content Section -->
    <div class="content-section">
        <!-- Add Item Form -->
        <div class="add-item-form">
            <input type="text" class="add-item-input" id="newItemInput" 
                   placeholder="Agregar nueva tarea..." 
                   onkeypress="handleAddKeypress(event)">
            <button class="btn btn-primary" onclick="addItem()">
                <i class="bi bi-plus"></i>
            </button>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="quick-action" onclick="addQuickItem('Revisar emails')">
                <i class="bi bi-envelope"></i> Revisar emails
            </div>
            <div class="quick-action" onclick="addQuickItem('Llamar a...')">
                <i class="bi bi-telephone"></i> Llamar a...
            </div>
            <div class="quick-action" onclick="addQuickItem('Comprar...')">
                <i class="bi bi-cart"></i> Comprar...
            </div>
            <div class="quick-action" onclick="addQuickItem('Estudiar...')">
                <i class="bi bi-book"></i> Estudiar...
            </div>
        </div>
        
        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <button class="filter-tab active" onclick="filterItems('all')" id="filterAll">
                <i class="bi bi-list-ul"></i> Todas
            </button>
            <button class="filter-tab" onclick="filterItems('pending')" id="filterPending">
                <i class="bi bi-circle"></i> Pendientes
            </button>
            <button class="filter-tab" onclick="filterItems('completed')" id="filterCompleted">
                <i class="bi bi-check-circle"></i> Completadas
            </button>
        </div>
        
        <!-- Items List -->
        <ul class="items-list" id="itemsList">
            <!-- Los items se cargar√°n din√°micamente -->
        </ul>
        
        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">
                <i class="bi bi-list-check"></i>
            </div>
            <h4>¬°Lista vac√≠a!</h4>
            <p>Agrega tu primera tarea para comenzar a organizarte</p>
            <button class="btn btn-primary" onclick="document.getElementById('newItemInput').focus()">
                <i class="bi bi-plus"></i> Agregar tarea
            </button>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<button class="btn-floating" onclick="document.getElementById('newItemInput').focus()" title="Agregar tarea">
    <i class="bi bi-plus"></i>
</button>

<!-- Completion Celebration -->
<div class="completion-celebration" id="completionCelebration">
    <div class="celebration-icon">
        <i class="bi bi-trophy"></i>
    </div>
    <h4>¬°Excelente trabajo!</h4>
    <p>Has completado todas las tareas de tu lista</p>
</div>

<!-- Modal para configurar lista -->
<div class="modal fade" id="listaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configurar Lista</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="listaForm">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="listaTituloInput" required>
                        <label for="listaTituloInput">T√≠tulo de la lista</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <textarea class="form-control" id="listaDescripcion" style="height: 100px"></textarea>
                        <label for="listaDescripcion">Descripci√≥n (opcional)</label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="autoDeleteCompleted">
                        <label class="form-check-label" for="autoDeleteCompleted">
                            Eliminar autom√°ticamente tareas completadas despu√©s de 24 horas
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showPriorities">
                        <label class="form-check-label" for="showPriorities">
                            Mostrar niveles de prioridad
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveLista()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar item -->
<div class="modal fade" id="itemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Tarea</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="itemForm">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="itemTextoInput" required>
                        <label for="itemTextoInput">Texto de la tarea</label>
                    </div>
                    
                    <div class="form-floating mb-3" id="prioritySection" style="display: none;">
                        <select class="form-select" id="itemPrioridad">
                            <option value="baja">Baja</option>
                            <option value="media" selected>Media</option>
                            <option value="alta">Alta</option>
                        </select>
                        <label for="itemPrioridad">Prioridad</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <textarea class="form-control" id="itemNotas" style="height: 80px"></textarea>
                        <label for="itemNotas">Notas adicionales (opcional)</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveItem()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
let listaData = {
    titulo: '{{ block.title }}',
    descripcion: '{{ block.content }}',
    items: {{ block.get_metadata().get('items', [])|tojson }},
    configuracion: {
        autoDeleteCompleted: {{ block.get_metadata().get('auto_delete_completed', false)|tojson }},
        showPriorities: {{ block.get_metadata().get('show_priorities', false)|tojson }}
    }
};

let currentFilter = 'all';
let editingItemIndex = -1;

document.addEventListener('DOMContentLoaded', function() {
    updateHeader();
    loadItems();
    updateStats();
    
    // Auto-save cada 30 segundos
    setInterval(saveData, 30000);
    
    // Focus en input al cargar
    document.getElementById('newItemInput').focus();
});

function updateHeader() {
    document.getElementById('listaTitulo').textContent = listaData.titulo;
    
    // Mostrar/ocultar secci√≥n de prioridades
    const prioritySection = document.getElementById('prioritySection');
    if (listaData.configuracion.showPriorities) {
        prioritySection.style.display = 'block';
    } else {
        prioritySection.style.display = 'none';
    }
}

function loadItems() {
    const container = document.getElementById('itemsList');
    const emptyState = document.getElementById('emptyState');
    
    // Filtrar items seg√∫n el filtro actual
    let filteredItems = listaData.items;
    if (currentFilter === 'pending') {
        filteredItems = listaData.items.filter(item => !item.completed);
    } else if (currentFilter === 'completed') {
        filteredItems = listaData.items.filter(item => item.completed);
    }
    
    container.innerHTML = '';
    
    if (filteredItems.length === 0) {
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    filteredItems.forEach((item, originalIndex) => {
        const actualIndex = listaData.items.findIndex(i => i.id === item.id);
        const li = document.createElement('li');
        li.className = `item-element ${item.completed ? 'completed' : ''}`;
        
        const priorityBadge = listaData.configuracion.showPriorities && item.priority ? 
            `<span class="item-priority priority-${item.priority}">${item.priority}</span>` : '';
        
        const fecha = new Date(item.createdAt).toLocaleDateString();
        
        li.innerHTML = `
            <div class="item-checkbox ${item.completed ? 'completed' : ''}" 
                 onclick="toggleItem(${actualIndex})">
                <i class="bi bi-check"></i>
            </div>
            <div class="item-content">
                <div class="item-text ${item.completed ? 'completed' : ''}">${item.text}</div>
                <div class="item-meta">
                    ${priorityBadge}
                    <span class="item-date">
                        <i class="bi bi-calendar3"></i> ${fecha}
                    </span>
                    ${item.notes ? `<span><i class="bi bi-sticky"></i> Con notas</span>` : ''}
                </div>
            </div>
            <div class="item-actions">
                <button class="btn btn-sm btn-outline-primary" onclick="editItem(${actualIndex})" title="Editar">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${actualIndex})" title="Eliminar">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(li);
    });
}

function updateStats() {
    const total = listaData.items.length;
    const completed = listaData.items.filter(item => item.completed).length;
    const pending = total - completed;
    const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
    
    document.getElementById('totalCount').textContent = total;
    document.getElementById('completedCount').textContent = completed;
    document.getElementById('pendingCount').textContent = pending;
    document.getElementById('progressPercentage').textContent = `${percentage}%`;
    
    // Actualizar c√≠rculo de progreso
    const circumference = 2 * Math.PI * 36; // radio = 36
    const progress = (percentage / 100) * circumference;
    document.getElementById('progressCircle').style.strokeDasharray = `${progress} ${circumference}`;
    
    // Mostrar celebraci√≥n si se complet√≥ todo
    if (total > 0 && completed === total) {
        showCompletionCelebration();
    }
}

function addItem() {
    const input = document.getElementById('newItemInput');
    const text = input.value.trim();
    
    if (text) {
        const newItem = {
            id: Date.now().toString(),
            text: text,
            completed: false,
            createdAt: new Date().toISOString(),
            priority: listaData.configuracion.showPriorities ? 'media' : null,
            notes: ''
        };
        
        listaData.items.unshift(newItem); // Agregar al inicio
        input.value = '';
        loadItems();
        updateStats();
        saveData();
        
        // Animaci√≥n de entrada
        setTimeout(() => {
            const firstItem = document.querySelector('.item-element');
            if (firstItem) {
                firstItem.style.transform = 'translateX(-20px)';
                firstItem.style.opacity = '0';
                setTimeout(() => {
                    firstItem.style.transform = 'translateX(0)';
                    firstItem.style.opacity = '1';
                }, 50);
            }
        }, 50);
    }
}

function addQuickItem(text) {
    document.getElementById('newItemInput').value = text;
    document.getElementById('newItemInput').focus();
    document.getElementById('newItemInput').select();
}

function toggleItem(index) {
    listaData.items[index].completed = !listaData.items[index].completed;
    
    // Si se complet√≥, mover al final
    if (listaData.items[index].completed) {
        const item = listaData.items.splice(index, 1)[0];
        listaData.items.push(item);
    }
    
    loadItems();
    updateStats();
    saveData();
}

function editItem(index) {
    editingItemIndex = index;
    const item = listaData.items[index];
    
    document.getElementById('itemTextoInput').value = item.text;
    document.getElementById('itemPrioridad').value = item.priority || 'media';
    document.getElementById('itemNotas').value = item.notes || '';
    
    const modal = new bootstrap.Modal(document.getElementById('itemModal'));
    modal.show();
}

function saveItem() {
    const form = document.getElementById('itemForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    if (editingItemIndex >= 0) {
        listaData.items[editingItemIndex].text = document.getElementById('itemTextoInput').value;
        listaData.items[editingItemIndex].priority = document.getElementById('itemPrioridad').value;
        listaData.items[editingItemIndex].notes = document.getElementById('itemNotas').value;
        
        loadItems();
        saveData();
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('itemModal'));
        modal.hide();
        editingItemIndex = -1;
    }
}

function deleteItem(index) {
    if (confirm('¬øEst√°s seguro de que quieres eliminar esta tarea?')) {
        listaData.items.splice(index, 1);
        loadItems();
        updateStats();
        saveData();
    }
}

function filterItems(filter) {
    currentFilter = filter;
    
    // Actualizar tabs
    document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
    document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`).classList.add('active');
    
    loadItems();
}

function handleAddKeypress(event) {
    if (event.key === 'Enter') {
        addItem();
    }
}

function editLista() {
    document.getElementById('listaTituloInput').value = listaData.titulo;
    document.getElementById('listaDescripcion').value = listaData.descripcion;
    document.getElementById('autoDeleteCompleted').checked = listaData.configuracion.autoDeleteCompleted;
    document.getElementById('showPriorities').checked = listaData.configuracion.showPriorities;
    
    const modal = new bootstrap.Modal(document.getElementById('listaModal'));
    modal.show();
}

function saveLista() {
    const form = document.getElementById('listaForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    listaData.titulo = document.getElementById('listaTituloInput').value;
    listaData.descripcion = document.getElementById('listaDescripcion').value;
    listaData.configuracion.autoDeleteCompleted = document.getElementById('autoDeleteCompleted').checked;
    listaData.configuracion.showPriorities = document.getElementById('showPriorities').checked;
    
    updateHeader();
    loadItems(); // Recargar para mostrar/ocultar prioridades
    saveData();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('listaModal'));
    modal.hide();
}

function showCompletionCelebration() {
    const celebration = document.getElementById('completionCelebration');
    celebration.classList.add('show');
    
    setTimeout(() => {
        celebration.classList.remove('show');
    }, 3000);
}

function exportLista() {
    const data = {
        lista: {
            titulo: listaData.titulo,
            descripcion: listaData.descripcion,
            configuracion: listaData.configuracion
        },
        items: listaData.items,
        estadisticas: {
            total: listaData.items.length,
            completadas: listaData.items.filter(i => i.completed).length,
            pendientes: listaData.items.filter(i => !i.completed).length,
            porcentajeCompletado: listaData.items.length > 0 ? 
                Math.round((listaData.items.filter(i => i.completed).length / listaData.items.length) * 100) : 0
        },
        exportadoEn: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${listaData.titulo || 'lista'}_datos.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function saveData() {
    fetch(`/espacio-personal/api/blocks/{{ block.id }}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            title: listaData.titulo,
            content: listaData.descripcion,
            metadata: {
                items: listaData.items,
                auto_delete_completed: listaData.configuracion.autoDeleteCompleted,
                show_priorities: listaData.configuracion.showPriorities
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Lista guardada correctamente');
            
            // Auto-eliminar completadas si est√° habilitado
            if (listaData.configuracion.autoDeleteCompleted) {
                autoDeleteCompleted();
            }
        }
    })
    .catch(error => console.error('Error saving lista:', error));
}

function autoDeleteCompleted() {
    const now = new Date();
    const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    
    const originalLength = listaData.items.length;
    listaData.items = listaData.items.filter(item => {
        if (item.completed) {
            const completedDate = new Date(item.completedAt || item.createdAt);
            return completedDate > oneDayAgo;
        }
        return true;
    });
    
    if (listaData.items.length < originalLength) {
        loadItems();
        updateStats();
        console.log(`Auto-eliminadas ${originalLength - listaData.items.length} tareas completadas`);
    }
}

function getCsrfToken() {
    return document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
}
</script>
{% endblock %}