<!-- Personal Space Dashboard - Main redesigned dashboard page -->
{% extends "base.html" %}
{% from 'personal_space/components/layout/DashboardLayout.html' import render_dashboard_layout with context %}
{% from 'personal_space/components/widgets/TemplateGallery.html' import render_template_gallery_modal %}
{% from 'personal_space/components/widgets/BlockFactory.html' import render_block_factory_modal %}
{% from 'personal_space/components/widgets/AnalyticsDashboard.html' import render_analytics_dashboard %}

{% block title %}Personal Space - Dashboard{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personal-space-optimized.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/modal-fixes.css') }}">
<!-- Block Factory Enhanced CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/block-factory-enhanced.css') }}">
<!-- Chart.js for analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Sortable.js for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<!-- Personal Space JavaScript -->
<script src="{{ url_for('static', filename='js/personal-space.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-content">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="welcome-section">
                <div class="welcome-text">
                    <h1>¡Bienvenido de vuelta, {{ user.first_name or 'Usuario' }}!</h1>
                    <p class="welcome-subtitle">
                        {% set current_hour = moment().hour %}
                        {% if current_hour < 12 %}
                            Buenos días. Tienes {{ pending_tasks_count or 0 }} tareas pendientes para hoy.
                        {% elif current_hour < 18 %}
                            Buenas tardes. Vas por buen camino con tus objetivos de hoy.
                        {% else %}
                            Buenas noches. Es hora de revisar tu progreso del día.
                        {% endif %}
                    </p>
                </div>
                
                <div class="quick-actions">
                    <button type="button" 
                            class="btn quick-action-btn" 
                            data-bs-toggle="modal" 
                            data-bs-target="#block-factory-modal">
                        <i class="bi bi-plus-circle me-2"></i>
                        Nuevo Bloque
                    </button>
                    
                    <button type="button" 
                            class="btn quick-action-btn secondary" 
                            data-bs-toggle="modal" 
                            data-bs-target="#template-gallery-modal">
                        <i class="bi bi-collection me-2"></i>
                        Plantillas
                    </button>
                    
                    <div class="dropdown">
                        <button class="btn quick-action-btn secondary dropdown-toggle"
                                type="button"
                                data-bs-toggle="dropdown"
                                aria-label="Más opciones">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('personal_space.workspace') }}">
                                <i class="bi bi-grid-3x3-gap me-2"></i>Workspace
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="toggleAnalytics()">
                                <i class="bi bi-graph-up me-2"></i>Analytics
                            </a></li>

                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('personal_space.configuracion') }}">
                                <i class="bi bi-gear me-2"></i>Configuración
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Stats Overview -->
            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="stat-value">{{ completed_tasks_today or 0 }}</div>
                    <div class="stat-label">Tareas completadas hoy</div>
                    <div class="stat-trend positive">
                        <i class="bi bi-arrow-up"></i> +{{ task_completion_trend or 0 }}%
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="bi bi-target"></i>
                    </div>
                    <div class="stat-value">{{ active_objectives or 0 }}</div>
                    <div class="stat-label">Objetivos activos</div>
                    <div class="stat-trend positive">
                        <i class="bi bi-arrow-up"></i> {{ objective_progress_avg or 0 }}% promedio
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="bi bi-clock"></i>
                    </div>
                    <div class="stat-value">{{ productive_hours_today or 0 }}h</div>
                    <div class="stat-label">Horas productivas</div>
                    {% set trend = productivity_trend | default(0) %}
                    <div class="stat-trend {{ 'positive' if trend >= 0 else 'negative' }}">
                        <i class="bi bi-arrow-{{ 'up' if trend >= 0 else 'down' }}"></i>
                        {{ trend }}%
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon info">
                        <i class="bi bi-lightning"></i>
                    </div>
                    <div class="stat-value">{{ focus_score or 0 }}%</div>
                    <div class="stat-label">Puntuación de foco</div>
                    {% set f_trend = focus_trend | default(0) %}
                    <div class="stat-trend {{ 'positive' if f_trend >= 0 else 'negative' }}">
                        <i class="bi bi-arrow-{{ 'up' if f_trend >= 0 else 'down' }}"></i>
                        {{ f_trend }}%
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Dashboard Sections -->
        <div class="dashboard-sections">
            <!-- Main Content -->
            <div class="main-content">
                <!-- Today's Focus -->
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="bi bi-sun"></i>
                            Enfoque de Hoy
                        </h3>
                        <div class="section-actions">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshTodaysFocus()" aria-label="Actualizar enfoque de hoy">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <div class="section-body">
                        <!-- Focus blocks placeholder -->
                    </div>
                </div>
                
                <!-- Weekly Progress -->
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="bi bi-calendar-week"></i>
                            Progreso Semanal
                        </h3>
                        <div class="section-actions">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewWeeklyDetails()">
                                Ver detalles
                            </button>
                        </div>
                    </div>
                    <div class="section-body">
                        <!-- Weekly progress placeholder -->
                    </div>
                </div>
            </div>
            
            <!-- Sidebar Content -->
            <div class="sidebar-content">
                <!-- Recent Activity -->
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="bi bi-activity"></i>
                            Actividad Reciente
                        </h3>
                        <div class="section-actions">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewAllActivity()">
                                Ver todo
                            </button>
                        </div>
                    </div>
                    <div class="section-body">
                        {% if recent_activities %}
                            {% for activity in recent_activities[:5] %}
                            <div class="recent-activity-item">
                                <div class="activity-icon {{ activity.type }}">
                                    <i class="bi bi-{{ activity.icon or 'circle' }}"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">{{ activity.title }}</div>
                                    <p class="activity-description">{{ activity.description }}</p>
                                </div>
                                <div class="activity-time">
                                    {{ moment(activity.created_at).fromNow() }}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-activity text-muted" style="font-size: 2rem;"></i>
                                <p class="text-muted mt-2 mb-0">No hay actividad reciente</p>
                                <small class="text-muted">Tu actividad aparecerá aquí</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Quick Notes -->
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="bi bi-sticky"></i>
                            Notas Rápidas
                        </h3>
                    </div>
                    <div class="section-body">
                        <div class="quick-notes">
                            <textarea class="quick-note-input" 
                                      placeholder="Escribe una nota rápida..." 
                                      rows="4" 
                                      id="quick-note-text"></textarea>
                    <div class="quick-note-actions">
                        <small class="text-muted">Ctrl+Enter para guardar</small>
                        <button type="button"
                                class="note-save-btn"
                                onclick="window.PersonalSpaceDashboard.saveQuickNote()">
                            <i class="bi bi-save me-1"></i>
                            Guardar
                        </button>
                    </div>
                </div>
                        
                        <!-- Recent Quick Notes -->
                        <div class="mt-3" id="recent-quick-notes">
                            {% if recent_quick_notes %}
                                {% for note in recent_quick_notes[:3] %}
                                <div class="quick-note-item mb-2 p-2 bg-light rounded">
                                    <small class="text-muted d-block">{{ moment(note.created_at).fromNow() }}</small>
                                    <div class="mt-1">{{ note.content[:100] }}{% if note.content|length > 100 %}...{% endif %}</div>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analytics Dashboard (Hidden by default) -->
        <div class="section-card d-none" id="analytics-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="bi bi-graph-up"></i>
                    Panel de Análisis
                </h3>
                <div class="section-actions">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleAnalytics()">
                        <i class="bi bi-x"></i>
                        Cerrar
                    </button>
                </div>
            </div>
            <div class="section-body">
                {{ render_analytics_dashboard() }}
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<button type="button"
        class="floating-action-btn"
        data-bs-toggle="modal"
        data-bs-target="#block-factory-modal"
        title="Crear nuevo bloque">
    <i class="bi bi-plus"></i>
</button>

<!-- Modals placeholders -->
{{ render_block_factory_modal() }}
{{ render_template_gallery_modal() }}
{% endblock %}

{% block extra_js %}
<script>
// Dashboard JavaScript
window.PersonalSpaceDashboard = {
    // Initialize dashboard
    init: function() {
        this.bindEvents();
        this.loadDashboardData();
        this.setupAutoRefresh();
    },
    
    // Bind event listeners
    bindEvents: function() {
        // Quick note keyboard shortcut
        document.getElementById('quick-note-text')?.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                this.saveQuickNote();
            }
        });

        // Auto-save quick notes
        let saveTimeout;
        document.getElementById('quick-note-text')?.addEventListener('input', () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                this.autoSaveQuickNote();
            }, 2000);
        });

        // Ensure Bootstrap modals open when buttons are clicked
        document.querySelectorAll('[data-bs-toggle="modal"]').forEach((btn) => {
            btn.addEventListener('click', () => {
                const target = btn.getAttribute('data-bs-target');
                if (target) {
                    const el = document.querySelector(target);
                    if (el) {
                        const modal = new bootstrap.Modal(el);
                        modal.show();
                    }
                }
            });
        });
    },
    
    // Load dashboard data
    loadDashboardData: async function() {
        try {
            const response = await fetch('/api/personal-space/analytics/productivity');
            if (response.ok) {
                const data = await response.json();
                this.updateDashboardStats(data.stats);
                this.updateRecentActivity(data.recent_activities);
                this.updateTodaysFocus(data.todays_focus);
            }
        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    },
    
    // Update dashboard statistics
    updateDashboardStats: function(stats) {
        if (!stats) return;
        
        // Update stat values with animation
        Object.entries(stats).forEach(([key, value]) => {
            const element = document.querySelector(`[data-stat="${key}"]`);
            if (element) {
                this.animateNumber(element, parseInt(element.textContent) || 0, value);
            }
        });
    },
    
    // Animate number changes
    animateNumber: function(element, from, to) {
        const duration = 1000;
        const start = Date.now();
        const step = (to - from) / duration;
        
        const animate = () => {
            const elapsed = Date.now() - start;
            const progress = Math.min(elapsed / duration, 1);
            const current = Math.floor(from + (to - from) * progress);
            
            element.textContent = current;
            
            if (progress < 1) {
                requestAnimationFrame(animate);
            }
        };
        
        animate();
    },
    
    // Update recent activity
    updateRecentActivity: function(activities) {
        // This would update the recent activity section
        // Implementation depends on your specific needs
    },
    
    // Update today's focus
    updateTodaysFocus: function(focusData) {
        // This would update the today's focus section
        // Implementation depends on your specific needs
    },
    
    // Refresh today's focus data
    refreshTodaysFocus: async function() {
        const btn = document.querySelector('[onclick="refreshTodaysFocus()"]');
        if (btn) {
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i>';
            btn.disabled = true;
        }
        
        try {
            const response = await fetch('/api/personal-space/todays-focus');
            if (response.ok) {
                const data = await response.json();
                this.updateTodaysFocus(data);
                this.showSuccessMessage('Enfoque de hoy actualizado');
            } else {
                throw new Error('Error al cargar datos');
            }
        } catch (error) {
            console.error('Error refreshing today\'s focus:', error);
            this.showErrorMessage('Error al actualizar el enfoque de hoy');
        } finally {
            if (btn) {
                btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
                btn.disabled = false;
            }
        }
    },
    
    // Show weekly progress modal
    showWeeklyProgressModal: async function() {
        try {
            const response = await fetch('/api/personal-space/analytics/weekly-progress');
            if (response.ok) {
                const data = await response.json();
                this.displayWeeklyProgressModal(data);
            } else {
                throw new Error('Error al cargar datos de progreso semanal');
            }
        } catch (error) {
            console.error('Error loading weekly progress:', error);
            this.showErrorMessage('Error al cargar el progreso semanal');
        }
    },
    
    // Display weekly progress modal
    displayWeeklyProgressModal: function(data) {
        const modalHtml = `
            <div class="modal fade" id="weeklyProgressModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Progreso Semanal Detallado</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h6>Tareas Completadas</h6>
                                        <div class="display-6 text-success">${data.tasks_completed || 0}</div>
                                        <small class="text-muted">de ${data.total_tasks || 0} tareas</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h6>Objetivos Alcanzados</h6>
                                        <div class="display-6 text-primary">${data.objectives_completed || 0}</div>
                                        <small class="text-muted">de ${data.total_objectives || 0} objetivos</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h6>Productividad</h6>
                                        <div class="display-6 text-warning">${data.productivity_score || 0}%</div>
                                        <small class="text-muted">puntuación general</small>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="mt-3">
                                <h6>Progreso por Día</h6>
                                <div class="progress-timeline">
                                    ${(data.daily_progress || []).map(day => `
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>${day.day}</span>
                                            <div class="progress flex-grow-1 mx-3" style="height: 8px;">
                                                <div class="progress-bar" style="width: ${day.progress}%"></div>
                                            </div>
                                            <span class="text-muted">${day.progress}%</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('weeklyProgressModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('weeklyProgressModal'));
        modal.show();
    },
    
    // Save quick note
    saveQuickNote: async function() {
        const textarea = document.getElementById('quick-note-text');
        const content = textarea?.value.trim();

        if (!content) return;

        try {
            const response = await fetch('/api/personal-space/blocks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({ type: 'nota', content })
            });

            if (response.ok) {
                textarea.value = '';
                this.showSuccessMessage('Nota guardada');
                this.loadRecentQuickNotes();
            }
        } catch (error) {
            console.error('Error saving quick note:', error);
            this.showErrorMessage('Error al guardar la nota');
        }
    },
    
    // Auto-save quick note (draft)
    autoSaveQuickNote: function() {
        const content = document.getElementById('quick-note-text')?.value;
        if (content) {
            localStorage.setItem('quick_note_draft', content);
        }
    },
    
    // Load recent quick notes
    loadRecentQuickNotes: async function() {
        try {
            const response = await fetch('/api/personal-space/blocks?type=nota');
            if (response.ok) {
                const data = await response.json();
                this.renderRecentQuickNotes(data.blocks || []);
            }
        } catch (error) {
            console.error('Error loading recent quick notes:', error);
        }
    },
    
    // Render recent quick notes
    renderRecentQuickNotes: function(notes) {
        const container = document.getElementById('recent-quick-notes');
        if (!container) return;
        
        container.innerHTML = notes.map(note => `
            <div class="quick-note-item mb-2 p-2 bg-light rounded">
                <small class="text-muted d-block">${this.timeAgo(note.created_at)}</small>
                <div class="mt-1">${this.truncateText(note.content, 100)}</div>
            </div>
        `).join('');
    },
    
    // Setup auto-refresh
    setupAutoRefresh: function() {
        // Refresh dashboard data every 5 minutes
        setInterval(() => {
            this.loadDashboardData();
        }, 5 * 60 * 1000);
    },
    
    // Utility functions
    getCSRFToken: function() {
        return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    },
    
    timeAgo: function(date) {
        // Simple time ago implementation
        const now = new Date();
        const past = new Date(date);
        const diff = now - past;
        
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (days > 0) return `hace ${days} día${days > 1 ? 's' : ''}`;
        if (hours > 0) return `hace ${hours} hora${hours > 1 ? 's' : ''}`;
        if (minutes > 0) return `hace ${minutes} minuto${minutes > 1 ? 's' : ''}`;
        return 'hace un momento';
    },
    
    truncateText: function(text, length) {
        return text.length > length ? text.substring(0, length) + '...' : text;
    },
    
    showSuccessMessage: function(message) {
        // Integration with your notification system
        console.log('Success:', message);
    },
    
    showErrorMessage: function(message) {
        // Integration with your notification system
        console.error('Error:', message);
    }
};

// Global functions
window.refreshTodaysFocus = function() {
    if (window.PersonalSpaceDashboard) {
        window.PersonalSpaceDashboard.refreshTodaysFocus();
    }
};

window.viewWeeklyDetails = function() {
    if (window.PersonalSpaceDashboard) {
        window.PersonalSpaceDashboard.showWeeklyProgressModal();
    }
};

window.toggleAnalytics = function() {
    const section = document.getElementById('analytics-section');
    if (section) {
        section.classList.toggle('d-none');
        
        // Initialize analytics if showing
        if (!section.classList.contains('d-none') && window.AnalyticsDashboard) {
            window.AnalyticsDashboard.init();
        }
    }
};

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Personal Space core functionality
    if (window.initPersonalSpace) {
        window.initPersonalSpace();
    }
    
    // Initialize Dashboard
    window.PersonalSpaceDashboard.init();
    
    // Restore quick note draft
    const draft = localStorage.getItem('quick_note_draft');
    if (draft) {
        const textarea = document.getElementById('quick-note-text');
        if (textarea) {
            textarea.value = draft;
        }
    }
});
</script>
{% endblock %}