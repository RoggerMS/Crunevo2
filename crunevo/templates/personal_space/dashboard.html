<!-- Personal Space Dashboard - Main redesigned dashboard page -->
{% extends "base.html" %}
{% from 'personal_space/components/layout/DashboardLayout.html' import render_dashboard_layout with context %}
{% from 'personal_space/components/widgets/TemplateGallery.html' import render_template_gallery_modal %}
{% from 'personal_space/components/widgets/BlockFactory.html' import render_block_factory_modal %}
{% from 'personal_space/components/widgets/AnalyticsDashboard.html' import render_analytics_dashboard %}

{% block title %}Personal Space - Dashboard{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personal-space-optimized.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/modal-fixes.css') }}">
<!-- Block Factory Enhanced CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/block-factory-enhanced.css') }}">
<!-- Chart.js for analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Sortable.js for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<!-- Personal Space JavaScript -->
<script src="{{ url_for('static', filename='js/personal-space.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-content">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="welcome-section">
                <div class="welcome-text">
                    <h1>¡Bienvenido de vuelta, {{ user.first_name or 'Usuario' }}!</h1>
                    <p class="welcome-subtitle">
                        {% set current_hour = moment().hour %}
                        {% if current_hour < 12 %}
                            Buenos días. Tienes {{ pending_tasks_count or 0 }} tareas pendientes para hoy.
                        {% elif current_hour < 18 %}
                            Buenas tardes. Vas por buen camino con tus objetivos de hoy.
                        {% else %}
                            Buenas noches. Es hora de revisar tu progreso del día.
                        {% endif %}
                    </p>
                </div>
                
                <div class="quick-actions">
                    <button type="button" 
                            class="btn quick-action-btn" 
                            data-bs-toggle="modal" 
                            data-bs-target="#block-factory-modal">
                        <i class="bi bi-plus-circle me-2"></i>
                        Nuevo Bloque
                    </button>
                    
                    <button type="button" 
                            class="btn quick-action-btn secondary" 
                            data-bs-toggle="modal" 
                            data-bs-target="#template-gallery-modal">
                        <i class="bi bi-collection me-2"></i>
                        Plantillas
                    </button>
                    
                    <div class="dropdown">
                        <button class="btn quick-action-btn secondary dropdown-toggle"
                                type="button"
                                data-bs-toggle="dropdown"
                                aria-label="Más opciones">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="openQuickNotesModal()">
                                <i class="bi bi-sticky me-2"></i>Notas Rápidas
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('personal_space.workspace') }}">
                                <i class="bi bi-grid-3x3-gap me-2"></i>Workspace
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('personal_space.analytics') }}">
                                <i class="bi bi-graph-up me-2"></i>Analytics
                            </a></li>

                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('personal_space.configuracion') }}">
                                <i class="bi bi-gear me-2"></i>Configuración
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Stats Overview -->
            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="stat-value">{{ completed_tasks_today or 0 }}</div>
                    <div class="stat-label">Tareas completadas hoy</div>
                    <div class="stat-trend positive">
                        <i class="bi bi-arrow-up"></i> +{{ task_completion_trend or 0 }}%
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="bi bi-target"></i>
                    </div>
                    <div class="stat-value">{{ active_objectives or 0 }}</div>
                    <div class="stat-label">Objetivos activos</div>
                    <div class="stat-trend positive">
                        <i class="bi bi-arrow-up"></i> {{ objective_progress_avg or 0 }}% promedio
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="bi bi-clock"></i>
                    </div>
                    <div class="stat-value">{{ productive_hours_today or 0 }}h</div>
                    <div class="stat-label">Horas productivas</div>
                    {% set trend = productivity_trend | default(0) %}
                    <div class="stat-trend {{ 'positive' if trend >= 0 else 'negative' }}">
                        <i class="bi bi-arrow-{{ 'up' if trend >= 0 else 'down' }}"></i>
                        {{ trend }}%
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon info">
                        <i class="bi bi-lightning"></i>
                    </div>
                    <div class="stat-value">{{ focus_score or 0 }}%</div>
                    <div class="stat-label">Puntuación de foco</div>
                    {% set f_trend = focus_trend | default(0) %}
                    <div class="stat-trend {{ 'positive' if f_trend >= 0 else 'negative' }}">
                        <i class="bi bi-arrow-{{ 'up' if f_trend >= 0 else 'down' }}"></i>
                        {{ f_trend }}%
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Dashboard Sections -->
        <div class="dashboard-sections">
            <!-- Main Content -->
            <div class="main-content">
                <!-- Today's Focus -->
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="bi bi-sun"></i>
                            Enfoque de Hoy
                        </h3>
                        <div class="section-actions">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshTodaysFocus()" aria-label="Actualizar enfoque de hoy">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <div class="section-body">
                        <!-- Focus blocks placeholder -->
                    </div>
                </div>
                
                <!-- Weekly Progress -->
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="bi bi-calendar-week"></i>
                            Progreso Semanal
                        </h3>
                        <div class="section-actions">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewWeeklyDetails()" aria-label="Ver detalles del progreso semanal">
                                Ver detalles
                            </button>
                        </div>
                    </div>
                    <div class="section-body">
                        <!-- Weekly progress placeholder -->
                    </div>
                </div>
            </div>
            
            <!-- Sidebar Content -->
            <div class="sidebar-content">
                <!-- Recent Activity -->
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="bi bi-activity"></i>
                            Actividad Reciente
                        </h3>
                        <div class="section-actions">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewAllActivity()" aria-label="Ver toda la actividad reciente">
                                Ver todo
                            </button>
                        </div>
                    </div>
                    <div class="section-body">
                        {% if recent_activities %}
                            {% for activity in recent_activities[:5] %}
                            <div class="recent-activity-item">
                                <div class="activity-icon {{ activity.type }}">
                                    <i class="bi bi-{{ activity.icon or 'circle' }}"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">{{ activity.title }}</div>
                                    <p class="activity-description">{{ activity.description }}</p>
                                </div>
                                <div class="activity-time">
                                    {{ moment(activity.created_at).fromNow() }}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-activity text-muted" style="font-size: 2rem;"></i>
                                <p class="text-muted mt-2 mb-0">No hay actividad reciente</p>
                                <small class="text-muted">Tu actividad aparecerá aquí</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Quick Notes section removed - now accessible via menu -->
            </div>
        </div>
        
        <!-- Analytics Dashboard (Hidden by default) -->
        <div class="section-card d-none" id="analytics-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="bi bi-graph-up"></i>
                    Panel de Análisis
                </h3>
                <div class="section-actions">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleAnalytics()" aria-label="Cerrar panel de análisis">
                        <i class="bi bi-x"></i>
                        Cerrar
                    </button>
                </div>
            </div>
            <div class="section-body">
                {{ render_analytics_dashboard() }}
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<button type="button"
        class="floating-action-btn"
        data-bs-toggle="modal"
        data-bs-target="#block-factory-modal"
        title="Crear nuevo bloque"
        aria-label="Crear nuevo bloque">
    <i class="bi bi-plus"></i>
</button>

<!-- Modals placeholders -->
{{ render_block_factory_modal() }}
{{ render_template_gallery_modal() }}

<!-- Quick Notes Modal -->
<div class="modal fade" id="quick-notes-modal" tabindex="-1" aria-labelledby="quickNotesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickNotesModalLabel">
                    <i class="bi bi-sticky me-2"></i>
                    Notas Rápidas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="quick-note-content" class="form-label">Contenido de la nota</label>
                            <textarea class="form-control" 
                                      id="quick-note-content" 
                                      rows="8" 
                                      placeholder="Escribe tu nota aquí..."
                                      aria-describedby="quickNoteHelp"></textarea>
                            <div id="quickNoteHelp" class="form-text">
                                Presiona Ctrl+Enter para guardar rápidamente
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="quick-note-tags" class="form-label">Etiquetas (opcional)</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="quick-note-tags" 
                                   placeholder="trabajo, personal, ideas..."
                                   aria-describedby="tagsHelp">
                            <div id="tagsHelp" class="form-text">
                                Separa las etiquetas con comas
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Notas Recientes</h6>
                        <div id="recent-notes-list" class="recent-notes-container">
                            <!-- Recent notes will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showNoteOnLogin" name="showNoteOnLogin">
                        <label class="form-check-label" for="showNoteOnLogin">
                            Mostrar última nota al iniciar sesión
                        </label>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="save-quick-note-btn">
                            <i class="bi bi-save me-1"></i>
                            Guardar Nota
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dashboard JavaScript
window.PersonalSpaceDashboard = {
    // Initialize dashboard
    init: function() {
        this.bindEvents();
        this.loadDashboardData();
        this.setupAutoRefresh();
    },
    
    // Bind event listeners
    bindEvents: function() {
        // Quick notes functionality moved to modal

        // Ensure Bootstrap modals open when buttons are clicked
        document.querySelectorAll('[data-bs-toggle="modal"]').forEach((btn) => {
            btn.addEventListener('click', () => {
                const target = btn.getAttribute('data-bs-target');
                if (target) {
                    const el = document.querySelector(target);
                    if (el) {
                        const modal = new bootstrap.Modal(el);
                        modal.show();
                    }
                }
            });
        });
    },
    
    // Load dashboard data
    loadDashboardData: async function() {
        try {
            const response = await fetch('/api/personal-space/analytics/productivity');
            if (response.ok) {
                const data = await response.json();
                this.updateDashboardStats(data.stats);
                this.updateRecentActivity(data.recent_activities);
                this.updateTodaysFocus(data.todays_focus);
            }
        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    },
    
    // Update dashboard statistics
    updateDashboardStats: function(stats) {
        if (!stats) return;
        
        // Update stat values with animation
        Object.entries(stats).forEach(([key, value]) => {
            const element = document.querySelector(`[data-stat="${key}"]`);
            if (element) {
                this.animateNumber(element, parseInt(element.textContent) || 0, value);
            }
        });
    },
    
    // Animate number changes
    animateNumber: function(element, from, to) {
        const duration = 1000;
        const start = Date.now();
        const step = (to - from) / duration;
        
        const animate = () => {
            const elapsed = Date.now() - start;
            const progress = Math.min(elapsed / duration, 1);
            const current = Math.floor(from + (to - from) * progress);
            
            element.textContent = current;
            
            if (progress < 1) {
                requestAnimationFrame(animate);
            }
        };
        
        animate();
    },
    
    // Update recent activity
    updateRecentActivity: function(activities) {
        // This would update the recent activity section
        // Implementation depends on your specific needs
    },
    
    // Update today's focus
    updateTodaysFocus: function(focusData) {
        // This would update the today's focus section
        // Implementation depends on your specific needs
    },
    
    // Refresh today's focus data
    refreshTodaysFocus: async function() {
        const btn = document.querySelector('[onclick="refreshTodaysFocus()"]');
        if (btn) {
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i>';
            btn.disabled = true;
        }
        
        try {
            const response = await fetch('/api/personal-space/todays-focus');
            if (response.ok) {
                const data = await response.json();
                this.updateTodaysFocus(data);
                this.showSuccessMessage('Enfoque de hoy actualizado');
            } else {
                throw new Error('Error al cargar datos');
            }
        } catch (error) {
            console.error('Error refreshing today\'s focus:', error);
            this.showErrorMessage('Error al actualizar el enfoque de hoy');
        } finally {
            if (btn) {
                btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
                btn.disabled = false;
            }
        }
    },
    
    // Show weekly progress modal
    showWeeklyProgressModal: async function() {
        try {
            const response = await fetch('/api/personal-space/analytics/weekly-progress');
            if (response.ok) {
                const data = await response.json();
                this.displayWeeklyProgressModal(data);
            } else {
                throw new Error('Error al cargar datos de progreso semanal');
            }
        } catch (error) {
            console.error('Error loading weekly progress:', error);
            this.showErrorMessage('Error al cargar el progreso semanal');
        }
    },
    
    // Display weekly progress modal
    displayWeeklyProgressModal: function(data) {
        const modalHtml = `
            <div class="modal fade" id="weeklyProgressModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Progreso Semanal Detallado</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h6>Tareas Completadas</h6>
                                        <div class="display-6 text-success">${data.tasks_completed || 0}</div>
                                        <small class="text-muted">de ${data.total_tasks || 0} tareas</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h6>Objetivos Alcanzados</h6>
                                        <div class="display-6 text-primary">${data.objectives_completed || 0}</div>
                                        <small class="text-muted">de ${data.total_objectives || 0} objetivos</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <h6>Productividad</h6>
                                        <div class="display-6 text-warning">${data.productivity_score || 0}%</div>
                                        <small class="text-muted">puntuación general</small>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="mt-3">
                                <h6>Progreso por Día</h6>
                                <div class="progress-timeline">
                                    ${(data.daily_progress || []).map(day => `
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>${day.day}</span>
                                            <div class="progress flex-grow-1 mx-3" style="height: 8px;">
                                                <div class="progress-bar" style="width: ${day.progress}%"></div>
                                            </div>
                                            <span class="text-muted">${day.progress}%</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('weeklyProgressModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('weeklyProgressModal'));
        modal.show();
    },
    
    // Quick notes functions removed - functionality moved to modal
    
    // Setup auto-refresh
    setupAutoRefresh: function() {
        // Refresh dashboard data every 5 minutes
        setInterval(() => {
            this.loadDashboardData();
        }, 5 * 60 * 1000);
    },
    
    // Utility functions
    getCSRFToken: function() {
        return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    },
    
    timeAgo: function(date) {
        // Simple time ago implementation
        const now = new Date();
        const past = new Date(date);
        const diff = now - past;
        
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (days > 0) return `hace ${days} día${days > 1 ? 's' : ''}`;
        if (hours > 0) return `hace ${hours} hora${hours > 1 ? 's' : ''}`;
        if (minutes > 0) return `hace ${minutes} minuto${minutes > 1 ? 's' : ''}`;
        return 'hace un momento';
    },
    
    truncateText: function(text, length) {
        return text.length > length ? text.substring(0, length) + '...' : text;
    },
    
    showSuccessMessage: function(message) {
        // Integration with your notification system
        console.log('Success:', message);
    },
    
    showErrorMessage: function(message) {
        // Integration with your notification system
        console.error('Error:', message);
    }
};

// Global functions
window.refreshTodaysFocus = function() {
    if (window.PersonalSpaceDashboard) {
        window.PersonalSpaceDashboard.refreshTodaysFocus();
    }
};

window.viewWeeklyDetails = function() {
    if (window.PersonalSpaceDashboard) {
        window.PersonalSpaceDashboard.showWeeklyProgressModal();
    }
};

window.openQuickNotesModal = function() {
    const modal = new bootstrap.Modal(document.getElementById('quick-notes-modal'));
    loadRecentQuickNotes();
    loadQuickNotesPreferences();
    modal.show();
};

// Analytics toggle function removed - now navigates to analytics page

// Quick Notes functionality
function loadRecentQuickNotes() {
    fetch('/api/personal-space/quick-notes')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('recent-notes-list');
        if (data.success && data.notes.length > 0) {
            container.innerHTML = data.notes.map(note => `
                <div class="recent-note-item mb-2 p-2 border rounded">
                    <div class="note-content text-truncate" title="${note.content}">
                        ${note.content.substring(0, 50)}${note.content.length > 50 ? '...' : ''}
                    </div>
                    <div class="note-meta small text-muted">
                        ${note.tags ? note.tags.join(', ') : ''}
                        <span class="float-end">${formatTimeAgo(note.created_at)}</span>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<p class="text-muted small">No hay notas recientes</p>';
        }
    })
    .catch(error => {
        console.error('Error loading recent notes:', error);
        document.getElementById('recent-notes-list').innerHTML = '<p class="text-muted small">Error al cargar notas</p>';
    });
}

function loadQuickNotesPreferences() {
    const showOnLogin = localStorage.getItem('show_quick_note_on_login') === 'true';
    document.getElementById('showNoteOnLogin').checked = showOnLogin;
}

function saveQuickNotesPreferences(showOnLogin) {
    localStorage.setItem('show_quick_note_on_login', showOnLogin.toString());
    
    // Also save to backend
    fetch('/api/personal-space/preferences', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            show_quick_note_on_login: showOnLogin
        })
    })
    .catch(error => console.error('Error saving preferences:', error));
}

function saveQuickNote() {
    const content = document.getElementById('quick-note-content').value.trim();
    const tags = document.getElementById('quick-note-tags').value.trim();
    const showOnLogin = document.getElementById('showNoteOnLogin').checked;
    
    if (!content) {
        showMessage('Por favor, escribe algo en la nota.', 'warning');
        return;
    }
    
    const noteData = {
        content: content,
        tags: tags ? tags.split(',').map(tag => tag.trim()) : [],
        show_on_login: showOnLogin
    };
    
    fetch('/api/personal-space/quick-notes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(noteData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Nota guardada exitosamente', 'success');
            document.getElementById('quick-note-content').value = '';
            document.getElementById('quick-note-tags').value = '';
            loadRecentQuickNotes();
            
            // Save preference
            saveQuickNotesPreferences(showOnLogin);
        } else {
            showMessage(data.error || 'Error al guardar la nota', 'error');
        }
    })
    .catch(error => {
        console.error('Error saving quick note:', error);
        showMessage('Error al guardar la nota', 'error');
    });
}

function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

function showMessage(message, type) {
    // Integration with your notification system
    console.log(`${type}: ${message}`);
}

function formatTimeAgo(date) {
    const now = new Date();
    const past = new Date(date);
    const diff = now - past;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (days > 0) return `hace ${days} día${days > 1 ? 's' : ''}`;
    if (hours > 0) return `hace ${hours} hora${hours > 1 ? 's' : ''}`;
    if (minutes > 0) return `hace ${minutes} minuto${minutes > 1 ? 's' : ''}`;
    return 'hace un momento';
}

// Bind save button event
document.addEventListener('DOMContentLoaded', function() {
    const saveBtn = document.getElementById('save-quick-note-btn');
    if (saveBtn) {
        saveBtn.addEventListener('click', saveQuickNote);
    }
    
    // Bind Ctrl+Enter shortcut
    const textarea = document.getElementById('quick-note-content');
    if (textarea) {
        textarea.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                saveQuickNote();
            }
        });
    }
});

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Personal Space core functionality
    if (window.initPersonalSpace) {
        window.initPersonalSpace();
    }
    
    // Initialize Dashboard
    window.PersonalSpaceDashboard.init();
});
</script>
{% endblock %}