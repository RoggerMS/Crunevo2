<!-- Personal Space Workspace - Dynamic drag-and-drop workspace -->
{% extends "base.html" %}
{% from 'personal_space/components/layout/WorkspaceLayout.html' import render_workspace_layout %}
{% from 'personal_space/components/widgets/TemplateGallery.html' import render_template_gallery_modal %}

{% block title %}Personal Space - Workspace{% endblock %}

{% block extra_head %}
<!-- Sortable.js for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<!-- GridStack for advanced grid layout -->
<script src="https://cdn.jsdelivr.net/npm/gridstack@latest/dist/gridstack-all.js"></script>
<link href="https://cdn.jsdelivr.net/npm/gridstack@latest/dist/gridstack.min.css" rel="stylesheet">
<!-- Optimized Personal Space CSS -->
<link href="{{ url_for('static', filename='css/personal-space-optimized.css') }}" rel="stylesheet">
<!-- Workspace Unified CSS -->
<link href="{{ url_for('static', filename='css/workspace-unified.css') }}" rel="stylesheet">
<!-- Personal Space JavaScript -->
<script src="{{ url_for('static', filename='js/personal-space.js') }}" defer></script>
<!-- BlockFactory JavaScript -->
<script src="{{ url_for('static', filename='js/BlockFactory.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="workspace-container" id="workspace-container">
    <!-- Workspace Header -->
    <div class="workspace-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="workspace-title">Workspace</h1>
                    <p class="workspace-subtitle">Organiza tus bloques como prefieras</p>
                </div>
                <div class="col-md-6">
                    <div class="workspace-controls">
            <!-- View Toggle -->
            <div class="view-toggle">
                <button type="button" 
                        class="btn workspace-btn secondary active" 
                        id="grid-view-btn"
                        aria-label="Vista de cuadrícula">
                    <i class="bi bi-grid-3x3-gap me-1"></i>
                    Cuadrícula
                </button>
                <button type="button" 
                        class="btn workspace-btn secondary" 
                        id="list-view-btn"
                        aria-label="Vista de lista">
                    <i class="bi bi-list me-1"></i>
                    Lista
                </button>
            </div>
            
            <!-- Workspace Actions -->
            <div class="workspace-actions">
                <button type="button" 
                        class="btn workspace-btn secondary" 
                        id="edit-mode-btn"
                        aria-label="Alternar modo de edición">
                    <i class="bi bi-pencil me-1"></i>
                    Editar
                </button>
                
                <button type="button" 
                        class="btn workspace-btn" 
                        id="new-block-btn"
                        data-bs-toggle="modal" 
                        data-bs-target="#block-factory-modal">
                    <i class="bi bi-plus me-1"></i>
                    Nuevo Bloque
                </button>
                
                <div class="dropdown">
                    <button class="btn workspace-btn secondary dropdown-toggle" 
                            type="button" 
                            data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" id="save-workspace-btn">
                            <i class="bi bi-save me-2"></i>Guardar Layout
                        </a></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#template-gallery-modal">
                            <i class="bi bi-collection me-2"></i>Cargar Plantilla
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="reset-workspace-btn">
                            <i class="bi bi-arrow-clockwise me-2"></i>Resetear
                        </a></li>
                        <li><a class="dropdown-item" href="#" id="export-workspace-btn">
                            <i class="bi bi-download me-2"></i>Exportar
                        </a></li>
                    </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Workspace Main Area -->
    <div class="workspace-main">
        <!-- Sidebar -->
        <div class="workspace-sidebar" id="workspace-sidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-title">
                    <i class="bi bi-building-add"></i>
                    <span>Bloques Disponibles</span>
                </h3>
            </div>
            
            <div class="sidebar-content">
                <!-- Productivity Blocks -->
                <div class="block-category">
                    <div class="category-title">Productividad</div>
                    <div class="block-list">
                        <div class="block-item" data-block-type="task" draggable="true">
                            <div class="block-item-header">
                                <div class="block-icon task">
                                    <i class="bi bi-check-square"></i>
                                </div>
                                <div>
                                    <div class="block-name">Tareas</div>
                                    <div class="block-description">Lista de tareas con seguimiento</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="block-item" data-block-type="kanban" draggable="true">
                            <div class="block-item-header">
                                <div class="block-icon kanban">
                                    <i class="bi bi-kanban"></i>
                                </div>
                                <div>
                                    <div class="block-name">Kanban</div>
                                    <div class="block-description">Tablero de gestión visual</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="block-item" data-block-type="objective" draggable="true">
                            <div class="block-item-header">
                                <div class="block-icon objective">
                                    <i class="bi bi-target"></i>
                                </div>
                                <div>
                                    <div class="block-name">Objetivos</div>
                                    <div class="block-description">Seguimiento de metas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Organization Blocks -->
                <div class="block-category">
                    <div class="category-title">Organización</div>
                    <div class="block-list">
                        <div class="block-item" data-block-type="note" draggable="true">
                            <div class="block-item-header">
                                <div class="block-icon note">
                                    <i class="bi bi-journal-text"></i>
                                </div>
                                <div>
                                    <div class="block-name">Notas</div>
                                    <div class="block-description">Notas rápidas y documentos</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="block-item" data-block-type="calendar" draggable="true">
                            <div class="block-item-header">
                                <div class="block-icon calendar">
                                    <i class="bi bi-calendar3"></i>
                                </div>
                                <div>
                                    <div class="block-name">Calendario</div>
                                    <div class="block-description">Eventos y citas</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="block-item" data-block-type="habit" draggable="true">
                            <div class="block-item-header">
                                <div class="block-icon habit">
                                    <i class="bi bi-arrow-repeat"></i>
                                </div>
                                <div>
                                    <div class="block-name">Hábitos</div>
                                    <div class="block-description">Seguimiento de rutinas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Workspace Area -->
        <div class="workspace-area">
            <div class="grid-container">
                {% if workspace_blocks %}
                    {{ render_workspace_layout(blocks=workspace_blocks, edit_mode=false) }}
                {% else %}
                    <div class="empty-workspace">
                        <div class="empty-workspace-icon">
                            <i class="bi bi-grid-3x3-gap"></i>
                        </div>
                        <h3 class="empty-workspace-title">Tu workspace está vacío</h3>
                        <p class="empty-workspace-description">
                            Arrastra bloques desde la barra lateral o crea nuevos bloques para comenzar a organizar tu espacio de trabajo.
                        </p>
                        <button type="button" 
                                class="btn workspace-btn" 
                                id="create-first-block-btn"
                                data-bs-toggle="modal" 
                                data-bs-target="#block-factory-modal">
                            <i class="bi bi-plus me-2"></i>
                            Crear tu primer bloque
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Workspace Footer -->
    <div class="workspace-footer">
        <div class="workspace-info">
            <div class="workspace-status">
                <div class="status-indicator" id="save-status"></div>
                <span id="save-status-text">Guardado</span>
            </div>
            
            <div>{{ workspace_blocks|length or 0 }} bloques</div>
            
            <div>Última modificación: <span id="last-modified">{{ moment(workspace.updated_at).fromNow() if workspace else 'Nunca' }}</span></div>
        </div>
        
        <div class="workspace-actions">
            <button type="button" 
                    class="btn btn-sm btn-outline-secondary" 
                    id="toggle-sidebar-btn"
                    aria-label="Alternar barra lateral">
                <i class="bi bi-layout-sidebar"></i>
            </button>
        </div>
    </div>
</div>

<!-- Modals -->
{% include 'personal_space/components/widgets/BlockFactory.html' %}
{{ render_template_gallery_modal() }}
{% endblock %}

{% block extra_js %}
<script>
// Workspace JavaScript
window.PersonalSpaceWorkspace = {
    grid: null,
    editMode: false,
    currentView: 'grid',
    
    // Initialize workspace
    init: function() {
        this.initializeGrid();
        this.bindEvents();
        this.loadWorkspaceData();
        this.setupDragAndDrop();
        this.setupAutoSave();
    },
    
    // Initialize GridStack
    initializeGrid: function() {
        this.grid = GridStack.init({
            cellHeight: 80,
            verticalMargin: 10,
            horizontalMargin: 10,
            minRow: 6,
            animate: true,
            float: false,
            removable: false,
            acceptWidgets: true,
            dragIn: '.block-item',
            dragInOptions: {
                revert: 'invalid',
                scroll: false,
                appendTo: 'body',
                helper: 'clone'
            }
        });
        
        // Handle grid changes
        this.grid.on('change', (event, items) => {
            this.onGridChange(items);
        });
        
        // Handle new items dropped
        this.grid.on('dropped', (event, previousWidget, newWidget) => {
            this.onBlockDropped(newWidget);
        });
    },
    
    // Bind event listeners
    bindEvents: function() {
        // Sidebar toggle
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                this.toggleSidebar();
            }
        });
        
        // Save shortcut
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                this.saveWorkspace();
            }
        });
    },
    
    // Setup drag and drop
    setupDragAndDrop: function() {
        const blockItems = document.querySelectorAll('.block-item');
        
        blockItems.forEach(item => {
            item.addEventListener('dragstart', (e) => {
                const blockType = item.dataset.blockType;
                e.dataTransfer.setData('text/plain', blockType);
                e.dataTransfer.effectAllowed = 'copy';
            });
        });
    },
    
    // Handle grid changes
    onGridChange: function(items) {
        if (items && items.length > 0) {
            this.markAsModified();
            this.scheduleAutoSave();
        }
    },
    
    // Handle block dropped
    onBlockDropped: function(newWidget) {
        const blockType = newWidget.el.dataset.blockType || 'task';
        
        // Create new block via API
        this.createBlock({
            type: blockType,
            x: newWidget.x,
            y: newWidget.y,
            width: newWidget.w || 4,
            height: newWidget.h || 3
        }).then(block => {
            if (block) {
                // Update the widget with real block data
                this.updateBlockWidget(newWidget.el, block);
            }
        });
    },
    
    // Create new block
    createBlock: async function(blockData) {
        try {
            const response = await fetch('/api/personal-space/blocks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify(blockData)
            });
            
            if (response.ok) {
                const block = await response.json();
                this.showSuccessMessage('Bloque creado exitosamente');
                return block;
            } else {
                throw new Error('Error creating block');
            }
        } catch (error) {
            console.error('Error creating block:', error);
            this.showErrorMessage('Error al crear el bloque');
            return null;
        }
    },
    
    // Update block widget
    updateBlockWidget: function(element, block) {
        element.dataset.blockId = block.id;
        element.innerHTML = this.renderBlockContent(block);
    },
    
    // Render block content
    renderBlockContent: function(block) {
        return `
            <div class="grid-stack-item-content">
                <div class="block-header">
                    <h4 class="block-title">
                        <i class="bi bi-${this.getBlockIcon(block.type)}"></i>
                        ${block.title || this.getBlockTypeName(block.type)}
                    </h4>
                    <div class="block-actions">
                        <button type="button" class="block-action-btn" data-action="edit" data-block-id="${block.id}" aria-label="Editar bloque">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="block-action-btn" data-action="delete" data-block-id="${block.id}" aria-label="Eliminar bloque">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="block-body">
                    ${this.renderBlockBody(block)}
                </div>
            </div>
        `;
    },
    
    // Get block icon
    getBlockIcon: function(type) {
        const icons = {
            task: 'check-square',
            note: 'journal-text',
            kanban: 'kanban',
            objective: 'target',
            calendar: 'calendar3',
            habit: 'arrow-repeat'
        };
        return icons[type] || 'square';
    },
    
    // Get block type name
    getBlockTypeName: function(type) {
        const names = {
            task: 'Tareas',
            note: 'Notas',
            kanban: 'Kanban',
            objective: 'Objetivos',
            calendar: 'Calendario',
            habit: 'Hábitos'
        };
        return names[type] || 'Bloque';
    },
    
    // Render block body
    renderBlockBody: function(block) {
        // This would render the specific content based on block type
        // For now, return a placeholder
        return `
            <div class="text-center py-4">
                <i class="bi bi-${this.getBlockIcon(block.type)} text-muted" style="font-size: 2rem;"></i>
                <p class="text-muted mt-2 mb-0">Contenido del bloque</p>
                <small class="text-muted">Haz clic para configurar</small>
            </div>
        `;
    },
    
    // Load workspace data
    loadWorkspaceData: async function() {
        try {
            const response = await fetch('/api/personal-space/blocks');
            if (response.ok) {
                const data = await response.json();
                this.renderWorkspaceBlocks(data.blocks);
            }
        } catch (error) {
            console.error('Error loading workspace data:', error);
        }
    },
    
    // Render workspace blocks
    renderWorkspaceBlocks: function(blocks) {
        if (!blocks || blocks.length === 0) return;
        
        // Clear existing grid
        this.grid.removeAll();
        
        // Add blocks to grid
        blocks.forEach(block => {
            const widget = {
                x: block.position_x || 0,
                y: block.position_y || 0,
                w: block.width || 4,
                h: block.height || 3,
                content: this.renderBlockContent(block),
                id: block.id
            };
            
            this.grid.addWidget(widget);
        });
    },
    
    // Toggle edit mode
    toggleEditMode: function() {
        this.editMode = !this.editMode;
        const container = document.getElementById('workspace-container');
        const btn = document.getElementById('edit-mode-btn');
        
        if (this.editMode) {
            container.classList.add('edit-mode');
            btn.innerHTML = '<i class="bi bi-check me-1"></i>Finalizar';
            btn.classList.remove('secondary');
            this.grid.enable();
        } else {
            container.classList.remove('edit-mode');
            btn.innerHTML = '<i class="bi bi-pencil me-1"></i>Editar';
            btn.classList.add('secondary');
            this.grid.disable();
            this.saveWorkspace();
        }
    },
    
    // Switch view
    switchView: function(view) {
        if (this.currentView === view) return;
        
        this.currentView = view;
        
        // Update toggle buttons
        document.querySelectorAll('.view-toggle-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === view);
        });
        
        // Switch layout
        if (view === 'list') {
            this.switchToListView();
        } else {
            this.switchToGridView();
        }
    },
    
    // Switch to grid view
    switchToGridView: function() {
        const container = document.querySelector('.grid-container');
        if (!container) {
            console.warn('Grid container not found');
            return;
        }
        container.style.display = 'block';
        if (this.grid) {
            this.grid.enable();
        }
    },
    
    // Switch to list view
    switchToListView: function() {
        // Implementation for list view
        console.log('Switching to list view');
    },
    
    // Toggle sidebar
    toggleSidebar: function() {
        const sidebar = document.getElementById('workspace-sidebar');
        if (!sidebar) {
            console.warn('Workspace sidebar not found');
            return;
        }
        sidebar.classList.toggle('collapsed');
    },
    
    // Save workspace
    saveWorkspace: async function() {
        const blocks = this.getWorkspaceState();
        
        this.setSaveStatus('saving');
        
        try {
            const response = await fetch('/api/personal-space/blocks/reorder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({ blocks })
            });
            
            if (response.ok) {
                this.setSaveStatus('saved');
                this.updateLastModified();
                this.showSuccessMessage('Workspace guardado');
            } else {
                throw new Error('Save failed');
            }
        } catch (error) {
            console.error('Error saving workspace:', error);
            this.setSaveStatus('error');
            this.showErrorMessage('Error al guardar');
        }
    },
    
    // Get workspace state
    getWorkspaceState: function() {
        const items = this.grid.getGridItems();
        return items.map(item => {
            const node = item.gridstackNode;
            return {
                id: node.id,
                x: node.x,
                y: node.y,
                width: node.w,
                height: node.h
            };
        });
    },
    
    // Setup auto-save
    setupAutoSave: function() {
        this.autoSaveTimeout = null;
    },
    
    // Schedule auto-save
    scheduleAutoSave: function() {
        clearTimeout(this.autoSaveTimeout);
        this.autoSaveTimeout = setTimeout(() => {
            this.saveWorkspace();
        }, 3000); // Auto-save after 3 seconds of inactivity
    },
    
    // Mark as modified
    markAsModified: function() {
        this.setSaveStatus('modified');
    },
    
    // Set save status
    setSaveStatus: function(status) {
        const indicator = document.getElementById('save-status');
        const text = document.getElementById('save-status-text');
        
        if (indicator) {
            indicator.className = `status-indicator ${status}`;
        }
        
        const statusTexts = {
            saved: 'Guardado',
            saving: 'Guardando...',
            modified: 'Modificado',
            error: 'Error'
        };
        
        if (text) {
            text.textContent = statusTexts[status] || 'Desconocido';
        }
    },
    
    // Update last modified
    updateLastModified: function() {
        const element = document.getElementById('last-modified');
        if (element) {
            element.textContent = 'hace un momento';
        }
    },
    
    // Reset workspace
    resetWorkspace: function() {
        if (confirm('¿Estás seguro de que quieres resetear el workspace? Esta acción no se puede deshacer.')) {
            this.grid.removeAll();
            this.saveWorkspace();
        }
    },
    
    // Export workspace
    exportWorkspace: function() {
        const state = this.getWorkspaceState();
        const dataStr = JSON.stringify(state, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `workspace-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
    },
    
    // Utility functions
    getCSRFToken: function() {
        return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    },
    
    showSuccessMessage: function(message) {
        console.log('Success:', message);
    },
    
    showErrorMessage: function(message) {
        console.error('Error:', message);
    }
};

// Event delegation for block actions
function setupEventListeners() {
    // Block actions (edit/delete)
    document.addEventListener('click', function(e) {
        const actionBtn = e.target.closest('[data-action]');
        if (actionBtn) {
            const action = actionBtn.dataset.action;
            const blockId = actionBtn.dataset.blockId;
            
            if (action === 'edit') {
                editBlock(blockId);
            } else if (action === 'delete') {
                deleteBlock(blockId);
            }
        }
    });
    
    // Sidebar toggle
    const sidebarToggle = document.getElementById('toggle-sidebar-btn');
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', () => {
            window.PersonalSpaceWorkspace.toggleSidebar();
        });
    }
    
    // View toggle buttons
    const gridViewBtn = document.getElementById('grid-view-btn');
    const listViewBtn = document.getElementById('list-view-btn');
    
    if (gridViewBtn) {
        gridViewBtn.addEventListener('click', () => {
            window.PersonalSpaceWorkspace.switchView('grid');
        });
    }
    
    if (listViewBtn) {
        listViewBtn.addEventListener('click', () => {
            window.PersonalSpaceWorkspace.switchView('list');
        });
    }
    
    // Edit mode toggle
    const editModeBtn = document.getElementById('edit-mode-btn');
    if (editModeBtn) {
        editModeBtn.addEventListener('click', () => {
            window.PersonalSpaceWorkspace.toggleEditMode();
        });
    }
    
    // Save workspace
    const saveBtn = document.getElementById('save-workspace-btn');
    if (saveBtn) {
        saveBtn.addEventListener('click', () => {
            window.PersonalSpaceWorkspace.saveWorkspace();
        });
    }
    
    // Reset workspace
    const resetBtn = document.getElementById('reset-workspace-btn');
    if (resetBtn) {
        resetBtn.addEventListener('click', () => {
            window.PersonalSpaceWorkspace.resetWorkspace();
        });
    }
    
    // Export workspace
    const exportBtn = document.getElementById('export-workspace-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', () => {
            window.PersonalSpaceWorkspace.exportWorkspace();
        });
    }
}

// Block action functions
function editBlock(blockId) {
    console.log('Edit block:', blockId);
    // TODO: Implement block editing functionality
}

function deleteBlock(blockId) {
    if (confirm('¿Estás seguro de que quieres eliminar este bloque?')) {
        console.log('Delete block:', blockId);
        // TODO: Implement block deletion functionality
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Personal Space core functionality
    if (window.initPersonalSpace) {
        window.initPersonalSpace();
    }
    
    // Setup event listeners
    setupEventListeners();
    
    // Initialize Workspace
    window.PersonalSpaceWorkspace.init();
});
</script>
{% endblock %}