<div class="bloque-personalizado-content">
    {% set metadata = block.get_metadata() %}
    
    <!-- Header con materia y color -->
    <div class="bloque-header" style="background: linear-gradient(135deg, {{ metadata.get('color', '#6366f1') }}22, {{ metadata.get('color', '#6366f1') }}11);">
        <div class="materia-info">
            <div class="materia-icon" style="background: {{ metadata.get('color', '#6366f1') }}22; color: {{ metadata.get('color', '#6366f1') }};">
                <i class="{{ metadata.get('icon', 'bi bi-book') }}"></i>
            </div>
            <div class="materia-details">
                <h6 class="materia-name">{{ metadata.get('subject', block.title) }}</h6>
                <span class="materia-code">{{ metadata.get('subject_code', 'SIN CÓDIGO') }}</span>
            </div>
        </div>
        {% if metadata.get('professor') %}
        <div class="professor-info">
            <span class="professor-name">{{ metadata.get('professor') }}</span>
        </div>
        {% endif %}
    </div>
    
    <!-- Elementos agrupados -->
    <div class="elementos-container">
        {% set elementos = metadata.get('elementos', []) %}
        {% if elementos %}
            {% for elemento in elementos[:4] %}
            <div class="elemento-item elemento-{{ elemento.type }}">
                <div class="elemento-icon">
                    {% if elemento.type == 'tarea' %}
                        <i class="bi bi-check-square"></i>
                    {% elif elemento.type == 'examen' %}
                        <i class="bi bi-clipboard-check"></i>
                    {% elif elemento.type == 'proyecto' %}
                        <i class="bi bi-folder"></i>
                    {% elif elemento.type == 'nota' %}
                        <i class="bi bi-file-text"></i>
                    {% elif elemento.type == 'enlace' %}
                        <i class="bi bi-link-45deg"></i>
                    {% else %}
                        <i class="bi bi-circle"></i>
                    {% endif %}
                </div>
                <div class="elemento-content">
                    <span class="elemento-title">{{ elemento.title[:30] }}{% if elemento.title|length > 30 %}...{% endif %}</span>
                    {% if elemento.due_date %}
                    <span class="elemento-date">{{ elemento.due_date }}</span>
                    {% endif %}
                </div>
                {% if elemento.priority %}
                <div class="elemento-priority priority-{{ elemento.priority }}">
                    <i class="bi bi-flag-fill"></i>
                </div>
                {% endif %}
            </div>
            {% endfor %}
            {% if elementos|length > 4 %}
            <div class="more-elementos">
                <span class="text-muted">+{{ elementos|length - 4 }} elementos más</span>
            </div>
            {% endif %}
        {% else %}
            <div class="elementos-empty">
                <i class="bi bi-plus-circle text-muted"></i>
                <p class="text-muted">Agregar elementos a esta materia</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Estadísticas rápidas -->
    <div class="bloque-stats">
        <div class="stat-group">
            <div class="stat-item">
                <span class="stat-number">{{ metadata.get('completed_tasks', 0) }}</span>
                <span class="stat-label">Completadas</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">{{ metadata.get('pending_tasks', 0) }}</span>
                <span class="stat-label">Pendientes</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">{{ metadata.get('grade_average', 0) }}%</span>
                <span class="stat-label">Promedio</span>
            </div>
        </div>
    </div>
    
    <button class="btn btn-sm btn-outline-primary mt-2" onclick="openBlock({{ block.id }})">
        <i class="bi bi-plus"></i>
        Gestionar materia
    </button>
</div>

<style>
.bloque-header {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.materia-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.materia-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
}

.materia-name {
    margin: 0;
    font-weight: 600;
    font-size: 0.9rem;
}

.materia-code {
    font-size: 0.7rem;
    color: var(--bs-secondary);
    font-weight: 500;
}

.professor-info {
    text-align: right;
}

.professor-name {
    font-size: 0.75rem;
    color: var(--bs-secondary);
    font-weight: 500;
}

.elemento-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid var(--bs-border-color-translucent);
}

.elemento-item:last-child {
    border-bottom: none;
}

.elemento-icon {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    font-size: 0.9rem;
}

.elemento-tarea .elemento-icon {
    background: var(--bs-success-bg);
    color: var(--bs-success);
}

.elemento-examen .elemento-icon {
    background: var(--bs-danger-bg);
    color: var(--bs-danger);
}

.elemento-proyecto .elemento-icon {
    background: var(--bs-warning-bg);
    color: var(--bs-warning);
}

.elemento-nota .elemento-icon {
    background: var(--bs-info-bg);
    color: var(--bs-info);
}

.elemento-enlace .elemento-icon {
    background: var(--bs-primary-bg);
    color: var(--bs-primary);
}

.elemento-content {
    flex: 1;
}

.elemento-title {
    display: block;
    font-size: 0.85rem;
    font-weight: 500;
    line-height: 1.2;
}

.elemento-date {
    font-size: 0.7rem;
    color: var(--bs-secondary);
}

.elemento-priority {
    font-size: 0.8rem;
}

.priority-high { color: var(--bs-danger); }
.priority-medium { color: var(--bs-warning); }
.priority-low { color: var(--bs-success); }

.more-elementos {
    text-align: center;
    padding: 8px;
    font-size: 0.8rem;
}

.elementos-empty {
    text-align: center;
    padding: 20px;
}

.elementos-empty i {
    font-size: 1.5rem;
    margin-bottom: 8px;
}

.bloque-stats {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--bs-border-color);
}

.stat-group {
    display: flex;
    justify-content: space-around;
}

.stat-item {
    text-align: center;
}

.stat-number {
    display: block;
    font-weight: 600;
    font-size: 1rem;
    color: var(--bs-primary);
}

.stat-label {
    font-size: 0.7rem;
    color: var(--bs-secondary);
}
</style>