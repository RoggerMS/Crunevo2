
<!doctype html>
<html lang="es" data-bs-theme="{{ 'dark' if current_user.is_authenticated and (current_user.pref_dark|default(false)) else 'light' }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Modern fonts with display=swap -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <title>{% block title %}Crunevo - Comunidad Educativa Moderna{% endblock %}</title>
    <meta name="description" content="Crunevo es la plataforma educativa moderna que conecta estudiantes. Comparte apuntes, gana Crolars y forma parte de una comunidad que impulsa tu crecimiento académico.">
    
    <!-- Enhanced Open Graph -->
    <meta property="og:title" content="{% block og_title %}Crunevo - Comunidad Educativa Moderna{% endblock %}" />
    <meta property="og:description" content="{% block og_description %}Plataforma educativa moderna que conecta estudiantes. Comparte conocimiento, gana recompensas y crece académicamente.{% endblock %}" />
    <meta property="og:image" content="{{ url_for('static', filename='img/opengraph.jpg') }}" />
    <meta property="og:url" content="{{ request.url }}" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Crunevo" />
    
    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}Crunevo - Comunidad Educativa Moderna{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}Plataforma educativa que conecta estudiantes y potencia el aprendizaje colaborativo{% endblock %}">
    <meta name="twitter:image" content="{{ url_for('static', filename='img/opengraph.jpg') }}">
    
    <!-- Stylesheets with optimized loading -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/accessibility.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/bootstrap-icons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tokens.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fix-bootstrap.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern-components.css') }}">
    {% block head_extra %}{% endblock %}
</head>
<body class="d-flex flex-column min-vh-100">
    <!-- Navigation -->
    {% if not request.path.startswith('/admin') %}
      {% if config.ADMIN_INSTANCE %}
        {% include 'components/navbar_admin.html' %}
      {% else %}
        {% include 'components/navbar.html' %}
      {% endif %}
    {% endif %}

    <!-- Main content with enhanced container -->
    <main class="flex-grow-1">
        <div class="container-fluid px-md-5 pb-5">
            <!-- Toast notifications -->
            {% import 'components/toast.html' as toast %}
            {% with messages = get_flashed_messages() %}
              {% if messages %}
                <div class="toast-container position-fixed top-0 start-0 end-0 z-50 d-flex flex-column align-items-center gap-2 mt-5" style="z-index: 1080;">
                  {% for msg in messages %}
                    {{ toast.toast(msg) }}
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}
            
            <!-- Page content -->
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Enhanced footer -->
    <footer class="text-center py-4 mt-5" style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px);">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-6 text-md-start">
            <span class="text-muted small">© 2024 Crunevo - Construyendo el futuro educativo</span>
          </div>
          <div class="col-md-6 text-md-end">
            <a href="/cookies" class="text-muted text-decoration-none me-3 small">Cookies</a>
            <a href="/privacidad" class="text-muted text-decoration-none me-3 small">Privacidad</a>
            <a href="/terminos" class="text-muted text-decoration-none small">Términos</a>
          </div>
        </div>
      </div>
    </footer>

    <!-- Enhanced achievement popup -->
    {% if current_user.is_authenticated and not config.ADMIN_INSTANCE %}
    <div class="achievement-popup tw-hidden d-none" id="achievementPopup" role="dialog" aria-modal="true">
      <div class="popup-content p-5 rounded-4 text-center shadow-lg text-white">
        <div class="mb-3">
          <i class="bi bi-trophy-fill display-3 text-warning"></i>
        </div>
        <h3 class="fw-bold mb-2">¡Logro desbloqueado!</h3>
        <p id="achievementTitle" class="mb-2 fw-semibold fs-5"></p>
        <p class="credit-gain mb-4 text-warning fw-bold">+1 Crolar</p>
        <button class="btn btn-primary btn-lg px-4" id="closeAchievementBtn" aria-label="Cerrar logro desbloqueado">
          ¡Genial!
        </button>
      </div>
    </div>
    {% endif %}

    <!-- Toast container for dynamic notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1080;"></div>

    <!-- Shopping cart button for store pages -->
    {% if request.path.startswith('/store') and 'store.view_cart' in current_app.view_functions %}
    <a href="{{ url_for('store.view_cart') }}" 
       class="btn btn-primary rounded-circle position-fixed shadow-lg d-lg-none mobile-overlay-btn"
       style="bottom: 80px; right: 20px; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center;">
      <i class="bi bi-cart fs-5"></i>
      <span id="mobileCartBadge" 
            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger {% if CART_COUNT == 0 %}tw-hidden{% endif %}">
        {{ CART_COUNT }}
      </span>
    </a>
    {% endif %}

    <!-- Mobile bottom navigation -->
    {% if not config.ADMIN_INSTANCE %}
    {% include 'components/mobile_bottom_nav.html' %}
    {% endif %}

    <!-- Core JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- App JavaScript with enhanced loading -->
    <script src="{{ url_for('static', filename='js/feed_toggle.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/feed.js') }}" defer></script>
    
    <!-- Configuration variables -->
    <script>
      window.HAS_STORE = {{ 'true' if 'store.cart_count_api' in current_app.view_functions else 'false' }};
      window.CRUNEVO_CONFIG = {
        isDark: document.documentElement.dataset.bsTheme === 'dark',
        hasStore: {{ 'true' if 'store.cart_count_api' in current_app.view_functions else 'false' }},
        version: '2.0.0'
      };
    </script>
    
    <!-- User context -->
    {% if current_user.is_authenticated %}
    <script>
      const CURRENT_USER_ID = {{ current_user.id }};
      window.CURRENT_USER_ID = CURRENT_USER_ID;
      window.CURRENT_USER = {
        id: {{ current_user.id }},
        username: '{{ current_user.username }}',
        credits: {{ current_user.credits }},
        isDark: {{ current_user.pref_dark|default(false)|tojson }}
      };
      {% if NEW_ACHIEVEMENTS %}
      window.NEW_ACHIEVEMENTS = {{ NEW_ACHIEVEMENTS|tojson }};
      {% endif %}
    </script>
    {% else %}
    <script>
      window.CURRENT_USER_ID = null;
      window.CURRENT_USER = null;
    </script>
    {% endif %}
    
    <!-- Main app initialization -->
    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
    
    {% block body_end %}{% endblock %}
</body>
</html>
