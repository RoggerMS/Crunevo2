
{% extends "base.html" %}

{% block title %}{{ user.username }} - Perfil{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-4">
  <div class="row g-4">
    <!-- Left Sidebar -->
    <div class="col-lg-3 d-none d-lg-block">
      {% include 'components/sidebar_left_feed.html' %}
    </div>

    <!-- Main Content -->
    <div class="col-lg-6">
      <!-- Profile Header -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="position-relative">
          <div class="profile-header-bg" style="height: 150px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 16px 16px 0 0;"></div>
          <div class="username-display">
            {{ user.username }}
            {% if user.verification_level > 0 %}
            <i class="bi bi-patch-check-fill ms-1"></i>
            {% endif %}
          </div>
        </div>
        <div class="card-body p-4" style="margin-top: -75px;">
          <div class="row align-items-end">
            <div class="col-auto">
              <div class="profile-avatar-container position-relative">
                <img src="{{ user.avatar_url or url_for('static', filename='img/default.png') }}" 
                     alt="{{ user.username }}" 
                     class="rounded-circle border-4 border-white shadow" 
                     width="120" height="120">
                {% if is_own_profile %}
                <button class="btn btn-sm btn-primary rounded-circle position-absolute bottom-0 end-0">
                  <i class="bi bi-camera"></i>
                </button>
                {% endif %}
              </div>
            </div>
            <div class="col">
              <div class="mt-3">
                
                {% if user.about %}
                <p class="text-muted mb-3">{{ user.about }}</p>
                {% elif is_own_profile %}
                <p class="text-muted mb-3">
                  <i>Añade una descripción sobre ti...</i>
                  <button class="btn btn-sm btn-outline-primary ms-2">Editar</button>
                </p>
                {% endif %}
                
                <!-- Quick Stats -->
                <div class="row g-2 text-center">
                  <div class="col-3">
                    <div class="stat-item">
                      <div class="fw-bold text-primary">{{ user.credits or 0 }}</div>
                      <div class="small text-muted">Crolars</div>
                    </div>
                  </div>
                  <div class="col-3">
                    <div class="stat-item">
                      <div class="fw-bold text-success">{{ user.notes|length }}</div>
                      <div class="small text-muted">Apuntes</div>
                    </div>
                  </div>
                  <div class="col-3">
                    <div class="stat-item">
                      <div class="fw-bold text-info">{{ user_clubs|length }}</div>
                      <div class="small text-muted">Clubes</div>
                    </div>
                  </div>
                  <div class="col-3">
                    <div class="stat-item">
                      <div class="fw-bold text-warning">{{ completed_missions_count }}</div>
                      <div class="small text-muted">Misiones</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% if is_own_profile %}
            <div class="col-auto">
              <div class="btn-group-vertical">
                <button class="btn btn-primary btn-sm">
                  <i class="bi bi-pencil"></i> Editar Perfil
                </button>
                <button class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-eye"></i> Ver como Público
                </button>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Profile Navigation -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-0">
          <nav class="nav nav-pills nav-fill">
            <a class="nav-link active" data-bs-toggle="pill" href="#overview-tab">
              <i class="bi bi-house"></i> Resumen
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#notes-tab">
              <i class="bi bi-journal-text"></i> Apuntes
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#clubs-tab">
              <i class="bi bi-people"></i> Clubes
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#missions-tab">
              <i class="bi bi-trophy"></i> Misiones
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#achievements-tab">
              <i class="bi bi-award"></i> Logros
            </a>
            {% if is_own_profile %}
            <a class="nav-link" data-bs-toggle="pill" href="#referrals-tab">
              <i class="bi bi-person-plus"></i> Referidos
            </a>
            {% endif %}
          </nav>
        </div>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview-tab">
          <!-- Recent Activity -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
              <h6 class="fw-bold text-primary mb-3">
                <i class="bi bi-clock-history"></i> Actividad Reciente
              </h6>
              
              <div class="activity-timeline">
                {% for activity in recent_activities %}
                <div class="activity-item d-flex align-items-start gap-3 mb-3">
                  <div class="activity-icon bg-{{ activity.type_color }}-subtle rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="bi bi-{{ activity.icon }} text-{{ activity.type_color }}"></i>
                  </div>
                  <div class="flex-grow-1">
                    <p class="mb-1">{{ activity.description }}</p>
                    <small class="text-muted">{{ activity.timestamp.strftime('%d %b %Y, %H:%M') }}</small>
                  </div>
                </div>
                {% else %}
                <div class="text-center py-4">
                  <i class="bi bi-clock-history display-1 text-muted mb-3"></i>
                  <p class="text-muted">No hay actividad reciente</p>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <!-- Statistics Overview -->
          <div class="row g-3">
            <div class="col-md-6">
              <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                  <h6 class="fw-bold text-success mb-3">
                    <i class="bi bi-graph-up"></i> Estadísticas Académicas
                  </h6>
                  <div class="stats-list">
                    <div class="d-flex justify-content-between mb-2">
                      <span>Apuntes subidos</span>
                      <span class="fw-bold">{{ user.notes|length }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span>Comentarios hechos</span>
                      <span class="fw-bold">{{ user.comments|length }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span>Puntos ganados</span>
                      <span class="fw-bold">{{ user.points or 0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                      <span>Nivel de verificación</span>
                      <span class="fw-bold">{{ user.verification_level }}/5</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                  <h6 class="fw-bold text-warning mb-3">
                    <i class="bi bi-coin"></i> Crolars y Recompensas
                  </h6>
                  <div class="crolars-info">
                    <div class="text-center mb-3">
                      <div class="display-6 fw-bold text-warning">{{ user.credits or 0 }}</div>
                      <div class="text-muted">Crolars disponibles</div>
                    </div>
                    
                    {% if is_own_profile %}
                    <div class="d-grid gap-2">
                      <button class="btn btn-warning btn-sm">
                        <i class="bi bi-plus-circle"></i> Comprar más Crolars
                      </button>
                      <a href="{{ url_for('store.store_index') if 'store.store_index' in url_for.__globals__.get('current_app', {}).view_functions else '/store' }}" class="btn btn-outline-warning btn-sm">
                        <i class="bi bi-shop"></i> Ir a la Tienda
                      </a>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Notes Tab -->
        <div class="tab-pane fade" id="notes-tab">
          {% if user.notes %}
          <div class="row g-3">
            {% for note in user.notes[:12] %}
            <div class="col-md-6">
              {% include 'components/note_card.html' %}
            </div>
            {% endfor %}
          </div>
          
          {% if user.notes|length > 12 %}
          <div class="text-center mt-4">
            <a href="{{ url_for('notes.list_notes') if 'notes.list_notes' in url_for.__globals__.get('current_app', {}).view_functions else '/notes' }}" class="btn btn-outline-primary">
              Ver todos los apuntes ({{ user.notes|length }})
            </a>
          </div>
          {% endif %}
          {% else %}
          <div class="text-center py-5">
            <i class="bi bi-journal-text display-1 text-muted mb-3"></i>
            <h5 class="text-muted">Sin apuntes subidos</h5>
            {% if is_own_profile %}
            <p class="text-muted mb-3">¡Sube tu primer apunte y ayuda a la comunidad!</p>
            <a href="{{ url_for('notes.upload') }}" class="btn btn-primary">
              <i class="bi bi-plus-circle"></i> Subir Apunte
            </a>
            {% endif %}
          </div>
          {% endif %}
        </div>

        <!-- Clubs Tab -->
        <div class="tab-pane fade" id="clubs-tab">
          {% if user_clubs %}
          <div class="row g-3">
            {% for club in user_clubs %}
            <div class="col-md-6">
              <div class="card border-0 shadow-sm">
                <div class="card-body p-3">
                  <div class="d-flex align-items-center gap-3">
                    <img src="{{ club.avatar_url or url_for('static', filename='img/default.png') }}" 
                         alt="{{ club.name }}" 
                         class="rounded-circle" 
                         width="48" height="48">
                    <div class="flex-grow-1">
                      <h6 class="fw-bold mb-1">{{ club.name }}</h6>
                      <p class="text-muted small mb-0">{{ club.career }}</p>
                      <p class="text-muted small">{{ club.member_count }} miembros</p>
                    </div>
                    <a href="{{ url_for('club.view_club', club_id=club.id) }}" 
                       class="btn btn-outline-primary btn-sm">
                      Ver
                    </a>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="bi bi-people display-1 text-muted mb-3"></i>
            <h5 class="text-muted">Sin clubes unidos</h5>
            {% if is_own_profile %}
            <p class="text-muted mb-3">¡Únete a clubes académicos y conecta con otros estudiantes!</p>
            <a href="{{ url_for('club.list_clubs') }}" class="btn btn-primary">
              <i class="bi bi-search"></i> Explorar Clubes
            </a>
            {% endif %}
          </div>
          {% endif %}
        </div>

        <!-- Missions Tab -->
        <div class="tab-pane fade" id="missions-tab">
          {% include 'auth/missions_tab.html' %}
        </div>

        <!-- Achievements Tab -->
        <div class="tab-pane fade" id="achievements-tab">
          <div class="row g-3">
            {% for achievement in user_achievements %}
            <div class="col-md-4">
              <div class="card border-0 shadow-sm text-center">
                <div class="card-body p-3">
                  <div class="achievement-icon mb-2">
                    <i class="bi bi-trophy-fill display-4 text-warning"></i>
                  </div>
                  <h6 class="fw-bold mb-1">{{ achievement.title }}</h6>
                  <p class="text-muted small mb-2">{{ achievement.description }}</p>
                  <small class="text-muted">
                    Desbloqueado {{ achievement.unlocked_date.strftime('%d/%m/%Y') }}
                  </small>
                </div>
              </div>
            </div>
            {% else %}
            <div class="col-12">
              <div class="text-center py-5">
                <i class="bi bi-award display-1 text-muted mb-3"></i>
                <h5 class="text-muted">Sin logros desbloqueados</h5>
                {% if is_own_profile %}
                <p class="text-muted mb-3">¡Completa misiones para desbloquear logros!</p>
                <a href="{{ url_for('auth.perfil', tab='misiones') }}" class="btn btn-primary">
                  <i class="bi bi-trophy"></i> Ver Misiones
                </a>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Referrals Tab -->
        {% if is_own_profile %}
        <div class="tab-pane fade" id="referrals-tab">
          {% include 'auth/referrals_tab.html' %}
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="col-lg-3 d-none d-lg-block">
      <div class="sticky-top" style="top: 100px;">
        <!-- Profile Stats -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body p-4">
            <h6 class="fw-bold text-primary mb-3">
              <i class="bi bi-bar-chart"></i> Estadísticas del Perfil
            </h6>
            
            <div class="stats-chart mb-3">
              <canvas id="profileStatsChart" width="200" height="200"></canvas>
            </div>
            
            <div class="stats-summary">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Nivel académico</span>
                <span class="fw-bold">{{ user_level }}/10</span>
              </div>
              <div class="progress mb-3" style="height: 6px;">
                <div class="progress-bar bg-primary" style="width: {{ (user_level/10*100) }}%"></div>
              </div>
              
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Participación</span>
                <span class="fw-bold">{{ participation_percentage }}%</span>
              </div>
              <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-success" style="width: {{ participation_percentage }}%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        {% if is_own_profile %}
        <div class="card border-0 shadow-sm">
          <div class="card-body p-4">
            <h6 class="fw-bold text-success mb-3">
              <i class="bi bi-lightning"></i> Acciones Rápidas
            </h6>
            <div class="d-grid gap-2">
              <a href="{{ url_for('notes.upload') }}" class="btn btn-primary btn-sm">
                <i class="bi bi-plus-circle"></i> Subir Apunte
              </a>
              <a href="{{ url_for('forum.ask_question') }}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-question-circle"></i> Hacer Pregunta
              </a>
              <a href="{{ url_for('club.list_clubs') }}" class="btn btn-outline-success btn-sm">
                <i class="bi bi-people"></i> Buscar Clubes
              </a>
              <a href="{{ url_for('store.store_index') if 'store.store_index' in url_for.__globals__.get('current_app', {}).view_functions else '/store' }}" class="btn btn-outline-warning btn-sm">
                <i class="bi bi-shop"></i> Tienda
              </a>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Mobile Bottom Navigation -->
<div class="d-lg-none">
  {% include 'components/mobile_bottom_nav.html' %}
</div>

<style>
.profile-header-bg {
  position: relative;
  z-index: 0;
}

.profile-avatar-container {
  z-index: 10;
}

.username-display {
  position: absolute;
  bottom: 12px;
  left: 16px;
  background: rgba(0, 0, 0, 0.5);
  color: #fff;
  padding: 4px 8px;
  border-radius: 8px;
  font-weight: bold;
  z-index: 2;
}

.stat-item {
  padding: 8px;
  border-radius: 8px;
  background: rgba(102, 126, 234, 0.05);
}

.activity-timeline {
  max-height: 400px;
  overflow-y: auto;
}

.stats-chart {
  position: relative;
  height: 200px;
}
</style>

<script>
// Initialize profile stats chart
document.addEventListener('DOMContentLoaded', function() {
  const ctx = document.getElementById('profileStatsChart');
  if (ctx) {
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Apuntes', 'Comentarios', 'Misiones', 'Clubes'],
        datasets: [{
          data: [{{ user.notes|length }}, {{ user.comments|length }}, {{ completed_missions_count }}, {{ user_clubs|length }}],
          backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              boxWidth: 12,
              font: {
                size: 10
              }
            }
          }
        }
      }
    });
  }
});
</script>
{% endblock %}
