{% extends "base.html" %}
{% import 'components/csrf.html' as csrf %}
{% from 'components/price_credits.html' import render_price_credits %}

{% block head_extra %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/perfil.css') }}">
{% endblock %}

{% block title %}{{ user.username }} - Perfil{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-4">
  <div class="row g-4">
    <!-- Left Sidebar -->
    <div class="col-lg-3 d-none d-lg-block">
      {% include 'components/sidebar_left_feed.html' %}
    </div>

    <!-- Main Content -->
    <div class="col-12 col-lg-6 mx-auto">
      <!-- Profile Header -->
      <div class="card border-0 shadow-sm mb-4 profile-header">
        <div class="position-relative">
          <div class="profile-header-bg position-relative" style="height: 200px;">
  <img src="{{ user.banner_url or url_for('static', filename='img/default.png') }}" id="bannerPreview" class="w-100 h-100 object-fit-cover" alt="Banner">

  {% if current_user.id == user.id %}
  <form id="bannerForm" method="POST" enctype="multipart/form-data"
        action="{{ url_for('auth.update_banner') }}" class="position-absolute end-0 top-0 p-2">
    {{ csrf.csrf_field() }}
    <input type="file" name="banner" id="bannerInput" accept="image/*" hidden>
    <button type="button" class="profile-banner-edit" onclick="document.getElementById('bannerInput').click()">
      <i class="bi bi-camera"></i> Cambiar Banner
    </button>
    <button type="submit" id="saveBannerBtn" class="btn btn-success d-none mt-2">Guardar Banner</button>
  </form>
  {% endif %}
</div>
        </div>
        <div class="card-body position-relative p-4" style="margin-top: -60px;">

          <div class="row align-items-center">
            <div class="col-auto">
              <div class="profile-avatar-container text-center position-relative" style="margin-top: -60px;">
                <img src="{{ (user.avatar_url|cl_url(120,120,'thumb')) if user.avatar_url else url_for('static', filename='img/default.png') }}"
                     class="rounded-circle border border-white shadow avatar-img"
                     id="avatarPreview" width="120" height="120" alt="Avatar">

                {% if current_user.id == user.id %}
                <button class="avatar-edit-btn" id="editAvatarBtn" aria-label="Editar avatar">
                  <i class="bi bi-camera"></i>
                </button>

                <form id="avatarForm" method="POST" enctype="multipart/form-data" action="{{ url_for('auth.update_avatar') }}">
                  {{ csrf.csrf_field() }}
                  <input type="file" name="avatar" id="avatarInput" accept="image/*" hidden>
                  <button type="submit" id="saveAvatarBtn" class="btn btn-success mt-2 d-none">Guardar cambios</button>
                </form>
                {% endif %}
              </div>
            </div>
              <div class="col" style="margin-top: 8px;">
                <div class="mt-3 d-none d-lg-block">
                  <h3 class="fw-bold mb-1">
                    {{ user.username }}
                    {% if user.verification_level >= 2 %}
                      <span class="badge verified-badge" data-bs-toggle="tooltip" title="Cuenta verificada">
                        <i class="bi bi-check-circle-fill"></i>
                      </span>
                    {% endif %}
                  </h3>
                  {% if user.about %}
                  <p class="text-muted mb-2">{{ user.about }}</p>
                  {% elif is_own_profile %}
                  <p class="text-muted mb-2">
                    <i>Añade una descripción sobre ti...</i>
                    <button class="btn btn-sm btn-outline-primary ms-2">Editar</button>
                  </p>
                  {% else %}
                  <p class="text-muted mb-2"><i>Este usuario aún no ha escrito su biografía.</i></p>
                  {% endif %}
                </div>
              </div>
              {% if is_own_profile %}
              <div class="col-auto">
                <div class="btn-group-vertical">
                  <a href="{{ url_for('auth.view_profile', username=user.username, public='true') }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-eye"></i> Ver como Público
                  </a>
                </div>
            </div>
            {% endif %}
          </div>

          <!-- Mobile profile info -->
          <div class="d-lg-none mt-3">
            <div class="d-flex justify-content-start align-items-center mb-2 px-3">
              <h3 class="fw-bold mb-0 me-2">
                {{ user.username }}
                {% if user.verification_level >= 2 %}
                  <span class="badge verified-badge">
                    <i class="bi bi-check-circle-fill"></i>
                  </span>
                {% endif %}
              </h3>
            </div>
            <p class="text-muted text-center px-3">
              {% if user.about %}
                {{ user.about }}
              {% elif is_own_profile %}
                <i>Añade una descripción sobre ti...</i>
                <button class="btn btn-sm btn-outline-primary ms-2">Editar</button>
              {% else %}
                <i>Este usuario aún no ha escrito su biografía.</i>
              {% endif %}
            </p>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      {% if not is_own_profile %}
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-3">
          <div class="d-flex gap-2 justify-content-center">
            <button class="btn btn-primary">
              <i class="fas fa-heart me-2"></i>Agradecer
            </button>
            <button class="btn btn-outline-primary">
              <i class="fas fa-envelope me-2"></i>Mensaje
            </button>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Profile Navigation -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-0">
          <ul class="nav nav-tabs nav-fill border-0" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link {% if not tab or tab == 'publicaciones' %}active{% endif %}" 
                      id="publicaciones-tab" data-bs-toggle="tab" data-bs-target="#publicaciones" 
                      type="button" role="tab" aria-controls="publicaciones" aria-selected="true">
                <i class="fas fa-newspaper me-2"></i>Publicaciones
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link {% if tab == 'apuntes' %}active{% endif %}" 
                      id="apuntes-tab" data-bs-toggle="tab" data-bs-target="#apuntes" 
                      type="button" role="tab" aria-controls="apuntes" aria-selected="false">
                <i class="fas fa-book me-2"></i>Apuntes
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link {% if tab == 'logros' %}active{% endif %}" 
                      id="logros-tab" data-bs-toggle="tab" data-bs-target="#logros" 
                      type="button" role="tab" aria-controls="logros" aria-selected="false">
                <i class="fas fa-trophy me-2"></i>Logros
              </button>
            </li>
            {% if user.mostrar_tienda_perfil %}
            <li class="nav-item" role="presentation">
              <button class="nav-link {% if tab == 'tienda' %}active{% endif %}" 
                      id="tienda-tab" data-bs-toggle="tab" data-bs-target="#tienda" 
                      type="button" role="tab" aria-controls="tienda" aria-selected="false">
                <i class="fas fa-store me-2"></i>Tienda
              </button>
            </li>
            {% endif %}
          </ul>
        </div>
      </div>

      <!-- Tab Content -->
      <div class="tab-content" id="profileTabContent">
        <!-- Publicaciones Tab -->
        {% include 'profile/tabs/publicaciones.html' %}
        
        <!-- Apuntes Tab -->
        {% include 'profile/tabs/apuntes.html' %}
        
        <!-- Logros Tab -->
        {% include 'profile/tabs/logros.html' %}
        
        <!-- Tienda Tab -->
        {% if user.mostrar_tienda_perfil %}
          {% include 'profile/tabs/tienda.html' %}
        {% endif %}
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="col-lg-3 d-none d-lg-block">
      <div class="sticky-top" style="top: 100px;">
        <!-- Profile Stats -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body p-4">
            <h6 class="fw-bold text-primary mb-3">
              <i class="bi bi-bar-chart"></i> Estadísticas del Perfil
            </h6>

            <div class="stats-chart mb-3">
              <canvas id="profileStatsChart" width="200" height="200"></canvas>
            </div>

            <div class="stats-summary">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">
                  Nivel académico
                  <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip"
                     title="Basado en tus logros, apuntes y participación."
                  ></i>
                </span>
                <span class="fw-bold">{{ user_level }}/10</span>
              </div>
              <div class="progress mb-3" style="height: 6px;">
                <div class="progress-bar bg-primary" style="width: {{ (user_level/10*100) }}%"></div>
              </div>

              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Participación</span>
                <span class="fw-bold">{{ participation_percentage }}%</span>
              </div>
              <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-success" style="width: {{ participation_percentage }}%"></div>
              </div>

              <div class="d-flex justify-content-between mb-2">
                <span><i class="bi bi-journal-text me-1"></i> Apuntes subidos</span>
                <span class="fw-bold">{{ notes_count(user) }}</span>
              </div>
              <div class="d-flex justify-content-between">
                <span><i class="bi bi-coin me-1"></i> Crolars acumulados</span>
                <span class="fw-bold">{{ user.credits }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Achievements Summary -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body p-4">
            <h6 class="fw-bold text-info mb-3">
              <i class="bi bi-stars"></i> Resumen de Logros
            </h6>
            <p class="mb-2">Has alcanzado {{ achievements|length }} logros.</p>
            <div class="progress mb-2" style="height: 6px;">
              <div class="progress-bar bg-info" style="width: {{ (achievements|length/10*100)|int }}%"></div>
            </div>
            <small class="text-muted">Has alcanzado {{ achievements|length }}/10 logros posibles</small>
          </div>
        </div>

        <!-- Global Progress -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body p-4">
            <h6 class="fw-bold text-secondary mb-3">
              <i class="bi bi-graph-up-arrow"></i> Progreso Global del Usuario
            </h6>
            {% set global_progress = (((user_level/10*100) + participation_percentage) / 2)|int %}
            <div class="progress mb-2" style="height: 8px;">
              <div class="progress-bar" style="width: {{ global_progress }}%"></div>
            </div>
            <small class="text-muted">{{ global_progress }}% completado</small>
          </div>
        </div>

        <!-- Quick Actions -->
        {% if is_own_profile %}
        <div class="card border-0 shadow-sm">
          <div class="card-body p-4">
            <h6 class="fw-bold text-success mb-3">
              <i class="bi bi-lightning"></i> Acciones Rápidas
            </h6>
            <div class="d-grid gap-2">
              <a href="{{ url_for('notes.upload') }}" class="btn btn-primary btn-sm">
                <i class="bi bi-plus-circle"></i> Subir Apunte
              </a>
              <a href="{{ url_for('forum.ask_question') if 'forum.ask_question' in url_for.__globals__.get('current_app', {}).view_functions else '/foro/hacer-pregunta' }}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-question-circle"></i> Hacer Pregunta
              </a>
              <a href="{{ url_for('club.list_clubs') }}" class="btn btn-outline-success btn-sm">
                <i class="bi bi-people"></i> Buscar Clubes
              </a>
              <a href="{{ url_for('commerce.commerce_index') if 'commerce.commerce_index' in url_for.__globals__.get('current_app', {}).view_functions else '/tienda' }}" class="btn btn-outline-warning btn-sm">
                <i class="bi bi-shop"></i> Tienda
              </a>
              <a href="{{ url_for('personal_space.index') }}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-house-gear"></i>
                Mi Espacio Personal
              </a>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>



<script>
// Initialize profile stats chart and tabs
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Chart.js if available
  const ctx = document.getElementById('profileStatsChart');
  if (ctx && typeof Chart !== 'undefined') {
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Apuntes', 'Comentarios', 'Misiones', 'Clubes'],
        datasets: [{
          data: [{{ user_notes|length }}, {{ user.comments|length }}, {{ completed_missions_count }}, {{ user_clubs|length }}],
          backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              boxWidth: 12,
              font: {
                size: 10
              }
            }
          }
        }
      }
    });
  }

  // Initialize Bootstrap tabs
  const triggerTabList = document.querySelectorAll('#profileTabs button[data-bs-toggle="tab"]');
  triggerTabList.forEach(triggerEl => {
    const tabTrigger = new bootstrap.Tab(triggerEl);
    
    triggerEl.addEventListener('click', event => {
      event.preventDefault();
      tabTrigger.show();
      
      // Update URL with tab parameter
      const tab = triggerEl.getAttribute('data-bs-target').replace('#', '');
      const url = new URL(window.location);
      url.searchParams.set('tab', tab);
      window.history.replaceState({}, '', url);
    });
  });

  // Activate tab based on URL parameter
  const urlParams = new URLSearchParams(window.location.search);
  const activeTab = urlParams.get('tab');
  if (activeTab) {
    const tabButton = document.querySelector(`#profileTabs button[data-bs-target="#${activeTab}"]`);
    if (tabButton) {
      const tab = new bootstrap.Tab(tabButton);
      tab.show();
    }
  }
});
</script>
{% endblock %}