{% extends "base.html" %}
{% block title %}Feed Social - Crunevo{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-100 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">Feed Social del Foro</h1>
            <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                Mantente al día con las últimas actividades de la comunidad
            </p>
        </div>

        <!-- Activity Filters -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex flex-wrap gap-2">
                <button onclick="filterActivities('all')" 
                        class="activity-filter active px-4 py-2 rounded-full text-sm font-medium transition-colors"
                        data-filter="all">
                    Todas las actividades
                </button>
                <button onclick="filterActivities('questions')" 
                        class="activity-filter px-4 py-2 rounded-full text-sm font-medium transition-colors"
                        data-filter="questions">
                    <i class="fas fa-question-circle mr-1"></i>
                    Nuevas preguntas
                </button>
                <button onclick="filterActivities('answers')" 
                        class="activity-filter px-4 py-2 rounded-full text-sm font-medium transition-colors"
                        data-filter="answers">
                    <i class="fas fa-reply mr-1"></i>
                    Respuestas
                </button>
                <button onclick="filterActivities('accepted')" 
                        class="activity-filter px-4 py-2 rounded-full text-sm font-medium transition-colors"
                        data-filter="accepted">
                    <i class="fas fa-check-circle mr-1"></i>
                    Respuestas aceptadas
                </button>
                <button onclick="filterActivities('achievements')" 
                        class="activity-filter px-4 py-2 rounded-full text-sm font-medium transition-colors"
                        data-filter="achievements">
                    <i class="fas fa-trophy mr-1"></i>
                    Logros
                </button>
            </div>
        </div>

        <!-- Activity Feed -->
        <div class="space-y-6">
            {% for activity in activities %}
            <div class="activity-item bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow" 
                 data-type="{{ activity.type }}">
                
                {% if activity.type == 'new_question' %}
                <!-- New Question Activity -->
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-question-circle text-blue-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-2">
                            <img src="{{ activity.user.avatar_url or '/static/images/default-avatar.png' }}" 
                                 alt="{{ activity.user.username }}" 
                                 class="w-8 h-8 rounded-full">
                            <span class="font-semibold text-gray-900">{{ activity.user.username }}</span>
                            <span class="text-gray-500">hizo una nueva pregunta</span>
                            <span class="text-sm text-gray-400">{{ activity.created_at|timeago }}</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">
                            <a href="{{ url_for('forum.view_question', question_id=activity.question.id) }}" 
                               class="hover:text-blue-600 transition-colors">
                                {{ activity.question.title }}
                            </a>
                        </h3>
                        <p class="text-gray-600 mb-3 line-clamp-2">{{ activity.question.content[:150] }}...</p>
                        <div class="flex items-center space-x-4 text-sm text-gray-500">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                                {{ activity.question.category|title }}
                            </span>
                            <span class="flex items-center">
                                <i class="fas fa-eye mr-1"></i>
                                {{ activity.question.views }} vistas
                            </span>
                            <span class="flex items-center">
                                <i class="fas fa-reply mr-1"></i>
                                {{ activity.question.answers|length }} respuestas
                            </span>
                        </div>
                    </div>
                </div>
                
                {% elif activity.type == 'new_answer' %}
                <!-- New Answer Activity -->
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-reply text-green-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-2">
                            <img src="{{ activity.user.avatar_url or '/static/images/default-avatar.png' }}" 
                                 alt="{{ activity.user.username }}" 
                                 class="w-8 h-8 rounded-full">
                            <span class="font-semibold text-gray-900">{{ activity.user.username }}</span>
                            <span class="text-gray-500">respondió a</span>
                            <span class="text-sm text-gray-400">{{ activity.created_at|timeago }}</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">
                            <a href="{{ url_for('forum.view_question', question_id=activity.question.id) }}" 
                               class="hover:text-blue-600 transition-colors">
                                {{ activity.question.title }}
                            </a>
                        </h3>
                        <div class="bg-gray-50 rounded-lg p-4 mb-3">
                            <p class="text-gray-700 line-clamp-3">{{ activity.answer.content[:200] }}...</p>
                        </div>
                        <div class="flex items-center space-x-4 text-sm text-gray-500">
                            <span class="flex items-center">
                                <i class="fas fa-thumbs-up mr-1"></i>
                                {{ activity.answer.votes }} votos
                            </span>
                            <span class="flex items-center">
                                <i class="fas fa-heart mr-1"></i>
                                {{ activity.answer.helpful_count }} útil
                            </span>
                        </div>
                    </div>
                </div>
                
                {% elif activity.type == 'accepted_answer' %}
                <!-- Accepted Answer Activity -->
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-check-circle text-yellow-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-2">
                            <img src="{{ activity.answer.author.avatar_url or '/static/images/default-avatar.png' }}" 
                                 alt="{{ activity.answer.author.username }}" 
                                 class="w-8 h-8 rounded-full">
                            <span class="font-semibold text-gray-900">{{ activity.answer.author.username }}</span>
                            <span class="text-gray-500">tuvo su respuesta aceptada</span>
                            <span class="text-sm text-gray-400">{{ activity.created_at|timeago }}</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">
                            <a href="{{ url_for('forum.view_question', question_id=activity.question.id) }}" 
                               class="hover:text-blue-600 transition-colors">
                                {{ activity.question.title }}
                            </a>
                        </h3>
                        <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-3">
                            <p class="text-gray-700 line-clamp-3">{{ activity.answer.content[:200] }}...</p>
                        </div>
                        <div class="flex items-center space-x-4 text-sm text-gray-500">
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full flex items-center">
                                <i class="fas fa-check mr-1"></i>
                                Respuesta aceptada
                            </span>
                            <span class="flex items-center">
                                <i class="fas fa-coins mr-1"></i>
                                +{{ activity.crolars_earned or 50 }} Crolars
                            </span>
                        </div>
                    </div>
                </div>
                
                {% elif activity.type == 'achievement' %}
                <!-- Achievement Activity -->
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-trophy text-purple-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-2">
                            <img src="{{ activity.user.avatar_url or '/static/images/default-avatar.png' }}" 
                                 alt="{{ activity.user.username }}" 
                                 class="w-8 h-8 rounded-full">
                            <span class="font-semibold text-gray-900">{{ activity.user.username }}</span>
                            <span class="text-gray-500">desbloqueó un logro</span>
                            <span class="text-sm text-gray-400">{{ activity.created_at|timeago }}</span>
                        </div>
                        <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <div class="text-3xl">{{ activity.achievement.icon or '🏆' }}</div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">{{ activity.achievement.title }}</h3>
                                    <p class="text-gray-600">{{ activity.achievement.description }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% elif activity.type == 'level_up' %}
                <!-- Level Up Activity -->
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-arrow-up text-indigo-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-2">
                            <img src="{{ activity.user.avatar_url or '/static/images/default-avatar.png' }}" 
                                 alt="{{ activity.user.username }}" 
                                 class="w-8 h-8 rounded-full">
                            <span class="font-semibold text-gray-900">{{ activity.user.username }}</span>
                            <span class="text-gray-500">subió de nivel</span>
                            <span class="text-sm text-gray-400">{{ activity.created_at|timeago }}</span>
                        </div>
                        <div class="bg-gradient-to-r from-indigo-100 to-blue-100 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">¡Nivel {{ activity.new_level }}!</h3>
                                    <p class="text-gray-600">Continúa así para seguir creciendo en la comunidad</p>
                                </div>
                                <div class="text-4xl font-bold text-indigo-600">{{ activity.new_level }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Load More Button -->
        {% if has_more %}
        <div class="text-center mt-8">
            <button onclick="loadMoreActivities()" 
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                Cargar más actividades
            </button>
        </div>
        {% endif %}

        <!-- Empty State -->
        {% if not activities %}
        <div class="text-center py-12">
            <div class="text-6xl text-gray-300 mb-4">📱</div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">No hay actividades recientes</h3>
            <p class="text-gray-600 mb-6">¡Sé el primero en participar en el foro!</p>
            <a href="{{ url_for('forum.ask_question') }}" 
               class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                Hacer una pregunta
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
let currentFilter = 'all';
let currentPage = 1;

function filterActivities(filter) {
    currentFilter = filter;
    
    // Update active filter button
    document.querySelectorAll('.activity-filter').forEach(btn => {
        btn.classList.remove('active', 'bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
    });
    
    const activeBtn = document.querySelector(`[data-filter="${filter}"]`);
    activeBtn.classList.add('active', 'bg-blue-600', 'text-white');
    activeBtn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
    
    // Filter activities
    document.querySelectorAll('.activity-item').forEach(item => {
        const itemType = item.dataset.type;
        if (filter === 'all' || itemType === filter) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function loadMoreActivities() {
    currentPage++;
    // Implementation for loading more activities via AJAX
    fetch(`{{ url_for('social.social_feed') }}?page=${currentPage}&filter=${currentFilter}`)
        .then(response => response.json())
        .then(data => {
            // Append new activities to the feed
            // This would require the backend to return JSON data
        })
        .catch(error => {
            console.error('Error loading more activities:', error);
        });
}

// Initialize filter styles
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.activity-filter').forEach(btn => {
        if (!btn.classList.contains('active')) {
            btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
        } else {
            btn.classList.add('bg-blue-600', 'text-white');
        }
    });
});
</script>

<style>
.activity-filter.active {
    background-color: #2563EB;
    color: white;
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}