
{% extends 'base.html' %}

{% block title %}Marketplace CRUNEVO{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/store.css') }}">
<style>
/* Modern Marketplace Layout */
.marketplace-hero {
  background: linear-gradient(135deg, #6366F1 0%, #10B981 100%);
  color: white;
  padding: 3rem 0;
  margin-bottom: 2rem;
}

.marketplace-hero h1 {
  font-family: 'Poppins', sans-serif;
  font-weight: 700;
  font-size: 2.5rem;
  margin-bottom: 1rem;
}

.marketplace-hero p {
  font-family: 'Inter', sans-serif;
  font-size: 1.1rem;
  opacity: 0.9;
}

/* Grid System */
@media (max-width: 575.98px) {
  .product-grid {
    --bs-gutter-x: 0.5rem;
  }
  .product-grid .col {
    flex: 0 0 auto;
    width: 50%;
  }
}

@media (min-width: 576px) {
  .product-grid .col {
    flex: 0 0 auto;
    width: 33.33333333%;
  }
}

@media (min-width: 768px) {
  .product-grid .col {
    flex: 0 0 auto;
    width: 25%;
  }
}

@media (min-width: 992px) {
  .product-grid .col {
    flex: 0 0 auto;
    width: 20%;
  }
}

/* Sidebar Filters */
.filter-sidebar {
  background: #ffffff;
  border-radius: 0.75rem;
  padding: 1.5rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  position: sticky;
  top: 100px;
}

.filter-section {
  margin-bottom: 2rem;
}

.filter-title {
  font-size: 0.9rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: #1E293B;
  margin-bottom: 0.75rem;
}

.filter-checkbox {
  margin-bottom: 0.5rem;
}

.filter-checkbox input[type="checkbox"] {
  margin-right: 0.5rem;
}

.price-range {
  margin-bottom: 1rem;
}

.btn-apply-filters {
  background: linear-gradient(135deg, #6366F1, #8B5CF6);
  border: none;
  border-radius: 0.75rem;
  padding: 0.75rem 1.5rem;
  font-weight: 600;
  color: white;
  width: 100%;
  transition: all 0.2s ease;
}

.btn-apply-filters:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

/* Product Cards */
.product-card {
  background: white;
  border: none;
  border-radius: 0.75rem;
  overflow: hidden;
  transition: all 0.2s ease-in-out;
  height: 100%;
  min-height: 320px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.product-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 16px rgba(0,0,0,0.12);
}

.product-image-container {
  position: relative;
  aspect-ratio: 4/3;
  overflow: hidden;
  border-radius: 0.5rem 0.5rem 0 0;
}

.product-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.product-card:hover .product-image {
  transform: scale(1.05);
}

.product-badge {
  position: absolute;
  top: 12px;
  left: 12px;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  z-index: 2;
}

.badge-new {
  background: linear-gradient(135deg, #10B981, #059669);
  color: white;
}

.badge-popular {
  background: linear-gradient(135deg, #EF4444, #DC2626);
  color: white;
}

.badge-offer {
  background: linear-gradient(135deg, #F59E0B, #EAB308);
  color: white;
}

.product-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.product-card:hover .product-overlay {
  opacity: 1;
}

.product-info {
  padding: 1rem;
}

.product-title {
  font-size: 0.95rem;
  font-weight: 600;
  color: #1E293B;
  margin-bottom: 0.5rem;
  line-height: 1.3;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.product-price {
  font-size: 1.1rem;
  font-weight: 700;
  color: #10B981;
  margin-bottom: 0.5rem;
}

.product-rating {
  display: flex;
  align-items: center;
  margin-bottom: 0.75rem;
}

.product-rating .stars {
  color: #F59E0B;
  margin-right: 0.5rem;
}

.product-rating .rating-count {
  font-size: 0.8rem;
  color: #64748B;
}

.product-actions {
  display: flex;
  gap: 0.5rem;
}

.btn-quick-view {
  flex: 1;
  background: #6366F1;
  border: none;
  border-radius: 0.5rem;
  padding: 0.5rem;
  color: white;
  font-size: 0.85rem;
  font-weight: 600;
  transition: all 0.2s ease;
}

.btn-quick-view:hover {
  background: #5855EB;
  color: white;
}

.btn-add-cart {
  background: #10B981;
  border: none;
  border-radius: 0.5rem;
  padding: 0.5rem 0.75rem;
  color: white;
  transition: all 0.2s ease;
}

.btn-add-cart:hover {
  background: #059669;
  color: white;
}

/* Featured Products */
.featured-section {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(16, 185, 129, 0.05));
  border-radius: 1rem;
  padding: 2rem;
  margin-bottom: 3rem;
}

.featured-carousel {
  display: flex;
  gap: 1rem;
  overflow-x: auto;
  padding-bottom: 1rem;
  scrollbar-width: thin;
  scrollbar-color: #6366F1 transparent;
}

.featured-card {
  min-width: 200px;
  flex-shrink: 0;
}

/* Category Filters */
.category-filters {
  background: white;
  border-radius: 1rem;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.category-btn {
  background: transparent;
  border: 2px solid #E2E8F0;
  border-radius: 2rem;
  padding: 0.5rem 1rem;
  margin: 0.25rem;
  color: #64748B;
  font-weight: 500;
  transition: all 0.2s ease;
}

.category-btn:hover,
.category-btn.active {
  background: #6366F1;
  border-color: #6366F1;
  color: white;
}

/* Mobile Responsiveness */
@media (max-width: 991.98px) {
  .filter-sidebar {
    display: none;
  }
  
  .mobile-filter-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    background: #6366F1;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    color: white;
    font-size: 1.2rem;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
  }
}

/* Request Product Floating Button */
.btn-request-product {
  position: fixed;
  bottom: 24px;
  left: 24px;
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, #F59E0B, #EAB308);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 1.5rem;
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
  z-index: 999;
  transition: all 0.2s ease;
}

.btn-request-product:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
}

/* Loading States */
.loading-spinner {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 3rem;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #E2E8F0;
  border-top: 4px solid #6366F1;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Dark Mode Support */
[data-bs-theme="dark"] .product-card {
  background: #334155;
  border: 1px solid #475569;
}

[data-bs-theme="dark"] .product-title {
  color: #F1F5F9;
}

[data-bs-theme="dark"] .filter-sidebar {
  background: #334155;
  border: 1px solid #475569;
}

[data-bs-theme="dark"] .filter-title {
  color: #F1F5F9;
}

[data-bs-theme="dark"] .category-filters {
  background: #334155;
  border: 1px solid #475569;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Hero Section -->
  <div class="marketplace-hero">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <h1>üõçÔ∏è Marketplace CRUNEVO</h1>
          <p class="lead">Descubre recursos educativos, plantillas, cursos y m√°s para potenciar tu aprendizaje</p>
        </div>
        <div class="col-lg-4 text-end">
          <div class="d-flex align-items-center justify-content-end">
            <i class="bi bi-coin me-2 fs-3"></i>
            <span class="fs-4 fw-bold">{{ current_user.credits }} Crolars</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid px-3">
    <div class="row g-4">
      <!-- Desktop Sidebar Filters -->
      <div class="col-lg-3 d-none d-lg-block">
        <div class="filter-sidebar">
          <form id="filterForm">
            <!-- Categories -->
            <div class="filter-section">
              <h6 class="filter-title">Categor√≠as</h6>
              {% for category in categories %}
              <div class="filter-checkbox">
                <input type="checkbox" name="categories" value="{{ category }}" id="cat-{{ loop.index }}">
                <label for="cat-{{ loop.index }}">{{ category }}</label>
              </div>
              {% endfor %}
            </div>

            <!-- Price Range -->
            <div class="filter-section">
              <h6 class="filter-title">Rango de Precio</h6>
              <div class="price-range">
                <label for="priceRange" class="form-label">Hasta {{ max_price or 100 }} Crolars</label>
                <input type="range" class="form-range" id="priceRange" min="0" max="{{ max_price or 100 }}" value="{{ max_price or 100 }}">
                <div class="d-flex justify-content-between">
                  <small>0</small>
                  <small>{{ max_price or 100 }}</small>
                </div>
              </div>
            </div>

            <!-- Tags -->
            <div class="filter-section">
              <h6 class="filter-title">Etiquetas</h6>
              <div class="filter-checkbox">
                <input type="checkbox" name="tags" value="premium" id="tag-premium">
                <label for="tag-premium">‚≠ê Premium</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" name="tags" value="offers" id="tag-offers">
                <label for="tag-offers">üî• Ofertas</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" name="tags" value="digital" id="tag-digital">
                <label for="tag-digital">üíª Digital</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" name="tags" value="physical" id="tag-physical">
                <label for="tag-physical">üì¶ F√≠sico</label>
              </div>
            </div>

            <!-- Stock -->
            <div class="filter-section">
              <h6 class="filter-title">Stock</h6>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="onlyAvailable">
                <label class="form-check-label" for="onlyAvailable">
                  Solo disponibles
                </label>
              </div>
            </div>

            <button type="submit" class="btn-apply-filters">
              <i class="bi bi-funnel me-2"></i>Aplicar Filtros
            </button>
          </form>
        </div>
      </div>

      <!-- Main Content -->
      <div class="col-lg-9">
        <!-- Featured Products -->
        {% if featured_products %}
        <div class="featured-section">
          <h3 class="fw-bold mb-3">‚≠ê Productos Destacados</h3>
          <div class="featured-carousel">
            {% for product in featured_products %}
            <div class="featured-card">
              <div class="card product-card">
                <div class="product-image-container">
                  <img src="{{ product.first_image or url_for('static', filename='img/default_product.png') }}" 
                       class="product-image" alt="{{ product.name }}">
                  {% if product.is_new %}
                  <div class="product-badge badge-new">NUEVO</div>
                  {% elif product.is_popular %}
                  <div class="product-badge badge-popular">POPULAR</div>
                  {% endif %}
                </div>
                <div class="product-info">
                  <h6 class="product-title">{{ product.name }}</h6>
                  <div class="product-price">
                    {% if product.price_credits %}
                      {{ product.price_credits }} Crolars
                    {% else %}
                      S/ {{ product.price }}
                    {% endif %}
                  </div>
                  <button class="btn btn-quick-view w-100" onclick="viewProduct({{ product.id }})">
                    Ver Producto
                  </button>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Category Filters -->
        <div class="category-filters">
          <h5 class="fw-bold mb-3">Explorar por Categor√≠a</h5>
          <div class="d-flex flex-wrap">
            <button class="category-btn active" data-category="all">
              <i class="bi bi-grid me-1"></i>Todos
            </button>
            <button class="category-btn" data-category="education">
              <i class="bi bi-book me-1"></i>Educaci√≥n
            </button>
            <button class="category-btn" data-category="technology">
              <i class="bi bi-laptop me-1"></i>Tecnolog√≠a
            </button>
            <button class="category-btn" data-category="templates">
              <i class="bi bi-file-earmark me-1"></i>Plantillas
            </button>
            <button class="category-btn" data-category="courses">
              <i class="bi bi-play-circle me-1"></i>Cursos
            </button>
            <button class="category-btn" data-category="premium">
              <i class="bi bi-star me-1"></i>Premium
            </button>
          </div>
        </div>

        <!-- Products Grid -->
        <div class="row product-grid g-3" id="productsGrid">
          {% for product in products %}
          <div class="col product-item" 
               data-category="{{ product.category or 'education' }}"
               data-price="{{ product.price_credits or product.price }}"
               data-stock="{{ product.stock }}">
            <div class="card product-card">
              <div class="product-image-container">
                <img src="{{ product.first_image or url_for('static', filename='img/default_product.png') }}" 
                     class="product-image" alt="{{ product.name }}">
                
                {% if product.is_new %}
                <div class="product-badge badge-new">NUEVO</div>
                {% elif product.is_popular %}
                <div class="product-badge badge-popular">POPULAR</div>
                {% elif product.discount_percent %}
                <div class="product-badge badge-offer">-{{ product.discount_percent }}%</div>
                {% endif %}

                <div class="product-overlay">
                  <button class="btn btn-light btn-sm" onclick="viewProduct({{ product.id }})">
                    <i class="bi bi-eye me-1"></i>Ver Detalles
                  </button>
                </div>
              </div>

              <div class="product-info">
                <h6 class="product-title">{{ product.name }}</h6>
                
                {% if ratings.get(product.id) %}
                <div class="product-rating">
                  <div class="stars">
                    {% for i in range(5) %}
                      {% if i < ratings[product.id]|round %}
                        <i class="bi bi-star-fill"></i>
                      {% else %}
                        <i class="bi bi-star"></i>
                      {% endif %}
                    {% endfor %}
                  </div>
                  <span class="rating-count">({{ product.review_count or 0 }})</span>
                </div>
                {% endif %}

                <div class="product-price">
                  {% if product.price_credits %}
                    {{ product.price_credits }} Crolars
                  {% else %}
                    S/ {{ product.price }}
                  {% endif %}
                </div>

                {% if product.stock < 1 %}
                <div class="alert alert-warning py-1 px-2 small mb-2">
                  Sin stock
                </div>
                {% elif product.stock < 5 %}
                <div class="alert alert-info py-1 px-2 small mb-2">
                  √öltimas {{ product.stock }} unidades
                </div>
                {% endif %}

                <div class="product-actions">
                  <button class="btn-quick-view" onclick="viewProduct({{ product.id }})">
                    Ver Producto
                  </button>
                  {% if product.stock > 0 and product.id not in purchased_ids %}
                  <button class="btn-add-cart" onclick="addToCart({{ product.id }})">
                    <i class="bi bi-cart-plus"></i>
                  </button>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- Load More -->
        <div class="text-center mt-4">
          <button class="btn btn-outline-primary btn-lg" id="loadMore" style="display: none;">
            <i class="bi bi-arrow-down-circle me-2"></i>Cargar M√°s Productos
          </button>
        </div>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner" style="display: none;">
          <div class="spinner"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mobile Filter Button -->
<button class="mobile-filter-btn d-lg-none" data-bs-toggle="offcanvas" data-bs-target="#mobileFilters">
  <i class="bi bi-funnel"></i>
</button>

<!-- Request Product Button -->
<button class="btn-request-product" data-bs-toggle="modal" data-bs-target="#requestProductModal">
  <i class="bi bi-plus-lg"></i>
</button>

<!-- Mobile Filters Offcanvas -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="mobileFilters">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Filtros</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <!-- Same filter content as sidebar -->
    <form id="mobileFilterForm">
      <!-- Categories -->
      <div class="filter-section">
        <h6 class="filter-title">Categor√≠as</h6>
        {% for category in categories %}
        <div class="filter-checkbox">
          <input type="checkbox" name="categories" value="{{ category }}" id="mobile-cat-{{ loop.index }}">
          <label for="mobile-cat-{{ loop.index }}">{{ category }}</label>
        </div>
        {% endfor %}
      </div>

      <!-- Price Range -->
      <div class="filter-section">
        <h6 class="filter-title">Rango de Precio</h6>
        <div class="price-range">
          <label for="mobilePriceRange" class="form-label">Hasta {{ max_price or 100 }} Crolars</label>
          <input type="range" class="form-range" id="mobilePriceRange" min="0" max="{{ max_price or 100 }}" value="{{ max_price or 100 }}">
        </div>
      </div>

      <button type="submit" class="btn-apply-filters">
        <i class="bi bi-funnel me-2"></i>Aplicar Filtros
      </button>
    </form>
  </div>
</div>

<!-- Request Product Modal -->
<div class="modal fade" id="requestProductModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle me-2"></i>Solicitar Producto
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="requestProductForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="productName" class="form-label">Nombre del Producto</label>
              <input type="text" class="form-control" id="productName" required>
            </div>
            <div class="col-md-6">
              <label for="productCategory" class="form-label">Categor√≠a</label>
              <select class="form-select" id="productCategory" required>
                <option value="">Seleccionar...</option>
                <option value="education">Educaci√≥n</option>
                <option value="technology">Tecnolog√≠a</option>
                <option value="templates">Plantillas</option>
                <option value="courses">Cursos</option>
              </select>
            </div>
            <div class="col-12">
              <label for="productDescription" class="form-label">Descripci√≥n</label>
              <textarea class="form-control" id="productDescription" rows="3" required></textarea>
            </div>
            <div class="col-md-6">
              <label for="productImage" class="form-label">Imagen (opcional)</label>
              <input type="file" class="form-control" id="productImage" accept="image/*">
            </div>
            <div class="col-md-6">
              <label for="suggestedPrice" class="form-label">Precio Sugerido (Crolars)</label>
              <input type="number" class="form-control" id="suggestedPrice" min="0">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="submitProductRequest()">
          <i class="bi bi-send me-2"></i>Enviar Solicitud
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Enhanced marketplace functionality
document.addEventListener('DOMContentLoaded', function() {
  initializeMarketplace();
});

function initializeMarketplace() {
  // Category filtering
  const categoryBtns = document.querySelectorAll('.category-btn');
  const productItems = document.querySelectorAll('.product-item');

  categoryBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      // Update active state
      categoryBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Filter products
      const category = btn.dataset.category;
      filterProducts(category);
    });
  });

  // Filter form submission
  document.getElementById('filterForm')?.addEventListener('submit', handleFilterSubmit);
  document.getElementById('mobileFilterForm')?.addEventListener('submit', handleFilterSubmit);

  // Price range updates
  document.getElementById('priceRange')?.addEventListener('input', updatePriceDisplay);
  document.getElementById('mobilePriceRange')?.addEventListener('input', updatePriceDisplay);
}

function filterProducts(category) {
  const productItems = document.querySelectorAll('.product-item');
  
  productItems.forEach(item => {
    const itemCategory = item.dataset.category;
    const show = category === 'all' || itemCategory === category;
    
    if (show) {
      item.style.display = 'block';
      item.style.animation = 'fadeInUp 0.5s ease';
    } else {
      item.style.display = 'none';
    }
  });
}

function handleFilterSubmit(e) {
  e.preventDefault();
  
  // Collect filter values
  const formData = new FormData(e.target);
  const filters = {
    categories: formData.getAll('categories'),
    tags: formData.getAll('tags'),
    priceMax: document.getElementById('priceRange')?.value || document.getElementById('mobilePriceRange')?.value,
    onlyAvailable: formData.get('onlyAvailable') === 'on'
  };

  // Apply filters
  applyFilters(filters);
  
  // Close mobile offcanvas if open
  const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('mobileFilters'));
  if (offcanvas) {
    offcanvas.hide();
  }
}

function applyFilters(filters) {
  const productItems = document.querySelectorAll('.product-item');
  
  productItems.forEach(item => {
    let show = true;
    
    // Category filter
    if (filters.categories.length > 0) {
      const itemCategory = item.dataset.category;
      show = show && filters.categories.includes(itemCategory);
    }
    
    // Price filter
    if (filters.priceMax) {
      const itemPrice = parseFloat(item.dataset.price) || 0;
      show = show && itemPrice <= parseFloat(filters.priceMax);
    }
    
    // Stock filter
    if (filters.onlyAvailable) {
      const itemStock = parseInt(item.dataset.stock) || 0;
      show = show && itemStock > 0;
    }
    
    // Apply visibility
    item.style.display = show ? 'block' : 'none';
    if (show) {
      item.style.animation = 'fadeInUp 0.5s ease';
    }
  });
}

function updatePriceDisplay(e) {
  const value = e.target.value;
  const label = e.target.previousElementSibling;
  if (label) {
    label.textContent = `Hasta ${value} Crolars`;
  }
}

function viewProduct(productId) {
  window.location.href = `/store/product/${productId}`;
}

function addToCart(productId) {
  fetch(`/store/add/${productId}`, {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.count !== undefined) {
      showToast('Producto agregado al carrito', 'success');
      updateCartBadge(data.count);
    } else {
      showToast('Error al agregar al carrito', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Error de conexi√≥n', 'error');
  });
}

function submitProductRequest() {
  const form = document.getElementById('requestProductForm');
  const formData = new FormData(form);
  
  // Show loading state
  const submitBtn = event.target;
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Enviando...';
  submitBtn.disabled = true;

  // Simulate API call (replace with actual endpoint)
  setTimeout(() => {
    showToast('Solicitud enviada correctamente', 'success');
    
    // Reset form and close modal
    form.reset();
    bootstrap.Modal.getInstance(document.getElementById('requestProductModal')).hide();
    
    // Reset button
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  }, 1500);
}

function showToast(message, type = 'info') {
  // Create toast element if it doesn't exist
  let toastContainer = document.getElementById('toast-container');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.id = 'toast-container';
    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
    toastContainer.style.zIndex = '9999';
    document.body.appendChild(toastContainer);
  }

  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'} border-0`;
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">
        <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
        ${message}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;

  toastContainer.appendChild(toast);
  const bsToast = new bootstrap.Toast(toast);
  bsToast.show();

  // Remove toast after it's hidden
  toast.addEventListener('hidden.bs.toast', () => {
    toast.remove();
  });
}

function updateCartBadge(count) {
  const badge = document.querySelector('.cart-badge');
  if (badge) {
    badge.textContent = count;
    badge.style.display = count > 0 ? 'inline' : 'none';
  }
}

// Infinite scroll (if needed)
let isLoading = false;
let page = 1;

window.addEventListener('scroll', () => {
  if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000 && !isLoading) {
    loadMoreProducts();
  }
});

function loadMoreProducts() {
  if (isLoading) return;
  
  isLoading = true;
  page++;
  
  const spinner = document.getElementById('loadingSpinner');
  if (spinner) spinner.style.display = 'block';

  // Simulate API call for more products
  setTimeout(() => {
    // Add new products to grid
    const grid = document.getElementById('productsGrid');
    
    // Reset loading state
    isLoading = false;
    if (spinner) spinner.style.display = 'none';
  }, 1000);
}
</script>
{% endblock %}
