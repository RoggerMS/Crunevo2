
{% extends "base.html" %}

{% block title %}Tienda - Crunevo{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-lg-5">
  <!-- Store Header -->
  <div class="store-header">
    <h1 class="store-title display-5">
      <i class="bi bi-shop me-2"></i>
      Tienda Crunevo
    </h1>
    <p class="store-subtitle">Intercambia tus Crolars por increíbles productos educativos</p>
    <div class="d-flex justify-content-center align-items-center gap-3 mt-3">
      <div class="d-flex align-items-center gap-2">
        <i class="bi bi-coin text-warning fs-4"></i>
        <span class="fw-bold fs-5">{{ current_user.credits if current_user.is_authenticated else 0 }} Crolars</span>
      </div>
      {% if current_user.is_authenticated %}
      <a href="{{ url_for('store.view_cart') }}" class="btn btn-outline-primary">
        <i class="bi bi-cart"></i>
        Carrito
        <span class="badge cart-badge ms-1">{{ cart_count or 0 }}</span>
      </a>
      {% endif %}
    </div>
  </div>

  <!-- Category Filters -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex flex-wrap justify-content-center gap-2">
        <button class="category-filter active" data-category="all">
          <i class="bi bi-grid"></i> Todos
        </button>
        <button class="category-filter" data-category="libros">
          <i class="bi bi-book"></i> Libros
        </button>
        <button class="category-filter" data-category="papeleria">
          <i class="bi bi-pencil"></i> Papelería
        </button>
        <button class="category-filter" data-category="tecnologia">
          <i class="bi bi-laptop"></i> Tecnología
        </button>
        <button class="category-filter" data-category="accesorios">
          <i class="bi bi-bag"></i> Accesorios
        </button>
      </div>
    </div>
  </div>

  <!-- Featured Products -->
  {% if featured_products %}
  <div class="row mb-5">
    <div class="col-12">
      <h3 class="mb-3 text-center">
        <i class="bi bi-star-fill text-warning me-2"></i>
        Productos Destacados
      </h3>
      <div class="d-flex gap-3 overflow-auto pb-3" style="scroll-snap-type: x mandatory;">
        {% for product in featured_products %}
        <div class="featured-card flex-shrink-0" style="scroll-snap-align: start;">
          <a href="{{ url_for('store.product_detail', id=product.id) }}" class="text-decoration-none">
            <img src="{{ product.image_url or url_for('static', filename='img/default_product.png') }}" 
                 class="card-img-top" alt="{{ product.name }}" loading="lazy">
            <div class="p-2">
              <div class="featured-title">{{ product.name }}</div>
              <div class="text-center">
                <span class="product-price">{{ product.price }} <i class="bi bi-coin text-warning"></i></span>
              </div>
            </div>
          </a>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Products Grid -->
  <div class="row" id="productsContainer">
    {% if products %}
      {% for product in products %}
      <div class="col-lg-3 col-md-4 col-sm-6 col-12 mb-4 product-item" data-category="{{ product.category or 'general' }}">
        <div class="card product-card h-100">
          <a href="{{ url_for('store.product_detail', id=product.id) }}" class="text-decoration-none">
            <img src="{{ product.image_url or url_for('static', filename='img/default_product.png') }}" 
                 class="card-img-top" alt="{{ product.name }}" loading="lazy"
                 style="height: 200px; object-fit: cover;">
          </a>
          <div class="card-body d-flex flex-column">
            <h5 class="product-name mb-2">
              <a href="{{ url_for('store.product_detail', id=product.id) }}" 
                 class="text-decoration-none">{{ product.name }}</a>
            </h5>
            <p class="product-desc text-muted flex-grow-1">{{ product.description or 'Sin descripción disponible' }}</p>
            
            <div class="mt-auto">
              <div class="product-price mb-3">
                {{ product.price }} <i class="bi bi-coin text-warning"></i>
              </div>
              
              {% if current_user.is_authenticated %}
                {% if current_user.credits >= product.price %}
                  <button class="btn-add-cart" 
                          onclick="addToCart({{ product.id }}, '{{ product.name }}', {{ product.price }})"
                          data-product-id="{{ product.id }}">
                    <i class="bi bi-cart-plus me-1"></i>
                    Agregar
                  </button>
                {% else %}
                  <button class="btn-add-cart" disabled>
                    <i class="bi bi-coin me-1"></i>
                    Insuficientes Crolars
                  </button>
                {% endif %}
              {% else %}
                <a href="{{ url_for('auth.login') }}" class="btn-add-cart text-decoration-none d-block text-center">
                  <i class="bi bi-box-arrow-in-right me-1"></i>
                  Inicia Sesión
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="col-12">
        <div class="empty-state">
          <i class="bi bi-shop"></i>
          <h3>¡Pronto tendremos productos increíbles!</h3>
          <p>Nuestro equipo está trabajando para traerte los mejores productos educativos.</p>
          {% if current_user.is_authenticated and (current_user.is_admin or current_user.is_moderator) %}
            <a href="{{ url_for('admin.manage_store') }}" class="btn btn-primary">
              Agregar Productos
            </a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Load More Button -->
  {% if products and products|length >= 12 %}
  <div class="row">
    <div class="col-12 text-center">
      <button id="loadMoreBtn" class="btn btn-outline-primary">
        <i class="bi bi-arrow-down-circle"></i>
        Cargar más productos
      </button>
    </div>
  </div>
  {% endif %}
</div>

<!-- Cart Added Modal -->
<div class="modal fade" id="cartAddedModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title">
          <i class="bi bi-check-circle-fill text-success me-2"></i>
          ¡Agregado al carrito!
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <div id="cartModalContent"></div>
        <div class="mt-3">
          <button type="button" class="btn btn-outline-primary me-2" data-bs-dismiss="modal">
            Seguir comprando
          </button>
          <a href="{{ url_for('store.view_cart') }}" class="btn btn-primary">
            <i class="bi bi-cart"></i> Ver carrito
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block body_end %}
<script>
// Add to cart functionality
function addToCart(productId, productName, productPrice) {
    const button = document.querySelector(`[data-product-id="${productId}"]`);
    const originalContent = button.innerHTML;
    
    // Show loading state
    button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Agregando...';
    button.disabled = true;
    
    fetch('/store/add-to-cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        },
        body: JSON.stringify({
            product_id: productId,
            quantity: 1
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update cart count
            updateCartCount(data.cart_count);
            
            // Show success modal
            document.getElementById('cartModalContent').innerHTML = `
                <div class="d-flex align-items-center justify-content-center gap-3 mb-3">
                    <div class="bg-success rounded-circle p-2">
                        <i class="bi bi-check text-white fs-4"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">${productName}</h6>
                        <small class="text-muted">${productPrice} Crolars</small>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('cartAddedModal'));
            modal.show();
            
            // Reset button
            button.innerHTML = '<i class="bi bi-check me-1"></i> Agregado';
            button.classList.add('btn-success');
            
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.classList.remove('btn-success');
                button.disabled = false;
            }, 2000);
            
        } else {
            showToast(data.message || 'Error al agregar al carrito', 'error');
            button.innerHTML = originalContent;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error al agregar al carrito', 'error');
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}

// Update cart count in navbar and other places
function updateCartCount(count) {
    const cartBadges = document.querySelectorAll('.cart-badge, #mobileCartBadge');
    cartBadges.forEach(badge => {
        badge.textContent = count;
        badge.classList.toggle('d-none', count === 0);
    });
}

// Category filtering
document.addEventListener('DOMContentLoaded', function() {
    const categoryButtons = document.querySelectorAll('.category-filter');
    const productItems = document.querySelectorAll('.product-item');
    
    categoryButtons.forEach(button => {
        button.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            
            // Update active button
            categoryButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Filter products
            productItems.forEach(item => {
                const itemCategory = item.getAttribute('data-category');
                if (category === 'all' || itemCategory === category) {
                    item.style.display = 'block';
                    item.classList.add('fade-in');
                } else {
                    item.style.display = 'none';
                    item.classList.remove('fade-in');
                }
            });
        });
    });
    
    // Load more functionality
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', function() {
            // Implement load more logic here
            console.log('Loading more products...');
        });
    }
});

// Toast notification function
function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container');
    const toastId = 'toast-' + Date.now();
    
    const toastHTML = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body d-flex align-items-center">
                <i class="bi bi-${type === 'error' ? 'exclamation-triangle' : 'check-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    const toast = new bootstrap.Toast(document.getElementById(toastId));
    toast.show();
    
    // Remove toast element after it's hidden
    document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}
</script>
{% endblock %}
