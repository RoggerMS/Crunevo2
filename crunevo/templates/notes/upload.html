{% extends 'base.html' %}
{% import 'components/csrf.html' as csrf %}
{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-lg border-0">
        <div class="card-body p-4 p-md-5">
          <h3 class="card-title mb-4 text-center">Subir nuevo apunte</h3>
          <form method="post" enctype="multipart/form-data" id="noteUploadForm">
            {{ csrf.csrf_field() }}

            <div class="form-floating mb-3">
              <input type="text" class="form-control" id="title" name="title" placeholder="Título" required>
              <label for="title">Título</label>
            </div>

            <div class="form-floating mb-3">
              <textarea class="form-control" placeholder="Descripción" id="description" name="description" style="height: 120px"></textarea>
              <label for="description">Descripción</label>
            </div>

            <div class="form-floating mb-3">
              <input type="text" class="form-control" id="tags" name="tags" placeholder="Etiquetas (separadas por coma)">
              <label for="tags">Etiquetas (ej. mate, física)</label>
            </div>

            <div class="form-floating mb-3">
              <input type="text" class="form-control" id="category" name="category" placeholder="Categoría">
              <label for="category">Categoría</label>
            </div>

            <div class="mb-4">
              <label for="file" class="form-label">Archivo</label>
              <input class="form-control" type="file" id="file" name="file" accept="application/pdf,image/*" required>
            </div>
            <canvas id="pdfPreview" class="w-100 border rounded shadow-sm mb-3 tw-hidden" style="max-height:400px;"></canvas>
            <img loading="lazy" id="imgPreview" class="img-fluid border rounded shadow-sm mb-3 tw-hidden" style="max-height:400px;" />

            <button type="submit" class="btn btn-primary w-100" id="uploadBtn">Subir</button>
          </form>
        </div>
      </div>
</div>
</div>
</div>
{% endblock %}

{% block body_end %}
  {{ super() }}
  <script src="{{ url_for('static', filename='pdfjs/pdf.min.js') }}"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = "{{ url_for('static', filename='pdfjs/pdf.worker.min.js') }}";
    const fileInput = document.getElementById('file');
    const canvas = document.getElementById('pdfPreview');
    const imgPrev = document.getElementById('imgPreview');
    const form = document.getElementById('noteUploadForm');
    const btn = document.getElementById('uploadBtn');

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      canvas.classList.add('tw-hidden');
      imgPrev.classList.add('tw-hidden');
      if (!file) return;
      if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const task = pdfjsLib.getDocument({ data: e.target.result });
          task.promise
            .then((pdf) => pdf.getPage(1))
            .then((page) => {
              const viewport = page.getViewport({ scale: 1.2 });
              const ctx = canvas.getContext('2d');
              canvas.width = viewport.width;
              canvas.height = viewport.height;
              page.render({ canvasContext: ctx, viewport });
              canvas.classList.remove('tw-hidden');
            })
            .catch(() => {
              canvas.classList.add('tw-hidden');
            });
        };
        reader.readAsArrayBuffer(file);
      } else if (file.type.startsWith('image/')) {
        imgPrev.src = URL.createObjectURL(file);
        imgPrev.onload = () => URL.revokeObjectURL(imgPrev.src);
        imgPrev.classList.remove('tw-hidden');
      }
    });

    form.addEventListener('submit', () => {
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Subiendo...';
    });
  </script>
{% endblock %}
