{% extends 'base.html' %}
{% import 'components/csrf.html' as csrf %}
{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-lg border-0">
        <div class="card-body p-4 p-md-5">
          <h3 class="card-title mb-4 text-center">Subir nuevo apunte</h3>
          <form method="post" enctype="multipart/form-data" id="noteUploadForm">
            {{ csrf.csrf_field() }}

            <div class="form-floating mb-3">
              <input type="text" class="form-control" id="title" name="title" placeholder="Título" required>
              <label for="title">Título</label>
            </div>

            <div class="form-floating mb-3">
              <textarea class="form-control" placeholder="Descripción" id="description" name="description" style="height: 120px"></textarea>
              <label for="description">Descripción breve</label>
            </div>

            <div class="mb-3">
              <label class="form-label" for="category">Categoría</label>
              <select class="form-select" id="category" name="category" required>
                <option value="" selected>Seleccionar...</option>
                <option>Matemática</option>
                <option>Historia</option>
                <option>Biología</option>
                <option>Comunicación</option>
              </select>
            </div>

            <div class="form-floating mb-3">
              <input type="text" class="form-control" id="course" name="course" placeholder="Curso específico (opcional)">
              <label for="course">Curso específico (opcional)</label>
            </div>

            <div class="mb-3">
              <label class="form-label" for="level">Nivel Académico</label>
              <select class="form-select" id="level" name="level" required>
                <option value="Primaria">Primaria</option>
                <option value="Secundaria">Secundaria</option>
                <option value="Universidad" selected>Universidad</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label" for="tagsInput">Etiquetas</label>
              <div id="tagsContainer" class="mb-2"></div>
              <input type="text" class="form-control" id="tagsInput" placeholder="Añadir etiqueta">
              <div class="dropdown-menu w-100" id="tagSuggestionBox"></div>
              <input type="hidden" id="tagsHidden" name="tags">
            </div>

            <div class="mb-4">
              <label for="file" class="form-label">Archivo</label>
              <input class="form-control" type="file" id="file" name="file" accept="application/pdf,image/*" required>
            </div>
            <canvas id="pdfPreview" class="w-100 border rounded shadow-sm mb-3 tw-hidden" style="max-height:400px;"></canvas>
            <img loading="lazy" id="imgPreview" class="img-fluid border rounded shadow-sm mb-3 tw-hidden" style="max-height:400px;" />

            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="privacyToggle" name="private" value="1">
              <label class="form-check-label" for="privacyToggle">Privado</label>
            </div>

            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="noteTerms" required>
              <label class="form-check-label" for="noteTerms">Acepto los <a href="{{ url_for('main.terms') }}">Términos y Condiciones</a>, incluyendo que soy el autor del documento o tengo permiso para compartirlo.</label>
            </div>

            <button type="submit" class="btn btn-primary w-100" id="uploadBtn">Subir</button>
          </form>
        </div>
      </div>
</div>
</div>
</div>
{% endblock %}

{% block body_end %}
  {{ super() }}
  <script src="{{ url_for('static', filename='pdfjs/pdf.min.js') }}"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = "{{ url_for('static', filename='pdfjs/pdf.worker.min.js') }}";
    const fileInput = document.getElementById('file');
    const canvas = document.getElementById('pdfPreview');
    const imgPrev = document.getElementById('imgPreview');
    const form = document.getElementById('noteUploadForm');
    const btn = document.getElementById('uploadBtn');

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      canvas.classList.add('tw-hidden');
      imgPrev.classList.add('tw-hidden');
      if (!file) return;
      if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const task = pdfjsLib.getDocument({ data: e.target.result });
          task.promise
            .then((pdf) => pdf.getPage(1))
            .then((page) => {
              const viewport = page.getViewport({ scale: 1.2 });
              const ctx = canvas.getContext('2d');
              canvas.width = viewport.width;
              canvas.height = viewport.height;
              page.render({ canvasContext: ctx, viewport });
              canvas.classList.remove('tw-hidden');
            })
            .catch(() => {
              canvas.classList.add('tw-hidden');
            });
        };
        reader.readAsArrayBuffer(file);
      } else if (file.type.startsWith('image/')) {
        imgPrev.src = URL.createObjectURL(file);
        imgPrev.onload = () => URL.revokeObjectURL(imgPrev.src);
        imgPrev.classList.remove('tw-hidden');
      }
    });

    const suggestions = {{ suggestions|tojson }};
    const tagInput = document.getElementById('tagsInput');
    const tagBox = document.getElementById('tagSuggestionBox');
    const tagContainer = document.getElementById('tagsContainer');
    const hiddenTags = document.getElementById('tagsHidden');
    const picked = [];

    function renderTags() {
      tagContainer.innerHTML = '';
      picked.forEach((t, i) => {
        const span = document.createElement('span');
        span.className = 'badge bg-secondary me-1 mb-1 d-inline-flex align-items-center';
        span.textContent = t;
        const close = document.createElement('button');
        close.type = 'button';
        close.className = 'btn-close btn-close-white btn-sm ms-1';
        close.style.fontSize = '0.6rem';
        close.addEventListener('click', () => {
          picked.splice(i, 1);
          renderTags();
        });
        span.appendChild(close);
        tagContainer.appendChild(span);
      });
      hiddenTags.value = picked.join(',');
    }

    function showSuggestions(val) {
      tagBox.innerHTML = '';
      if (!val) return;
      suggestions
        .filter((s) => s.toLowerCase().startsWith(val.toLowerCase()) && !picked.includes(s))
        .slice(0, 5)
        .forEach((s) => {
          const item = document.createElement('button');
          item.type = 'button';
          item.className = 'dropdown-item';
          item.textContent = s;
          item.addEventListener('click', () => {
            picked.push(s);
            renderTags();
            tagBox.classList.remove('show');
            tagInput.value = '';
          });
          tagBox.appendChild(item);
        });
      if (tagBox.children.length) {
        tagBox.classList.add('show');
      } else {
        tagBox.classList.remove('show');
      }
    }

    tagInput.addEventListener('input', () => {
      showSuggestions(tagInput.value.trim());
    });

    tagInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && tagInput.value.trim()) {
        e.preventDefault();
        picked.push(tagInput.value.trim());
        renderTags();
        tagInput.value = '';
        tagBox.classList.remove('show');
      }
    });

    document.addEventListener('click', (e) => {
      if (!tagInput.contains(e.target)) {
        tagBox.classList.remove('show');
      }
    });

    form.addEventListener('submit', () => {
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Subiendo...';
    });
  </script>
{% endblock %}
